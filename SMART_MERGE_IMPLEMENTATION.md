# –£–º–Ω–æ–µ –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –±–µ–∑ –ø–æ—Ç–µ—Ä–∏ –¥–∞–Ω–Ω—ã—Ö

## –ü—Ä–æ–±–ª–µ–º–∞

–ü—Ä–∏ –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏–∏ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ **–≤—Å–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ –æ–±—ä–µ–¥–∏–Ω—è–µ–º–æ–≥–æ –ø—Ä–æ—Ñ–∏–ª—è —Ç–µ—Ä—è–ª–∏—Å—å**. –°—Ç–∞—Ä–∞—è —Ñ—É–Ω–∫—Ü–∏—è `merge_participants_extended` —Ç–æ–ª—å–∫–æ:
- –ü–µ—Ä–µ–Ω–æ—Å–∏–ª–∞ —Å–≤—è–∑–∏ –≥—Ä—É–ø–ø
- –ü–µ—Ä–µ–Ω–æ—Å–∏–ª–∞ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏
- –ü–µ—Ä–µ–Ω–æ—Å–∏–ª–∞ —Å–æ–±—ã—Ç–∏—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
- **–ù–û –ù–ï –æ–±—ä–µ–¥–∏–Ω—è–ª–∞ –ø–æ–ª—è** (email, phone, full_name, etc.)

**–†–µ–∑—É–ª—å—Ç–∞—Ç**: –ï—Å–ª–∏ —É –¥—É–±–ª–∏–∫–∞—Ç–∞ –±—ã–ª –∑–∞–ø–æ–ª–Ω–µ–Ω —Ç–µ–ª–µ—Ñ–æ–Ω, –∞ —É –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –ø—Ä–æ—Ñ–∏–ª—è - –Ω–µ—Ç, —ç—Ç–æ—Ç —Ç–µ–ª–µ—Ñ–æ–Ω **—Ç–µ—Ä—è–ª—Å—è –Ω–∞–≤—Å–µ–≥–¥–∞**.

## –†–µ—à–µ–Ω–∏–µ

–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ **—É–º–Ω–æ–µ –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ** —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö –ø–æ —Å–ª–µ–¥—É—é—â–µ–π –ª–æ–≥–∏–∫–µ:

### –õ–æ–≥–∏–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø–æ–ª–µ–π

–î–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–æ–ª—è (email, phone, full_name, username, first_name, last_name):

```
IF target.field = NULL AND duplicate.field ‚â† NULL
   ‚Üí –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å: target.field = duplicate.field
   ‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç: –ü—É—Å—Ç–æ–µ –ø–æ–ª–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–æ

ELSE IF target.field ‚â† NULL AND duplicate.field ‚â† NULL AND target.field ‚â† duplicate.field
   ‚Üí –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–æ–Ω—Ñ–ª–∏–∫—Ç –≤ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏:
      - trait_key = "phone_merged" (–∏–ª–∏ "phone_merged_2" –µ—Å–ª–∏ —É–∂–µ –µ—Å—Ç—å)
      - trait_value = duplicate.field
      - metadata = { merged_from, original_field, conflict_with }
   ‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç: –û–±–∞ –∑–Ω–∞—á–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã, –º–æ–∂–Ω–æ –≤—ã–±—Ä–∞—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ

ELSE IF target.field = duplicate.field
   ‚Üí –ù–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞—Ç—å
   ‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç: –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–µ —Å–æ–∑–¥–∞—ë—Ç—Å—è
```

### –ü–æ—á–µ–º—É —ç—Ç–æ—Ç –ø–æ–¥—Ö–æ–¥ –æ–ø—Ç–∏–º–∞–ª–µ–Ω

| –ö—Ä–∏—Ç–µ—Ä–∏–π | –û—Ü–µ–Ω–∫–∞ | –ü–æ—è—Å–Ω–µ–Ω–∏–µ |
|----------|---------|-----------|
| **–ü–æ—Ç–µ—Ä—è –¥–∞–Ω–Ω—ã—Ö** | ‚úÖ –ù—É–ª–µ–≤–∞—è | –í—Å–µ –¥–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è |
| **–ü—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å** | ‚úÖ –í—ã—Å–æ–∫–∞—è | –í–∏–¥–Ω–æ, –æ—Ç–∫—É–¥–∞ –ø—Ä–∏—à–ª–∏ –¥–∞–Ω–Ω—ã–µ |
| **–ì–∏–±–∫–æ—Å—Ç—å** | ‚úÖ –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è | –ú–æ–∂–Ω–æ –≤—Ä—É—á–Ω—É—é –≤—ã–±—Ä–∞—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ |
| **–ò—Å—Ç–æ—Ä–∏—è** | ‚úÖ –ü–æ–ª–Ω–∞—è | Metadata —Å–æ–¥–µ—Ä–∂–∏—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç |
| **–ü—Ä–æ—Å—Ç–æ—Ç–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è** | ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è | –ù–µ —Ç—Ä–µ–±—É–µ—Ç —É—á–∞—Å—Ç–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è |
| **–ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å** | ‚úÖ –•–æ—Ä–æ—à–∞—è | –•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ –Ω—É–º–µ—Ä—É—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ |

### –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞–º–∏

#### –í–∞—Ä–∏–∞–Ω—Ç A: –ü—Ä–æ—Å—Ç–æ –∑–∞–ø–æ–ª–Ω—è—Ç—å –ø—É—Å—Ç—ã–µ
```sql
IF target.field IS NULL THEN
  target.field = duplicate.field
END IF
```
‚ùå **–ù–µ–¥–æ—Å—Ç–∞—Ç–æ–∫**: –ö–æ–Ω—Ñ–ª–∏–∫—Ç—É—é—â–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è —Ç–µ—Ä—è—é—Ç—Å—è

#### –í–∞—Ä–∏–∞–Ω—Ç B: –£–º–Ω–æ–µ –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ (–≤—ã–±—Ä–∞–Ω)
```sql
IF target.field IS NULL THEN
  target.field = duplicate.field
ELSIF target.field != duplicate.field THEN
  -- –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏
END IF
```
‚úÖ **–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–æ**: –ù–∏–∫–∞–∫–∏–µ –¥–∞–Ω–Ω—ã–µ –Ω–µ —Ç–µ—Ä—è—é—Ç—Å—è

#### –í–∞—Ä–∏–∞–Ω—Ç C: –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π –≤—ã–±–æ—Ä
```sql
-- –ü—Ä–∏ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–µ –∑–∞–ø—Ä–æ—Å–∏—Ç—å —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤—ã–±–æ—Ä
```
‚ùå **–ù–µ–¥–æ—Å—Ç–∞—Ç–æ–∫**: –¢—Ä–µ–±—É–µ—Ç —É—á–∞—Å—Ç–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –∑–∞–º–µ–¥–ª—è–µ—Ç –ø—Ä–æ—Ü–µ—Å—Å

## –†–µ–∞–ª–∏–∑–∞—Ü–∏—è

### 1. –ù–æ–≤–∞—è SQL —Ñ—É–Ω–∫—Ü–∏—è `merge_participants_smart`

**–§–∞–π–ª**: `db/migrations/25_merge_participants_smart.sql`

**–ö–ª—é—á–µ–≤—ã–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏**:
- –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç 6 –æ—Å–Ω–æ–≤–Ω—ã—Ö –ø–æ–ª–µ–π: full_name, email, phone, username, first_name, last_name
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –Ω—É–º–µ—Ä—É–µ—Ç –∫–æ–Ω—Ñ–ª–∏–∫—Ç—É—é—â–∏–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ (phone_merged, phone_merged_2, etc.)
- –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –æ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–µ (–æ—Ç–∫—É–¥–∞ –ø—Ä–∏—à–ª–æ, —Å —á–µ–º –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤–∞–ª–æ)
- –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø–æ–¥—Ä–æ–±–Ω—ã–π JSON —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏ –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏—è

**–í–æ–∑–≤—Ä–∞—â–∞–µ–º–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ**:
```json
{
  "merged_fields": [
    {
      "field": "phone",
      "action": "filled",
      "value": "+79991234567"
    }
  ],
  "conflicts": [
    {
      "field": "email",
      "target_value": "ivan@example.com",
      "duplicate_value": "ivan.petrov@example.com",
      "saved_as": "email_merged"
    }
  ],
  "target": "uuid-target",
  "duplicates": ["uuid-duplicate"]
}
```

### 2. –û–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–π API endpoint

**–§–∞–π–ª**: `app/api/participants/[participantId]/route.ts`

**–ò–∑–º–µ–Ω–µ–Ω–∏—è**:
```typescript
// –ü—ã—Ç–∞–µ–º—Å—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –Ω–æ–≤—É—é —Ñ—É–Ω–∫—Ü–∏—é
const { data: mergeResult, error: mergeError } = await supabase
  .rpc('merge_participants_smart', {
    p_target: targetCanonical,
    p_duplicates: [canonicalId],
    p_actor: actorId
  });

// –ï—Å–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞, –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç–∞—Ä—É—é (–æ–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å)
if (mergeError) {
  await supabase.rpc('merge_participants_extended', ...);
}

// –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∫–ª–∏–µ–Ω—Ç—É
return NextResponse.json({ 
  success: true, 
  detail, 
  merged_into: targetCanonical,
  merge_result: mergeResult // ‚Üê –ù–æ–≤–æ–µ
});
```

### 3. –£–ª—É—á—à—ë–Ω–Ω—ã–π UI –∫–æ–º–ø–æ–Ω–µ–Ω—Ç

**–§–∞–π–ª**: `components/members/participant-duplicates-card.tsx`

**–ù–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å**:
```typescript
// –ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏—è –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–µ—Ç–∞–ª–∏
if (data?.merge_result) {
  const result = data.merge_result;
  let message = '–ü—Ä–æ—Ñ–∏–ª–∏ —É—Å–ø–µ—à–Ω–æ –æ–±—ä–µ–¥–∏–Ω–µ–Ω—ã!\n\n';
  
  if (result.merged_fields.length > 0) {
    message += `–ó–∞–ø–æ–ª–Ω–µ–Ω–æ –ø–æ–ª–µ–π: ${result.merged_fields.length}\n`;
  }
  
  if (result.conflicts.length > 0) {
    message += `\n–ö–æ–Ω—Ñ–ª–∏–∫—Ç—É—é—â–∏—Ö –∑–Ω–∞—á–µ–Ω–∏–π: ${result.conflicts.length}\n`;
    message += '–û–Ω–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∞—Ö\n';
  }
  
  alert(message);
}
```

## –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

### –ü—Ä–∏–º–µ—Ä 1: –ü—Ä–æ—Å—Ç–æ–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –ø—É—Å—Ç—ã—Ö –ø–æ–ª–µ–π

**–î–æ –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏—è**:
```
Target:
  - full_name: "–ò–≤–∞–Ω –ü–µ—Ç—Ä–æ–≤"
  - email: null
  - phone: null

Duplicate:
  - full_name: "–ò–≤–∞–Ω"
  - email: "ivan@example.com"
  - phone: "+79991234567"
```

**–ü–æ—Å–ª–µ –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏—è**:
```
Target:
  - full_name: "–ò–≤–∞–Ω –ü–µ—Ç—Ä–æ–≤" (–Ω–µ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å)
  - email: "ivan@example.com" ‚úÖ –ó–∞–ø–æ–ª–Ω–µ–Ω–æ
  - phone: "+79991234567" ‚úÖ –ó–∞–ø–æ–ª–Ω–µ–Ω–æ

Characteristics: (–ø—É—Å—Ç–æ)
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç**:
```json
{
  "merged_fields": [
    {"field": "email", "value": "ivan@example.com"},
    {"field": "phone", "value": "+79991234567"}
  ],
  "conflicts": []
}
```

### –ü—Ä–∏–º–µ—Ä 2: –ö–æ–Ω—Ñ–ª–∏–∫—Ç—É—é—â–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è

**–î–æ –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏—è**:
```
Target:
  - full_name: "–ò–≤–∞–Ω –ü–µ—Ç—Ä–æ–≤"
  - email: "ivan@example.com"
  - phone: "+79991234567"

Duplicate:
  - full_name: "–ü–µ—Ç—Ä–æ–≤ –ò–≤–∞–Ω"
  - email: "ivan.petrov@gmail.com"
  - phone: "+79991234567" (–æ–¥–∏–Ω–∞–∫–æ–≤—ã–π)
```

**–ü–æ—Å–ª–µ –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏—è**:
```
Target:
  - full_name: "–ò–≤–∞–Ω –ü–µ—Ç—Ä–æ–≤" (–Ω–µ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å)
  - email: "ivan@example.com" (–Ω–µ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å)
  - phone: "+79991234567" (–Ω–µ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å)

Characteristics:
  - full_name_merged: "–ü–µ—Ç—Ä–æ–≤ –ò–≤–∞–Ω" ‚úÖ
    metadata: {
      merged_from: "uuid-duplicate",
      original_field: "full_name",
      conflict_with: "–ò–≤–∞–Ω –ü–µ—Ç—Ä–æ–≤"
    }
  - email_merged: "ivan.petrov@gmail.com" ‚úÖ
    metadata: {
      merged_from: "uuid-duplicate",
      original_field: "email",
      conflict_with: "ivan@example.com"
    }
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç**:
```json
{
  "merged_fields": [],
  "conflicts": [
    {
      "field": "full_name",
      "target_value": "–ò–≤–∞–Ω –ü–µ—Ç—Ä–æ–≤",
      "duplicate_value": "–ü–µ—Ç—Ä–æ–≤ –ò–≤–∞–Ω",
      "saved_as": "full_name_merged"
    },
    {
      "field": "email",
      "target_value": "ivan@example.com",
      "duplicate_value": "ivan.petrov@gmail.com",
      "saved_as": "email_merged"
    }
  ]
}
```

### –ü—Ä–∏–º–µ—Ä 3: –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã –æ–¥–Ω–æ–≥–æ –ø–æ–ª—è

**–î–æ –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏—è**:
```
Target:
  - phone: "+79991111111"
  - Characteristics:
    - phone_merged: "+79992222222" (–æ—Ç –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏—è)

Duplicate:
  - phone: "+79993333333"
```

**–ü–æ—Å–ª–µ –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏—è**:
```
Target:
  - phone: "+79991111111" (–Ω–µ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å)
  - Characteristics:
    - phone_merged: "+79992222222" (—Å—Ç–∞—Ä–æ–µ)
    - phone_merged_2: "+79993333333" ‚úÖ –ù–æ–≤–æ–µ
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç**:
```json
{
  "merged_fields": [],
  "conflicts": [
    {
      "field": "phone",
      "target_value": "+79991111111",
      "duplicate_value": "+79993333333",
      "saved_as": "phone_merged_2"
    }
  ]
}
```

## –ú–∏–≥—Ä–∞—Ü–∏—è

### –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–∏

```bash
# –ü—Ä–∏–º–µ–Ω–∏—Ç—å –Ω–æ–≤—É—é –º–∏–≥—Ä–∞—Ü–∏—é
supabase db push

# –ò–ª–∏ —á–µ—Ä–µ–∑ Supabase Dashboard:
# SQL Editor ‚Üí –í—Å—Ç–∞–≤–∏—Ç—å —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ 25_merge_participants_smart.sql ‚Üí Run
```

### –û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å

–ö–æ–¥ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç, –¥–æ—Å—Ç—É–ø–Ω–∞ –ª–∏ –Ω–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è:
```typescript
// –ü—ã—Ç–∞–µ–º—Å—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –Ω–æ–≤—É—é
const { data, error } = await supabase.rpc('merge_participants_smart', ...);

if (error) {
  // Fallback –Ω–∞ —Å—Ç–∞—Ä—É—é —Ñ—É–Ω–∫—Ü–∏—é
  await supabase.rpc('merge_participants_extended', ...);
}
```

–≠—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç:
- ‚úÖ –ü—Ä–∏–º–µ–Ω—è—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é –ø–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ
- ‚úÖ –ù–µ –ª–æ–º–∞—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–¥
- ‚úÖ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –≤ staging –ø–µ—Ä–µ–¥ production

## –†–∞–±–æ—Ç–∞ —Å –∫–æ–Ω—Ñ–ª–∏–∫—Ç–∞–º–∏

### –ü—Ä–æ—Å–º–æ—Ç—Ä –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤

–í—Å–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç—É—é—â–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –∫–∞–∫ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ —Å –ø—Ä–µ—Ñ–∏–∫—Å–æ–º `*_merged`:

```sql
SELECT 
  trait_key,
  trait_value,
  metadata->>'original_field' as original_field,
  metadata->>'conflict_with' as conflict_with
FROM participant_traits
WHERE participant_id = 'target-uuid'
  AND source = 'merge'
ORDER BY created_at DESC;
```

### –†–∞–∑—Ä–µ—à–µ–Ω–∏–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ –≤—Ä—É—á–Ω—É—é

–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –º–æ–∂–µ—Ç:

1. **–í—ã–±—Ä–∞—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ**:
```typescript
// –û–±–Ω–æ–≤–∏—Ç—å –æ—Å–Ω–æ–≤–Ω–æ–µ –ø–æ–ª–µ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º –∑–Ω–∞—á–µ–Ω–∏–µ–º
await supabase
  .from('participants')
  .update({ phone: '+79993333333' })
  .eq('id', participantId);

// –£–¥–∞–ª–∏—Ç—å —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫—É
await supabase
  .from('participant_traits')
  .delete()
  .eq('trait_key', 'phone_merged');
```

2. **–û—Å—Ç–∞–≤–∏—Ç—å –æ–±–µ –∑–∞–ø–∏—Å–∏** –¥–ª—è –∏—Å—Ç–æ—Ä–∏–∏

3. **–î–æ–±–∞–≤–∏—Ç—å –ø—Ä–∏–º–µ—á–∞–Ω–∏–µ**:
```typescript
await supabase
  .from('participant_traits')
  .update({ 
    metadata: { 
      ...existing_metadata, 
      note: '–°—Ç–∞—Ä—ã–π –Ω–æ–º–µ—Ä, –±–æ–ª—å—à–µ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è' 
    }
  })
  .eq('trait_key', 'phone_merged');
```

## –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏–π

```sql
-- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ –ø–æ –ø–æ–ª—è–º
SELECT 
  metadata->>'original_field' as field,
  COUNT(*) as conflicts_count
FROM participant_traits
WHERE source = 'merge'
GROUP BY metadata->>'original_field'
ORDER BY conflicts_count DESC;
```

### –£—á–∞—Å—Ç–Ω–∏–∫–∏ —Å –∫–æ–Ω—Ñ–ª–∏–∫—Ç–∞–º–∏

```sql
-- –£—á–∞—Å—Ç–Ω–∏–∫–∏, —É –∫–æ—Ç–æ—Ä—ã—Ö –µ—Å—Ç—å –∫–æ–Ω—Ñ–ª–∏–∫—Ç—É—é—â–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è
SELECT 
  p.id,
  p.full_name,
  COUNT(pt.id) as conflicts_count,
  array_agg(pt.trait_key) as conflict_keys
FROM participants p
JOIN participant_traits pt ON pt.participant_id = p.id
WHERE pt.source = 'merge'
GROUP BY p.id, p.full_name
ORDER BY conflicts_count DESC;
```

## –õ—É—á—à–∏–µ –ø—Ä–∞–∫—Ç–∏–∫–∏

### 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ–¥ –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ–º
–ü—Ä–æ—Å–º–∞—Ç—Ä–∏–≤–∞–π—Ç–µ —Å–ø–∏—Å–æ–∫ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ –∏ –ø—Ä–æ–≤–µ—Ä—è–π—Ç–µ, –∫–∞–∫–æ–π –ø—Ä–æ—Ñ–∏–ª—å –±–æ–ª–µ–µ –ø–æ–ª–Ω—ã–π.

### 2. –†–∞–∑—Ä–µ—à–µ–Ω–∏–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤
–ü–æ—Å–ª–µ –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏—è –ø—Ä–æ–≤–µ—Ä—è–π—Ç–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ —Å –ø—Ä–µ—Ñ–∏–∫—Å–æ–º `*_merged` –∏ —Ä–∞–∑—Ä–µ—à–∞–π—Ç–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã.

### 3. –û—á–∏—Å—Ç–∫–∞
–ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏ —É–¥–∞–ª—è–π—Ç–µ —Ä–∞–∑—Ä–µ—à—ë–Ω–Ω—ã–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã:
```sql
DELETE FROM participant_traits
WHERE source = 'merge'
  AND metadata->>'resolved' = 'true';
```

### 4. –î–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
–î–æ–±–∞–≤–ª—è–π—Ç–µ –ø—Ä–∏–º–µ—á–∞–Ω–∏—è –∫ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–∞–º –¥–ª—è –¥—Ä—É–≥–∏—Ö –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤.

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –¢–µ—Å—Ç 1: –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –ø—É—Å—Ç—ã—Ö –ø–æ–ª–µ–π
```
‚úÖ –°–æ–∑–¥–∞—Ç—å –¥–≤—É—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ —Å –Ω–µ–ø–µ—Ä–µ—Å–µ–∫–∞—é—â–∏–º–∏—Å—è –ø–æ–ª—è–º–∏
‚úÖ –û–±—ä–µ–¥–∏–Ω–∏—Ç—å –∏—Ö
‚úÖ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –≤—Å–µ –ø–æ–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω—ã
‚úÖ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ –Ω–µ—Ç
```

### –¢–µ—Å—Ç 2: –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤
```
‚úÖ –°–æ–∑–¥–∞—Ç—å –¥–≤—É—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ —Å –æ–¥–∏–Ω–∞–∫–æ–≤—ã–º–∏ –ø–æ–ª—è–º–∏, –Ω–æ —Ä–∞–∑–Ω—ã–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏
‚úÖ –û–±—ä–µ–¥–∏–Ω–∏—Ç—å –∏—Ö
‚úÖ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –∑–Ω–∞—á–µ–Ω–∏–µ target –Ω–µ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å
‚úÖ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏
‚úÖ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å metadata –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤
```

### –¢–µ—Å—Ç 3: –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã
```
‚úÖ –°–æ–∑–¥–∞—Ç—å —É—á–∞—Å—Ç–Ω–∏–∫–∞ —Å —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–æ–π phone_merged
‚úÖ –û–±—ä–µ–¥–∏–Ω–∏—Ç—å —Å –¥—Ä—É–≥–∏–º —É—á–∞—Å—Ç–Ω–∏–∫–æ–º —Å –∫–æ–Ω—Ñ–ª–∏–∫—Ç—É—é—â–∏–º phone
‚úÖ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –Ω–æ–≤–∞—è —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∞ –Ω–∞–∑–≤–∞–Ω–∞ phone_merged_2
```

### –¢–µ—Å—Ç 4: –û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å
```
‚úÖ –ù–ï –ø—Ä–∏–º–µ–Ω—è—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é
‚úÖ –ü–æ–ø—ã—Ç–∞—Ç—å—Å—è –æ–±—ä–µ–¥–∏–Ω–∏—Ç—å —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
‚úÖ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Å—Ç–∞—Ä–∞—è —Ñ—É–Ω–∫—Ü–∏—è (fallback)
‚úÖ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –æ—à–∏–±–æ–∫ –Ω–µ—Ç
```

## –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

–ù–æ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞ –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏—è —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤:
- ‚úÖ **–ù–µ —Ç–µ—Ä—è–µ—Ç –¥–∞–Ω–Ω—ã–µ** - –≤—Å–µ –∑–Ω–∞—á–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è
- ‚úÖ **–ü—Ä–æ–∑—Ä–∞—á–Ω–∞** - –≤–∏–¥–Ω–æ, —á—Ç–æ –±—ã–ª–æ –æ–±—ä–µ–¥–∏–Ω–µ–Ω–æ
- ‚úÖ **–ì–∏–±–∫–∞—è** - –º–æ–∂–Ω–æ –≤—Ä—É—á–Ω—É—é —Ä–∞–∑—Ä–µ—à–∏—Ç—å –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã
- ‚úÖ **–û–±—Ä–∞—Ç–Ω–æ —Å–æ–≤–º–µ—Å—Ç–∏–º–∞** - —Ä–∞–±–æ—Ç–∞–µ—Ç —Å–æ —Å—Ç–∞—Ä–æ–π —Ñ—É–Ω–∫—Ü–∏–µ–π
- ‚úÖ **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è** - –Ω–µ —Ç—Ä–µ–±—É–µ—Ç —É—á–∞—Å—Ç–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

–ö–æ–Ω—Ñ–ª–∏–∫—Ç—É—é—â–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏, –≥–¥–µ –∏—Ö –º–æ–∂–Ω–æ:
- –ü—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å
- –°—Ä–∞–≤–Ω–∏—Ç—å —Å —Ç–µ–∫—É—â–∏–º –∑–Ω–∞—á–µ–Ω–∏–µ–º
- –í—ã–±—Ä–∞—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ
- –ò–ª–∏ –æ—Å—Ç–∞–≤–∏—Ç—å –¥–ª—è –∏—Å—Ç–æ—Ä–∏–∏

–≠—Ç–æ –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏—è –¥—É–±–ª–∏–∫–∞—Ç–æ–≤! üéâ

