# Deploy Checklist: Day 8 (06.11.2025)

## ‚úÖ Pre-Deploy:

- [x] –ú–∏–≥—Ä–∞—Ü–∏—è 094 –ø—Ä–∏–º–µ–Ω–µ–Ω–∞ –≤ Supabase (`db/migrations/094_openai_api_logs.sql`)
- [x] –í—Å–µ –æ—à–∏–±–∫–∏ –∫–æ–º–ø–∏–ª—è—Ü–∏–∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã

---

## üöÄ Deploy Steps:

```bash
git add .
git commit -m "Day 8: OpenAI API logging + cost monitoring + 4 hotfixes"
git push
```

---

## üß™ Post-Deploy Testing:

### **1. OpenAI Logging (–Ω–æ–≤–æ–µ):**

**Test 1: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∞–±–ª–∏—Ü—ã**
```sql
SELECT * FROM openai_api_logs ORDER BY created_at DESC LIMIT 5;
```
–î–æ–ª–∂–Ω–æ –±—ã—Ç—å –ø—É—Å—Ç–æ (–µ—Å–ª–∏ –µ—â—ë –Ω–µ –±—ã–ª–æ –≤—ã–∑–æ–≤–æ–≤).

**Test 2: –ü—Ä–æ–≤–µ—Ä–∫–∞ RPC —Ñ—É–Ω–∫—Ü–∏–∏**
```sql
SELECT * FROM get_openai_cost_summary(NULL, 30);
```
–î–æ–ª–∂–Ω–æ –≤–µ—Ä–Ω—É—Ç—å:
```
total_requests: 0
total_tokens: 0
total_cost_usd: 0
total_cost_rub: 0
avg_cost_per_request_usd: 0
by_request_type: null
```

**Test 3: –ü—Ä–æ–≤–µ—Ä–∫–∞ UI**
- –û—Ç–∫—Ä—ã—Ç—å `/superadmin/ai-costs`
- –î–æ–ª–∂–Ω–∞ –∑–∞–≥—Ä—É–∑–∏—Ç—å—Å—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –±–µ–∑ –æ—à–∏–±–æ–∫
- –î–æ–ª–∂–Ω—ã –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –∫–∞—Ä—Ç–æ—á–∫–∏ —Å –Ω—É–ª–µ–≤—ã–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏

**Test 4: –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ–ª–æ–≥–≥–∏—Ä–æ–≤–∞–Ω–∏—è**
- –û—Ç–∫—Ä—ã—Ç—å –ø—Ä–æ—Ñ–∏–ª—å –ª—é–±–æ–≥–æ —É—á–∞—Å—Ç–Ω–∏–∫–∞ —Å —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏
- –ù–∞–∂–∞—Ç—å "–û—Ü–µ–Ω–∏—Ç—å –Ω–∞–ª–∏—á–∏–µ –¥–∞–Ω–Ω—ã—Ö" ‚Üí "–ó–∞–ø—É—Å—Ç–∏—Ç—å AI-–∞–Ω–∞–ª–∏–∑"
- –ü–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –æ—Ç–∫—Ä—ã—Ç—å `/superadmin/ai-costs`
- –î–æ–ª–∂–Ω–∞ –ø–æ—è–≤–∏—Ç—å—Å—è –Ω–æ–≤–∞—è –∑–∞–ø–∏—Å—å:
  - –¢–∏–ø: `participant_enrichment`
  - –ú–æ–¥–µ–ª—å: `gpt-4o-mini`
  - –°—Ç–æ–∏–º–æ—Å—Ç—å: ~$0.0001-0.0005
  - –¢–æ–∫–µ–Ω—ã: ~500-1500

---

### **2. Hotfixes (–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ —Ä–∞–Ω–µ–µ):**

**Test 5: Import Validation (chat_id)**
- –û—Ç–∫—Ä—ã—Ç—å –ª—é–±—É—é –≥—Ä—É–ø–ø—É ‚Üí "–ò–º–ø–æ—Ä—Ç –∏—Å—Ç–æ—Ä–∏–∏"
- –ó–∞–≥—Ä—É–∑–∏—Ç—å JSON —Ñ–∞–π–ª **–¥—Ä—É–≥–æ–π** –≥—Ä—É–ø–ø—ã
- –î–æ–ª–∂–Ω–∞ –±—ã—Ç—å –æ—à–∏–±–∫–∞: "Chat ID mismatch"

**Test 6: Participant Audit Log Error**
- –û—Ç–∫—Ä—ã—Ç—å –ª—é–±–æ–π –ø—Ä–æ—Ñ–∏–ª—å —É—á–∞—Å—Ç–Ω–∏–∫–∞
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ Vercel ‚Üí –Ω–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –æ—à–∏–±–∫–∏ `participant_audit_log`

**Test 7: Webhook Recovery**
- –°–ª–µ–¥–∏—Ç—å –∑–∞ –ª–æ–≥–∞–º–∏ Vercel
- –ù–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –≤—ã–∑–æ–≤–æ–≤ `setWebhook` –ø–æ–¥—Ä—è–¥

---

## ‚ùå Rollback Plan (–µ—Å–ª–∏ —á—Ç–æ-—Ç–æ —Å–ª–æ–º–∞–ª–æ—Å—å):

**–ï—Å–ª–∏ –æ—à–∏–±–∫–∞ –≤ OpenAI Logging:**
```sql
-- 1. –£–¥–∞–ª–∏—Ç—å RPC —Ñ—É–Ω–∫—Ü–∏—é
DROP FUNCTION IF EXISTS public.get_openai_cost_summary(UUID, INT);

-- 2. –£–¥–∞–ª–∏—Ç—å —Ç–∞–±–ª–∏—Ü—É
DROP TABLE IF EXISTS public.openai_api_logs CASCADE;
```

**–ï—Å–ª–∏ –æ—à–∏–±–∫–∞ –≤ –∫–æ–¥–µ:**
```bash
git revert HEAD
git push
```

---

## üìù Known Issues:

- ‚ùå –ù–µ—Ç: –≤—Å—ë –¥–æ–ª–∂–Ω–æ —Ä–∞–±–æ—Ç–∞—Ç—å

---

## ‚úÖ Success Criteria:

- [x] –ö–æ–º–ø–∏–ª—è—Ü–∏—è –ø—Ä–æ—Ö–æ–¥–∏—Ç –±–µ–∑ –æ—à–∏–±–æ–∫
- [ ] –°—Ç—Ä–∞–Ω–∏—Ü–∞ `/superadmin/ai-costs` –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è
- [ ] RPC `get_openai_cost_summary` —Ä–∞–±–æ—Ç–∞–µ—Ç
- [ ] AI-–∞–Ω–∞–ª–∏–∑ —É—á–∞—Å—Ç–Ω–∏–∫–∞ –ª–æ–≥–≥–∏—Ä—É–µ—Ç—Å—è –≤ —Ç–∞–±–ª–∏—Ü—É
- [ ] –ò–º–ø–æ—Ä—Ç —Å –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–º `chat_id` –æ—Ç–∫–ª–æ–Ω—è–µ—Ç—Å—è
- [ ] –ù–µ—Ç –æ—à–∏–±–∫–∏ `participant_audit_log` –≤ –ª–æ–≥–∞—Ö

---

**–î–∞—Ç–∞:** 06.11.2025  
**–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π:** Timur + Assistant  
**–í—Ä–µ–º—è –¥–µ–ø–ª–æ—è:** ~5 –º–∏–Ω—É—Ç (Vercel)

