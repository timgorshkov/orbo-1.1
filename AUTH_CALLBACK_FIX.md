# üîß –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ Auth Callback (PKCE Flow)

## –ü—Ä–æ–±–ª–µ–º–∞
–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—Ö–æ–¥–µ —á–µ—Ä–µ–∑ email magic link: `invalid request: both auth code and code verifier should be non-empty`

## –ü—Ä–∏—á–∏–Ω–∞
–î–ª—è email magic links Supabase –∏—Å–ø–æ–ª—å–∑—É–µ—Ç PKCE flow, –∫–æ—Ç–æ—Ä—ã–π —Ç—Ä–µ–±—É–µ—Ç server-side –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∫–æ–¥–∞. –°—Ç–∞—Ä–∞—è client-side —Å—Ç—Ä–∞–Ω–∏—Ü–∞ `/auth-callback` –ø—ã—Ç–∞–ª–∞—Å—å –≤—Ä—É—á–Ω—É—é –æ–±–º–µ–Ω—è—Ç—å –∫–æ–¥ –Ω–∞ —Å–µ—Å—Å–∏—é –±–µ–∑ code_verifier.

## –†–µ—à–µ–Ω–∏–µ
–°–æ–∑–¥–∞–Ω –Ω–æ–≤—ã–π **server-side** –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ `/auth/callback` (Route Handler), –∫–æ—Ç–æ—Ä—ã–π –ø—Ä–∞–≤–∏–ª—å–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç PKCE flow.

## –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ –∫–æ–¥–µ

### 1. –ù–æ–≤—ã–π server-side handler
**–§–∞–π–ª:** `app/auth/callback/route.ts`
- ‚úÖ Server-side –æ–±—Ä–∞–±–æ—Ç–∫–∞ PKCE
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ä–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ `/orgs/new` –∏–ª–∏ `/orgs`
- ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è —Ä–∞–±–æ—Ç–∞ —Å cookies —á–µ—Ä–µ–∑ `@supabase/ssr`

### 2. –û–±–Ω–æ–≤–ª–µ–Ω redirect URL
**–§–∞–π–ª:** `app/(auth)/signin/page.tsx`
```typescript
// –ë—ã–ª–æ:
emailRedirectTo: `${window.location.origin}/auth-callback`

// –°—Ç–∞–ª–æ:
emailRedirectTo: `${window.location.origin}/auth/callback`
```

### 3. –û–±–Ω–æ–≤–ª–µ–Ω middleware
**–§–∞–π–ª:** `middleware.ts`
- –î–æ–±–∞–≤–ª–µ–Ω –Ω–æ–≤—ã–π –ø—É—Ç—å `/auth/callback` –≤ –ø—É–±–ª–∏—á–Ω—ã–µ –º–∞—Ä—à—Ä—É—Ç—ã
- –û—Å—Ç–∞–≤–ª–µ–Ω —Å—Ç–∞—Ä—ã–π `/auth-callback` –¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏

## üìã –ß—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å –ø–æ—Å–ª–µ –¥–µ–ø–ª–æ—è

### 1. –û–±–Ω–æ–≤–∏—Ç—å Redirect URLs –≤ Supabase Dashboard

1. –û—Ç–∫—Ä–æ–π—Ç–µ [Supabase Dashboard](https://supabase.com/dashboard)
2. –í—ã–±–µ—Ä–∏—Ç–µ –≤–∞—à –ø—Ä–æ–µ–∫—Ç
3. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ **Authentication ‚Üí URL Configuration**
4. –í –ø–æ–ª–µ **Redirect URLs** –¥–æ–±–∞–≤—å—Ç–µ:
   ```
   https://app.orbo.ru/auth/callback
   ```
5. **–ù–ï —É–¥–∞–ª—è–π—Ç–µ** —Å—Ç–∞—Ä—ã–π URL `https://app.orbo.ru/auth-callback` (–¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏)
6. –ù–∞–∂–º–∏—Ç–µ **Save**

### 2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞–±–æ—Ç—É

1. –û—Ç–∫—Ä–æ–π—Ç–µ https://app.orbo.ru/signin
2. –í–≤–µ–¥–∏—Ç–µ email
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ—á—Ç—É –∏ –ø–µ—Ä–µ–π–¥–∏—Ç–µ –ø–æ —Å—Å—ã–ª–∫–µ
4. –î–æ–ª–∂–µ–Ω —É—Å–ø–µ—à–Ω–æ –≤–æ–π—Ç–∏ –∏ –ø–æ–ø–∞—Å—Ç—å –Ω–∞ `/orgs` –∏–ª–∏ `/orgs/new`

## –õ–æ–≥–∏ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏

–í —Å–ª—É—á–∞–µ –ø—Ä–æ–±–ª–µ–º –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ Vercel:
- `[Auth Callback] Processing callback:` ‚Äî –Ω–∞—á–∞–ª–æ –æ–±—Ä–∞–±–æ—Ç–∫–∏
- `[Auth Callback] Session created for user:` ‚Äî —É—Å–ø–µ—à–Ω–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ —Å–µ—Å—Å–∏–∏
- `[Auth Callback] Found X organizations` ‚Äî –Ω–∞–π–¥–µ–Ω–Ω—ã–µ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏
- `[Auth Callback] Exchange error:` ‚Äî –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–º–µ–Ω–µ –∫–æ–¥–∞

## –û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å

–°—Ç–∞—Ä–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ `/auth-callback` (client-side) –æ—Å—Ç–∞–≤–ª–µ–Ω–∞ –¥–ª—è —Å–ª—É—á–∞–µ–≤, –µ—Å–ª–∏ –∫—Ç–æ-—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Å—Ç–∞—Ä—ã–µ —Å—Å—ã–ª–∫–∏ –∏–∑ email. Middleware —Ä–∞–∑—Ä–µ—à–∞–µ—Ç –¥–æ—Å—Ç—É–ø –∫ –æ–±–æ–∏–º –≤–∞—Ä–∏–∞–Ω—Ç–∞–º.

## –í–∞–∂–Ω–æ

–ü–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è Redirect URLs –≤ Supabase, –Ω–æ–≤—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –±—É–¥—É—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π server-side callback, –∏ –æ—à–∏–±–∫–∞ PKCE –±–æ–ª—å—à–µ –Ω–µ –±—É–¥–µ—Ç –≤–æ–∑–Ω–∏–∫–∞—Ç—å. ‚úÖ

