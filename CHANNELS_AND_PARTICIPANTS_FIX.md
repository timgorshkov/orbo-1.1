# –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è: –ö–∞–Ω–∞–ª—ã –∏ –ü–æ–¥—Å—á–µ—Ç –£—á–∞—Å—Ç–Ω–∏–∫–æ–≤

**–î–∞—Ç–∞:** 2026-01-20

## üêõ –ü—Ä–æ–±–ª–µ–º—ã

### 1. Telegram-–∫–∞–Ω–∞–ª—ã –Ω–µ –æ—Ç–æ–±—Ä–∞–∂–∞–ª–∏—Å—å –≤ –ª–µ–≤–æ–º –º–µ–Ω—é
**–ü—Ä–∏—á–∏–Ω–∞:** –ü–æ—Å–ª–µ —É–¥–∞–ª–µ–Ω–∏—è –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ –∫–∞–Ω–∞–ª–æ–≤ –æ—Å—Ç–∞–ª–∏—Å—å "–±–∏—Ç—ã–µ" —Å—Å—ã–ª–∫–∏ –≤ `org_telegram_channels`, —É–∫–∞–∑—ã–≤–∞—é—â–∏–µ –Ω–∞ –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –∑–∞–ø–∏—Å–∏ –≤ `telegram_channels`.

### 2. –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–æ–¥—Å—á–µ—Ç —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –≤ –≥—Ä—É–ø–ø–∞—Ö
**–ü—Ä–∏–º–µ—Ä—ã:**
- –ì—Ä—É–ø–ø–∞ `-1003485407311`: –ø–æ–∫–∞–∑—ã–≤–∞–ª–∞ 1, –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å 2 (@Belyaev_Aleksey, @timgorshkov)
- –ì—Ä—É–ø–ø–∞ `-1002994446785`: –ø–æ–∫–∞–∑—ã–≤–∞–ª–∞ 4, –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å 2 (@timgorshkov, –¢–∏–º—É—Ä –ì–æ–ª–∏—Ü—ã–Ω)
- –ì—Ä—É–ø–ø–∞ `-1003401096638`: –ø–æ–∫–∞–∑—ã–≤–∞–ª–∞ 2, –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å 1 (+ —Å–∏—Å—Ç–µ–º–Ω—ã–µ –∞–∫–∫–∞—É–Ω—Ç—ã –≤ —Å–ø–∏—Å–∫–∞—Ö)

**–ü—Ä–∏—á–∏–Ω–∞:** –°–ª–æ–∂–Ω–∞—è –ª–æ–≥–∏–∫–∞ —Å –¥–≤—É–º—è –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω—ã–º–∏ –∑–∞–ø—Ä–æ—Å–∞–º–∏ —á–µ—Ä–µ–∑ query builder –¥–∞–≤–∞–ª–∞ –Ω–µ—Ç–æ—á–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã.

### 3. –°–∏—Å—Ç–µ–º–Ω—ã–µ –∞–∫–∫–∞—É–Ω—Ç—ã –≤ —Å–ø–∏—Å–∫–∞—Ö
- `777000` (Telegram Service Notifications)
- `136817688` (@Channel_Bot)
- –û—Ç–æ–±—Ä–∞–∂–∞–ª–∏—Å—å –≤ "–¢–æ–ø-—É—á–∞—Å—Ç–Ω–∏–∫–∞—Ö" –∏ —Å–ø–∏—Å–∫–∞—Ö –≥—Ä—É–ø–ø—ã

---

## ‚úÖ –†–µ—à–µ–Ω–∏—è

### 1. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –∑–∞–≥—Ä—É–∑–∫–∞ –∫–∞–Ω–∞–ª–æ–≤ (–æ–±–∞ layout)

**–§–∞–π–ª—ã:**
- `app/p/[org]/layout.tsx`
- `app/app/[org]/layout.tsx`

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
```typescript
// –î–æ–±–∞–≤–ª–µ–Ω —Ñ–∏–ª—å—Ç—Ä –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è "–±–∏—Ç—ã—Ö" —Å—Å—ã–ª–æ–∫
telegramChannels = channelsResult
  .filter((link: any) => link.telegram_channels) // ‚úÖ –§–∏–ª—å—Ç—Ä
  .map((link: any) => ({ /* ... */ }))
  .sort(/* ... */);

// –î–æ–±–∞–≤–ª–µ–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—à–∏–±–æ–∫
if (channelsError) {
  logger.error({ error: channelsError, org_id: org.id }, 'Failed to load telegram channels');
}
```

### 2. –°–æ–∑–¥–∞–Ω–∞ RPC —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–¥—Å—á–µ—Ç–∞ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤

**–§–∞–π–ª:** `db/migrations/205_count_valid_group_participants_rpc.sql`

**–§—É–Ω–∫—Ü–∏—è:**
```sql
CREATE OR REPLACE FUNCTION public.count_valid_group_participants(
    p_tg_group_id BIGINT,
    p_org_id UUID
)
RETURNS BIGINT
```

**–õ–æ–≥–∏–∫–∞:**
- ‚úÖ `JOIN participant_groups + participants`
- ‚úÖ –§–∏–ª—å—Ç—Ä: `is_active = true`
- ‚úÖ –§–∏–ª—å—Ç—Ä: `source != 'bot'`
- ‚úÖ –§–∏–ª—å—Ç—Ä: `merged_into IS NULL`
- ‚úÖ –§–∏–ª—å—Ç—Ä: `participant_status != 'excluded'`
- ‚úÖ `COUNT(DISTINCT p.id)`

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- –†–∞–±–æ—Ç–∞–µ—Ç –Ω–∞–ø—Ä—è–º—É—é –≤ PostgreSQL (–±—ã—Å—Ç—Ä–µ–µ)
- –ò–∑–±–µ–≥–∞–µ—Ç –ø—Ä–æ–±–ª–µ–º —Å query builder
- –ë–æ–ª–µ–µ –Ω–∞–¥–µ–∂–Ω—ã–π –∏ —Ç–µ—Å—Ç–∏—Ä—É–µ–º—ã–π

### 3. –û–±–Ω–æ–≤–ª–µ–Ω–∞ –ª–æ–≥–∏–∫–∞ –ø–æ–¥—Å—á–µ—Ç–∞ –≤ API

**–§–∞–π–ª:** `app/api/analytics/[orgId]/key-metrics/route.ts`

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
```typescript
// –ò—Å–ø–æ–ª—å–∑—É–µ–º RPC —Ñ—É–Ω–∫—Ü–∏—é
const { data: countResult, error: countError } = await adminSupabase
  .rpc('count_valid_group_participants', {
    p_tg_group_id: numericChatId,
    p_org_id: orgId
  });

// Fallback –Ω–∞ –ø—Ä—è–º–æ–π –∑–∞–ø—Ä–æ—Å, –µ—Å–ª–∏ RPC –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç
if (countError) {
  // ... fallback query
}

totalMembersInOrg = countResult || 0;
```

### 4. –°–∏—Å—Ç–µ–º–Ω—ã–µ –∞–∫–∫–∞—É–Ω—Ç—ã –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω—ã

**–§–∞–π–ª:** `app/api/analytics/[orgId]/contributors/route.ts`

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
```typescript
// –§–∏–ª—å—Ç—Ä —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –∞–∫–∫–∞—É–Ω—Ç–æ–≤
const SYSTEM_ACCOUNT_IDS = [
  777000,      // Telegram Service Notifications
  136817688,   // @Channel_Bot
  1087968824   // Group Anonymous Bot
];
if (SYSTEM_ACCOUNT_IDS.includes(userId)) return;
```

---

## üìã –î–µ–π—Å—Ç–≤–∏—è –¥–ª—è –¥–µ–ø–ª–æ—è

### –®–∞–≥ 1: –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ

```bash
# SSH –Ω–∞ —Å–µ—Ä–≤–µ—Ä
ssh your-server

# –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é
scp db/migrations/205_count_valid_group_participants_rpc.sql user@server:/path/

# –ü—Ä–∏–º–µ–Ω–∏—Ç—å —á–µ—Ä–µ–∑ psql
psql -U orbo -d orbo -f /path/205_count_valid_group_participants_rpc.sql
```

**–ò–ª–∏ —á–µ—Ä–µ–∑ Supabase Dashboard:**
1. –û—Ç–∫—Ä—ã—Ç—å SQL Editor
2. –í—Å—Ç–∞–≤–∏—Ç—å —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ `db/migrations/205_count_valid_group_participants_rpc.sql`
3. –ó–∞–ø—É—Å—Ç–∏—Ç—å

### –®–∞–≥ 2: –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ

```bash
docker-compose restart app
# –∏–ª–∏
pm2 restart orbo
```

### –®–∞–≥ 3: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏

```bash
docker-compose logs -f app | grep -i "channel\|participant"
```

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∫–∞–Ω–∞–ª–æ–≤

**URL:** [https://my.orbo.ru/p/a3e8bc8f-8171-472c-a955-2f7878aed6f1/dashboard](https://my.orbo.ru/p/a3e8bc8f-8171-472c-a955-2f7878aed6f1/dashboard)

**–û–∂–∏–¥–∞–µ—Ç—Å—è:**
- ‚úÖ –ö–∞–Ω–∞–ª—ã –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –≤ –ª–µ–≤–æ–º –º–µ–Ω—é (—Ä–∞–∑–¥–µ–ª "–ì—Ä—É–ø–ø—ã")
- ‚úÖ –ü—Ä–∏ –∫–ª–∏–∫–µ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –∫–∞–Ω–∞–ª–∞

### 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥—Å—á–µ—Ç–∞ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ (3 –≥—Ä—É–ø–ø—ã)

–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å–∫—Ä–∏–ø—Ç `scripts/debug_groups_channels.sql` –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–∞–Ω–Ω—ã—Ö –≤ –ë–î:

```bash
psql -U orbo -d orbo -f scripts/debug_groups_channels.sql > debug_output.txt
```

**–ì—Ä—É–ø–ø–∞ 1:** `-1003485407311`
- **URL:** [https://my.orbo.ru/p/.../telegram/groups/-1003485407311](https://my.orbo.ru/p/a3e8bc8f-8171-472c-a955-2f7878aed6f1/telegram/groups/-1003485407311)
- **–û–∂–∏–¥–∞–µ—Ç—Å—è:** 2 —É—á–∞—Å—Ç–Ω–∏–∫–∞ (@Belyaev_Aleksey, @timgorshkov)

**–ì—Ä—É–ø–ø–∞ 2:** `-1002994446785`
- **URL:** [https://my.orbo.ru/p/.../telegram/groups/-1002994446785](https://my.orbo.ru/p/a3e8bc8f-8171-472c-a955-2f7878aed6f1/telegram/groups/-1002994446785)
- **–û–∂–∏–¥–∞–µ—Ç—Å—è:** 2 —É—á–∞—Å—Ç–Ω–∏–∫–∞ (@timgorshkov, –¢–∏–º—É—Ä –ì–æ–ª–∏—Ü—ã–Ω)

**–ì—Ä—É–ø–ø–∞ 3:** `-1003401096638` (Discussion Group)
- **URL:** [https://my.orbo.ru/p/.../telegram/groups/-1003401096638](https://my.orbo.ru/p/a3e8bc8f-8171-472c-a955-2f7878aed6f1/telegram/groups/-1003401096638)
- **–û–∂–∏–¥–∞–µ—Ç—Å—è:** 1-2 —É—á–∞—Å—Ç–Ω–∏–∫–∞ (–±–µ–∑ —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –∞–∫–∫–∞—É–Ω—Ç–æ–≤)
- **–°–∏—Å—Ç–µ–º–Ω—ã–µ –∞–∫–∫–∞—É–Ω—Ç—ã –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω—ã:**
  - ‚ùå Telegram (777000)
  - ‚ùå ID: 136817688 (@Channel_Bot)

### 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ "–¢–æ–ø-—É—á–∞—Å—Ç–Ω–∏–∫–æ–≤"

**–ì–¥–µ:** –ù–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –≥—Ä—É–ø–ø—ã (—Ä–∞–∑–¥–µ–ª "–õ–∏–¥–µ—Ä—ã")

**–û–∂–∏–¥–∞–µ—Ç—Å—è:**
- ‚úÖ –ù–µ—Ç —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ —Å –∏–º–µ–Ω–µ–º "Telegram"
- ‚úÖ –ù–µ—Ç —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ —Å ID 777000, 136817688, 1087968824

---

## üîç –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞

### –ï—Å–ª–∏ –∫–∞–Ω–∞–ª—ã –Ω–µ –ø–æ—è–≤–∏–ª–∏—Å—å:

1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ –∑–∞–≥—Ä—É–∑–∫–∏:
```bash
docker-compose logs app | grep "Loaded telegram channels"
```

2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–∞–ª–∏—á–∏–µ –∫–∞–Ω–∞–ª–æ–≤ –≤ –ë–î:
```sql
SELECT tc.id, tc.title, tc.tg_chat_id, otc.org_id
FROM telegram_channels tc
JOIN org_telegram_channels otc ON otc.channel_id = tc.id
WHERE otc.org_id = 'a3e8bc8f-8171-472c-a955-2f7878aed6f1'::uuid;
```

3. –ï—Å–ª–∏ –∫–∞–Ω–∞–ª–æ–≤ –Ω–µ—Ç - –¥–æ–±–∞–≤–∏—Ç—å –∑–∞–Ω–æ–≤–æ —á–µ—Ä–µ–∑ UI

### –ï—Å–ª–∏ —á–∏—Å–ª–æ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –≤—Å—ë –µ—â—ë –Ω–µ–≤–µ—Ä–Ω–æ–µ:

1. –ó–∞–ø—É—Å—Ç–∏—Ç—å RPC —Ñ—É–Ω–∫—Ü–∏—é –≤—Ä—É—á–Ω—É—é:
```sql
SELECT public.count_valid_group_participants(-1003485407311, 'a3e8bc8f-8171-472c-a955-2f7878aed6f1'::uuid);
```

2. –°—Ä–∞–≤–Ω–∏—Ç—å —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–º debug —Å–∫—Ä–∏–ø—Ç–∞

3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –≤ `participant_groups`:
```sql
SELECT pg.*, p.username, p.source, p.participant_status, p.merged_into
FROM participant_groups pg
JOIN participants p ON p.id = pg.participant_id
WHERE pg.tg_group_id = -1003485407311;
```

---

## üìù –ó–∞–º–µ—Ç–∫–∏

### –ü–æ—á–µ–º—É RPC –≤–º–µ—Å—Ç–æ query builder?

**–ü—Ä–æ–±–ª–µ–º—ã —Å query builder:**
- Nested JOINs —á–µ—Ä–µ–∑ `.inner` –∏–Ω–æ–≥–¥–∞ —Ä–∞–±–æ—Ç–∞—é—Ç –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- –§–∏–ª—å—Ç—Ä—ã –≤ —Å–≤—è–∑–∞–Ω–Ω—ã—Ö —Ç–∞–±–ª–∏—Ü–∞—Ö –º–æ–≥—É—Ç –∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è
- –°–ª–æ–∂–Ω–æ –æ—Ç–ª–∞–∂–∏–≤–∞—Ç—å

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ RPC:**
- –ü—Ä—è–º–æ–π SQL –≤ PostgreSQL (–ø—Ä–æ–≤–µ—Ä–µ–Ω–æ –∏ –Ω–∞–¥–µ–∂–Ω–æ)
- –õ–µ–≥–∫–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –æ—Ç–¥–µ–ª—å–Ω–æ
- –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –≤—ã—à–µ
- –õ–æ–≥–∏–∫–∞ –≤ –æ–¥–Ω–æ–º –º–µ—Å—Ç–µ

### –°–∏—Å—Ç–µ–º–Ω—ã–µ –∞–∫–∫–∞—É–Ω—Ç—ã

**–ü–æ–ª–Ω—ã–π —Å–ø–∏—Å–æ–∫:**
- `777000` - Telegram Service Notifications (—Å–∏—Å—Ç–µ–º–Ω—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è)
- `136817688` - @Channel_Bot (—Å–≤—è–∑—å –∫–∞–Ω–∞–ª–æ–≤ –∏ –≥—Ä—É–ø–ø)
- `1087968824` - Group Anonymous Bot (–∞–Ω–æ–Ω–∏–º–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è)

**–ì–¥–µ —Ñ–∏–ª—å—Ç—Ä—É—é—Ç—Å—è:**
1. ‚úÖ Top Contributors API (`/api/analytics/[orgId]/contributors`)
2. ‚è∏Ô∏è TODO: –°–ø–∏—Å–∫–∏ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –≥—Ä—É–ø–ø (—Ç—Ä–µ–±—É–µ—Ç –æ—Ç–¥–µ–ª—å–Ω–æ–≥–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è)
3. ‚è∏Ô∏è TODO: Channel subscribers lists

---

## ‚ùì –í–æ–ø—Ä–æ—Å—ã –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

–ü–æ—Å–ª–µ –¥–µ–ø–ª–æ—è –ø—Ä–æ–≤–µ—Ä—å—Ç–µ:

1. **–ö–∞–Ω–∞–ª—ã:** –û—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –ª–∏ –∫–∞–Ω–∞–ª—ã –≤ –ª–µ–≤–æ–º –º–µ–Ω—é?
2. **–ì—Ä—É–ø–ø–∞ 1 (-1003485407311):** –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç 2 —É—á–∞—Å—Ç–Ω–∏–∫–∞?
3. **–ì—Ä—É–ø–ø–∞ 2 (-1002994446785):** –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç 2 —É—á–∞—Å—Ç–Ω–∏–∫–∞?
4. **–ì—Ä—É–ø–ø–∞ 3 (-1003401096638):** –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç 1-2 —É—á–∞—Å—Ç–Ω–∏–∫–∞ (–±–µ–∑ "Telegram" –∏ "ID: 136817688")?
5. **–¢–æ–ø-—É—á–∞—Å—Ç–Ω–∏–∫–∏:** –ù–µ—Ç —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –∞–∫–∫–∞—É–Ω—Ç–æ–≤?

**–ï—Å–ª–∏ –≤—Å—ë –û–ö ‚Üí** –ó–∞–∫—Ä—ã–≤–∞–µ–º –∑–∞–¥–∞—á—É!  
**–ï—Å–ª–∏ –µ—Å—Ç—å –ø—Ä–æ–±–ª–µ–º—ã ‚Üí** –ó–∞–ø—É—Å—Ç–∏—Ç–µ `scripts/debug_groups_channels.sql` –∏ –ø—Ä–∏—à–ª–∏—Ç–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã.
