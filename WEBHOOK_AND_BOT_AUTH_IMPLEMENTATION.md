# –†–µ–∞–ª–∏–∑–∞—Ü–∏—è —Å—Ç–∞–±–∏–ª–∏–∑–∞—Ü–∏–∏ Webhook –∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ –±–æ—Ç–∞

## –î–∞—Ç–∞: 13.10.2025

## –û–±–∑–æ—Ä

–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã –¥–≤–µ –≤–∞–∂–Ω—ã–µ –∑–∞–¥–∞—á–∏:
1. ‚úÖ **–°—Ç–∞–±–∏–ª–∏–∑–∞—Ü–∏—è Telegram Webhook** (–†–µ—à–µ–Ω–∏–µ 1 + 2)
2. ‚úÖ **–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ Telegram –±–æ—Ç–∞** (–∑–∞–º–µ–Ω–∞ Telegram Login Widget)

---

## –ß–∞—Å—Ç—å 1: –°—Ç–∞–±–∏–ª–∏–∑–∞—Ü–∏—è Telegram Webhook

### –ü—Ä–æ–±–ª–µ–º–∞
Webhook –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏ –æ—Ç–≤–∞–ª–∏–≤–∞–ª—Å—è, —Ç—Ä–µ–±–æ–≤–∞–ª–∞—Å—å —Ä—É—á–Ω–∞—è –ø–µ—Ä–µ—É—Å—Ç–∞–Ω–æ–≤–∫–∞ –∫–æ–º–∞–Ω–¥–æ–π `setWebhook`.

### –†–µ—à–µ–Ω–∏–µ 1: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ (Cron Job)

#### –°–æ–∑–¥–∞–Ω endpoint –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ webhook
**–§–∞–π–ª:** `app/api/cron/check-webhook/route.ts`

**–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å:**
- –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Å—Ç–∞—Ç—É—Å webhook –∫–∞–∂–¥—ã–µ 30 –º–∏–Ω—É—Ç
- –°—Ä–∞–≤–Ω–∏–≤–∞–µ—Ç —Ç–µ–∫—É—â–∏–π URL —Å –æ–∂–∏–¥–∞–µ–º—ã–º
- –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–∞–ª–∏—á–∏–µ –æ—à–∏–±–æ–∫
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç webhook –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏

**–ö–æ–¥:**
```typescript
export async function GET(request: NextRequest) {
  // 1. –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ webhook
  const webhookInfo = await fetch(
    `https://api.telegram.org/bot${botToken}/getWebhookInfo`
  )
  
  // 2. –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω—É–∂–Ω–æ –ª–∏ –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—Ç—å
  const needsRestore = 
    currentWebhook.url !== webhookUrl || // URL –Ω–µ —Å–æ–≤–ø–∞–¥–∞–µ—Ç
    currentWebhook.last_error_date // –ï—Å—Ç—å –æ—à–∏–±–∫–∏

  // 3. –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º webhook
  if (needsRestore) {
    await fetch(
      `https://api.telegram.org/bot${botToken}/setWebhook`,
      {
        method: 'POST',
        body: JSON.stringify({ 
          url: webhookUrl,
          max_connections: 40
        })
      }
    )
  }
}
```

#### –î–æ–±–∞–≤–ª–µ–Ω cron job –≤ Vercel
**–§–∞–π–ª:** `vercel.json`

```json
{
  "crons": [
    {
      "path": "/api/cron/check-webhook",
      "schedule": "*/30 * * * *"  // –ö–∞–∂–¥—ã–µ 30 –º–∏–Ω—É—Ç
    }
  ]
}
```

### –†–µ—à–µ–Ω–∏–µ 2: –£–ª—É—á—à–µ–Ω–Ω—ã–π webhook handler

**–§–∞–π–ª:** `app/api/telegram/webhook/route.ts`

**–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è:**
- ‚úÖ –ú–≥–Ω–æ–≤–µ–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç 200 OK –¥–ª—è Telegram
- ‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤ —Ñ–æ–Ω–æ–≤–æ–º —Ä–µ–∂–∏–º–µ
- ‚úÖ –£–º–µ–Ω—å—à–µ–Ω–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ª–æ–≥–æ–≤
- ‚úÖ –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ timeout

**–ö–æ–¥:**
```typescript
export async function POST(req: NextRequest) {
  try {
    const body = await req.json()
    
    // ‚úÖ –ó–∞–ø—É—Å–∫–∞–µ–º –æ–±—Ä–∞–±–æ—Ç–∫—É –≤ —Ñ–æ–Ω–µ, –Ω–µ –¥–æ–∂–∏–¥–∞—è—Å—å –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
    processWebhookInBackground(body).catch(error => {
      console.error('[Webhook] Background processing error:', error)
    })
    
    // ‚úÖ –°—Ä–∞–∑—É –≤–æ–∑–≤—Ä–∞—â–∞–µ–º —É—Å–ø–µ—à–Ω—ã–π –æ—Ç–≤–µ—Ç Telegram
    return NextResponse.json({ ok: true })
  } catch (error) {
    // –í—Å–µ–≥–¥–∞ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º —É—Å–ø–µ—à–Ω—ã–π –æ—Ç–≤–µ—Ç
    return NextResponse.json({ ok: true });
  }
}

async function processWebhookInBackground(body: any) {
  // –í—Å—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –∑–¥–µ—Å—å
  // - –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ/–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≥—Ä—É–ø–ø—ã
  // - –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–±—ã—Ç–∏–π —á–µ—Ä–µ–∑ eventProcessingService
  // - –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥ –±–æ—Ç–∞
}
```

### –†–µ–∑—É–ª—å—Ç–∞—Ç
- ‚úÖ Webhook –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∫–∞–∂–¥—ã–µ 30 –º–∏–Ω—É—Ç
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–∏ —Å–±–æ—è—Ö
- ‚úÖ –ë—ã—Å—Ç—Ä—ã–π –æ—Ç–≤–µ—Ç Telegram (< 100ms)
- ‚úÖ –£–º–µ–Ω—å—à–µ–Ω–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ timeout –æ—à–∏–±–æ–∫

---

## –ß–∞—Å—Ç—å 2: –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ Telegram –±–æ—Ç–∞

### –ü—Ä–æ–±–ª–µ–º–∞
Telegram Login Widget —Ä–∞–±–æ—Ç–∞–ª –Ω–µ—Å—Ç–∞–±–∏–ª—å–Ω–æ:
- ‚ùå –ó–∞–ø—Ä–æ—Å —Ç–µ–ª–µ—Ñ–æ–Ω–∞
- ‚ùå –ö–æ–¥ –Ω–µ –ø—Ä–∏—Ö–æ–¥–∏–ª
- ‚ùå –ü–ª–æ—Ö–æ–π UX –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö

### –†–µ—à–µ–Ω–∏–µ: –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ –±–æ—Ç–∞ —Å –æ–¥–Ω–æ—Ä–∞–∑–æ–≤—ã–º –∫–æ–¥–æ–º

#### –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

```
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç —Å—Ç—Ä–∞–Ω–∏—Ü—É —Å–æ–±—ã—Ç–∏—è
   ‚Üì
2. –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è –æ–¥–Ω–æ—Ä–∞–∑–æ–≤—ã–π –∫–æ–¥ (6 —Å–∏–º–≤–æ–ª–æ–≤ hex)
   ‚Üì
3. –û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è QR-–∫–æ–¥ + –∫–Ω–æ–ø–∫–∞ "–û—Ç–∫—Ä—ã—Ç—å –±–æ—Ç–∞"
   ‚Üì
4. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç /start CODE –±–æ—Ç—É
   ‚Üì
5. –ë–æ—Ç –≤–µ—Ä–∏—Ñ–∏—Ü–∏—Ä—É–µ—Ç –∫–æ–¥ –∏ —Å–æ–∑–¥–∞–µ—Ç —Å–µ—Å—Å–∏—é
   ‚Üì
6. –ë–æ—Ç –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å—Å—ã–ª–∫—É –¥–ª—è –≤—Ö–æ–¥–∞
   ‚Üì
7. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç –ø–æ —Å—Å—ã–ª–∫–µ –∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∞–≤—Ç–æ—Ä–∏–∑—É–µ—Ç—Å—è
```

### –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

#### 1. SQL –º–∏–≥—Ä–∞—Ü–∏—è
**–§–∞–π–ª:** `db/migrations/33_telegram_auth_codes.sql`

**–¢–∞–±–ª–∏—Ü–∞:** `telegram_auth_codes`
```sql
CREATE TABLE telegram_auth_codes (
  id UUID PRIMARY KEY,
  code VARCHAR(10) UNIQUE NOT NULL,
  org_id UUID REFERENCES organizations(id),
  event_id UUID REFERENCES events(id),
  redirect_url TEXT,
  is_used BOOLEAN DEFAULT FALSE,
  telegram_user_id BIGINT,
  expires_at TIMESTAMPTZ NOT NULL,
  created_at TIMESTAMPTZ DEFAULT NOW()
);
```

**–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**
- –ö–æ–¥—ã –∏—Å—Ç–µ–∫–∞—é—Ç —á–µ—Ä–µ–∑ 10 –º–∏–Ω—É—Ç
- –û–¥–Ω–æ—Ä–∞–∑–æ–≤—ã–µ (is_used)
- –ü—Ä–∏–≤—è–∑–∫–∞ –∫ org_id –∏–ª–∏ event_id
- –§—É–Ω–∫—Ü–∏—è –æ—á–∏—Å—Ç–∫–∏ –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã—Ö –∫–æ–¥–æ–≤

#### 2. API endpoint –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∫–æ–¥–∞
**–§–∞–π–ª:** `app/api/auth/telegram-code/generate/route.ts`

**POST /api/auth/telegram-code/generate**
```typescript
// –ó–∞–ø—Ä–æ—Å
{
  "orgId": "uuid",      // –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ
  "eventId": "uuid",    // –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ
  "redirectUrl": "/path" // –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ
}

// –û—Ç–≤–µ—Ç
{
  "code": "A3F7B2",
  "botUsername": "your_bot",
  "deepLink": "https://t.me/your_bot?start=A3F7B2",
  "qrUrl": "https://chart.googleapis.com/chart?cht=qr&...",
  "expiresAt": "2025-10-13T12:30:00Z",
  "expiresInSeconds": 600
}
```

#### 3. API endpoint –¥–ª—è –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏ –∫–æ–¥–∞
**–§–∞–π–ª:** `app/api/auth/telegram-code/verify/route.ts`

**POST /api/auth/telegram-code/verify**
```typescript
// –ó–∞–ø—Ä–æ—Å (–æ—Ç –±–æ—Ç–∞)
{
  "code": "A3F7B2",
  "telegramUserId": 123456789,
  "telegramUsername": "username",
  "firstName": "John",
  "lastName": "Doe"
}

// –û—Ç–≤–µ—Ç
{
  "success": true,
  "sessionUrl": "https://app.com/auth/...",
  "redirectUrl": "/app/org/...",
  "userId": "uuid",
  "orgId": "uuid"
}
```

**–õ–æ–≥–∏–∫–∞:**
1. ‚úÖ –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –∫–æ–¥ –∏ —Å—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è
2. ‚úÖ –ü–æ–º–µ—á–∞–µ—Ç –∫–æ–¥ –∫–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã–π
3. ‚úÖ –ù–∞—Ö–æ–¥–∏—Ç/—Å–æ–∑–¥–∞–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ Telegram ID
4. ‚úÖ –°–æ–∑–¥–∞–µ—Ç/–æ–±–Ω–æ–≤–ª—è–µ—Ç participant –∏ membership
5. ‚úÖ –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç –Ω–∞ —Å–æ–±—ã—Ç–∏–µ (–µ—Å–ª–∏ –∫–æ–¥ –¥–ª—è —Å–æ–±—ã—Ç–∏—è)
6. ‚úÖ –°–æ–∑–¥–∞–µ—Ç magic link –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
7. ‚úÖ –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å—Å—ã–ª–∫—É –¥–ª—è –≤—Ö–æ–¥–∞

#### 4. –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥—ã /start CODE –≤ –±–æ—Ç–µ
**–§–∞–π–ª:** `app/api/telegram/webhook/route.ts`

**–î–æ–±–∞–≤–ª–µ–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞:**
```typescript
async function handleBotCommand(message: any) {
  // ‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ –∫–æ–¥: /start CODE
  if (command === '/start' && text.split(' ').length > 1) {
    const code = text.split(' ')[1].trim().toUpperCase();
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–æ—Ä–º–∞—Ç –∫–æ–¥–∞ (6 hex —Å–∏–º–≤–æ–ª–æ–≤)
    if (/^[0-9A-F]{6}$/.test(code)) {
      // –í—ã–∑—ã–≤–∞–µ–º API –¥–ª—è –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏
      const verifyResponse = await fetch('.../api/auth/telegram-code/verify', {
        method: 'POST',
        body: JSON.stringify({
          code,
          telegramUserId: from.id,
          telegramUsername: from.username,
          firstName: from.first_name,
          lastName: from.last_name
        })
      });

      if (verifyResponse.ok) {
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å—Å—ã–ª–∫—É –¥–ª—è –≤—Ö–æ–¥–∞
        await telegramService.sendMessage(
          chatId,
          `‚úÖ –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞!\n\n–û—Ç–∫—Ä–æ–π—Ç–µ —ç—Ç—É —Å—Å—ã–ª–∫—É:\n${sessionUrl}`
        );
      } else {
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ
        await telegramService.sendMessage(
          chatId,
          '‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π –∏–ª–∏ –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–π –∫–æ–¥'
        );
      }
    }
  }
}
```

#### 5. UI –∫–æ–º–ø–æ–Ω–µ–Ω—Ç
**–§–∞–π–ª:** `components/auth/telegram-bot-auth.tsx`

**–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å:**
- ‚úÖ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–æ–¥–∞ –ø—Ä–∏ –º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏
- ‚úÖ –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ QR-–∫–æ–¥–∞
- ‚úÖ –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∫–æ–¥–∞ –¥–ª—è —Ä—É—á–Ω–æ–≥–æ –≤–≤–æ–¥–∞
- ‚úÖ –ö–Ω–æ–ø–∫–∞ "–û—Ç–∫—Ä—ã—Ç—å –±–æ—Ç–∞" (deep link)
- ‚úÖ –¢–∞–π–º–µ—Ä –æ–±—Ä–∞—Ç–Ω–æ–≥–æ –æ—Ç—Å—á–µ—Ç–∞ (10 –º–∏–Ω—É—Ç)
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–∏ –∏—Å—Ç–µ—á–µ–Ω–∏–∏
- ‚úÖ –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**
```tsx
<TelegramBotAuth
  orgId="uuid"
  eventId="uuid"
  redirectUrl="/app/org/..."
/>
```

#### 6. –ó–∞–º–µ–Ω–∞ —Å—Ç–∞—Ä–æ–≥–æ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞
**–§–∞–π–ª:** `components/events/access-denied-with-auth.tsx`

**–ë—ã–ª–æ:**
```tsx
<TelegramLogin
  botUsername={botUsername}
  onAuth={handleTelegramAuth}
  buttonSize="large"
/>
```

**–°—Ç–∞–ª–æ:**
```tsx
<TelegramBotAuth
  orgId={orgId}
  eventId={eventId}
  redirectUrl={`/p/${orgId}/events/${eventId}`}
/>
```

### –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –Ω–æ–≤–æ–≥–æ –º–µ—Ç–æ–¥–∞

#### ‚úÖ –ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å
- –ù–µ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç Telegram OAuth
- –ü–æ–ª–Ω—ã–π –∫–æ–Ω—Ç—Ä–æ–ª—å –Ω–∞–¥ –ø—Ä–æ—Ü–µ—Å—Å–æ–º
- –ù–µ —Ç—Ä–µ–±—É–µ—Ç —Ç–µ–ª–µ—Ñ–æ–Ω–∞/SMS

#### ‚úÖ UX
- –ü—Ä–æ—Å—Ç–æ–π –∏ –ø–æ–Ω—è—Ç–Ω—ã–π –ø—Ä–æ—Ü–µ—Å—Å
- QR-–∫–æ–¥ –¥–ª—è –¥–µ—Å–∫—Ç–æ–ø–∞
- –ü—Ä—è–º–∞—è —Å—Å—ã–ª–∫–∞ –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö
- –ü—Ä–∏–≤—ã—á–Ω—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å (–∫–∞–∫ –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è –≤–ª–∞–¥–µ–ª—å—Ü–∞)

#### ‚úÖ –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å
- –û–¥–Ω–æ—Ä–∞–∑–æ–≤—ã–µ –∫–æ–¥—ã
- –°—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è 10 –º–∏–Ω—É—Ç
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–ª–∏–Ω–Ω–æ—Å—Ç–∏ —á–µ—Ä–µ–∑ –±–æ—Ç–∞
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ IP –∏ User Agent

#### ‚úÖ –ö–æ–Ω–≤–µ—Ä—Å–∏—è
- –û–¥–∏–Ω –∫–ª–∏–∫ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π Telegram
- –ù–µ —Ç—Ä–µ–±—É–µ—Ç –≤–≤–æ–¥–∞ –¥–∞–Ω–Ω—ã—Ö
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è

---

## –ò–∑–º–µ–Ω–µ–Ω–Ω—ã–µ/—Å–æ–∑–¥–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

### Webhook —Å—Ç–∞–±–∏–ª–∏–∑–∞—Ü–∏—è
| –§–∞–π–ª | –°—Ç–∞—Ç—É—Å | –û–ø–∏—Å–∞–Ω–∏–µ |
|------|--------|----------|
| `app/api/cron/check-webhook/route.ts` | ‚ûï –°–æ–∑–¥–∞–Ω | Endpoint –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ webhook |
| `vercel.json` | ‚úèÔ∏è –ò–∑–º–µ–Ω–µ–Ω | –î–æ–±–∞–≤–ª–µ–Ω cron job (–∫–∞–∂–¥—ã–µ 30 –º–∏–Ω—É—Ç) |
| `app/api/telegram/webhook/route.ts` | ‚úèÔ∏è –ò–∑–º–µ–Ω–µ–Ω | –ë—ã—Å—Ç—Ä—ã–π –æ—Ç–≤–µ—Ç + —Ñ–æ–Ω–æ–≤–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ |

### –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ –±–æ—Ç–∞
| –§–∞–π–ª | –°—Ç–∞—Ç—É—Å | –û–ø–∏—Å–∞–Ω–∏–µ |
|------|--------|----------|
| `db/migrations/33_telegram_auth_codes.sql` | ‚ûï –°–æ–∑–¥–∞–Ω | –¢–∞–±–ª–∏—Ü–∞ –¥–ª—è –æ–¥–Ω–æ—Ä–∞–∑–æ–≤—ã—Ö –∫–æ–¥–æ–≤ |
| `app/api/auth/telegram-code/generate/route.ts` | ‚ûï –°–æ–∑–¥–∞–Ω | –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–æ–¥–∞ |
| `app/api/auth/telegram-code/verify/route.ts` | ‚ûï –°–æ–∑–¥–∞–Ω | –í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è –∫–æ–¥–∞ (–¥–ª—è –±–æ—Ç–∞) |
| `app/api/telegram/webhook/route.ts` | ‚úèÔ∏è –ò–∑–º–µ–Ω–µ–Ω | –û–±—Ä–∞–±–æ—Ç–∫–∞ /start CODE |
| `components/auth/telegram-bot-auth.tsx` | ‚ûï –°–æ–∑–¥–∞–Ω | UI –∫–æ–º–ø–æ–Ω–µ–Ω—Ç —Å QR-–∫–æ–¥–æ–º |
| `components/events/access-denied-with-auth.tsx` | ‚úèÔ∏è –ò–∑–º–µ–Ω–µ–Ω | –ó–∞–º–µ–Ω–µ–Ω —Å—Ç–∞—Ä—ã–π widget |

---

## –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç

### –°—Ü–µ–Ω–∞—Ä–∏–π 1: –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –Ω–∞ —Å–æ–±—ã—Ç–∏–µ

1. **–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç –ø—É–±–ª–∏—á–Ω—É—é —Å—Å—ã–ª–∫—É —Å–æ–±—ã—Ç–∏—è**
   - URL: `/p/{org}/events/{id}`
   - –ï—Å–ª–∏ –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω –∏ –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞ ‚Üí –ø–æ–∫–∞–∑—ã–≤–∞–µ–º AccessDeniedWithAuth

2. **–û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏**
   - –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è –∫–æ–¥ (–Ω–∞–ø—Ä–∏–º–µ—Ä, `A3F7B2`)
   - –û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è QR-–∫–æ–¥
   - –ü–æ–∫–∞–∑–∞–Ω–∞ –∫–Ω–æ–ø–∫–∞ "–û—Ç–∫—Ä—ã—Ç—å @orbo_community_bot"

3. **–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã–±–∏—Ä–∞–µ—Ç —Å–ø–æ—Å–æ–± –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏**
   - –í–∞—Ä–∏–∞–Ω—Ç A: –°–∫–∞–Ω–∏—Ä—É–µ—Ç QR-–∫–æ–¥ –∫–∞–º–µ—Ä–æ–π
   - –í–∞—Ä–∏–∞–Ω—Ç B: –ù–∞–∂–∏–º–∞–µ—Ç –∫–Ω–æ–ø–∫—É "–û—Ç–∫—Ä—ã—Ç—å –±–æ—Ç–∞"
   - –û–±–∞ –≤–∞—Ä–∏–∞–Ω—Ç–∞ –æ—Ç–∫—Ä—ã–≤–∞—é—Ç –±–æ—Ç–∞ —Å –∫–æ–º–∞–Ω–¥–æ–π `/start A3F7B2`

4. **–ë–æ—Ç –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∫–æ–º–∞–Ω–¥—É**
   - –ò–∑–≤–ª–µ–∫–∞–µ—Ç –∫–æ–¥ –∏–∑ –∫–æ–º–∞–Ω–¥—ã
   - –í—ã–∑—ã–≤–∞–µ—Ç `/api/auth/telegram-code/verify`
   - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –∫–æ–¥ –≤ –±–∞–∑–µ

5. **–°–æ–∑–¥–∞–µ—Ç—Å—è —Å–µ—Å—Å–∏—è**
   - –ù–∞—Ö–æ–¥–∏—Ç—Å—è/—Å–æ–∑–¥–∞–µ—Ç—Å—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
   - –°–æ–∑–¥–∞–µ—Ç—Å—è participant –∏ membership
   - –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç—Å—è –Ω–∞ —Å–æ–±—ã—Ç–∏–µ (–µ—Å–ª–∏ –∫–æ–¥ –¥–ª—è —Å–æ–±—ã—Ç–∏—è)
   - –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è magic link

6. **–ë–æ—Ç –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å—Å—ã–ª–∫—É**
   ```
   ‚úÖ –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞!

   –û—Ç–∫—Ä–æ–π—Ç–µ —ç—Ç—É —Å—Å—ã–ª–∫—É –¥–ª—è –≤—Ö–æ–¥–∞ –≤ —Å–∏—Å—Ç–µ–º—É:
   https://app.com/auth/v1/verify?token=...

   üîí –°—Å—ã–ª–∫–∞ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–∞ 1 —á–∞—Å.
   ```

7. **–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç –ø–æ —Å—Å—ã–ª–∫–µ**
   - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è
   - –†–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É —Å–æ–±—ã—Ç–∏—è
   - –ü–æ–ª–Ω—ã–π –¥–æ—Å—Ç—É–ø

### –°—Ü–µ–Ω–∞—Ä–∏–π 2: –ò—Å—Ç–µ—á–µ–Ω–∏–µ –∫–æ–¥–∞

1. **–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª –∫–æ–¥ –∑–∞ 10 –º–∏–Ω—É—Ç**
   - –¢–∞–π–º–µ—Ä –æ–±—Ä–∞—Ç–Ω–æ–≥–æ –æ—Ç—Å—á–µ—Ç–∞ –¥–æ—Å—Ç–∏–≥–∞–µ—Ç 00:00
   - QR-–∫–æ–¥ —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –∑–∞—Ç–µ–º–Ω–µ–Ω–Ω—ã–º
   - –ü–æ–∫–∞–∑–∞–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ "–ö–æ–¥ –∏—Å—Ç–µ–∫"

2. **–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–¥–∞**
   - –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∏–º–∞–µ—Ç "–ü–æ–ª—É—á–∏—Ç—å –Ω–æ–≤—ã–π –∫–æ–¥"
   - –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è –Ω–æ–≤—ã–π –∫–æ–¥
   - –ü—Ä–æ—Ü–µ—Å—Å –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è –∑–∞–Ω–æ–≤–æ

---

## –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∏ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ

### 1. –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é
```bash
# –ó–∞–ø—É—Å—Ç–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Ç–∞–±–ª–∏—Ü—ã telegram_auth_codes
npm run db:migrate
```

### 2. –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
```env
# Telegram Bot Token (–¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω)
TELEGRAM_BOT_TOKEN=your_bot_token

# Telegram Bot Username (–¥–ª—è deep links)
NEXT_PUBLIC_TELEGRAM_BOT_USERNAME=your_bot_username

# Secret –¥–ª—è Cron Job (—Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —Å–ª—É—á–∞–π–Ω—É—é —Å—Ç—Ä–æ–∫—É)
CRON_SECRET=random_secret_string_here

# –û—Å—Ç–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ (–¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã)
NEXT_PUBLIC_APP_URL=https://your-app.com
NEXT_PUBLIC_SUPABASE_URL=...
SUPABASE_SERVICE_ROLE_KEY=...
```

### 3. –ù–∞—Å—Ç—Ä–æ–∏—Ç—å Vercel Cron
–ü–æ—Å–ª–µ –¥–µ–ø–ª–æ—è –Ω–∞ Vercel:
1. –û—Ç–∫—Ä–æ–π—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–æ–µ–∫—Ç–∞
2. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ "Cron Jobs"
3. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ cron job –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω
4. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ `CRON_SECRET` –≤ Environment Variables

### 4. –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å webhook
```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å webhook
curl https://api.telegram.org/bot<TOKEN>/getWebhookInfo

# –í—Ä—É—á–Ω—É—é –∑–∞–ø—É—Å—Ç–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É webhook (–ª–æ–∫–∞–ª—å–Ω–æ)
curl -H "Authorization: Bearer $CRON_SECRET" \
  http://localhost:3000/api/cron/check-webhook
```

### 5. –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é
1. –û—Ç–∫—Ä–æ–π—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É —Å–æ–±—ã—Ç–∏—è –±–µ–∑ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
2. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –∫–æ–º–ø–æ–Ω–µ–Ω—Ç TelegramBotAuth
3. –û—Ç—Å–∫–∞–Ω–∏—Ä—É–π—Ç–µ QR-–∫–æ–¥ –∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É
4. –û—Ç–ø—Ä–∞–≤—å—Ç–µ –∫–æ–¥ –±–æ—Ç—É
5. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –±–æ—Ç –ø—Ä–∏—Å–ª–∞–ª —Å—Å—ã–ª–∫—É –¥–ª—è –≤—Ö–æ–¥–∞
6. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –ø–æ —Å—Å—ã–ª–∫–µ –∏ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é

---

## –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –ª–æ–≥–∏

### –õ–æ–≥–∏ webhook –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
```
[Webhook Cron] Checking webhook status...
[Webhook Cron] Current webhook: { url: '...', pending_update_count: 0 }
[Webhook Cron] Webhook is healthy, no action needed
```

–∏–ª–∏

```
[Webhook Cron] Restoring webhook...
[Webhook Cron] ‚úÖ Webhook restored successfully
```

### –õ–æ–≥–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ –±–æ—Ç–∞
```
[Auth Code] Generated code A3F7B2 for org uuid, event uuid
[Bot Auth] Received auth code A3F7B2 from user 123456789
[Auth Code] Verifying code A3F7B2 for Telegram user 123456789
[Auth Code] ‚úÖ Code A3F7B2 verified successfully for user uuid
[Bot Auth] ‚úÖ User 123456789 authenticated successfully with code A3F7B2
```

---

## –°—Ç–∞—Ç—É—Å

‚úÖ **–í—Å–µ –∑–∞–¥–∞—á–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω—ã**  
‚úÖ **9 –∏–∑ 9 –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ**  
üìÖ **–î–∞—Ç–∞**: 13.10.2025  
üìä **–û—à–∏–±–æ–∫ –∫–æ–º–ø–∏–ª—è—Ü–∏–∏**: –ù–µ—Ç  
üìä **–û—à–∏–±–æ–∫ –ª–∏–Ω—Ç–µ—Ä–∞**: –ù–µ—Ç  
üéØ **–ì–æ—Ç–æ–≤–æ –∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é –∏ –¥–µ–ø–ª–æ—é**

---

## –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

### –ö—Ä–∞—Ç–∫–æ—Å—Ä–æ—á–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è
1. ‚è≥ –î–æ–±–∞–≤–∏—Ç—å rate limiting –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∫–æ–¥–æ–≤
2. ‚è≥ –î–æ–±–∞–≤–∏—Ç—å –º–µ—Ç—Ä–∏–∫–∏ –∏ –∞–Ω–∞–ª–∏—Ç–∏–∫—É –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
3. ‚è≥ –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å cron job –¥–ª—è –æ—á–∏—Å—Ç–∫–∏ –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã—Ö –∫–æ–¥–æ–≤

### –î–æ–ª–≥–æ—Å—Ä–æ—á–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è
1. ‚è≥ Queue-based –æ–±—Ä–∞–±–æ—Ç–∫–∞ webhook (Upstash QStash)
2. ‚è≥ Push-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –Ω–æ–≤—ã—Ö —Å–æ–±—ã—Ç–∏—è—Ö
3. ‚è≥ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –±–æ—Ç–æ–≤ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–π

---

**–í–µ—Ä—Å–∏—è**: 1.0  
**–ê–≤—Ç–æ—Ä**: AI Assistant  
**–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ**: 13.10.2025

