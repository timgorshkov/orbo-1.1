# –û—Ç–ª–∞–¥–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ –±–æ—Ç–∞

## –î–∞—Ç–∞: 13.10.2025

## –ü—Ä–æ–±–ª–µ–º–∞

–ë–æ—Ç –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ –∫–æ–¥—ã –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏:
- Webhook –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è (–≤–∏–¥–Ω–æ –≤ –ª–æ–≥–∞—Ö Vercel)
- –í –ë–î –∫–æ–¥ –Ω–µ –ø–æ–º–µ—á–∞–µ—Ç—Å—è `is_used=TRUE`
- `telegram_user_id` –Ω–µ –∑–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è
- –°—Å—ã–ª–∫–∞ –¥–ª—è –≤—Ö–æ–¥–∞ –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è
- –ß–µ—Ä–µ–∑ 11 –º–∏–Ω—É—Ç –ø—Ä–∏—Ö–æ–¥–∏—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ "–ö–æ–¥ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –∏—Å—Ç–µ–∫"

## –î–æ–±–∞–≤–ª–µ–Ω–æ –ø–æ–¥—Ä–æ–±–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

### 1. Webhook –æ–±—Ä–∞–±–æ—Ç–∫–∞ (`app/api/telegram/webhook/route.ts`)

#### –õ–æ–≥–∏ –ø–æ–ª—É—á–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è:
```
[Webhook] Received text message: { text, from, chat, chatType }
[Webhook] Is auth code? true/false
[Webhook] Pattern test result: true/false
```

#### –õ–æ–≥–∏ –ø—Ä–∏ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–∏ –∫–æ–¥–∞:
```
[Webhook] ‚úÖ Detected auth code directly: CODE
```

#### –õ–æ–≥–∏ –ø—Ä–∏ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–∏ –∫–æ–º–∞–Ω–¥—ã:
```
[Webhook] Detected command: /start
```

#### –õ–æ–≥–∏ –µ—Å–ª–∏ –Ω–µ –ø–æ–¥—Ö–æ–¥–∏—Ç:
```
[Webhook] Message does not match auth code or command pattern
```

### 2. –§—É–Ω–∫—Ü–∏—è handleAuthCode (`app/api/telegram/webhook/route.ts`)

#### –ù–∞—á–∞–ª–æ –æ–±—Ä–∞–±–æ—Ç–∫–∏:
```
[Bot Auth] ==================== START ====================
[Bot Auth] Processing auth code: CODE
[Bot Auth] User ID: 123456789
[Bot Auth] Chat ID: 987654321
[Bot Auth] Username: @username
[Bot Auth] API URL: https://your-app.com/api/auth/telegram-code/verify
```

#### –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏:
```
[Bot Auth] ‚ùå NEXT_PUBLIC_APP_URL is not set!  // –ï—Å–ª–∏ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω
```

#### –ó–∞–ø—Ä–æ—Å –∫ API:
```
[Bot Auth] Request body: { code, telegramUserId, ... }
[Bot Auth] Calling verify API...
[Bot Auth] Verify API response status: 200 OK
[Bot Auth] Verify response data: { success, sessionUrl, ... }
```

#### –†–µ–∑—É–ª—å—Ç–∞—Ç:
```
[Bot Auth] ‚úÖ User 123456789 authenticated successfully with code CODE
[Bot Auth] ==================== SUCCESS ====================
```

–∏–ª–∏

```
[Bot Auth] ‚ùå Sending error message: ...
[Bot Auth] ‚ùå Failed to verify code CODE: error
[Bot Auth] ==================== FAILED ====================
```

–∏–ª–∏

```
[Bot Auth] ‚ùå Exception in handleAuthCode: error
[Bot Auth] Error stack: ...
[Bot Auth] ==================== ERROR ====================
```

### 3. API –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏ (`app/api/auth/telegram-code/verify/route.ts`)

#### –ü–æ–ª—É—á–µ–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–∞:
```
[Verify API] ==================== RECEIVED REQUEST ====================
[Verify API] Request body: { code, telegramUserId, ... }
```

#### –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –ø–æ–ª–µ–π:
```
[Verify API] ‚ùå Missing required fields: { code: false, telegramUserId: false }
```

#### –®–∞–≥ 1: –ü–æ–∏—Å–∫ –∫–æ–¥–∞ –≤ –ë–î:
```
[Verify API] Step 1: Querying telegram_auth_codes for code=ABC123, is_used=false
[Verify API] ‚úÖ Code found: { id, org_id, event_id, expires_at, is_used }
```

–∏–ª–∏

```
[Verify API] ‚ùå Database error: ...
[Verify API] ‚ùå Code not found or already used
```

#### –®–∞–≥ 2: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ä–æ–∫–∞ –¥–µ–π—Å—Ç–≤–∏—è:
```
[Verify API] Step 2: Checking expiration - now: 2025-10-13T..., expires: 2025-10-13T...
[Verify API] ‚úÖ Code is valid, time left: 589 seconds
```

–∏–ª–∏

```
[Verify API] ‚ùå Code expired
```

#### –®–∞–≥ 3: –ü–æ–º–µ—Ç–∫–∞ –∫–æ–¥–∞ –∫–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω–æ–≥–æ:
```
[Verify API] Step 3: Marking code as used
[Verify API] ‚úÖ Code marked as used
```

–∏–ª–∏

```
[Verify API] ‚ùå Error updating code: ...
```

#### –§–∏–Ω–∞–ª—å–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:
```
[Verify API] ‚úÖ Code ABC123 verified successfully for user uuid
[Verify API] Session URL generated: https://...
[Verify API] ==================== SUCCESS ====================
```

–∏–ª–∏

```
[Verify API] ‚ùå Error verifying code: error
[Verify API] Error stack: ...
[Verify API] ==================== ERROR ====================
```

---

## –ß—Ç–æ —Å–º–æ—Ç—Ä–µ—Ç—å –≤ –ª–æ–≥–∞—Ö Vercel

### –°—Ü–µ–Ω–∞—Ä–∏–π 1: –ö–æ–¥ –Ω–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–µ—Ç—Å—è

–ï—Å–ª–∏ –≤ –ª–æ–≥–∞—Ö –ù–ï–¢ —Å—Ç—Ä–æ–∫–∏:
```
[Webhook] ‚úÖ Detected auth code directly: CODE
```

–ó–Ω–∞—á–∏—Ç:
- –ö–æ–¥ –Ω–µ –ø—Ä–æ—Ö–æ–¥–∏—Ç —Ä–µ–≥—É–ª—è—Ä–Ω–æ–µ –≤—ã—Ä–∞–∂–µ–Ω–∏–µ `/^[0-9A-F]{6}$/i`
- –í–æ–∑–º–æ–∂–Ω–æ, –≤ —Å–æ–æ–±—â–µ–Ω–∏–∏ –µ—Å—Ç—å –ª–∏—à–Ω–∏–µ —Å–∏–º–≤–æ–ª—ã (–ø—Ä–æ–±–µ–ª—ã, –ø–µ—Ä–µ–≤–æ–¥—ã —Å—Ç—Ä–æ–∫)
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≤—ã–≤–æ–¥ `[Webhook] Received text message: { text: "..." }`

### –°—Ü–µ–Ω–∞—Ä–∏–π 2: handleAuthCode –Ω–µ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è

–ï—Å–ª–∏ –µ—Å—Ç—å —Å—Ç—Ä–æ–∫–∞ `[Webhook] ‚úÖ Detected auth code directly:`, –Ω–æ –ù–ï–¢:
```
[Bot Auth] ==================== START ====================
```

–ó–Ω–∞—á–∏—Ç:
- –§—É–Ω–∫—Ü–∏—è `handleAuthCode` –ø–∞–¥–∞–µ—Ç –ø—Ä–∏ –≤—ã–∑–æ–≤–µ
- –ò–ª–∏ `body.message` –∏–º–µ–µ—Ç –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—É webhook payload

### –°—Ü–µ–Ω–∞—Ä–∏–π 3: NEXT_PUBLIC_APP_URL –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω

–ï—Å–ª–∏ –µ—Å—Ç—å —Å—Ç—Ä–æ–∫–∞:
```
[Bot Auth] ‚ùå NEXT_PUBLIC_APP_URL is not set!
```

–ó–Ω–∞—á–∏—Ç:
- –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è –æ–∫—Ä—É–∂–µ–Ω–∏—è `NEXT_PUBLIC_APP_URL` –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –≤ Vercel
- –î–æ–±–∞–≤—å—Ç–µ –µ—ë –≤ Environment Variables

### –°—Ü–µ–Ω–∞—Ä–∏–π 4: API –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏ –Ω–µ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è

–ï—Å–ª–∏ –µ—Å—Ç—å `[Bot Auth] Calling verify API...`, –Ω–æ –ù–ï–¢:
```
[Verify API] ==================== RECEIVED REQUEST ====================
```

–ó–Ω–∞—á–∏—Ç:
- `fetch` –ø–∞–¥–∞–µ—Ç —Å –æ—à–∏–±–∫–æ–π (network error, timeout)
- URL –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π
- API endpoint –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ `[Bot Auth] API URL: ...`

### –°—Ü–µ–Ω–∞—Ä–∏–π 5: API —Ä–∞–±–æ—Ç–∞–µ—Ç, –Ω–æ –∫–æ–¥ –Ω–µ –Ω–∞–π–¥–µ–Ω

–ï—Å–ª–∏ –µ—Å—Ç—å:
```
[Verify API] ‚ùå Code not found or already used
```

–ó–Ω–∞—á–∏—Ç:
- –ö–æ–¥ —É–∂–µ –±—ã–ª –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω (`is_used=TRUE`)
- –ö–æ–¥ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ –ë–î
- –ö–æ–¥ –Ω–µ —Å–æ–≤–ø–∞–¥–∞–µ—Ç (—Ä–µ–≥–∏—Å—Ç—Ä, –æ–ø–µ—á–∞—Ç–∫–∞)
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ç–∞–±–ª–∏—Ü—É `telegram_auth_codes` –≤ –ë–î

### –°—Ü–µ–Ω–∞—Ä–∏–π 6: –ö–æ–¥ –∏—Å—Ç–µ–∫

–ï—Å–ª–∏ –µ—Å—Ç—å:
```
[Verify API] ‚ùå Code expired
```

–ó–Ω–∞—á–∏—Ç:
- –ü—Ä–æ—à–ª–æ –±–æ–ª—å—à–µ 10 –º–∏–Ω—É—Ç —Å –º–æ–º–µ–Ω—Ç–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≤—Ä–µ–º—è: `now:` vs `expires:`
- –≠—Ç–æ –æ–±—ä—è—Å–Ω—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 11 –º–∏–Ω—É—Ç

---

## –ö–∞–∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å

### –®–∞–≥ 1: –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥
1. –û—Ç–∫—Ä–æ–π—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É —Å–æ–±—ã—Ç–∏—è –±–µ–∑ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
2. –î–æ–ª–∂–µ–Ω –ø–æ—è–≤–∏—Ç—å—Å—è –∫–æ–º–ø–æ–Ω–µ–Ω—Ç TelegramBotAuth
3. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ –∫–æ–¥ (–Ω–∞–ø—Ä–∏–º–µ—Ä, `A3F7B2`)

### –®–∞–≥ 2: –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–æ–¥ –±–æ—Ç—É
1. –û—Ç–∫—Ä–æ–π—Ç–µ –±–æ—Ç–∞ –≤ Telegram
2. –û—Ç–ø—Ä–∞–≤—å—Ç–µ –∫–æ–¥ **–æ–¥–Ω–∏–º —Å–æ–æ–±—â–µ–Ω–∏–µ–º** (–ø—Ä–æ—Å—Ç–æ `A3F7B2`, –±–µ–∑ `/start`)
3. –ñ–¥–∏—Ç–µ –æ—Ç–≤–µ—Ç–∞ (–¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –º–≥–Ω–æ–≤–µ–Ω–Ω—ã–º)

### –®–∞–≥ 3: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ Vercel
1. –û—Ç–∫—Ä–æ–π—Ç–µ Vercel Dashboard ‚Üí Logs ‚Üí Runtime Logs
2. –ù–∞–π–¥–∏—Ç–µ webhook –∑–∞–ø—Ä–æ—Å (–¥–æ–ª–∂–µ–Ω –±—ã—Ç—å timestamp —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ –æ—Ç–ø—Ä–∞–≤–∫–∏)
3. –†–∞–∑–≤–µ—Ä–Ω–∏—Ç–µ –ª–æ–≥–∏ –∏ –∏—â–∏—Ç–µ:
   - `[Webhook] Received text message:`
   - `[Webhook] ‚úÖ Detected auth code directly:`
   - `[Bot Auth] ==================== START ====================`
   - `[Bot Auth] Calling verify API...`
   - `[Verify API] ==================== RECEIVED REQUEST ====================`
   - `[Verify API] ‚úÖ Code marked as used`
   - `[Verify API] ==================== SUCCESS ====================`
   - `[Bot Auth] ==================== SUCCESS ====================`

### –®–∞–≥ 4: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ë–î
1. –û—Ç–∫—Ä–æ–π—Ç–µ Supabase ‚Üí Table Editor ‚Üí `telegram_auth_codes`
2. –ù–∞–π–¥–∏—Ç–µ —Å—Ç—Ä–æ–∫—É —Å –≤–∞—à–∏–º –∫–æ–¥–æ–º
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ:
   - `is_used` –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å `TRUE`
   - `telegram_user_id` –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∑–∞–ø–æ–ª–Ω–µ–Ω
   - `used_at` –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω

---

## –í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

### –ü—Ä–æ–±–ª–µ–º–∞ 1: `NEXT_PUBLIC_APP_URL` –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω
**–†–µ—à–µ–Ω–∏–µ:** –î–æ–±–∞–≤—å—Ç–µ –≤ Vercel Environment Variables:
```
NEXT_PUBLIC_APP_URL=https://app.orbo.ru
```

### –ü—Ä–æ–±–ª–µ–º–∞ 2: Webhook –ø—Ä–∏—Ö–æ–¥–∏—Ç —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π
**–ü—Ä–∏—á–∏–Ω–∞:** Telegram –º–æ–∂–µ—Ç –∑–∞–¥–µ—Ä–∂–∏–≤–∞—Ç—å webhook –µ—Å–ª–∏ endpoint –º–µ–¥–ª–µ–Ω–Ω–æ –æ—Ç–≤–µ—á–∞–µ—Ç.

**–†–µ—à–µ–Ω–∏–µ:** –£–∂–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ - webhook –æ—Ç–≤–µ—á–∞–µ—Ç 200 OK –º–≥–Ω–æ–≤–µ–Ω–Ω–æ, –æ–±—Ä–∞–±–æ—Ç–∫–∞ –≤ —Ñ–æ–Ω–µ.

### –ü—Ä–æ–±–ª–µ–º–∞ 3: –ö–æ–¥ –≤ —Å–æ–æ–±—â–µ–Ω–∏–∏ —Å –ª–∏—à–Ω–∏–º–∏ —Å–∏–º–≤–æ–ª–∞–º–∏
**–ü—Ä–∏–º–µ—Ä:** `"A3F7B2\n"` –∏–ª–∏ `" A3F7B2 "`

**–†–µ—à–µ–Ω–∏–µ:** –£–∂–µ –¥–æ–±–∞–≤–ª–µ–Ω `.trim()` –≤ –æ–±—Ä–∞–±–æ—Ç–∫—É.

### –ü—Ä–æ–±–ª–µ–º–∞ 4: Telegram –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∫–æ–¥ —Å lowercase
**–ü—Ä–∏–º–µ—Ä:** `a3f7b2` –≤–º–µ—Å—Ç–æ `A3F7B2`

**–†–µ—à–µ–Ω–∏–µ:** –†–µ–≥—É–ª—è—Ä–Ω–æ–µ –≤—ã—Ä–∞–∂–µ–Ω–∏–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Ñ–ª–∞–≥ `i` (case-insensitive) –∏ –∫–æ–¥ –ø—Ä–∏–≤–æ–¥–∏—Ç—Å—è –∫ uppercase: `.toUpperCase()`.

### –ü—Ä–æ–±–ª–µ–º–∞ 5: –ë–æ—Ç –Ω–µ –ø–æ–ª—É—á–∞–µ—Ç –ª–∏—á–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
**–ü—Ä–∏—á–∏–Ω–∞:** –ë–æ—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∑–∞–ø—É—â–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º.

**–†–µ—à–µ–Ω–∏–µ:** –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–æ–ª–∂–µ–Ω —Å–Ω–∞—á–∞–ª–∞ –Ω–∞–∂–∞—Ç—å "–û—Ç–∫—Ä—ã—Ç—å –±–æ—Ç–∞" –∏–ª–∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å `/start`.

---

## –ß—Ç–æ –¥–µ–ª–∞—Ç—å –¥–∞–ª—å—à–µ

1. **–û—Ç–ø—Ä–∞–≤—å—Ç–µ –Ω–æ–≤—ã–π –∫–æ–¥ –±–æ—Ç—É**
2. **–°—Ä–∞–∑—É –ø—Ä–æ–≤–µ—Ä—å—Ç–µ Vercel Logs**
3. **–ù–∞–π–¥–∏—Ç–µ —Å—Ç—Ä–æ–∫—É —Å –≤–∞—à–∏–º telegram user ID**
4. **–°–∫–æ–ø–∏—Ä—É–π—Ç–µ –≤—Å–µ –ª–æ–≥–∏ –æ—Ç `[Webhook] Received text message` –¥–æ `SUCCESS` –∏–ª–∏ `ERROR`**
5. **–û—Ç–ø—Ä–∞–≤—å—Ç–µ –ª–æ–≥–∏ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞**

–≠—Ç–æ –ø–æ–∑–≤–æ–ª–∏—Ç —Ç–æ—á–Ω–æ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å, –Ω–∞ –∫–∞–∫–æ–º —ç—Ç–∞–ø–µ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç —Å–±–æ–π.

---

## –°—Ç–∞—Ç—É—Å

‚úÖ **–î–æ–±–∞–≤–ª–µ–Ω–æ –ø–æ–¥—Ä–æ–±–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ**  
‚úÖ **–û—à–∏–±–æ–∫ –∫–æ–º–ø–∏–ª—è—Ü–∏–∏**: –ù–µ—Ç  
‚úÖ **–û—à–∏–±–æ–∫ –ª–∏–Ω—Ç–µ—Ä–∞**: –ù–µ—Ç  
üîç **–ì–æ—Ç–æ–≤–æ –∫ –æ—Ç–ª–∞–¥–∫–µ**

–°–ª–µ–¥—É—é—â–∏–π —à–∞–≥ - —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–º –ª–æ–≥–æ–≤.

---

**–í–µ—Ä—Å–∏—è**: 1.0  
**–ê–≤—Ç–æ—Ä**: AI Assistant  
**–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ**: 13.10.2025

