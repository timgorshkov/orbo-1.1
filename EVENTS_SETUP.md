# Настройка раздела "События"

## Обзор

Реализован полнофункциональный раздел управления событиями для клубов, сообществ и организаций.

## Основные возможности

### Для администраторов:
- ✅ Создание и редактирование событий (онлайн/офлайн)
- ✅ Управление регистрациями участников
- ✅ Ограничение количества мест
- ✅ Публичные и приватные события
- ✅ Платные и бесплатные события
- ✅ Отправка уведомлений в Telegram группы (ручная и автоматическая)
- ✅ Просмотр списка участников
- ✅ Экспорт в календарь (.ics файлы)

### Для участников:
- ✅ Просмотр событий организации
- ✅ Регистрация на события
- ✅ Отмена регистрации
- ✅ Добавление события в календарь
- ✅ Публичные страницы событий (доступны без авторизации)

### Автоматические уведомления:
- ✅ За 24 часа до события
- ✅ За 1 час до события
- ✅ Отправка во все подключенные Telegram группы

## Шаги по установке

### 1. Применить миграцию базы данных

Выполните SQL-скрипт в Supabase SQL Editor:

```bash
db/migrations/19_events.sql
```

Этот скрипт создаст:
- Таблицу `events` (события)
- Таблицу `event_registrations` (регистрации)
- Таблицу `event_telegram_notifications` (уведомления)
- Необходимые индексы и RLS политики
- Вспомогательные функции

### 2. Настроить переменные окружения

Добавьте в `.env.local`:

```bash
# Для автоматических уведомлений (необходимо для cron)
CRON_SECRET=your-random-secret-key-here

# URL приложения (для генерации ссылок в уведомлениях)
NEXT_PUBLIC_APP_URL=https://your-domain.com

# Telegram Bot Token (уже должен быть настроен)
TELEGRAM_BOT_TOKEN=your-bot-token-here
```

Для генерации `CRON_SECRET`:
```bash
node -e "console.log(require('crypto').randomBytes(32).toString('hex'))"
```

### 3. Настроить Vercel Cron (для продакшна)

Cron job уже настроен в `vercel.json`:

```json
{
  "path": "/api/cron/event-notifications",
  "schedule": "0 * * * *"
}
```

Это означает запуск каждый час для проверки и отправки уведомлений.

**Важно:** В настройках Vercel проекта добавьте переменную окружения:
- `CRON_SECRET` - тот же секрет, что и в `.env.local`

### 4. Для локальной разработки

Для тестирования автоматических уведомлений локально, можно вручную вызвать endpoint:

```bash
curl -H "Authorization: Bearer YOUR_CRON_SECRET" http://localhost:3000/api/cron/event-notifications
```

## Структура файлов

### API Routes
```
app/api/events/
  ├── route.ts                    # GET (список), POST (создание)
  ├── [id]/
  │   ├── route.ts               # GET, PUT, DELETE (конкретное событие)
  │   ├── register/route.ts      # POST, DELETE (регистрация/отмена)
  │   ├── ics/route.ts           # GET (экспорт в календарь)
  │   └── notify/route.ts        # POST (отправка уведомлений)
  └── ...

app/api/cron/
  └── event-notifications/route.ts # Автоматические уведомления
```

### Страницы
```
app/app/[org]/events/
  ├── page.tsx                    # Список событий (админы)
  ├── new/page.tsx               # Создание события
  └── [id]/page.tsx              # Детальная страница события

app/p/[org]/events/
  └── [id]/page.tsx              # Публичная страница события
```

### Компоненты
```
components/events/
  ├── events-list.tsx            # Список с фильтрами
  ├── event-form.tsx             # Форма создания/редактирования
  ├── event-detail.tsx           # Детальная карточка (для админов)
  └── public-event-detail.tsx    # Публичная карточка
```

## Использование

### Создание события

1. Перейдите в раздел "События" через боковое меню
2. Нажмите "Создать событие"
3. Заполните форму:
   - **Название** (обязательно)
   - **Описание**
   - **URL обложки** (изображение будет показано на карточке)
   - **Дата и время** (обязательно)
   - **Тип события**: онлайн или офлайн
   - **Место проведения**: ссылка для онлайн или адрес для офлайн
   - **Платность**: бесплатное или платное (с описанием оплаты)
   - **Ограничение участников**: оставьте пустым для неограниченного
   - **Статус**: черновик или опубликовано
   - **Видимость**: публичное (доступно всем) или для участников организации

4. Сохраните событие

### Отправка уведомлений

На странице события (для опубликованных событий):
1. Нажмите "Отправить в Telegram"
2. Выберите группы для отправки
3. Нажмите "Отправить"

Уведомление будет содержать:
- Название и описание события
- Дату и время
- Место проведения
- Ссылку на регистрацию

### Автоматические уведомления

Система автоматически отправит уведомления:
- **За 24 часа** до начала события (в интервале 23-25 часов)
- **За 1 час** до начала события (в интервале 1-2 часа)

Уведомления отправляются во **все подключенные Telegram группы** организации.

### Публичный доступ

Для публичных событий генерируется ссылка вида:
```
https://your-domain.com/p/{org-slug}/events/{event-id}
```

Эта страница доступна без авторизации, но для регистрации пользователь должен войти через Telegram.

### Регистрация участников

При регистрации через публичную страницу:
1. Пользователь авторизуется через Telegram
2. Система создает запись участника с источником "event"
3. Участник добавляется в общую базу участников организации

## Особенности реализации

### Проверка лимита мест
- При регистрации автоматически проверяется наличие свободных мест
- Если мест нет, регистрация блокируется
- На карточках событий показывается количество оставшихся мест

### .ics файлы
Генерируются с правильным форматом для:
- Google Calendar
- Apple Calendar
- Outlook
- Другие календарные приложения

Включают:
- Название и описание события
- Дату и время (с часовым поясом)
- Место проведения или ссылку
- Напоминания (за 1 час и за 1 день)

### Безопасность
- RLS политики для всех таблиц
- Только owner/admin могут создавать и редактировать события
- Автоматические уведомления защищены CRON_SECRET
- Публичные страницы доступны только для опубликованных публичных событий

## Тестирование

### Локальное тестирование
1. Создайте событие на завтра
2. Установите время начала через 25 часов
3. Вызовите cron endpoint вручную
4. Проверьте, что уведомление отправлено в Telegram группу

### Проверка регистрации
1. Опубликуйте событие как публичное
2. Откройте публичную ссылку в инкогнито режиме
3. Попробуйте зарегистрироваться
4. Проверьте вкладку "Участники" в админ панели

## Возможные проблемы и решения

### Уведомления не отправляются
- Проверьте `TELEGRAM_BOT_TOKEN` в переменных окружения
- Убедитесь, что бот добавлен в группу и является администратором
- Проверьте статус группы (`bot_status` должен быть `connected`)

### Cron job не запускается
- Убедитесь, что `CRON_SECRET` настроен в Vercel
- Проверьте логи Vercel в разделе "Deployments" > "Functions"
- Cron jobs работают только на продакшене, не в локальной разработке

### Публичная страница показывает ошибку
- Убедитесь, что событие имеет `status = 'published'` и `is_public = true`
- Проверьте, что миграция применена корректно
- Проверьте RLS политики в Supabase

## Будущие улучшения (опционально)

Потенциальные расширения функционала:
- [ ] Email уведомления участникам
- [ ] QR-коды для чек-ина на событии
- [ ] Повторяющиеся события (еженедельные встречи)
- [ ] Расписание внутри события (программа, спикеры)
- [ ] Разные тарифы участия (обычный/VIP)
- [ ] Интеграция с платежными системами
- [ ] Список ожидания при превышении лимита
- [ ] Модерация заявок на участие
- [ ] Отправка календарных приглашений по email
- [ ] Аналитика событий (конверсия, явка)

## Поддержка

При возникновении проблем проверьте:
1. Логи Supabase (Database > Logs)
2. Логи Vercel (Deployments > Functions)
3. Консоль браузера (Network tab)
4. Telegram Bot API логи (при проблемах с уведомлениями)

