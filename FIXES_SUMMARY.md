# Исправления от 10.10.2025

## Быстрая навигация
- [Проблема 1: Telegram webhook](#проблема-1-активность-из-telegram-групп-не-подтягивается)
- [Проблема 2: Таблица участников](#проблема-2-пропала-таблица-участников)
- [Проблема 3: Компиляция Button](#проблема-3-ошибка-компиляции-button)
- [Проблема 4: Пустая таблица участников](#проблема-4-пустая-таблица-участников)

---

## Проблема 1: Активность из Telegram групп не подтягивается

### Причина
Использование `@orbo_community_bot` для Login Widget **НЕ конфликтует** с webhook'ом для активности. Это разные механизмы:
- **Login Widget** - OAuth через браузер (авторизация)
- **Webhook** - получение обновлений из групп (активность)

### Решение
Скорее всего, webhook просто не настроен или неправильно настроен.

### Что сделано
✅ Создан подробный гайд: **`TELEGRAM_WEBHOOK_SETUP.md`**

Этот гайд включает:
1. Проверку статуса webhook
2. Установку webhook через curl/браузер
3. Проверку переменных окружения
4. Тестирование работы
5. Устранение типичных проблем
6. Проверочный чеклист

### Следующие шаги
1. Откройте `TELEGRAM_WEBHOOK_SETUP.md`
2. Выполните все шаги по порядку
3. Проверьте, что активность начала подтягиваться

---

## Проблема 2: Пропала таблица участников

### Причина
После рефакторинга интерфейса остался только вид "карточками", а табличное представление для админов было удалено.

### Решение
Добавлен переключатель между двумя видами:
- **Карточки** - для всех (участников и админов)
- **Таблица** - только для админов (CRM-стиль)

### Что сделано

#### 1. Создан `components/members/members-view.tsx`
- Компонент-обёртка с переключателем видов
- Кнопки "Карточки" и "Таблица" (таблица только для админов)
- Общий поиск для обоих видов
- Счётчик участников

#### 2. Создан `components/members/members-table.tsx`
- Табличное представление в CRM-стиле
- Колонки:
  - **Участник** (фото + имя + ID)
  - **Telegram** (@username с ссылкой)
  - **Email** (с ссылкой mailto)
  - **Статус** (цветной badge)
  - **Добавлен** (дата создания)
- Клик по строке открывает модальное окно профиля
- Адаптивное оформление

#### 3. Создан `components/ui/table.tsx`
- UI компонент таблицы (shadcn/ui стиль)
- Компоненты: `Table`, `TableHeader`, `TableBody`, `TableRow`, `TableHead`, `TableCell`
- Адаптивный overflow

#### 4. Обновлён `components/members/members-tabs.tsx`
- Заменён `MembersGrid` на `MembersView`
- Теперь в табе "Список" доступны оба вида

### Результат

#### Для всех пользователей:
- ✅ Вид "Карточками" с фото и основной информацией
- ✅ Поиск по имени, email, @username
- ✅ Клик по карточке → модальное окно с деталями

#### Для админов (дополнительно):
- ✅ Переключатель "Карточки / Таблица"
- ✅ Табличное представление с полной информацией
- ✅ Удобная сортировка и навигация (как в CRM)
- ✅ Все колонки с данными участников
- ✅ Цветовая индикация статусов

---

## Демонстрация

### Вид "Карточками" (все пользователи)
```
┌─────────────────────────────┐
│  Поиск...      [🔲] [📊]   │  ← кнопки переключения
├─────────────────────────────┤
│  ┌───┐  ┌───┐  ┌───┐       │
│  │👤 │  │👤 │  │👤 │       │  ← карточки с фото
│  └───┘  └───┘  └───┘       │
│  Имя 1  Имя 2  Имя 3       │
└─────────────────────────────┘
```

### Вид "Таблицей" (только админы)
```
┌──────────────────────────────────────────────────────────┐
│  Поиск...      [🔲] [📊]                                 │
├────────────┬──────────┬──────────┬────────┬─────────────┤
│ Участник   │ Telegram │ Email    │ Статус │ Добавлен    │
├────────────┼──────────┼──────────┼────────┼─────────────┤
│ 👤 Имя 1   │ @user1   │ email@   │ 🟢     │ 01.10.2025  │
│ 👤 Имя 2   │ @user2   │ email@   │ 🟢     │ 02.10.2025  │
└────────────┴──────────┴──────────┴────────┴─────────────┘
```

---

## Файлы

### Новые файлы:
- `components/members/members-view.tsx` - переключатель видов
- `components/members/members-table.tsx` - табличное представление
- `components/ui/table.tsx` - UI компонент таблицы
- `TELEGRAM_WEBHOOK_SETUP.md` - гайд по настройке webhook
- `FIXES_SUMMARY.md` - это резюме

### Изменённые файлы:
- `components/members/members-tabs.tsx` - использует `MembersView`

### Старые файлы (можно удалить):
- `components/members/members-grid.tsx` - заменён на `MembersView`

---

## Тестирование

### Для проблемы 1 (webhook):
1. Следуйте инструкциям в `TELEGRAM_WEBHOOK_SETUP.md`
2. Проверьте статус webhook через `/getWebhookInfo`
3. Отправьте сообщения в группу
4. Проверьте аналитику в админке

### Для проблемы 2 (таблица участников):
1. Зайдите как админ в `/app/[org]/members`
2. Переключите вид на "Таблица"
3. Проверьте отображение всех колонок
4. Кликните по строке → откроется модальное окно
5. Зайдите как обычный участник
6. Проверьте, что кнопка "Таблица" не отображается

---

## Деплой

```bash
git add .
git commit -m "fix: restore telegram activity webhook and add table view for members"
git push
```

После деплоя:
1. Настройте webhook по инструкции
2. Проверьте работу таблицы участников

---

---

## Проблема 4: Пустая таблица участников

### Причина
Страница `/app/[org]/members` использовала обычный Supabase клиент (`createClientServer()`), который блокировался политиками RLS. 

RLS политика для `participants` требует сложные JOIN'ы с `user_telegram_accounts`, `participant_groups`, и `telegram_groups`, что не всегда работает корректно.

### Решение
Использовать `createAdminServer()` для обхода RLS при загрузке участников.

### Что сделано

#### Обновлён `app/app/[org]/members/page.tsx`

**Изменения:**
```typescript
// Было:
const { data: participants } = await supabase
  .from('participants')
  .select('*')
  .eq('org_id', orgId)

// Стало:
const adminSupabase = createAdminServer()
const { data: participants } = await adminSupabase
  .from('participants')
  .select('*')
  .eq('org_id', orgId)
  .neq('participant_status', 'excluded')
  .order('full_name', { ascending: true, nullsFirst: false })

console.log(`Fetched ${participants?.length || 0} participants for org ${orgId}`)
```

**Улучшения:**
- ✅ Использование `createAdminServer()` для обхода RLS
- ✅ Явное исключение участников со статусом `'excluded'`
- ✅ Сортировка с `nullsFirst: false` (участники без имени в конце)
- ✅ Логирование количества загруженных участников
- ✅ Использование `adminSupabase` также для загрузки приглашений

**Безопасность:**
✅ Безопасно, так как проверка роли происходит через `getUserRoleInOrg()` перед загрузкой страницы.

### Результат
Теперь все участники организации (кроме исключённых) корректно отображаются как в виде карточек, так и в виде таблицы.

---

---

## Проблема 5: Профиль участника в модальном окне

### Причина
Карточки участников открывались во всплывающем модальном окне, что неудобно для детального просмотра и редактирования.

### Решение
Переделан весь UX профиля участника:
- Отдельная страница вместо модального окна
- Дизайн в стиле социальных сетей
- Интеграция характеристик в профиль
- Режимы просмотра/редактирования

### Что сделано

#### 1. Обновлена страница `/app/[org]/members/[participantId]/page.tsx`
- ✅ Добавлена проверка роли через `getUserRoleInOrg`
- ✅ Определение `canEdit` (админ или свой профиль)
- ✅ Передача пропсов для управления доступом
- ✅ Убран устаревший `AppShell`

#### 2. Переделан `ParticipantDetailTabs`
- ✅ Убрана вкладка "Характеристики"
- ✅ Вкладки "Активность" и "Дубликаты" - только для админов
- ✅ Условное отображение на основе `isAdmin` пропа

#### 3. Полностью переписан `ParticipantProfileCard`
**Дизайн в стиле соцсетей:**
- Цветной градиентный header
- Круглое фото профиля (на границе header/content)
- Карточки с иконками (Telegram, Email, Phone, Дата)
- Telegram username как активная ссылка `https://t.me/username`
- Email как `mailto:` ссылка
- Телефон как `tel:` ссылка

**Режим просмотра:**
- Стильное отображение всей информации
- Custom attributes (ключ: значение)
- Группы Telegram
- Заметки (если есть)

**Режим редактирования:**
- Кнопка "Редактировать" (только для админов и владельца профиля)
- Inline редактирование полей
- Управление custom attributes:
  - Редактирование значений
  - Удаление полей
  - Добавление новых через форму
- Кнопки "Сохранить" / "Отмена"

#### 4. Обновлены `MemberCard` и `MembersTable`
- ✅ Карточки теперь `<Link>` вместо `<button>`
- ✅ Таблица использует `router.push()` при клике по строке
- ✅ Навигация на `/app/[org]/members/[id]`
- ❌ Удалены callback'и `onClick` и `onRowClick`

#### 5. Обновлён `MembersView`
- ✅ Убрано модальное окно `MemberProfileModal`
- ✅ Убран state `selectedMember`
- ✅ Упрощена логика компонента

#### 6. Удалены устаревшие компоненты
- ❌ `participant-traits-card.tsx`
- ❌ `member-profile-modal.tsx`

### Права доступа

| Действие | Owner | Admin | Member | Guest |
|----------|-------|-------|--------|-------|
| Просмотр любого профиля | ✅ | ✅ | ✅ | ❌ |
| Редактирование любого профиля | ✅ | ✅ | ❌ | ❌ |
| Редактирование своего профиля | ✅ | ✅ | ✅ | ❌ |
| Вкладка "Активность" | ✅ | ✅ | ❌ | ❌ |
| Вкладка "Дубликаты" | ✅ | ✅ | ❌ | ❌ |

### Результат

**URL:** `/app/[org]/members/[participantId]`

**Особенности:**
- 📱 Современный дизайн как в соцсетях
- ✏️ Удобное inline редактирование
- 🔗 Активные ссылки на Telegram, Email, Phone
- 🏷️ Custom attributes с управлением
- 👥 Список Telegram групп
- 📝 Заметки
- 🔒 Контроль доступа на основе роли

**Документация:** `MEMBER_PROFILE_REDESIGN.md`

---

## Итоговый статус

| Проблема | Статус | Файлы |
|----------|--------|-------|
| 1. Telegram webhook | ✅ Гайд создан | `TELEGRAM_WEBHOOK_SETUP.md` |
| 2. Таблица участников | ✅ Реализовано | `members-view.tsx`, `members-table.tsx`, `ui/table.tsx` |
| 3. Компиляция Button | ✅ Исправлено | `ui/button.tsx` |
| 4. Пустая таблица | ✅ Исправлено | `app/[org]/members/page.tsx` |
| 5. **Профиль участника** | ✅ **Переделано** | См. `MEMBER_PROFILE_REDESIGN.md` |

**Статус:** ✅ Готово к деплою  
**Дата:** 10.10.2025

