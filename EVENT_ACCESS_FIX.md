# Исправление доступа к событиям

## Проблема

При переходе по ссылке на событие из Telegram группы пользователь получал ошибку:
> "Доступ ограничен. Это событие доступно только участникам организации."

Даже если пользователь был администратором организации.

## Причина

Старая логика в `/app/p/[org]/events/[id]/page.tsx` блокировала доступ ко **всем** приватным событиям (`is_public = false`), не проверяя, является ли пользователь участником организации.

```typescript
// ❌ Старый код
if (!event.is_public) {
  return "Доступ ограничен"
}
```

## Решение

### 1. Добавлена проверка авторизации и участия

```typescript
// ✅ Новый код
const { data: { user } } = await clientSupabase.auth.getUser()

let isOrgMember = false
if (user) {
  // Ищем связанный Telegram аккаунт
  const { data: telegramAccount } = await supabase
    .from('user_telegram_accounts')
    .select('telegram_user_id')
    .eq('user_id', user.id)
    .eq('org_id', org.id)
    .single()
  
  if (telegramAccount) {
    // Проверяем наличие участника
    const { data: participant } = await supabase
      .from('participants')
      .select('id')
      .eq('org_id', org.id)
      .eq('tg_user_id', telegramAccount.telegram_user_id)
      .single()
    
    isOrgMember = !!participant
  }
}

// Блокируем доступ только если событие приватное И пользователь НЕ участник
if (!event.is_public && !isOrgMember) {
  return "Доступ ограничен"
}
```

### 2. Добавлена прямая регистрация для авторизованных участников

В компоненте `PublicEventDetail`:

```typescript
const handleRegister = () => {
  // Если пользователь уже авторизован и является участником организации
  if (isAuthenticated && isOrgMember) {
    handleDirectRegister() // Регистрация без повторной авторизации
  } else {
    setShowAuthModal(true) // Показываем Telegram Login Widget
  }
}
```

### 3. Улучшен UX для неавторизованных участников

```typescript
if (!event.is_public && !isOrgMember) {
  return (
    <div>
      <h1>Доступ ограничен</h1>
      <p>Это событие доступно только участникам пространства.</p>
      {!user && (
        <p>Войдите через Telegram, если вы участник группы.</p>
      )}
    </div>
  )
}
```

## Измененные файлы

1. **`app/p/[org]/events/[id]/page.tsx`**
   - Добавлена проверка авторизации через `createClientServer()`
   - Добавлена проверка участия в организации через `user_telegram_accounts` и `participants`
   - Передача `isAuthenticated` и `isOrgMember` в компонент

2. **`components/events/public-event-detail.tsx`**
   - Добавлены пропсы `isAuthenticated` и `isOrgMember`
   - Добавлена функция `handleDirectRegister()` для авторизованных участников
   - Условное отображение текста "Для регистрации необходимо войти через Telegram"

## Новая логика доступа

| Тип события | Авторизация | Участие | Результат |
|-------------|------------|---------|-----------|
| Публичное (`is_public = true`) | Любая | Любое | ✅ Доступ предоставлен |
| Приватное (`is_public = false`) | ✅ Есть | ✅ Участник | ✅ Доступ предоставлен |
| Приватное (`is_public = false`) | ✅ Есть | ❌ НЕ участник | ❌ Доступ ограничен |
| Приватное (`is_public = false`) | ❌ Нет | - | ❌ Доступ ограничен + подсказка войти |

## Workflow для участника Telegram группы

1. **Пользователь получает ссылку** на событие в Telegram группе
2. **Кликает по ссылке** → открывается `/p/[org]/events/[id]`
3. **Система проверяет**:
   - Есть ли у пользователя Supabase сессия?
   - Связан ли его Telegram аккаунт с участником организации?
4. **Результаты**:
   - ✅ **Авторизован + участник** → Страница события, кнопка "Зарегистрироваться" (без повторной авторизации)
   - ✅ **Авторизован + НЕ участник + публичное событие** → Страница события, регистрация через Telegram Login
   - ❌ **НЕ авторизован + приватное событие** → "Доступ ограничен, войдите через Telegram"
   - ✅ **НЕ авторизован + публичное событие** → Страница события, регистрация через Telegram Login

## Тестирование

### Сценарий 1: Админ переходит по ссылке на приватное событие
```
✅ Ожидание: доступ предоставлен (админ = участник организации)
✅ Результат: страница события отображается
```

### Сценарий 2: Участник группы переходит по ссылке на приватное событие
```
✅ Ожидание: 
  - Если авторизован → доступ предоставлен
  - Если НЕ авторизован → "Доступ ограничен, войдите через Telegram"
✅ Результат: корректное поведение в зависимости от авторизации
```

### Сценарий 3: Любой пользователь переходит по ссылке на публичное событие
```
✅ Ожидание: доступ предоставлен всем
✅ Результат: страница события отображается
```

## Документация

Создана подробная документация:
- **`EVENT_ACCESS_LOGIC.md`** - полное описание логики доступа
- **`EVENT_SHARING_SETUP.md`** - руководство по публикации событий
- **`EVENT_ACCESS_FIX.md`** - этот файл с описанием исправления

## Заключение

Теперь участники Telegram групп могут:
1. ✅ Открывать ссылки на **публичные** события без авторизации
2. ✅ Открывать ссылки на **приватные** события после авторизации через Telegram
3. ✅ Регистрироваться на события одним кликом (если уже авторизованы)
4. ✅ Видеть понятные подсказки, если доступ ограничен

Проблема с "Доступ ограничен" для админов и участников организации **решена**! ✅

