# Import & Health Widget Fixes - 2025-11-04

## Проблема #1: Участники не распознаются при импорте

### Симптомы
При импорте JSON истории чата, участник, который уже есть в организации (но в других группах), не распознавался и предлагалось создать его как нового.

### Причина
1. **Parse API** искал участников только среди тех, кто уже в импортируемой группе (`participant_groups` с фильтром по `tg_group_id`)
2. **Import API** не создавал связь в `participant_groups` для существующих участников (merge)

### Решение

#### 1. Parse API (`app/api/telegram/import-history/[id]/parse/route.ts`)
Изменён запрос к БД - теперь ищет участников **по всей организации**, а не только в текущей группе:

```typescript
// БЫЛО:
.eq('participant_groups.tg_group_id', group.tg_chat_id)

// СТАЛО:
.eq('org_id', orgId)  // Ищем по всей организации
```

Это позволяет:
- ✅ Находить участников, которые уже есть в других группах
- ✅ Использовать perfect match по `tg_user_id` (из JSON)
- ✅ Избегать создания дублей

#### 2. Import API (`app/api/telegram/import-history/[id]/import/route.ts`)
Вынесена логика создания связи `participant_groups` **ВНЕ** блока `else`:

```typescript
// ⭐ ВАЖНО: Создаем связь с группой для ВСЕХ участников
await supabaseAdmin
  .from('participant_groups')
  .upsert({
    participant_id: participantId,
    tg_group_id: group.tg_chat_id,
    joined_at: author.firstMessageDate,
    is_active: true,
  }, {
    onConflict: 'participant_id,tg_group_id',
  });
```

Теперь связь создаётся для:
- ✅ Новых участников (созданных при импорте)
- ✅ Существующих участников (найденных по `tg_user_id` или имени)

#### 3. Полная поддержка JSON формата в Import API
Добавлена поддержка JSON парсинга в import endpoint:

- Импортирует `TelegramJsonParser` для JSON файлов
- Сохраняет `tg_user_id` из JSON (`author.userId`)
- Сохраняет `message_id` из JSON
- Помечает `source` как `json_import` или `html_import`
- Использует `authorUserId` и `messageId` из сообщений

### Результат
✅ Участники корректно распознаются по всей организации  
✅ Не создаются дубли  
✅ Правильно добавляются связи в `participant_groups`  
✅ JSON импорт полностью интегрирован

---

## Проблема #2: Telegram Webhook Status виджет в неправильном месте

### Симптомы
Виджет показывался обычному пользователю:
- В настройках Telegram аккаунта
- На английском языке
- С данными по **всем группам в базе** (не ограниченным по организации)

### Причина
Виджет был создан для мониторинга системы администратором, но случайно добавлен на пользовательскую страницу.

### Решение

#### 1. Создан новый компонент для суперадмина
`components/superadmin/telegram-health-status.tsx`:
- ✅ Полностью на русском языке
- ✅ Компактный дизайн для суперадмина
- ✅ Показывает глобальный статус всех групп в базе
- ✅ Цветовая индикация (зелёный/жёлтый/красный фон)

Изменения:
- "Telegram Webhook Status" → "Статус Telegram Webhook"
- "Total Groups" → "Всего групп"
- "Healthy" → "Активные"
- "Unhealthy" → "Неактивные"
- "Last checked" → "Обновлено"

#### 2. Удалён из пользовательской страницы
`app/app/[org]/telegram/account/client-page.tsx`:
- Удалён импорт `TelegramHealthWidget`
- Удалён блок рендера виджета (строки 474-478)

#### 3. Добавлен в суперадминку
`app/superadmin/groups/page.tsx`:
- Виджет размещён справа от заголовка "Группы"
- Фиксированная ширина `w-80`
- Flex layout для корректного расположения

### Результат
✅ Виджет отображается только суперадмину  
✅ На русском языке  
✅ В правильном месте (страница списка групп в суперадминке)  
✅ Компактный и информативный дизайн

---

## Файлы изменены

### Импорт участников:
1. `app/api/telegram/import-history/[id]/parse/route.ts` - поиск по всей организации
2. `app/api/telegram/import-history/[id]/import/route.ts` - JSON поддержка + правильное создание `participant_groups`

### Health Widget:
1. `components/superadmin/telegram-health-status.tsx` - новый компонент (русский)
2. `app/app/[org]/telegram/account/client-page.tsx` - удалён виджет
3. `app/superadmin/groups/page.tsx` - добавлен виджет

---

## Тестирование

### Импорт участников:
1. Создать участника в группе A
2. Импортировать JSON из группы B, где тот же участник (по `tg_user_id`)
3. ✅ Проверить, что участник распознан (не создан дубль)
4. ✅ Проверить, что создана связь в `participant_groups` для группы B
5. ✅ Проверить, что сообщения привязаны к существующему `participant_id`

### Health Widget:
1. Открыть суперадминку → Группы
2. ✅ Виджет отображается справа вверху
3. ✅ Все тексты на русском
4. ✅ Показывает корректные цифры (всего/активные/неактивные)
5. Открыть настройки Telegram аккаунта как обычный пользователь
6. ✅ Виджет НЕ отображается

---

## Статус
✅ **Завершено** - оба исправления готовы к деплою и тестированию

