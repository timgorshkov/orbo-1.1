# –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–≥—Ä—É–∑–∫–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤ Telegram

## –ü—Ä–æ–±–ª–µ–º–∞

–ü—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ –∫–Ω–æ–ø–∫–∏ "–û–±–Ω–æ–≤–∏—Ç—å –ø—Ä–∞–≤–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤":
- ‚úÖ –ö–Ω–æ–ø–∫–∞ –ø–æ–∫–∞–∑—ã–≤–∞–ª–∞ "–æ–±–Ω–æ–≤–ª–µ–Ω—ã 2 –∏–∑ 2"
- ‚ùå –ù–æ –≤ —Ç–∞–±–ª–∏—Ü–µ `telegram_group_admins` —Å–æ—Ö—Ä–∞–Ω—è–ª—Å—è —Ç–æ–ª—å–∫–æ —Ç–µ–∫—É—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
- ‚ùå –í—Ç–æ—Ä–æ–π –∞–¥–º–∏–Ω –≥—Ä—É–ø–ø—ã –Ω–µ –∑–∞–≥—Ä—É–∂–∞–ª—Å—è
- ‚ùå –í —Ä–∞–∑–¥–µ–ª–µ "–ö–æ–º–∞–Ω–¥–∞ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏" –≤—Ç–æ—Ä–æ–π –∞–¥–º–∏–Ω –Ω–µ –æ—Ç–æ–±—Ä–∞–∂–∞–ª—Å—è
- ‚ùå –°—Ç–∞—Ç—É—Å—ã –∞–¥–º–∏–Ω–æ–≤ –Ω–µ –ø–æ–¥—Ç—è–≥–∏–≤–∞–ª–∏—Å—å –∫ —É—á–∞—Å—Ç–Ω–∏–∫–∞–º

## –ü—Ä–∏—á–∏–Ω–∞

–ö–æ–¥ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª –º–µ—Ç–æ–¥ `getChatMember(chatId, userId)`, –∫–æ—Ç–æ—Ä—ã–π –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –ø—Ä–∞–≤–∞ **—Ç–æ–ª—å–∫–æ –æ–¥–Ω–æ–≥–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è** (—Ç–æ–≥–æ, –∫—Ç–æ –Ω–∞–∂–∞–ª –∫–Ω–æ–ø–∫—É).

```typescript
// ‚ùå –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û - –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —Ç–æ–ª—å–∫–æ —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
const adminInfo = await telegramService.getChatMember(chatId, activeAccount.telegram_user_id);
```

## –†–µ—à–µ–Ω–∏–µ

### 1. –î–æ–±–∞–≤–ª–µ–Ω –º–µ—Ç–æ–¥ `getChatAdministrators`

**–§–∞–π–ª:** `lib/services/telegramService.ts`

```typescript
/**
 * –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –≤—Å–µ—Ö –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤ –≥—Ä—É–ø–ø—ã
 */
async getChatAdministrators(chatId: number) {
  return this.callApi('getChatAdministrators', {
    chat_id: chatId
  });
}
```

### 2. –ü–µ—Ä–µ–ø–∏—Å–∞–Ω –∫–æ–¥ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–∞–≤

**–§–∞–π–ª:** `app/api/telegram/groups/update-admin-rights/route.ts`

–¢–µ–ø–µ—Ä—å –∫–æ–¥:
1. –í—ã–∑—ã–≤–∞–µ—Ç `getChatAdministrators(chatId)` ‚Äî –ø–æ–ª—É—á–∞–µ—Ç **–≤—Å–µ—Ö** –∞–¥–º–∏–Ω–æ–≤ –≥—Ä—É–ø–ø—ã
2. –ü—Ä–æ—Ö–æ–¥–∏—Ç –ø–æ –∫–∞–∂–¥–æ–º—É –∞–¥–º–∏–Ω—É
3. –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –∏—Ö –≤ `telegram_group_admins`
4. –í—ã–∑—ã–≤–∞–µ—Ç `sync_telegram_admins` –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è `memberships`

```typescript
// ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û - –ø–æ–ª—É—á–∞–µ–º –≤—Å–µ—Ö –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤
const adminsResponse = await telegramService.getChatAdministrators(chatId);
const administrators = adminsResponse.result || [];

// –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∫–∞–∂–¥–æ–≥–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
for (const admin of administrators) {
  const userId = admin?.user?.id;
  const isOwner = admin?.status === 'creator';
  const isAdmin = admin?.status === 'administrator' || admin?.status === 'creator';
  
  // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ telegram_group_admins
  await supabaseService
    .from('telegram_group_admins')
    .upsert({
      tg_chat_id: chatId,
      tg_user_id: userId,
      is_owner: isOwner,
      is_admin: isAdmin,
      custom_title: admin.custom_title || null,
      // ... –¥—Ä—É–≥–∏–µ –ø–æ–ª—è
    }, { onConflict: 'tg_chat_id,tg_user_id' });
}

// –ü–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≤—Å–µ—Ö –∞–¥–º–∏–Ω–æ–≤ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º —Å memberships
await supabaseService.rpc('sync_telegram_admins', {
  p_org_id: orgId
});
```

## –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–µ–ø–µ—Ä—å

### –®–∞–≥ 1: –ù–∞–∂–∞—Ç–∏–µ –∫–Ω–æ–ø–∫–∏ "–û–±–Ω–æ–≤–∏—Ç—å –ø—Ä–∞–≤–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤"

1. –°–∏—Å—Ç–µ–º–∞ –ø–æ–ª—É—á–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –≥—Ä—É–ø–ø –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏
2. –î–ª—è –∫–∞–∂–¥–æ–π –≥—Ä—É–ø–ø—ã –≤—ã–∑—ã–≤–∞–µ—Ç `getChatAdministrators(chatId)`
3. Telegram API –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç **–≤—Å–µ—Ö** –∞–¥–º–∏–Ω–æ–≤ –≥—Ä—É–ø–ø—ã
4. –ö–∞–∂–¥—ã–π –∞–¥–º–∏–Ω —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ `telegram_group_admins`

### –®–∞–≥ 2: –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å memberships

–ü–æ—Å–ª–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∞–¥–º–∏–Ω–æ–≤ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è RPC —Ñ—É–Ω–∫—Ü–∏—è `sync_telegram_admins`:
- –î–ª—è –∞–¥–º–∏–Ω–æ–≤ **—Å –ø—Ä–∏–≤—è–∑–∞–Ω–Ω—ã–º Telegram** ‚Üí —Å–æ–∑–¥–∞—ë—Ç—Å—è `membership` —Å —Ä–æ–ª—å—é `admin`
- –î–ª—è –∞–¥–º–∏–Ω–æ–≤ **–±–µ–∑ –ø—Ä–∏–≤—è–∑–∞–Ω–Ω–æ–≥–æ Telegram** ‚Üí —Å–æ–∑–¥–∞—ë—Ç—Å—è shadow profile (read-only)

### –®–∞–≥ 3: –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤ UI

#### –í —Ä–∞–∑–¥–µ–ª–µ "–£—á–∞—Å—Ç–Ω–∏–∫–∏" (`/app/[org]/members`)
- –£ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –ø–æ—è–≤–ª—è—é—Ç—Å—è –∏–∫–æ–Ω–∫–∏ –∞–¥–º–∏–Ω–∞ (shield) –∏–ª–∏ –≤–ª–∞–¥–µ–ª—å—Ü–∞ (crown)
- –û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è custom_title (–µ—Å–ª–∏ –µ—Å—Ç—å)

#### –í —Ä–∞–∑–¥–µ–ª–µ "–ö–æ–º–∞–Ω–¥–∞ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏" (`/app/[org]/settings`)
- –í–ª–∞–¥–µ–ª–µ—Ü
- –ê–¥–º–∏–Ω—ã —Å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥—ë–Ω–Ω—ã–º email
- Shadow –∞–¥–º–∏–Ω—ã (–±–µ–∑ email)

## –†–µ–∑—É–ª—å—Ç–∞—Ç

‚úÖ **–ü—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ "–û–±–Ω–æ–≤–∏—Ç—å –ø—Ä–∞–≤–∞":**
- –ó–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –í–°–ï –∞–¥–º–∏–Ω—ã –≤—Å–µ—Ö –≥—Ä—É–ø–ø
- –°–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ `telegram_group_admins`
- –°–æ–∑–¥–∞—é—Ç—Å—è `memberships` –¥–ª—è –∞–¥–º–∏–Ω–æ–≤ —Å –ø—Ä–∏–≤—è–∑–∞–Ω–Ω—ã–º Telegram
- –°–æ–∑–¥–∞—é—Ç—Å—è shadow profiles –¥–ª—è –∞–¥–º–∏–Ω–æ–≤ –±–µ–∑ email

‚úÖ **–í UI:**
- –°—Ç–∞—Ç—É—Å—ã –∞–¥–º–∏–Ω–æ–≤ –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –≤ —Ä–∞–∑–¥–µ–ª–µ "–£—á–∞—Å—Ç–Ω–∏–∫–∏"
- Custom titles –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç—Å—è —Ä—è–¥–æ–º —Å –∏–º–µ–Ω–∞–º–∏
- –ö–æ–º–∞–Ω–¥–∞ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –≤—Å–µ—Ö –∞–¥–º–∏–Ω–æ–≤

‚úÖ **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –≥—Ä—É–ø–ø—ã:**
- –ï—Å–ª–∏ –∞–¥–º–∏–Ω —É–∂–µ –µ—Å—Ç—å –≤ `telegram_group_admins` ‚Üí –æ–Ω —Å—Ä–∞–∑—É –ø–æ–ª—É—á–∞–µ—Ç –¥–æ—Å—Ç—É–ø
- –ï—Å–ª–∏ –∞–¥–º–∏–Ω –Ω–æ–≤—ã–π ‚Üí –Ω—É–∂–Ω–æ –Ω–∞–∂–∞—Ç—å "–û–±–Ω–æ–≤–∏—Ç—å –ø—Ä–∞–≤–∞"

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### 1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∑–∞–≥—Ä—É–∑–∫—É –∞–¥–º–∏–Ω–æ–≤

```sql
-- –î–æ–ª–∂–Ω—ã –±—ã—Ç—å –í–°–ï –∞–¥–º–∏–Ω—ã –≤—Å–µ—Ö –≥—Ä—É–ø–ø
SELECT 
  tga.tg_chat_id,
  tg.title,
  tga.tg_user_id,
  tga.is_owner,
  tga.is_admin,
  tga.custom_title
FROM telegram_group_admins tga
LEFT JOIN telegram_groups tg ON tg.tg_chat_id = tga.tg_chat_id
ORDER BY tga.tg_chat_id, tga.is_owner DESC;
```

### 2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é —Å memberships

```sql
-- –î–æ–ª–∂–Ω—ã –±—ã—Ç—å memberships –¥–ª—è –∞–¥–º–∏–Ω–æ–≤ —Å –ø—Ä–∏–≤—è–∑–∞–Ω–Ω—ã–º Telegram
SELECT 
  m.user_id,
  m.role,
  u.email,
  uta.telegram_user_id
FROM memberships m
LEFT JOIN auth.users u ON u.id = m.user_id
LEFT JOIN user_telegram_accounts uta ON uta.user_id = m.user_id
WHERE m.role IN ('admin', 'owner')
ORDER BY m.role;
```

### 3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤ UI

1. –ó–∞–π–¥–∏—Ç–µ –≤ `/app/[org]/members` ‚Äî –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –∏–∫–æ–Ω–∫–∏ –∞–¥–º–∏–Ω–æ–≤
2. –ó–∞–π–¥–∏—Ç–µ –≤ `/app/[org]/settings` ‚Üí "–ö–æ–º–∞–Ω–¥–∞ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏" ‚Äî –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –≤—Å–µ –∞–¥–º–∏–Ω—ã

## –§–∞–π–ª—ã —Å –∏–∑–º–µ–Ω–µ–Ω–∏—è–º–∏

1. `lib/services/telegramService.ts` ‚Äî –¥–æ–±–∞–≤–ª–µ–Ω `getChatAdministrators`
2. **`app/api/telegram/groups/update-admins/route.ts`** ‚Äî –ø–µ—Ä–µ–ø–∏—Å–∞–Ω–∞ –ª–æ–≥–∏–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ (—ç—Ç–æ —Ç–æ—Ç endpoint, –∫–æ—Ç–æ—Ä—ã–π –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –∫–Ω–æ–ø–∫–æ–π!)
3. `app/api/telegram/groups/update-admin-rights/route.ts` ‚Äî —Ç–∞–∫–∂–µ –æ–±–Ω–æ–≤–ª–µ–Ω –¥–ª—è –µ–¥–∏–Ω–æ–æ–±—Ä–∞–∑–∏—è
4. `docs/TELEGRAM_ADMINS_FIX.md` ‚Äî —ç—Ç–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

**–í–∞–∂–Ω–æ:** –ö–Ω–æ–ø–∫–∞ "–û–±–Ω–æ–≤–∏—Ç—å –ø—Ä–∞–≤–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤" –≤—ã–∑—ã–≤–∞–µ—Ç `/api/telegram/groups/update-admins`, –ø–æ—ç—Ç–æ–º—É –≥–ª–∞–≤–Ω–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ –∏–º–µ–Ω–Ω–æ –≤ —ç—Ç–æ–º —Ñ–∞–π–ª–µ!

## –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

–ü–æ—Å–ª–µ –¥–µ–ø–ª–æ—è:
1. –ù–∞–∂–º–∏—Ç–µ "–û–±–Ω–æ–≤–∏—Ç—å –ø—Ä–∞–≤–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤" –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ `/app/[org]/telegram/account`
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ Vercel ‚Äî –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å `Found X administrators in chat Y`
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö ‚Äî –≤ `telegram_group_admins` –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –≤—Å–µ –∞–¥–º–∏–Ω—ã
4. –ó–∞–π–¥–∏—Ç–µ –≤ —Ä–∞–∑–¥–µ–ª "–£—á–∞—Å—Ç–Ω–∏–∫–∏" ‚Äî –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –∏–∫–æ–Ω–∫–∏
5. –ó–∞–π–¥–∏—Ç–µ –≤ "–ö–æ–º–∞–Ω–¥–∞ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏" ‚Äî –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –≤—Å–µ –∞–¥–º–∏–Ω—ã

–ì–æ—Ç–æ–≤–æ! üéâ

