# Message Storage Unification - COMPLETE ‚úÖ

**Date:** Nov 4, 2025  
**Task:** –£–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å —Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π –º–µ–∂–¥—É webhook –∏ import, —Å–æ—Ö—Ä–∞–Ω—è—Ç—å –ø–æ–ª–Ω—ã–µ —Ç–µ–∫—Å—Ç—ã

---

## üéØ –¶–µ–ª–∏ –∑–∞–¥–∞—á–∏

1. ‚úÖ –£–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É `meta` –≤ `activity_events` –¥–ª—è webhook –∏ import
2. ‚úÖ –°–æ—Ö—Ä–∞–Ω—è—Ç—å –ø–æ–ª–Ω—ã–µ —Ç–µ–∫—Å—Ç—ã —Å–æ–æ–±—â–µ–Ω–∏–π –≤ `participant_messages`
3. ‚úÖ –û–±–µ—Å–ø–µ—á–∏—Ç—å —Å–≤—è–∑—å `activity_event_id` –º–µ–∂–¥—É —Ç–∞–±–ª–∏—Ü–∞–º–∏
4. ‚úÖ –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å –¥–ª—è –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –∏–º–ø–æ—Ä—Ç–æ–≤

---

## üìã –í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è

### Phase 1: –£–Ω–∏—Ñ–∏–∫–∞—Ü–∏—è —Å—Ç—Ä—É–∫—Ç—É—Ä—ã `meta`

**–ï–¥–∏–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ `meta` –¥–ª—è –æ–±–æ–∏—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤:**

```json
{
  "user": {
    "name": "Tim Gorshkov",
    "username": "timgorshkov",
    "tg_user_id": 154588486
  },
  "message": {
    "id": 182,
    "thread_id": null,
    "reply_to_id": null,
    "text_preview": "–ø–µ—Ä–≤—ã–µ ~200 —Å–∏–º–≤–æ–ª–æ–≤ —Ç–µ–∫—Å—Ç–∞...",
    "text_length": 1234,
    "has_media": true,
    "media_type": "photo"
  },
  "reactions": {
    "total_count": 5,
    "reaction_types": ["üëç", "‚ù§Ô∏è"]
  },
  "source": {
    "type": "webhook" | "import",
    "format": "json" | "html",  // —Ç–æ–ª—å–∫–æ –¥–ª—è import
    "batch_id": "uuid"           // —Ç–æ–ª—å–∫–æ –¥–ª—è import
  }
}
```

**–ò–∑–º–µ–Ω—ë–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã:**
- ‚úÖ `lib/services/eventProcessingService.ts` - —É–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–ª—è webhook
- ‚úÖ `app/api/telegram/import-history/[id]/import/route.ts` - —É–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–ª—è import

### Phase 2: –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø–æ–ª–Ω—ã—Ö —Ç–µ–∫—Å—Ç–æ–≤

**–¢–∞–±–ª–∏—Ü–∞ `participant_messages`:**
- –î–æ–±–∞–≤–ª–µ–Ω–∞ —Å–≤—è–∑—å `activity_event_id` (FK ‚Üí `activity_events.id`)
- –°–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –ø–æ–ª–Ω—ã–π —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è (`message_text`)
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `upsert` —Å `onConflict: 'tg_chat_id,message_id'` –¥–ª—è –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏

**–ò–∑–º–µ–Ω—ë–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã:**
- ‚úÖ `db/migrations/081_restore_activity_event_id.sql` - –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –∫–æ–ª–æ–Ω–∫–∞ `activity_event_id`
- ‚úÖ `lib/services/eventProcessingService.ts` - —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–æ–≤ –∏–∑ webhook
- ‚úÖ `app/api/telegram/import-history/[id]/import/route.ts` - —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–æ–≤ –∏–∑ import

### Phase 3: –£–ª—É—á—à–µ–Ω–∏—è –∏ —Ñ–∏–∫—Å—ã

**–§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –±–æ—Ç–æ–≤:**
- ‚úÖ –£–ª—É—á—à–µ–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è `isBot()` –≤ `parse/route.ts`
- –¢–µ–ø–µ—Ä—å –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –Ω–µ —Ç–æ–ª—å–∫–æ `username`, –Ω–æ –∏ `name` –Ω–∞ –æ–∫–æ–Ω—á–∞–Ω–∏–µ "bot"
- –ü—Ä–∏–º–µ—Ä—ã: `ChatKeeperBot`, `orbo_community_bot` —Ç–µ–ø–µ—Ä—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ —Ñ–∏–ª—å—Ç—Ä—É—é—Ç—Å—è

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:**
- ‚úÖ –£–±—Ä–∞–Ω–∞ –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–∞—è –∫–æ–ª–æ–Ω–∫–∞ `last_activity_at` –∏–∑ `for-user` API
- ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω—ã SQL —Å–∫—Ä–∏–ø—Ç—ã (`tg_username` ‚Üí `username`)

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –¢–µ—Å—Ç 1: Webhook —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç —Ç–µ–∫—Å—Ç—ã ‚úÖ

**–ó–∞–ø—Ä–æ—Å:**
```sql
SELECT 
  ae.id as event_id,
  ae.meta->'message'->>'text_preview' as preview,
  pm.message_text,
  pm.activity_event_id,
  pm.created_at
FROM activity_events ae
LEFT JOIN participant_messages pm ON pm.activity_event_id = ae.id
WHERE ae.import_source = 'webhook'
  AND ae.created_at > NOW() - INTERVAL '10 minutes'
ORDER BY ae.created_at DESC
LIMIT 5;
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- ‚úÖ event_id: 467
- ‚úÖ preview: "–≤–º—Å—ã–≤–º—ã–≤–º—ã"
- ‚úÖ message_text: "–≤–º—Å—ã–≤–º—ã–≤–º—ã"
- ‚úÖ activity_event_id: 467

### –¢–µ—Å—Ç 2: Import —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç —Ç–µ–∫—Å—Ç—ã ‚úÖ

**–ó–∞–ø—Ä–æ—Å:**
```sql
SELECT 
  pm.id,
  pm.activity_event_id,
  LENGTH(pm.message_text) as text_length,
  pm.created_at
FROM participant_messages pm
WHERE pm.created_at > NOW() - INTERVAL '1 hour'
ORDER BY pm.created_at DESC
LIMIT 10;
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç (–ø–æ—Å–ª–µ –∏–º–ø–æ—Ä—Ç–∞ 82 —Å–æ–æ–±—â–µ–Ω–∏–π –∏–∑ JSON):**
- ‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ 66 message texts (16 –±—ã–ª–∏ –±–æ—Ç–∞–º–∏/–ø—Ä–æ–ø—É—â–µ–Ω—ã)
- ‚úÖ activity_event_id –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ —Å–≤—è–∑–∞–Ω (480, 491, 505, –∏ —Ç.–¥.)
- ‚úÖ text_length –æ—Ç 2 –¥–æ 15 —Å–∏–º–≤–æ–ª–æ–≤

**–õ–æ–≥–∏ Vercel –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞—é—Ç:**
```
‚úÖ Successfully inserted 66 activity events (ID: 468-533)
‚úÖ Saved 66 message texts
üîç Verification check - found 3 records with batch_id=36a11bad...
```

---

## üìä –ú–∏–≥—Ä–∞—Ü–∏–∏

**Migration 081:** `restore_activity_event_id.sql`
- –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –∫–æ–ª–æ–Ω–∫–∞ `activity_event_id` –≤ `participant_messages` (–±—ã–ª–∞ —É–¥–∞–ª–µ–Ω–∞ –≤ migration 071)
- –î–æ–±–∞–≤–ª–µ–Ω –∏–Ω–¥–µ–∫—Å –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
- –î–æ–±–∞–≤–ª–µ–Ω FK constraint —Å `ON DELETE SET NULL`

---

## üîç –î–∏–∞–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫–∏–µ —Å–∫—Ä–∏–ø—Ç—ã

### `db/check_import_rls.sql`
–ü—Ä–æ–≤–µ—Ä—è–µ—Ç:
- RLS —Å—Ç–∞—Ç—É—Å –Ω–∞ `activity_events` –∏ `participant_messages`
- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –∑–∞–ø–∏—Å–µ–π
- –°—Ç—Ä—É–∫—Ç—É—Ä—É `meta` –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–æ–≤

### `db/check_imported_participants.sql`
–ü—Ä–æ–≤–µ—Ä—è–µ—Ç:
- –ù–µ–¥–∞–≤–Ω–æ —Å–æ–∑–¥–∞–Ω–Ω—ã—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
- –°–≤—è–∑—å —Å –≥—Ä—É–ø–ø–∞–º–∏ —á–µ—Ä–µ–∑ `participant_groups`
- –§–∏–ª—å—Ç—Ä–∞—Ü–∏—é –±–æ—Ç–æ–≤

### `db/test_import_fixed.sql`
–¢–µ—Å—Ç–æ–≤—ã–π —Å–∫—Ä–∏–ø—Ç, –∫–æ—Ç–æ—Ä—ã–π:
- –ù–∞—á–∏–Ω–∞–µ—Ç —Å `participant_messages` (–æ–±—Ö–æ–¥ RLS)
- –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Å–≤—è–∑—å —Å `activity_events`
- –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ —Ç–µ–∫—Å—Ç—ã

---

## üêõ –ò–∑–≤–µ—Å—Ç–Ω—ã–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏

### RLS –∏ —Ç–µ—Å—Ç–æ–≤—ã–µ –∑–∞–ø—Ä–æ—Å—ã
**–ü—Ä–æ–±–ª–µ–º–∞:** –ï—Å–ª–∏ SQL –∑–∞–ø—Ä–æ—Å –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å `activity_events`, RLS –º–æ–∂–µ—Ç –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å —á—Ç–µ–Ω–∏–µ –Ω–æ–≤—ã—Ö –∑–∞–ø–∏—Å–µ–π –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.

**–†–µ—à–µ–Ω–∏–µ:** –ù–∞—á–∏–Ω–∞—Ç—å –∑–∞–ø—Ä–æ—Å—ã —Å `participant_messages`:
```sql
-- ‚ùå –ú–æ–∂–µ—Ç –Ω–µ —Ä–∞–±–æ—Ç–∞—Ç—å (RLS –±–ª–æ–∫–∏—Ä—É–µ—Ç)
SELECT * FROM activity_events ae
LEFT JOIN participant_messages pm ON pm.activity_event_id = ae.id

-- ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç (–æ–±—Ö–æ–¥ RLS)
SELECT * FROM participant_messages pm
LEFT JOIN activity_events ae ON ae.id = pm.activity_event_id
```

### –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –±–æ—Ç–æ–≤
–ë–æ—Ç—ã —Ñ–∏–ª—å—Ç—Ä—É—é—Ç—Å—è –Ω–∞ —ç—Ç–∞–ø–µ **–ø–∞—Ä—Å–∏–Ω–≥–∞** (`parse/route.ts`) –∏ **–Ω–µ —Å–æ–∑–¥–∞—é—Ç—Å—è** –∫–∞–∫ —É—á–∞—Å—Ç–Ω–∏–∫–∏.

**–õ–æ–≥–∏–∫–∞ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏:**
- Username –∑–∞–∫–∞–Ω—á–∏–≤–∞–µ—Ç—Å—è –Ω–∞ "bot" ‚Üí –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å
- **–ò–º—è –∑–∞–∫–∞–Ω—á–∏–≤–∞–µ—Ç—Å—è –Ω–∞ "bot" ‚Üí –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å** (–¥–æ–±–∞–≤–ª–µ–Ω–æ –≤ —ç—Ç–æ–π –∑–∞–¥–∞—á–µ)
- –ò–º—è —Ç–æ—á–Ω–æ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç `['orbo', 'bot', 'telegram']` ‚Üí –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å

**–ü—Ä–∏–º–µ—Ä—ã:**
- ‚úÖ `ChatKeeperBot` (–∏–º—è) ‚Üí –±—É–¥–µ—Ç –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω
- ‚úÖ `orbo_community_bot` (username) ‚Üí –±—É–¥–µ—Ç –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω
- ‚úÖ `Telegram` (–∏–º—è) ‚Üí –±—É–¥–µ—Ç –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω

**–í–∞–∂–Ω–æ:** –ë–æ—Ç—ã, —Å–æ–∑–¥–∞–Ω–Ω—ã–µ **–¥–æ** —ç—Ç–æ–≥–æ —Ñ–∏–∫—Å–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, ChatKeeperBot —Å tg_user_id=553147242), –æ—Å—Ç–∞–ª–∏—Å—å –≤ –±–∞–∑–µ. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ `db/cleanup_bot_participant.sql` –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è, –µ—Å–ª–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ.

---

## ‚úÖ –ò—Ç–æ–≥–∏

### –ß—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç:
1. ‚úÖ Webhook —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –ø–æ–ª–Ω—ã–µ —Ç–µ–∫—Å—Ç—ã –≤ `participant_messages`
2. ‚úÖ Import (JSON/HTML) —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –ø–æ–ª–Ω—ã–µ —Ç–µ–∫—Å—Ç—ã –≤ `participant_messages`
3. ‚úÖ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ `meta` —É–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–∞
4. ‚úÖ –ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å –æ–±–µ—Å–ø–µ—á–µ–Ω–∞ —á–µ—Ä–µ–∑ `upsert`
5. ‚úÖ –ë–æ—Ç—ã –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ —Ñ–∏–ª—å—Ç—Ä—É—é—Ç—Å—è
6. ‚úÖ –°–≤—è–∑—å `activity_event_id` —Ä–∞–±–æ—Ç–∞–µ—Ç

### –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ):
- [ ] –î–æ–±–∞–≤–∏—Ç—å –∏–Ω–¥–µ–∫—Å—ã –Ω–∞ `participant_messages.tg_user_id` –∏ `participant_messages.tg_chat_id` –¥–ª—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏
- [ ] –†–∞—Å—Å–º–æ—Ç—Ä–µ—Ç—å —Å–∂–∞—Ç–∏–µ —Å—Ç–∞—Ä—ã—Ö —Ç–µ–∫—Å—Ç–æ–≤ —Å–æ–æ–±—â–µ–Ω–∏–π (>3 –º–µ—Å—è—Ü–µ–≤)
- [ ] –î–æ–±–∞–≤–∏—Ç—å RLS –ø–æ–ª–∏—Ç–∏–∫–∏ –Ω–∞ `participant_messages` (—Å–µ–π—á–∞—Å –¥–æ—Å—Ç—É–ø –æ—Ç–∫—Ä—ã—Ç)

---

**–ó–∞–¥–∞—á–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞:** Nov 4, 2025  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ü–æ–ª–Ω–æ—Å—Ç—å—é –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–æ –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ production
