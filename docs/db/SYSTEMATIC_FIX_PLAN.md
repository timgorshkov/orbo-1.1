# –°–∏—Å—Ç–µ–º–Ω–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤—Å–µ—Ö –ø—Ä–æ–±–ª–µ–º —Å –∫–æ–º–∞–Ω–¥–æ–π –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏

## üîç –ù–∞–π–¥–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

### 1Ô∏è‚É£ –î—É–±–ª–∏ user_id –¥–ª—è –æ–¥–Ω–æ–≥–æ tg_user_id
- **–°—Ç–∞—Ç—É—Å:** ‚úÖ –†–ï–®–ï–ù–û –º–∏–≥—Ä–∞—Ü–∏–µ–π 061
- **–†–µ—à–µ–Ω–∏–µ:** –ì–ª–æ–±–∞–ª—å–Ω—ã–π –ø–æ–∏—Å–∫ user_id –ø–µ—Ä–µ–¥ —Å–æ–∑–¥–∞–Ω–∏–µ–º shadow user

### 2Ô∏è‚É£ Telegram creator ‚Üí owner –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ ‚ùå
- **–ü—Ä–æ–±–ª–µ–º–∞:** `sync_telegram_admins` –ø–æ–≤—ã—à–∞–µ—Ç Telegram creator'–æ–≤ –¥–æ owner –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏
- **–ü—Ä–∏–º–µ—Ä:** –¢–∏–º–æ—Ñ–µ–π –ì–æ—Ä—à–∫–æ–≤ - admin –≤ org, –Ω–æ creator –≤ –≥—Ä—É–ø–ø–µ Test2 ‚Üí —Å—Ç–∞–ª owner
- **–ü—Ä–∏—á–∏–Ω–∞:** –°—Ç—Ä–æ–∫–∞ –≤ —Ñ—É–Ω–∫—Ü–∏–∏:
  ```sql
  CASE WHEN v_admin_record.is_owner THEN 'owner' ELSE 'admin' END
  ```
- **–†–∏—Å–∫:** –í –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ –º–æ–∂–µ—Ç –æ–∫–∞–∑–∞—Ç—å—Å—è –Ω–µ—Å–∫–æ–ª—å–∫–æ owner'–æ–≤!

### 3Ô∏è‚É£ has_verified_telegram –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç false
- **–ü—Ä–æ–±–ª–µ–º–∞:** –£ –¢–∏–º–æ—Ñ–µ—è `has_verified_telegram: false` –≤ org2, —Ö–æ—Ç—è –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å true
- **–ü—Ä–∏—á–∏–Ω–∞:** VIEW `organization_admins` –¥–∂–æ–π–Ω–∏—Ç `user_telegram_accounts` –ø–æ `org_id`
- **–ù–æ:** –£ –¢–∏–º–æ—Ñ–µ—è –Ω–µ—Ç –∑–∞–ø–∏—Å–∏ –≤ `user_telegram_accounts` –¥–ª—è org2!

### 4Ô∏è‚É£ –ó–∞—â–∏—Ç–∞ –æ—Ç –ø–æ–Ω–∏–∂–µ–Ω–∏—è –Ω–∞—Å—Ç–æ—è—â–µ–≥–æ owner
- **–†–∏—Å–∫:** –ï—Å–ª–∏ –Ω–∞—Å—Ç–æ—è—â–∏–π owner –Ω–µ –±—É–¥–µ—Ç creator –≤ –≥—Ä—É–ø–ø–∞—Ö, –µ–≥–æ –º–æ–≥—É—Ç –ø–æ–Ω–∏–∑–∏—Ç—å –¥–æ admin
- **–ù—É–∂–Ω–∞:** –ü—Ä–æ–≤–µ—Ä–∫–∞ `role_source` –ø–µ—Ä–µ–¥ –∏–∑–º–µ–Ω–µ–Ω–∏–µ–º —Ä–æ–ª–∏

---

## üìã –ü–ª–∞–Ω –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è (—Å –ø—Ä–æ–≤–µ—Ä–∫–∞–º–∏!)

### –≠—Ç–∞–ø 1: –ê–Ω–∞–ª–∏–∑ —Ç–µ–∫—É—â–µ–π –ª–æ–≥–∏–∫–∏ ‚úÖ

**–ü—Ä–æ–≤–µ—Ä–∏—Ç—å:**
1. –ö–∞–∫ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è "–Ω–∞—Å—Ç–æ—è—â–∏–π" owner –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏?
2. –ö–æ–≥–¥–∞ –º–æ–∂–Ω–æ/–Ω–µ–ª—å–∑—è –º–µ–Ω—è—Ç—å —Ä–æ–ª—å owner?
3. –ö–æ–≥–¥–∞ –¥–æ–ª–∂–µ–Ω –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å—Å—è has_verified_telegram?

### –≠—Ç–∞–ø 2: –ò—Å–ø—Ä–∞–≤–∏—Ç—å –ª–æ–≥–∏–∫—É role –≤ sync_telegram_admins

**–ü—Ä–∞–≤–∏–ª–æ:** 
- `is_owner` –≤ Telegram = creator –≥—Ä—É–ø–ø—ã
- `role = 'owner'` –≤ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ = —Å–æ–∑–¥–∞—Ç–µ–ª—å –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏

**–ù–ï –¥–æ–ª–∂–Ω—ã —Å–æ–≤–ø–∞–¥–∞—Ç—å!**

**–ù–æ–≤–∞—è –ª–æ–≥–∏–∫–∞:**
```sql
-- –ù–ò–ö–û–ì–î–ê –Ω–µ –ø–æ–≤—ã—à–∞–µ–º –¥–æ owner —á–µ—Ä–µ–∑ Telegram
role = 'admin'  -- –í—Å–µ–≥–¥–∞ admin, –¥–∞–∂–µ –µ—Å–ª–∏ creator –≤ –≥—Ä—É–ø–ø–µ

-- –ù–û —Å–æ—Ö—Ä–∞–Ω—è–µ–º info –≤ metadata
metadata = jsonb_build_object(
  'is_owner_in_groups', v_admin_record.is_owner,  -- –î–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è "üëë –í–ª–∞–¥–µ–ª–µ—Ü –≤ –≥—Ä—É–ø–ø–∞—Ö"
  ...
)
```

**–ó–∞—â–∏—Ç–∞:**
```sql
-- –ù–µ –ø–æ–Ω–∏–∂–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ owner, –µ—Å–ª–∏ –æ–Ω –Ω–µ –ø–æ–ª—É—á–µ–Ω —á–µ—Ä–µ–∑ telegram_admin
UPDATE memberships
SET role = CASE 
  WHEN m.role = 'owner' AND m.role_source != 'telegram_admin' THEN 'owner'  -- –°–æ—Ö—Ä–∞–Ω—è–µ–º
  ELSE 'admin'  -- Telegram-–∞–¥–º–∏–Ω—ã –≤—Å–µ–≥–¥–∞ admin
END
```

### –≠—Ç–∞–ø 3: –ò—Å–ø—Ä–∞–≤–∏—Ç—å has_verified_telegram –≤ VIEW

**–ü—Ä–æ–±–ª–µ–º–∞:** VIEW –∏—â–µ—Ç —Ç–æ–ª—å–∫–æ –≤ —Ç–µ–∫—É—â–µ–π org:
```sql
LEFT JOIN user_telegram_accounts uta 
  ON uta.user_id = m.user_id 
  AND uta.org_id = m.org_id  -- ‚ùå –°–ª–∏—à–∫–æ–º —Å—Ç—Ä–æ–≥–æ!
```

**–†–µ—à–µ–Ω–∏–µ:** –ò—Å–∫–∞—Ç—å –≥–ª–æ–±–∞–ª—å–Ω–æ –∏–ª–∏ –≤ –ª—é–±–æ–π org:
```sql
LEFT JOIN user_telegram_accounts uta 
  ON uta.user_id = m.user_id 
  AND uta.is_verified = true
  -- –ë–ï–ó —Ñ–∏–ª—å—Ç—Ä–∞ –ø–æ org_id –∏–ª–∏ —Å OR
ORDER BY uta.org_id = m.org_id DESC  -- –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç —Ç–µ–∫—É—â–µ–π org
LIMIT 1
```

**–ù–æ:** –ù—É–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å LATERAL –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ LEFT JOIN.

### –≠—Ç–∞–ø 4: –î–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏–∫—É —Å–æ–∑–¥–∞–Ω–∏—è user_telegram_accounts

**–ü—Ä–æ–±–ª–µ–º–∞:** –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å—Ç–∞–ª –∞–¥–º–∏–Ω–æ–º —á–µ—Ä–µ–∑ –≥—Ä—É–ø–ø—É, –Ω–æ –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–ª—Å—è –¥–ª—è —ç—Ç–æ–π org ‚Üí –Ω–µ—Ç –∑–∞–ø–∏—Å–∏ –≤ `user_telegram_accounts` –¥–ª—è org.

**–†–µ—à–µ–Ω–∏–µ:** –ü—Ä–∏ `sync_telegram_admins` —Å–æ–∑–¥–∞–≤–∞—Ç—å `user_telegram_accounts` –¥–ª—è org, –µ—Å–ª–∏ –µ—ë –Ω–µ—Ç.

### –≠—Ç–∞–ø 5: –ü–æ—á–∏—Å—Ç–∏—Ç—å –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ role

**–î–µ–π—Å—Ç–≤–∏–µ:** –ü–æ–Ω–∏–∑–∏—Ç—å –≤—Å–µ—Ö "–ª–æ–∂–Ω—ã—Ö owner'–æ–≤" –¥–æ admin.

**–ö—Ä–∏—Ç–µ—Ä–∏–π –ª–æ–∂–Ω–æ–≥–æ owner:**
- `role = 'owner'`
- `role_source = 'telegram_admin'`
- –ù–ï —è–≤–ª—è–µ—Ç—Å—è owner_user_id –≤ organizations

---

## ‚ö†Ô∏è –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∏

### –ß—Ç–æ –ù–ï –¥–æ–ª–∂–Ω–æ —Å–ª–æ–º–∞—Ç—å—Å—è:

1. **–ù–∞—Å—Ç–æ—è—â–∏–π owner –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏:**
   - –î–æ–ª–∂–µ–Ω –æ—Å—Ç–∞—Ç—å—Å—è owner
   - –î–∞–∂–µ –µ—Å–ª–∏ –Ω–µ creator –≤ –≥—Ä—É–ø–ø–∞—Ö
   - –ü—Ä–æ–≤–µ—Ä–∫–∞: `organizations.owner_user_id`

2. **–î–æ—Å—Ç—É–ø –∫ —Ñ—É–Ω–∫—Ü–∏—è–º owner:**
   - –°—Ç—Ä–∞–Ω–∏—Ü—ã –Ω–∞—Å—Ç—Ä–æ–µ–∫
   - –î–æ–±–∞–≤–ª–µ–Ω–∏–µ/—É–¥–∞–ª–µ–Ω–∏–µ –∞–¥–º–∏–Ω–æ–≤
   - Billing (–µ—Å–ª–∏ –µ—Å—Ç—å)

3. **–û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤ UI:**
   - Owner –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ–¥–∏–Ω
   - Admins - –≤—Å–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ
   - Indication "üëë –≤–ª–∞–¥–µ–ª–µ—Ü –≤ –≥—Ä—É–ø–ø–∞—Ö" –¥–ª—è creator'–æ–≤

4. **–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è:**
   - –ù–µ –¥–æ–ª–∂–Ω–∞ —Å–ª–æ–º–∞—Ç—å—Å—è
   - user_telegram_accounts –¥–æ–ª–∂–Ω—ã —Å–æ–∑–¥–∞–≤–∞—Ç—å—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

### –¢–µ—Å—Ç–æ–≤—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏:

1. **–ù–∞—Å—Ç–æ—è—â–∏–π owner –Ω–µ –≤ –≥—Ä—É–ø–ø–∞—Ö:**
   - –ù–µ –¥–æ–ª–∂–µ–Ω –ø–æ—Ç–µ—Ä—è—Ç—å —Ä–æ–ª—å owner
   
2. **Admin —Å—Ç–∞–ª creator –≤ –≥—Ä—É–ø–ø–µ:**
   - –î–æ–ª–∂–µ–Ω –æ—Å—Ç–∞—Ç—å—Å—è admin (–Ω–µ –ø–æ–≤—ã—Å–∏—Ç—å—Å—è –¥–æ owner)
   - –î–æ–ª–∂–µ–Ω –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å—Å—è "üëë –≤–ª–∞–¥–µ–ª–µ—Ü –≤ –≥—Ä—É–ø–ø–∞—Ö"

3. **Owner –ø–æ–∫–∏–Ω—É–ª –≤—Å–µ –≥—Ä—É–ø–ø—ã:**
   - –î–æ–ª–∂–µ–Ω –æ—Å—Ç–∞—Ç—å—Å—è owner –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏
   - Membership –Ω–µ –¥–æ–ª–∂–Ω–æ —É–¥–∞–ª–∏—Ç—å—Å—è

4. **–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–ª—Å—è —á–µ—Ä–µ–∑ Telegram:**
   - –î–æ–ª–∂–Ω–∞ —Å–æ–∑–¥–∞—Ç—å—Å—è –∑–∞–ø–∏—Å—å –≤ user_telegram_accounts
   - has_verified_telegram –¥–æ–ª–∂–Ω–æ —Å—Ç–∞—Ç—å true

---

## üõ†Ô∏è –†–µ–∞–ª–∏–∑–∞—Ü–∏—è

–°–æ–∑–¥–∞–º 3 –º–∏–≥—Ä–∞—Ü–∏–∏ –ø–æ –ø–æ—Ä—è–¥–∫—É:

### –ú–∏–≥—Ä–∞—Ü–∏—è 062: –ò—Å–ø—Ä–∞–≤–∏—Ç—å –ª–æ–≥–∏–∫—É role
- –û–±–Ω–æ–≤–∏—Ç—å sync_telegram_admins
- –î–æ–±–∞–≤–∏—Ç—å –∑–∞—â–∏—Ç—É owner
- –ù–ï –ø–æ–≤—ã—à–∞—Ç—å –¥–æ owner —á–µ—Ä–µ–∑ Telegram

### –ú–∏–≥—Ä–∞—Ü–∏—è 063: –ò—Å–ø—Ä–∞–≤–∏—Ç—å VIEW organization_admins
- –ì–ª–æ–±–∞–ª—å–Ω—ã–π –ø–æ–∏—Å–∫ user_telegram_accounts
- –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π LEFT JOIN —á–µ—Ä–µ–∑ LATERAL

### –ú–∏–≥—Ä–∞—Ü–∏—è 064: –ü–æ—á–∏—Å—Ç–∏—Ç—å –¥–∞–Ω–Ω—ã–µ
- –ü–æ–Ω–∏–∑–∏—Ç—å –ª–æ–∂–Ω—ã—Ö owner'–æ–≤
- –°–æ–∑–¥–∞—Ç—å –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏–µ user_telegram_accounts

---

## üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

```sql
-- 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ owner'–æ–≤ (–¥–æ–ª–∂–Ω–æ –±—ã—Ç—å —Ä–æ–≤–Ω–æ 1 –Ω–∞ org)
SELECT org_id, COUNT(*) as owners_count
FROM memberships
WHERE role = 'owner'
GROUP BY org_id
HAVING COUNT(*) > 1;

-- 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è owner –≤ memberships –∏ organizations
SELECT 
  o.id as org_id,
  o.owner_user_id as real_owner,
  m.user_id as membership_owner
FROM organizations o
LEFT JOIN memberships m ON m.org_id = o.id AND m.role = 'owner'
WHERE o.owner_user_id != m.user_id;

-- 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ has_verified_telegram
SELECT 
  oa.user_id,
  oa.has_verified_telegram as view_value,
  EXISTS(
    SELECT 1 FROM user_telegram_accounts uta 
    WHERE uta.user_id = oa.user_id AND uta.is_verified = true
  ) as should_be
FROM organization_admins oa
WHERE oa.has_verified_telegram != EXISTS(
  SELECT 1 FROM user_telegram_accounts uta 
  WHERE uta.user_id = oa.user_id AND uta.is_verified = true
);
```

---

–ü—Ä–∏—Å—Ç—É–ø–∞—é –∫ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏! üöÄ


