# ะกัะฐััั ะผะธะณัะฐัะธะธ ั Supabase

**ะะฐัะฐ ะฟัะพะฒะตัะบะธ:** 2026-01-20

## โ ะงะขะ ะฃะะ ะะะะะะะะะะะ

### 1. **ะะฒัะพัะธะทะฐัะธั** โ ะะะขะะะ
- **ะขะตะบััะตะต:** NextAuth.js + PostgreSQL
- **ะคะฐะนะป:** `lib/auth/unified-auth.ts`
- **ะกัะฐััั:** Supabase Auth ะะ ะธัะฟะพะปัะทัะตััั
- **ะัะพะฒะตัะตะฝะพ:** ะัะต session/user ะทะฐะฟัะพัั ะธะดัั ัะตัะตะท NextAuth

### 2. **ะะฐะทะฐ ะดะฐะฝะฝัั** โ๏ธ ะะะะะะะะซะ ะะะะะ
- **ะะตะฐะปะธะทะฐัะธั:** Proxy-ะฐััะธัะตะบัััะฐ ะฒ `lib/server/supabaseServer.ts`
- **ะะพะณะธะบะฐ:**
  ```typescript
  if (DB_PROVIDER === 'postgres') {
    // โ ะะฐะฟัะพัั .from() ะธ .rpc() โ ะปะพะบะฐะปัะฝัะน PostgreSQL
  } else {
    // โ ะะฐะฟัะพัั ะธะดัั ะฝะฐ Supabase (default)
  }
  ```

### 3. **Storage** โ๏ธ ะะะะะข ะะกะะะะฌะะะะะขะฌ SUPABASE
- **ะขะตะบััะตะต:** Selectel S3 ะบะฐะบ primary, Supabase Storage ะบะฐะบ fallback
- **ะคะฐะนะป:** `lib/storage/`
- **ะกัะฐััั:** ะะฐะฑะพัะฐะตั ะฑะตะท Supabase, ะตัะปะธ S3 ะฝะฐัััะพะตะฝ

---

## โ๏ธ ะะะะขะะงะะกะะะฏ ะะะะะะะะ

### ะะตัะตะผะตะฝะฝะฐั ะพะบััะถะตะฝะธั `DB_PROVIDER`

**ะงัะพ ััะพ:**
- ะะฟัะตะดะตะปัะตั ะบัะดะฐ ะธะดัั ะทะฐะฟัะพัั ะบ ะะ
- ะัะปะธ ะฝะต ัััะฐะฝะพะฒะปะตะฝะฐ โ **ะทะฐะฟัะพัั ะธะดัั ะฝะฐ Supabase** โ
- ะัะปะธ `DB_PROVIDER=postgres` โ ะทะฐะฟัะพัั ะฝะฐ ะปะพะบะฐะปัะฝัะน PostgreSQL โ

**ะัะพะฒะตัะบะฐ ะฝะฐ ะฟัะพะดะต:**
```bash
# SSH ะฝะฐ ัะตัะฒะตั
echo $DB_PROVIDER
# ะะพะปะถะฝะพ ะฑััั: postgres
```

**ะัะปะธ ะฝะต ัััะฐะฝะพะฒะปะตะฝะฐ - ะดะพะฑะฐะฒะธัั ะฒ `.env`:**
```env
DB_PROVIDER=postgres
DATABASE_URL=postgresql://orbo:PASSWORD@postgres:5432/orbo
```

---

## ๐ ะะะะกะขะะะฏ ะะะฏ ะะะะะะะ ะะขะะะฎะงะะะะฏ SUPABASE

### ะจะฐะณ 1: ะัะพะฒะตัะธัั `DB_PROVIDER` โ ะกะะะะะขะฌ ะกะะะงะะก
```bash
# ะะฐ ัะตัะฒะตัะต:
cd /var/www/orbo
grep DB_PROVIDER .env

# ะัะปะธ ะฝะตั - ะดะพะฑะฐะฒะธัั:
echo "DB_PROVIDER=postgres" >> .env
docker-compose restart app
```

### ะจะฐะณ 2: ะัะพะฒะตัะธัั ััะพ ะฒัะต ัะฐะฑะพัะฐะตั โ ะขะะกะขะะะะะะขะฌ
ะะพัะปะต ัััะฐะฝะพะฒะบะธ `DB_PROVIDER=postgres`:
1. ะัะบัััั ะดะฐัะฑะพัะด โ ะดะพะปะถะตะฝ ะทะฐะณััะทะธัััั
2. ะัะบัััั ัะฟะธัะพะบ ััะฐััะฝะธะบะพะฒ โ ะดะพะปะถะฝั ะพัะพะฑัะฐะถะฐัััั
3. ะกะพะทะดะฐัั ัะพะฑััะธะต โ ะดะพะปะถะฝะพ ัะพััะฐะฝะธัััั
4. ะะฒัะพัะธะทะพะฒะฐัััั โ ะดะพะปะถะฝะพ ัะฐะฑะพัะฐัั

**ะัะต ะทะฐะฟัะพัั ัะตะฟะตัั ะธะดัั ะฝะฐ ะปะพะบะฐะปัะฝัะน PostgreSQL!**

### ะจะฐะณ 3: ะฃะดะฐะปะธัั Supabase credentials (ะพะฟัะธะพะฝะฐะปัะฝะพ) โณ ะะะกะะ ะขะะกะขะะ
ะัะปะธ ะฒัั ัะฐะฑะพัะฐะตั 7+ ะดะฝะตะน ะฑะตะท Supabase:
```bash
# ะะพะถะฝะพ ัะดะฐะปะธัั ะธะท .env:
# NEXT_PUBLIC_SUPABASE_URL
# NEXT_PUBLIC_SUPABASE_ANON_KEY
# SUPABASE_SERVICE_ROLE_KEY
```

โ๏ธ **ะะ:** ะัะปะธ ะธัะฟะพะปัะทัะตัะต Supabase Storage ะดะปั ัะฐะนะปะพะฒ - ะพััะฐะฒััะต credentials!

### ะจะฐะณ 4: Cleanup ะบะพะดะฐ (ะฑัะดััะตะต) ๐ ะะะกะะ ะะะะะะะ ะะขะะะฎะงะะะะฏ
ะะพัะปะต ัะดะฐะปะตะฝะธั Supabase ะฟัะพะตะบัะฐ:
1. ะะตัะตะธะผะตะฝะพะฒะฐัั `lib/server/supabaseServer.ts` โ `postgresServer.ts`
2. ะฃะฑัะฐัั Proxy ะปะพะณะธะบั (ะพััะฐะฝะตััั ัะพะปัะบะพ direct PostgreSQL)
3. ะฃะดะฐะปะธัั `@supabase/ssr` ะธ `@supabase/supabase-js` ะธะท ะทะฐะฒะธัะธะผะพััะตะน

---

## ๐ฏ ะะขะะ

### ะกะตะนัะฐั:
```
โโโโโโโโโโโโโโโโโโโ
โ   adminSupabase โ  โ ะญัะพ ะฟัะพััะพ ะฝะฐะทะฒะฐะฝะธะต ะฟะตัะตะผะตะฝะฝะพะน!
โโโโโโโโโโฌโโโโโโโโโ
         โ
         โโ if DB_PROVIDER=postgres โ PostgreSQL โ
         โ
         โโ if DB_PROVIDER ะฝะต ัััะฐะฝะพะฒะปะตะฝ โ Supabase โ
```

### ะะพัะปะต ัััะฐะฝะพะฒะบะธ `DB_PROVIDER=postgres`:
```
โโโโโโโโโโโโโโโโโโโ
โ   adminSupabase โ  โ (ัััะฐัะตะฒัะตะต ะฝะฐะทะฒะฐะฝะธะต)
โโโโโโโโโโฌโโโโโโโโโ
         โ
         โโโโโโโโโโโ PostgreSQL ะะกะะะะ โ
```

---

## โ CHECKLIST ะะะะะ ะฃะะะะะะะะ SUPABASE

- [ ] `DB_PROVIDER=postgres` ัััะฐะฝะพะฒะปะตะฝ ะฒ `.env`
- [ ] ะัะธะปะพะถะตะฝะธะต ะฟะตัะตะทะฐะฟััะตะฝะพ ะฟะพัะปะต ะธะทะผะตะฝะตะฝะธั env
- [ ] ะะฒัะพัะธะทะฐัะธั ัะฐะฑะพัะฐะตั (NextAuth)
- [ ] ะะฐัะฑะพัะด ะทะฐะณััะถะฐะตััั ะฑััััะพ (<1s)
- [ ] ะฃัะฐััะฝะธะบะธ ะพัะพะฑัะฐะถะฐัััั
- [ ] ะกะพะฑััะธั ัะพะทะดะฐัััั ะธ ะพัะพะฑัะฐะถะฐัััั
- [ ] Telegram ะณััะฟะฟั ะฟะพะดะบะปััะฐัััั
- [ ] ะะฐะณััะทะบะฐ ัะฐะนะปะพะฒ ัะฐะฑะพัะฐะตั (ะตัะปะธ ะธัะฟะพะปัะทัะตััั S3)
- [ ] ะขะตััะธัะพะฒะฐะปะธ 7+ ะดะฝะตะน ะฑะตะท ะฟัะพะฑะปะตะผ
- [ ] ะะตะทะตัะฒะฝัะต ะบะพะฟะธะธ ะะ ะฝะฐัััะพะตะฝั

**ะะพัะปะต ะฒัะฟะพะปะฝะตะฝะธั ัะตะบะปะธััะฐ - ะผะพะถะฝะพ ัะดะฐะปััั Supabase ะฟัะพะตะบั!** ๐

---

## ๐ ะะะะะะะะะ

ะัะปะธ ะฟะพัะปะต ัััะฐะฝะพะฒะบะธ `DB_PROVIDER=postgres` ััะพ-ัะพ ัะปะพะผะฐะปะพัั:
1. ะัะพะฒะตัะธัั ะปะพะณะธ: `docker-compose logs app -f`
2. ะัะพะฒะตัะธัั ะฟะพะดะบะปััะตะฝะธะต ะบ ะะ: `docker-compose exec postgres psql -U orbo -c "\dt"`
3. ะัะบะฐัะธัั: `export DB_PROVIDER=` ะธ ะฟะตัะตะทะฐะฟัััะธัั

**ะ 99% ัะปััะฐะตะฒ ะฒัะต ัะฐะฑะพัะฐะตั ััะฐะทั ะฟะพัะปะต ัััะฐะฝะพะฒะบะธ ะฟะตัะตะผะตะฝะฝะพะน.**
