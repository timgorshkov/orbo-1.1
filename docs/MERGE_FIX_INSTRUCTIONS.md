# ะะฝััััะบัะธั ะฟะพ ะฟัะธะผะตะฝะตะฝะธั ะธัะฟัะฐะฒะปะตะฝะธะน ะพะฑัะตะดะธะฝะตะฝะธั ััะฐััะฝะธะบะพะฒ

## ะัััััะน ััะฐัั

### ะจะฐะณ 1: ะัะธะผะตะฝะธัั SQL ะผะธะณัะฐัะธั

```bash
# ะัะบัะพะนัะต Supabase SQL Editor
# ะกะบะพะฟะธััะนัะต ะธ ะฒัะฟะพะปะฝะธัะต ัะพะดะตัะถะธะผะพะต ัะฐะนะปะฐ:
db/migrations/26_fix_merge_smart_reload.sql
```

**ะงัะพ ะธัะฟัะฐะฒะปัะตั**: ะะตัะตะทะฐะณััะทะบั ะดะฐะฝะฝัั target ััะฐััะฝะธะบะฐ ะฟัะธ ะพะฑัะฐะฑะพัะบะต ะฝะตัะบะพะปัะบะธั ะดัะฑะปะธะบะฐัะพะฒ.

### ะจะฐะณ 2: ะะฐะดะตะฟะปะพะธัั ะธะทะผะตะฝะตะฝะธั ะบะพะดะฐ

ะัะต ะธะทะผะตะฝะตะฝะธั ัะถะต ะฒะฝะตัะตะฝั ะฒ ัะปะตะดัััะธะต ัะฐะนะปั:
- โ `app/app/[org]/members/page.tsx` - ัะธะปััั ะพะฑัะตะดะธะฝะตะฝะฝัั ะฒ ัะฟะธัะบะต
- โ `components/members/participant-profile-card.tsx` - ะพัะพะฑัะฐะถะตะฝะธะต traits
- โ `lib/services/participants/matcher.ts` - ะธัะบะปััะตะฝะธะต ะพะฑัะตะดะธะฝะตะฝะฝัั ะธะท ะฟะพะธัะบะฐ
- โ `app/api/participants/[participantId]/route.ts` - ัะปัััะตะฝะฝะพะต ะปะพะณะธัะพะฒะฐะฝะธะต

**ะะตะนััะฒะธะต**: ะัะพััะพ ะทะฐะดะตะฟะปะพะนัะต ะบะพะด ะฝะฐ Vercel.

### ะจะฐะณ 3: ะัะพะฒะตัะบะฐ

1. **ะกะฟะธัะพะบ ััะฐััะฝะธะบะพะฒ**:
   ```
   - ะัะบัะพะนัะต /app/[org]/members
   - ะฃะฑะตะดะธัะตัั ััะพ ะพะฑัะตะดะธะฝะตะฝะฝัะต ััะฐััะฝะธะบะธ ะฝะต ะพัะพะฑัะฐะถะฐัััั
   - ะะพะปะธัะตััะฒะพ ััะฐััะฝะธะบะพะฒ ะดะพะปะถะฝะพ ัะผะตะฝััะธัััั
   ```

2. **ะะฑัะตะดะธะฝะตะฝะธะต ะดัะฑะปะธะบะฐัะพะฒ**:
   ```
   - ะัะบัะพะนัะต ะฟัะพัะธะปั ะปัะฑะพะณะพ ััะฐััะฝะธะบะฐ
   - ะะตัะตะนะดะธัะต ะฝะฐ ะฒะบะปะฐะดะบั "ะัะฑะปะธะบะฐัั"
   - ะะฐะถะผะธัะต "ะะฑะฝะพะฒะธัั ัะฟะธัะพะบ"
   - ะะฑัะตะดะธะฝะธัะต ั ะฒัะฑัะฐะฝะฝัะผ ะดัะฑะปะธะบะฐัะพะผ
   - ะัะพะฒะตัััะต ะฒัะฟะปัะฒะฐััะตะต ะพะบะฝะพ ั ัะตะทัะปััะฐัะฐะผะธ
   ```

3. **ะฅะฐัะฐะบัะตัะธััะธะบะธ ะฒ ะฟัะพัะธะปะต**:
   ```
   - ะะพัะปะต ะพะฑัะตะดะธะฝะตะฝะธั ะพัะบัะพะตััั ะฟัะพัะธะปั
   - ะ ัะฐะทะดะตะปะต "ะะพะฟะพะปะฝะธัะตะปัะฝะฐั ะธะฝัะพัะผะฐัะธั" ะดะพะปะถะฝั ะฑััั:
     * ะะฐะฟะพะปะฝะตะฝะฝัะต ะฟะพะปั (ะตัะปะธ ะฑัะปะธ ะฟััััะต)
     * ะฅะฐัะฐะบัะตัะธััะธะบะธ ะธะท ะฑะฐะทั ะดะฐะฝะฝัั
     * ะะพะฝัะปะธะบัั ั ัะฝัะฐัะฝัะผ ัะพะฝะพะผ ะธ ะผะตัะบะพะน "ะะท ะพะฑัะตะดะธะฝะตะฝะธั"
   ```

---

## ะงัะพ ะธัะฟัะฐะฒะปะตะฝะพ

### โ ะัะพะฑะปะตะผะฐ 1: ะัะฑะปะธ ะฝะต ะธััะตะทะฐัั ะธะท ัะฟะธัะบะฐ

**ะะพ**: ะะพัะปะต ะพะฑัะตะดะธะฝะตะฝะธั ะฒ ัะฟะธัะบะต ะฒัะต ะตัะต ะฒะธััั ะพะฑะฐ ะฟัะพัะธะปั  
**ะะพัะปะต**: ะะฑัะตะดะธะฝะตะฝะฝัะน ะฟัะพัะธะปั ะฐะฒัะพะผะฐัะธัะตัะบะธ ัะบััะฒะฐะตััั

### โ ะัะพะฑะปะตะผะฐ 2: ะะพะปั ะฝะต ะทะฐะฟะพะปะฝััััั

**ะะพ**: ะัะฟะปัะฒะฐััะตะต ะพะบะฝะพ ะณะพะฒะพัะธั "ะทะฐะฟะพะปะฝะตะฝะพ", ะฝะพ ะฟัะพัะธะปั ะฟัััะพะน  
**ะะพัะปะต**: ะัะต ะฟะพะปั ะบะพััะตะบัะฝะพ ะทะฐะฟะพะปะฝััััั ะธ ะพัะพะฑัะฐะถะฐัััั

### โ ะัะพะฑะปะตะผะฐ 3: ะฅะฐัะฐะบัะตัะธััะธะบะธ ะฝะต ะฒะธะดะฝั

**ะะพ**: ะะพะฝัะปะธะบัั "ัะพััะฐะฝะตะฝั", ะฝะพ ะธั ะฝะธะณะดะต ะฝะตั  
**ะะพัะปะต**: ะะพะฝัะปะธะบัั ะพัะพะฑัะฐะถะฐัััั ะฒ ะฟัะพัะธะปะต ั ะฟะพะดัะพะฑะฝะพัััะผะธ

---

## ะะธะทัะฐะปัะฝัะต ะธะฝะดะธะบะฐัะพัั

ะะพัะปะต ะพะฑัะตะดะธะฝะตะฝะธั ะฒ ะฟัะพัะธะปะต ะฒั ัะฒะธะดะธัะต:

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ ะะพะฟะพะปะฝะธัะตะปัะฝะฐั ะธะฝัะพัะผะฐัะธั                           โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ ะฅะฐัะฐะบัะตัะธััะธะบะธ ะธะท ะฑะฐะทั ะดะฐะฝะฝัั                       โ
โ                                                     โ
โ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ    โ
โ โ EMAIL_MERGED            [ะะท ะพะฑัะตะดะธะฝะตะฝะธั] ๐ก โ    โ
โ โ old.email@example.com                       โ    โ
โ โ ะะพะฝัะปะธะบั ั: new.email@example.com           โ    โ
โ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ    โ
โ                                                     โ
โ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ    โ
โ โ PHONE_MERGED            [ะะท ะพะฑัะตะดะธะฝะตะฝะธั] ๐ก โ    โ
โ โ +79991234567                                โ    โ
โ โ ะะพะฝัะปะธะบั ั: +79995554433                    โ    โ
โ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ    โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

๐ก = ะฏะฝัะฐัะฝัะน ัะพะฝ (bg-amber-50 border-amber-200)

---

## Troubleshooting

### ะัะพะฑะปะตะผะฐ: ะะธะณัะฐัะธั ะฝะต ะฟัะธะผะตะฝะธะปะฐัั

```sql
-- ะัะพะฒะตัะธัั ะฒะตััะธั ััะฝะบัะธะธ
SELECT routine_name, routine_definition
FROM information_schema.routines
WHERE routine_name = 'merge_participants_smart';

-- ะะพะปะถะตะฝ ะฑััั ะบะพะผะผะตะฝัะฐัะธะน: "ะะตััะธั 26: ะฟะตัะตะทะฐะณััะถะฐะตั target record"
```

### ะัะพะฑะปะตะผะฐ: ะัะฑะปะธ ะฒัะต ะตัะต ะฒ ัะฟะธัะบะต

```sql
-- ะัะพะฒะตัะธัั ััะพ merged_into ัััะฐะฝะพะฒะปะตะฝ
SELECT id, full_name, merged_into
FROM participants
WHERE org_id = 'your-org-id'
ORDER BY merged_into NULLS FIRST;

-- ะัะปะธ merged_into NULL, ะฝะพ ััะฐััะฝะธะบ ะดะพะปะถะตะฝ ะฑััั ะพะฑัะตะดะธะฝะตะฝ:
-- ะะพะฟัะพะฑัะนัะต ะพะฑัะตะดะธะฝะธัั ะทะฐะฝะพะฒะพ
```

### ะัะพะฑะปะตะผะฐ: ะฅะฐัะฐะบัะตัะธััะธะบะธ ะฝะต ะพัะพะฑัะฐะถะฐัััั

1. ะัะพะฒะตัััะต ะฒ SQL ััะพ traits ัะพะทะดะฐะฝั:
```sql
SELECT * FROM participant_traits
WHERE participant_id = 'target-participant-id'
AND source = 'merge';
```

2. ะัะพะฒะตัััะต ะฒ ะฑัะฐัะทะตัะต DevTools โ Network:
```
GET /app/[org]/members/[id]
โ Response ะดะพะปะถะตะฝ ัะพะดะตัะถะฐัั traits: [...]
```

3. ะัะธััะธัะต ะบะตั ะฑัะฐัะทะตัะฐ ะธ ะฟะตัะตะทะฐะณััะทะธัะต ัััะฐะฝะธัั

---

## ะะพะณะธ ะดะปั ะพัะปะฐะดะบะธ

ะะพัะปะต ะดะตะฟะปะพั ะฒ ะบะพะฝัะพะปะธ ะฑัะฐัะทะตัะฐ (DevTools โ Console) ะฒั ัะฒะธะดะธัะต:

```
Finding matches for: { orgId: "...", email: "...", ... }
Exact matches found: 2
Fuzzy matches found: 1
Total matches returned: 3
```

ะ ะปะพะณะฐั Vercel (ะดะปั API ะทะฐะฟัะพัะพะฒ):

```
Merge check - Current participant: {
  id: "uuid-a",
  merged_into: null,
  status: "participant",
  canonicalId: "uuid-a"
}
Merge check - Target participant: {
  id: "uuid-b",
  merged_into: null,
  status: "participant",
  targetCanonical: "uuid-b"
}
```

---

## Rollback (ะตัะปะธ ะฝัะถะฝะพ)

### ะัะบะฐัะธัั SQL ะผะธะณัะฐัะธั:

```sql
-- ะะพัััะฐะฝะพะฒะธัั ััะฐััั ะฒะตััะธั ััะฝะบัะธะธ
-- (ะกะบะพะฟะธััะนัะต ะธะท db/migrations/25_merge_participants_smart.sql)
```

### ะัะบะฐัะธัั ะบะพะด:

```bash
git revert HEAD
git push
```

---

## ะะพะฝัะฐะบัั

ะัะปะธ ะฒะพะทะฝะธะบะปะธ ะฟัะพะฑะปะตะผั:
1. ะัะพะฒะตัััะต ะปะพะณะธ Vercel
2. ะัะพะฒะตัััะต Supabase Database Logs
3. ะะพัะผะพััะธัะต `MERGE_FULL_FIX.md` ะดะปั ะดะตัะฐะปัะฝะพะณะพ ะพะฟะธัะฐะฝะธั
4. ะัะพะฒะตัััะต `MERGE_ERROR_FIX.md` ะดะปั ะธะฝัะพัะผะฐัะธะธ ะพ ะดััะณะธั ะพัะธะฑะบะฐั

---

## ะะพะปะตะทะฝัะต SQL ะทะฐะฟัะพัั

### ะกัะฐัะธััะธะบะฐ ะพะฑัะตะดะธะฝะตะฝะธะน

```sql
SELECT 
  COUNT(*) FILTER (WHERE merged_into IS NULL) as active_participants,
  COUNT(*) FILTER (WHERE merged_into IS NOT NULL) as merged_participants,
  COUNT(DISTINCT merged_into) FILTER (WHERE merged_into IS NOT NULL) as canonical_participants
FROM participants
WHERE org_id = 'your-org-id';
```

### ะะพัะปะตะดะฝะธะต ะพะฑัะตะดะธะฝะตะฝะธั

```sql
SELECT 
  p.id,
  p.full_name,
  p.merged_into,
  p.updated_at,
  c.full_name as canonical_name
FROM participants p
LEFT JOIN participants c ON c.id = p.merged_into
WHERE p.org_id = 'your-org-id'
  AND p.merged_into IS NOT NULL
ORDER BY p.updated_at DESC
LIMIT 10;
```

### Traits ะธะท ะพะฑัะตะดะธะฝะตะฝะธะน

```sql
SELECT 
  t.participant_id,
  p.full_name,
  t.trait_key,
  t.trait_value,
  t.metadata,
  t.created_at
FROM participant_traits t
JOIN participants p ON p.id = t.participant_id
WHERE p.org_id = 'your-org-id'
  AND t.source = 'merge'
ORDER BY t.created_at DESC
LIMIT 20;
```

---

## ะกะปะตะดัััะธะต ัะฐะณะธ

ะะพัะปะต ััะฟะตัะฝะพะณะพ ะฟัะธะผะตะฝะตะฝะธั ะธัะฟัะฐะฒะปะตะฝะธะน:

1. โ ะัะพะฒะตัััะต ััะพ ะฒัะต ัะฐะฑะพัะฐะตั ะฝะฐ ะฟัะพะดะฐะบัะตะฝะต
2. โ ะะฑัะตะดะธะฝะธัะต ะฝะตัะบะพะปัะบะพ ัะตััะพะฒัั ะดัะฑะปะธะบะฐัะพะฒ
3. โ ะฃะฑะตะดะธัะตัั ััะพ ะดะฐะฝะฝัะต ะฝะต ัะตัััััั
4. โ ะัะพะฒะตัััะต ััะพ ัะฐัะฐะบัะตัะธััะธะบะธ ะพัะพะฑัะฐะถะฐัััั
5. โ ะฃะดะฐะปะธัะต ัะตััะพะฒัั ััะฐััะฝะธะบะพะฒ (ะตัะปะธ ัะพะทะดะฐะฒะฐะปะธ)

**ะะพัะพะฒะพ! ะกะธััะตะผะฐ ะพะฑัะตะดะธะฝะตะฝะธั ััะฐััะฝะธะบะพะฒ ัะตะฟะตัั ัะฐะฑะพัะฐะตั ะบะพััะตะบัะฝะพ.** ๐

