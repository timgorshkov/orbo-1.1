# Fix: –ù–µ –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –¥–æ—Å—Ç—É–ø–Ω—ã–µ Telegram –≥—Ä—É–ø–ø—ã

**–ü—Ä–æ–±–ª–µ–º–∞:** –ü–æ—Å–ª–µ –æ—á–∏—Å—Ç–∫–∏ –ë–î –∏ –ø—Ä–∏–≤—è–∑–∫–∏ Telegram –∞–∫–∫–∞—É–Ω—Ç–∞ —Å–ø–∏—Å–æ–∫ "–î–æ—Å—Ç—É–ø–Ω—ã–µ Telegram –≥—Ä—É–ø–ø—ã" –ø—É—Å—Ç, —Ö–æ—Ç—è –±–æ—Ç –¥–æ–±–∞–≤–ª–µ–Ω –≤ 4 –≥—Ä—É–ø–ø—ã.

**–ü—Ä–∏—á–∏–Ω–∞:** –ü–æ—Å–ª–µ –æ—á–∏—Å—Ç–∫–∏ –ë–î —É–¥–∞–ª–∏–ª–∏—Å—å –≤—Å–µ –∑–∞–ø–∏—Å–∏ –∏–∑ `telegram_groups` –∏ `telegram_group_admins`. –°–∏—Å—Ç–µ–º–∞ –Ω–µ –∑–Ω–∞–µ—Ç –æ –≤–∞—à–∏—Ö –≥—Ä—É–ø–ø–∞—Ö.

---

## üîç –®–∞–≥ 1: –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ (1 –º–∏–Ω—É—Ç–∞)

–í—ã–ø–æ–ª–Ω–∏—Ç–µ –≤ **Supabase SQL Editor**:

```sql
-- –°–∫–æ–ø–∏—Ä—É–π—Ç–µ –≤–µ—Å—å –∫–æ–¥ –∏–∑ db/CHECK_TELEGRAM_GROUPS.sql
-- –ò–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —ç—Ç–æ—Ç –±—ã—Å—Ç—Ä—ã–π –∑–∞–ø—Ä–æ—Å:

SELECT 
  'telegram_groups' as table_name, 
  COUNT(*) as count 
FROM telegram_groups
UNION ALL
SELECT 'telegram_group_admins', COUNT(*) FROM telegram_group_admins
UNION ALL
SELECT 'user_telegram_accounts (verified)', COUNT(*) 
FROM user_telegram_accounts WHERE is_verified = true;
```

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
- `telegram_groups`: 0 (–ø—Ä–æ–±–ª–µ–º–∞!)
- `telegram_group_admins`: 0 (–ø—Ä–æ–±–ª–µ–º–∞!)
- `user_telegram_accounts`: 1 (–≤–∞—à –∞–∫–∫–∞—É–Ω—Ç)

---

## ‚ö° –®–∞–≥ 2: –†–µ—à–µ–Ω–∏–µ - –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–∞–≤ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞

### –í–∞—Ä–∏–∞–Ω—Ç A: –ß–µ—Ä–µ–∑ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)

1. **–û—Ç–∫—Ä–æ–π—Ç–µ** `https://app.orbo.ru/app/[YOUR_ORG_ID]/telegram/account`
   - –ó–∞–º–µ–Ω–∏—Ç–µ `[YOUR_ORG_ID]` –Ω–∞ ID –≤–∞—à–µ–π –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏

2. **–ù–∞–π–¥–∏—Ç–µ –∫–Ω–æ–ø–∫—É** "–û–±–Ω–æ–≤–∏—Ç—å –ø—Ä–∞–≤–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤"

3. **–ù–∞–∂–º–∏—Ç–µ** –∏ –¥–æ–∂–¥–∏—Ç–µ—Å—å –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è

**–ß—Ç–æ –ø—Ä–æ–∏–∑–æ–π–¥—ë—Ç:**
- –ë–æ—Ç –∑–∞–ø—Ä–æ—Å–∏—Ç —Å–ø–∏—Å–æ–∫ –≤–∞—à–∏—Ö –≥—Ä—É–ø–ø —á–µ—Ä–µ–∑ Telegram Bot API
- –ù–∞–π–¥—ë—Ç –≥—Ä—É–ø–ø—ã, –≥–¥–µ –≤—ã –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä
- –°–æ–∑–¥–∞—Å—Ç –∑–∞–ø–∏—Å–∏ –≤ `telegram_groups`
- –°–æ–∑–¥–∞—Å—Ç –∑–∞–ø–∏—Å–∏ –≤ `telegram_group_admins`
- –ü–æ—Å–ª–µ —ç—Ç–æ–≥–æ –≥—Ä—É–ø–ø—ã –ø–æ—è–≤—è—Ç—Å—è –≤ —Å–ø–∏—Å–∫–µ!

### –í–∞—Ä–∏–∞–Ω—Ç B: –ß–µ—Ä–µ–∑ API (–µ—Å–ª–∏ –∫–Ω–æ–ø–∫–∞ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç)

–û—Ç–∫—Ä–æ–π—Ç–µ **Browser DevTools ‚Üí Console** –∏ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ:

```javascript
// –ó–∞–º–µ–Ω–∏—Ç–µ YOUR_ORG_ID –Ω–∞ ID –≤–∞—à–µ–π –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏
const orgId = 'YOUR_ORG_ID';

fetch(`/api/telegram/groups/update-admin-rights?orgId=${orgId}`, {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' }
})
.then(res => res.json())
.then(data => {
  console.log('–†–µ–∑—É–ª—å—Ç–∞—Ç:', data);
  alert(`–û–±–Ω–æ–≤–ª–µ–Ω–æ: ${data.updated} –∏–∑ ${data.total} –≥—Ä—É–ø–ø`);
})
.catch(err => {
  console.error('–û—à–∏–±–∫–∞:', err);
});
```

### –í–∞—Ä–∏–∞–Ω—Ç C: –ß–µ—Ä–µ–∑ SQL (—Ä—É—á–Ω–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è)

–ï—Å–ª–∏ –≤–∞—Ä–∏–∞–Ω—Ç—ã A –∏ B –Ω–µ —Ä–∞–±–æ—Ç–∞—é—Ç, –º–æ–∂–Ω–æ –≤—Ä—É—á–Ω—É—é –¥–æ–±–∞–≤–∏—Ç—å –æ–¥–Ω—É –≥—Ä—É–ø–ø—É –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:

```sql
-- –ó–ê–ú–ï–ù–ò–¢–ï –∑–Ω–∞—á–µ–Ω–∏—è –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–µ!
-- –í–∞–º –Ω—É–∂–Ω–æ —É–∑–Ω–∞—Ç—å:
-- 1. ID –≤–∞—à–µ–π Telegram –≥—Ä—É–ø–ø—ã (–æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω–æ–µ —á–∏—Å–ª–æ, –Ω–∞–ø—Ä–∏–º–µ—Ä -1001234567890)
-- 2. –ù–∞–∑–≤–∞–Ω–∏–µ –≤–∞—à–µ–π –≥—Ä—É–ø–ø—ã
-- 3. –í–∞—à Telegram User ID (—á–∏—Å–ª–æ, –Ω–∞–ø—Ä–∏–º–µ—Ä 123456789)

-- –°–æ–∑–¥–∞—ë–º –∑–∞–ø–∏—Å—å –æ –≥—Ä—É–ø–ø–µ
INSERT INTO telegram_groups (
  tg_chat_id,
  title,
  bot_status,
  member_count,
  created_at,
  updated_at
) VALUES (
  -1001234567890, -- –ó–ê–ú–ï–ù–ò–¢–ï –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–π Chat ID
  '–ú–æ—è —Ç–µ—Å—Ç–æ–≤–∞—è –≥—Ä—É–ø–ø–∞', -- –ó–ê–ú–ï–ù–ò–¢–ï –Ω–∞ –Ω–∞–∑–≤–∞–Ω–∏–µ
  'connected',
  1,
  NOW(),
  NOW()
)
ON CONFLICT (tg_chat_id) DO UPDATE
SET 
  title = EXCLUDED.title,
  bot_status = EXCLUDED.bot_status,
  updated_at = NOW()
RETURNING *;

-- –°–æ–∑–¥–∞—ë–º –∑–∞–ø–∏—Å—å –æ –≤–∞—à–∏—Ö –ø—Ä–∞–≤–∞—Ö –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
-- –°–Ω–∞—á–∞–ª–∞ –Ω–∞–π–¥–∏—Ç–µ ID –≤–∞—à–µ–≥–æ user_telegram_account:
SELECT id, telegram_user_id FROM user_telegram_accounts 
WHERE is_verified = true;

-- –ó–∞—Ç–µ–º –≤—Å—Ç–∞–≤—å—Ç–µ –∑–∞–ø–∏—Å—å (–ó–ê–ú–ï–ù–ò–¢–ï –∑–Ω–∞—á–µ–Ω–∏—è!)
INSERT INTO telegram_group_admins (
  user_telegram_account_id,
  tg_chat_id,
  tg_user_id,
  is_admin,
  is_owner,
  can_manage_chat,
  can_delete_messages,
  can_manage_video_chats,
  can_restrict_members,
  can_promote_members,
  can_change_info,
  can_invite_users,
  can_pin_messages,
  created_at,
  updated_at,
  expires_at
) VALUES (
  'UUID_FROM_PREVIOUS_QUERY', -- ID –∏–∑ user_telegram_accounts
  -1001234567890, -- Chat ID –≥—Ä—É–ø–ø—ã
  123456789, -- –í–∞—à Telegram User ID
  true,
  true, -- –ï—Å–ª–∏ –≤—ã –≤–ª–∞–¥–µ–ª–µ—Ü –≥—Ä—É–ø–ø—ã
  true,
  true,
  true,
  true,
  true,
  true,
  true,
  true,
  NOW(),
  NOW(),
  NOW() + INTERVAL '100 years' -- –ü—Ä–∞–≤–∞ –Ω–µ –∏—Å—Ç–µ–∫–∞—é—Ç
);
```

---

## üîç –®–∞–≥ 3: –ü—Ä–æ–≤–µ—Ä–∫–∞

–ü–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–∞–≤:

1. **–û–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É** "–î–æ—Å—Ç—É–ø–Ω—ã–µ Telegram –≥—Ä—É–ø–ø—ã"
2. **–ì—Ä—É–ø–ø—ã –¥–æ–ª–∂–Ω—ã –ø–æ—è–≤–∏—Ç—å—Å—è!**

–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≤ SQL:
```sql
SELECT 
  tg.title,
  tg.bot_status,
  tga.is_admin,
  tga.is_owner
FROM telegram_groups tg
LEFT JOIN telegram_group_admins tga ON tga.tg_chat_id = tg.tg_chat_id
WHERE tg.title IS NOT NULL;
```

---

## üö® –ï—Å–ª–∏ –≥—Ä—É–ø–ø—ã –≤—Å—ë –µ—â—ë –Ω–µ –ø–æ—è–≤–ª—è—é—Ç—Å—è

### –ü—Ä–æ–±–ª–µ–º–∞ 1: Webhook –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
```sql
-- –ï—Å—Ç—å –ª–∏ —Å–æ–±—ã—Ç–∏—è –æ—Ç –±–æ—Ç–∞ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 10 –º–∏–Ω—É—Ç?
SELECT COUNT(*), MAX(created_at) 
FROM activity_events
WHERE tg_chat_id IS NOT NULL
AND created_at > NOW() - INTERVAL '10 minutes';
```

–ï—Å–ª–∏ COUNT = 0 ‚Üí –≤–µ–±—Ö—É–∫ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç!

**–†–µ—à–µ–Ω–∏–µ:** –ü–µ—Ä–µ–Ω–∞—Å—Ç—Ä–æ–π—Ç–µ –≤–µ–±—Ö—É–∫:

1. **–ù–∞–π–¥–∏—Ç–µ –≤–∞—à WEBHOOK_SECRET** –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
2. –í—ã–ø–æ–ª–Ω–∏—Ç–µ –≤ —Ç–µ—Ä–º–∏–Ω–∞–ª–µ:

```bash
# –î–ª—è orbo_community_bot
curl -X POST "https://api.telegram.org/bot<YOUR_BOT_TOKEN>/setWebhook" \
  -H "Content-Type: application/json" \
  -d '{
    "url": "https://app.orbo.ru/api/telegram/webhook",
    "secret_token": "<YOUR_WEBHOOK_SECRET>"
  }'

# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Ç–∞—Ç—É—Å
curl "https://api.telegram.org/bot<YOUR_BOT_TOKEN>/getWebhookInfo"
```

### –ü—Ä–æ–±–ª–µ–º–∞ 2: –ë–æ—Ç –Ω–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –≤ –≥—Ä—É–ø–ø–∞—Ö

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**

1. –û—Ç–∫—Ä–æ–π—Ç–µ –∫–∞–∂–¥—É—é –≥—Ä—É–ø–ø—É –≤ Telegram
2. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≥—Ä—É–ø–ø—ã ‚Üí –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã
3. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ `@orbo_community_bot` –µ—Å—Ç—å –≤ —Å–ø–∏—Å–∫–µ

**–†–µ—à–µ–Ω–∏–µ:** –ï—Å–ª–∏ –±–æ—Ç–∞ –Ω–µ—Ç - –¥–æ–±–∞–≤—å—Ç–µ –µ–≥–æ –∫–∞–∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞

### –ü—Ä–æ–±–ª–µ–º–∞ 3: –í—ã –Ω–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –≤ –≥—Ä—É–ø–ø–∞—Ö

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**

–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ **–≤–∞—à** Telegram –∞–∫–∫–∞—É–Ω—Ç –∏–º–µ–µ—Ç –ø—Ä–∞–≤–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –≤ —ç—Ç–∏—Ö –≥—Ä—É–ø–ø–∞—Ö.

**–†–µ—à–µ–Ω–∏–µ:** –ï—Å–ª–∏ –Ω–µ—Ç - –ø–æ–ø—Ä–æ—Å–∏—Ç–µ –≤–ª–∞–¥–µ–ª—å—Ü–∞ –≥—Ä—É–ø–ø—ã –¥–æ–±–∞–≤–∏—Ç—å –≤–∞—Å –∫–∞–∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞

---

## üìã –ß–µ–∫-–ª–∏—Å—Ç –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏

- [ ] `telegram_groups` —Å–æ–¥–µ—Ä–∂–∏—Ç –∑–∞–ø–∏—Å–∏ –æ –≥—Ä—É–ø–ø–∞—Ö
- [ ] `telegram_group_admins` —Å–æ–¥–µ—Ä–∂–∏—Ç –≤–∞—à–∏ –ø—Ä–∞–≤–∞
- [ ] `user_telegram_accounts` —Å–æ–¥–µ—Ä–∂–∏—Ç –≤–∞—à –≤–µ—Ä–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∞–∫–∫–∞—É–Ω—Ç
- [ ] –ë–æ—Ç –¥–æ–±–∞–≤–ª–µ–Ω –≤ –≥—Ä—É–ø–ø—ã –∫–∞–∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä
- [ ] –í—ã –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –≤ –≥—Ä—É–ø–ø–∞—Ö
- [ ] Webhook —Ä–∞–±–æ—Ç–∞–µ—Ç (–µ—Å—Ç—å —Å–≤–µ–∂–∏–µ `activity_events`)
- [ ] –ö–Ω–æ–ø–∫–∞ "–û–±–Ω–æ–≤–∏—Ç—å –ø—Ä–∞–≤–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤" –æ—Ç—Ä–∞–±–æ—Ç–∞–ª–∞ —É—Å–ø–µ—à–Ω–æ

---

## üéØ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Ä–µ—à–µ–Ω–∏–µ

–ü–æ—Å–ª–µ —Ç–æ–≥–æ –∫–∞–∫ –≤—ã –Ω–∞–∂–º—ë—Ç–µ "–û–±–Ω–æ–≤–∏—Ç—å –ø—Ä–∞–≤–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤", —Å–∏—Å—Ç–µ–º–∞:

1. ‚úÖ –ó–∞–ø—Ä–æ—Å–∏—Ç —É Telegram Bot API —Å–ø–∏—Å–æ–∫ –≤–∞—à–∏—Ö –≥—Ä—É–ø–ø
2. ‚úÖ –î–ª—è –∫–∞–∂–¥–æ–π –≥—Ä—É–ø–ø—ã:
   - –°–æ–∑–¥–∞—Å—Ç –∑–∞–ø–∏—Å—å –≤ `telegram_groups`
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç –ø—Ä–∞–≤–∞ –±–æ—Ç–∞ —á–µ—Ä–µ–∑ `getChatMember`
   - –°–æ—Ö—Ä–∞–Ω–∏—Ç –≤–∞—à–∏ –ø—Ä–∞–≤–∞ –≤ `telegram_group_admins`
3. ‚úÖ –ì—Ä—É–ø–ø—ã –ø–æ—è–≤—è—Ç—Å—è –≤ —Å–ø–∏—Å–∫–µ "–î–æ—Å—Ç—É–ø–Ω—ã–µ Telegram –≥—Ä—É–ø–ø—ã"

---

## üìö –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ñ–∞–π–ª—ã

- `db/CHECK_TELEGRAM_GROUPS.sql` - SQL —Å–∫—Ä–∏–ø—Ç –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏
- `app/api/telegram/groups/update-admin-rights/route.ts` - API –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–∞–≤
- `app/app/[org]/telegram/account/page.tsx` - –°—Ç—Ä–∞–Ω–∏—Ü–∞ —Å –∫–Ω–æ–ø–∫–æ–π –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è

---

**–°–ª–µ–¥—É—é—â–∏–π —à–∞–≥:** –û—Ç–∫—Ä–æ–π—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É Telegram –∞–∫–∫–∞—É–Ω—Ç–∞ –∏ –Ω–∞–∂–º–∏—Ç–µ "–û–±–Ω–æ–≤–∏—Ç—å –ø—Ä–∞–≤–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤" üöÄ

–ï—Å–ª–∏ –Ω–µ –ø–æ–º–æ–≥–ª–æ - –≤—ã–ø–æ–ª–Ω–∏—Ç–µ SQL –ø—Ä–æ–≤–µ—Ä–∫—É –∏ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –º–Ω–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã!

