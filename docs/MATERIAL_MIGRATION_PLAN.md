# –ü–ª–∞–Ω –º–∏–≥—Ä–∞—Ü–∏–∏ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤ (—Å—Ç–∞—Ä–∞—è ‚Üí –Ω–æ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞)

## üéØ –°–∏—Ç—É–∞—Ü–∏—è

**–û–±–Ω–∞—Ä—É–∂–µ–Ω–æ –¥–∞–Ω–Ω—ã—Ö –≤ —Å—Ç–∞—Ä–æ–π —Å–∏—Å—Ç–µ–º–µ:**
- `material_folders`: 1 –∑–∞–ø–∏—Å—å
- `material_items`: 6 –∑–∞–ø–∏—Å–µ–π
- `material_access`: 0 –∑–∞–ø–∏—Å–µ–π

**–ù—É–∂–Ω–æ:** –ü–µ—Ä–µ–Ω–µ—Å—Ç–∏ –¥–∞–Ω–Ω—ã–µ –≤ `material_pages` (–Ω–æ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞)

---

## üìã –ü–õ–ê–ù –î–ï–ô–°–¢–í–ò–ô

### –®–∞–≥ 1: –ü–æ—Å–º–æ—Ç—Ä–∏, —á—Ç–æ –∏–º–µ–Ω–Ω–æ —Ç–∞–º —Ö—Ä–∞–Ω–∏—Ç—Å—è

–í—ã–ø–æ–ª–Ω–∏ –≤ Supabase SQL Editor:

```sql
-- –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ø–∞–ø–∫—É
SELECT id, org_id, parent_id, name, created_at 
FROM material_folders;

-- –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –∞–π—Ç–µ–º—ã
SELECT id, org_id, folder_id, kind, title, 
       substring(content from 1 for 50) as content_preview,
       file_path, url, created_at
FROM material_items
ORDER BY created_at;
```

**–ó–∞–ø–∏—à–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç** (–∏–ª–∏ —Å–¥–µ–ª–∞–π —Å–∫—Ä–∏–Ω—à–æ—Ç) - —ç—Ç–æ –ø–æ–º–æ–∂–µ—Ç –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏.

---

### –®–∞–≥ 2: –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é 43

```sql
-- –ó–∞–ø—É—Å—Ç–∏ —ç—Ç–æ—Ç —Ñ–∞–π–ª –≤ Supabase SQL Editor:
-- db/migrations/43_migrate_old_materials.sql
```

**–ß—Ç–æ –ø—Ä–æ–∏–∑–æ–π–¥–µ—Ç:**
1. –ü–∞–ø–∫–∞ –ø—Ä–µ–≤—Ä–∞—Ç–∏—Ç—Å—è –≤ —Å—Ç—Ä–∞–Ω–∏—Ü—É-—Ä–∞–∑–¥–µ–ª –≤ `material_pages`
2. –ö–∞–∂–¥—ã–π –∞–π—Ç–µ–º –ø—Ä–µ–≤—Ä–∞—Ç–∏—Ç—Å—è –≤ –æ—Ç–¥–µ–ª—å–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É
3. –°–æ—Ö—Ä–∞–Ω—è—Ç—Å—è —Å–≤—è–∑–∏ parent-child
4. –ö–æ–Ω—Ç–µ–Ω—Ç –±—É–¥–µ—Ç –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω:
   - `kind='doc'` ‚Üí —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –∫–∞–∫ –µ—Å—Ç—å
   - `kind='link'` ‚Üí —Å—Ç—Ä–∞–Ω–∏—Ü–∞ —Å–æ —Å—Å—ã–ª–∫–æ–π
   - `kind='file'` ‚Üí —Å—Ç—Ä–∞–Ω–∏—Ü–∞ —Å —É–∫–∞–∑–∞–Ω–∏–µ–º –Ω–∞ —Ñ–∞–π–ª

---

### –®–∞–≥ 3: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤ UI

1. –û—Ç–∫—Ä–æ–π `/app/[org]/materials`
2. –ü—Ä–æ–≤–µ—Ä—å:
   - ‚úì –í—Å–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã –Ω–∞ –º–µ—Å—Ç–µ?
   - ‚úì –ö–æ–Ω—Ç–µ–Ω—Ç –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ?
   - ‚úì –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø–∞–ø–æ–∫ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞?

---

### –®–∞–≥ 4: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤ –ë–î

```sql
-- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –º–∏–≥—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Å—Ç—Ä–∞–Ω–∏—Ü
SELECT COUNT(*) as total_pages FROM material_pages;

-- –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –º–∏–≥—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
SELECT id, title, slug, parent_id, 
       substring(content_md from 1 for 50) as content_preview,
       created_at
FROM material_pages
WHERE org_id = 'YOUR_ORG_ID' -- –ó–∞–º–µ–Ω–∏ –Ω–∞ —Å–≤–æ–π org_id
ORDER BY created_at;
```

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
- –î–æ–ª–∂–Ω–æ –±—ã—Ç—å 7 —Å—Ç—Ä–∞–Ω–∏—Ü (1 –ø–∞–ø–∫–∞ + 6 –∞–π—Ç–µ–º–æ–≤)

---

### –®–∞–≥ 5: –£–¥–∞–ª–∏—Ç—å —Å—Ç–∞—Ä—ã–µ —Ç–∞–±–ª–∏—Ü—ã (–µ—Å–ª–∏ –≤—Å—ë –û–ö)

–ï—Å–ª–∏ –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ—à–ª–∞ —É—Å–ø–µ—à–Ω–æ, —Ä–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–π STEP 7 –≤ –º–∏–≥—Ä–∞—Ü–∏–∏ 43:

```sql
-- –í —Ñ–∞–π–ª–µ db/migrations/43_migrate_old_materials.sql
-- –†–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–π —Å—Ç—Ä–æ–∫–∏ 178-188:

DO $$
BEGIN
  RAISE NOTICE 'Step 5: Dropping old tables...';
  
  DROP TABLE IF EXISTS material_access CASCADE;
  DROP TABLE IF EXISTS material_items CASCADE;
  DROP TABLE IF EXISTS material_folders CASCADE;
  
  RAISE NOTICE '  ‚úÖ Old material tables dropped';
  RAISE NOTICE '';
END $$;
```

–ò –∑–∞–ø—É—Å—Ç–∏ –º–∏–≥—Ä–∞—Ü–∏—é 43 –ø–æ–≤—Ç–æ—Ä–Ω–æ (–æ–Ω–∞ –±–µ–∑–æ–ø–∞—Å–Ω–∞ –¥–ª—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞).

---

## üîÑ –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –º–∏–≥—Ä–∞—Ü–∏—è

### –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ folder ‚Üí page:
```
material_folders:
  id: abc-123
  name: "–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è"
  parent_id: NULL

        ‚Üì

material_pages:
  id: xyz-789 (–Ω–æ–≤—ã–π)
  title: "–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è"
  slug: "dokumentaciya"
  content_md: "# –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è\n\n–≠—Ç–æ —Ä–∞–∑–¥–µ–ª –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤..."
  parent_id: NULL
```

### –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ item ‚Üí page:
```
material_items:
  id: def-456
  kind: "doc"
  title: "–ù–∞—á–∞–ª–æ —Ä–∞–±–æ—Ç—ã"
  content: "–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è..."
  folder_id: abc-123

        ‚Üì

material_pages:
  id: uvw-101 (–Ω–æ–≤—ã–π)
  title: "–ù–∞—á–∞–ª–æ —Ä–∞–±–æ—Ç—ã"
  slug: "nachalo-raboty"
  content_md: "# –ù–∞—á–∞–ª–æ —Ä–∞–±–æ—Ç—ã\n\n–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è..."
  parent_id: xyz-789 (—Å—Å—ã–ª–∫–∞ –Ω–∞ –º–∏–≥—Ä–∏—Ä–æ–≤–∞–Ω–Ω—É—é –ø–∞–ø–∫—É)
```

---

## ‚ö†Ô∏è –í–∞–∂–Ω—ã–µ –º–æ–º–µ–Ω—Ç—ã

1. **–§–∞–π–ª—ã (kind='file'):**
   - –ü—É—Ç—å –∫ —Ñ–∞–π–ª—É —Å–æ—Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ content_md
   - –ù–æ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å —Ñ–∞–π–ª–∞ –Ω—É–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –≤—Ä—É—á–Ω—É—é
   - –í–æ–∑–º–æ–∂–Ω–æ, –ø–æ—Ç—Ä–µ–±—É–µ—Ç—Å—è –ø–µ—Ä–µ–∑–∞–ª–∏—Ç—å –≤ –Ω–æ–≤—É—é —Å–∏—Å—Ç–µ–º—É

2. **–°—Å—ã–ª–∫–∏ (kind='link'):**
   - –ü—Ä–µ–æ–±—Ä–∞–∑—É—é—Ç—Å—è –≤ —Å—Ç—Ä–∞–Ω–∏—Ü—ã —Å–æ —Å—Å—ã–ª–∫–æ–π
   - –ú–æ–∂–Ω–æ –±—É–¥–µ—Ç –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —á–µ—Ä–µ–∑ UI

3. **Slugs:**
   - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≥–µ–Ω–µ—Ä–∏—Ä—É—é—Ç—Å—è –∏–∑ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤
   - –ï—Å–ª–∏ –µ—Å—Ç—å –¥—É–±–ª–∏–∫–∞—Ç—ã - –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è —á–∞—Å—Ç—å ID

4. **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:**
   - –ú–∏–≥—Ä–∞—Ü–∏—è –ù–ï —É–¥–∞–ª—è–µ—Ç —Å—Ç–∞—Ä—ã–µ —Ç–∞–±–ª–∏—Ü—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
   - –£–¥–∞–ª–µ–Ω–∏–µ —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ —Ç–≤–æ–µ–≥–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è (STEP 7)

---

## üÜò –ï—Å–ª–∏ —á—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫

### –û—Ç–∫–∞—Ç –º–∏–≥—Ä–∞—Ü–∏–∏ 43:

```sql
-- –£–¥–∞–ª–∏—Ç—å –º–∏–≥—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
DELETE FROM material_pages 
WHERE created_at >= NOW() - INTERVAL '1 hour'
  AND (
    content_md LIKE '%–º–∏–≥—Ä–∏—Ä–æ–≤–∞–Ω –∏–∑ —Å—Ç–∞—Ä–æ–π —Å–∏—Å—Ç–µ–º—ã%'
    OR updated_at >= NOW() - INTERVAL '1 hour'
  );

-- –°—Ç–∞—Ä—ã–µ —Ç–∞–±–ª–∏—Ü—ã –æ—Å—Ç–∞–Ω—É—Ç—Å—è –Ω–µ—Ç—Ä–æ–Ω—É—Ç—ã–º–∏
-- –î–∞–Ω–Ω—ã–µ –Ω–µ –ø–æ—Ç–µ—Ä—è—é—Ç—Å—è
```

**–ò–ª–∏:** –ü—Ä–æ—Å—Ç–æ –Ω–µ –∑–∞–ø—É—Å–∫–∞–π STEP 7 - —Å—Ç–∞—Ä—ã–µ —Ç–∞–±–ª–∏—Ü—ã –æ—Å—Ç–∞–Ω—É—Ç—Å—è, –∏ –º–æ–∂–Ω–æ –±—É–¥–µ—Ç –ø–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞.

---

## ‚úÖ –ß–µ–∫–ª–∏—Å—Ç

- [ ] –®–∞–≥ 1: –ü–æ—Å–º–æ—Ç—Ä–µ–ª, —á—Ç–æ –≤ —Å—Ç–∞—Ä—ã—Ö —Ç–∞–±–ª–∏—Ü–∞—Ö
- [ ] –®–∞–≥ 2: –ü—Ä–∏–º–µ–Ω–∏–ª –º–∏–≥—Ä–∞—Ü–∏—é 43
- [ ] –®–∞–≥ 3: –ü—Ä–æ–≤–µ—Ä–∏–ª –≤ UI (/app/[org]/materials)
- [ ] –®–∞–≥ 4: –ü—Ä–æ–≤–µ—Ä–∏–ª –≤ –ë–î (count –∏ content)
- [ ] –®–∞–≥ 5: –£–¥–∞–ª–∏–ª —Å—Ç–∞—Ä—ã–µ —Ç–∞–±–ª–∏—Ü—ã (—Ä–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–ª STEP 7)

---

**–ì–æ—Ç–æ–≤ –Ω–∞—á–∞—Ç—å?** –í—ã–ø–æ–ª–Ω–∏ –®–∞–≥ 1 –∏ –ø–æ–∫–∞–∂–∏, —á—Ç–æ —Ç–∞–º –≤ —Å—Ç–∞—Ä—ã—Ö —Ç–∞–±–ª–∏—Ü–∞—Ö! üöÄ



