# –ü–æ—Ä—è–¥–æ–∫ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –º–∏–≥—Ä–∞—Ü–∏–π 42-49

## ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω—ã –ø—Ä–æ–±–ª–µ–º—ã

1. **–î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–æ–º–µ—Ä–∞ 43** - –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–æ:
   - ~~`43_migrate_old_materials.sql`~~ ‚Üí `49_migrate_old_materials.sql`
   
2. **–û—à–∏–±–∫–∞ `custom_title` –≤ telegram_group_admins**:
   - ~~`43_create_telegram_group_admins.sql`~~ (—É–¥–∞–ª–µ–Ω–∞)
   - ‚úÖ `43_fix_telegram_group_admins.sql` (–Ω–æ–≤–∞—è, —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π —Ç–∞–±–ª–∏—Ü—ã)

3. **–î—É–±–ª–∏—Ä—É—é—â–∏–µ—Å—è slug –≤ –º–∞—Ç–µ—Ä–∏–∞–ª–∞—Ö**:
   - ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏—è —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö slug –≤ `49_migrate_old_materials.sql`

---

## üìã –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è

### –£–∂–µ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã (–ø—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ—Ç—Å—è):
- ‚úÖ `40_fix_sync_telegram_admins_column.sql`
- ‚úÖ `41_fix_sync_telegram_admins_table.sql`
- ‚úÖ `42_cleanup_unused_tables.sql`

### –ü—Ä–∏–º–µ–Ω—è–µ–º —Å–µ–π—á–∞—Å:

```sql
-- 1. –°–æ–∑–¥–∞–Ω–∏–µ/–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã telegram_group_admins
\i db/migrations/43_fix_telegram_group_admins.sql

-- 2. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏ sync_telegram_admins
\i db/migrations/44_sync_telegram_admins_use_new_table.sql

-- 3. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ view organization_admins
\i db/migrations/45_update_organization_admins_view.sql

-- 4. –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Ç–µ–Ω–µ–≤—ã—Ö –ø—Ä–æ—Ñ–∏–ª–µ–π
\i db/migrations/46_sync_telegram_admins_with_shadow_profiles.sql

-- 5. RLS –ø–æ–ª–∏—Ç–∏–∫–∏ –¥–ª—è —Ç–µ–Ω–µ–≤—ã—Ö –∞–¥–º–∏–Ω–æ–≤
\i db/migrations/47_rls_policies_for_shadow_admins.sql

-- 6. –¢–∞–±–ª–∏—Ü–∞ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–π
\i db/migrations/48_create_invitations_table.sql

-- 7. –ú–∏–≥—Ä–∞—Ü–∏—è —Å—Ç–∞—Ä—ã—Ö –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤ (–µ—Å–ª–∏ –µ—Å—Ç—å –¥–∞–Ω–Ω—ã–µ)
\i db/migrations/49_migrate_old_materials.sql
```

---

## üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ–¥ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ–º

### –ü—Ä–æ–≤–µ—Ä–∫–∞ 1: –ï—Å—Ç—å –ª–∏ —Å—Ç–∞—Ä—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã?

```sql
SELECT 
  (SELECT COUNT(*) FROM material_folders) as folders_count,
  (SELECT COUNT(*) FROM material_items) as items_count;
```

- –ï—Å–ª–∏ `0` / `0` ‚Üí **–ú–∏–≥—Ä–∞—Ü–∏—é 49 –º–æ–∂–Ω–æ –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å**
- –ï—Å–ª–∏ –µ—Å—Ç—å –¥–∞–Ω–Ω—ã–µ ‚Üí **–ü—Ä–∏–º–µ–Ω—è–π—Ç–µ –º–∏–≥—Ä–∞—Ü–∏—é 49**

### –ü—Ä–æ–≤–µ—Ä–∫–∞ 2: –°—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ telegram_group_admins?

```sql
SELECT EXISTS (
  SELECT FROM information_schema.tables 
  WHERE table_schema = 'public' 
  AND table_name = 'telegram_group_admins'
);
```

- `true` ‚Üí –ú–∏–≥—Ä–∞—Ü–∏—è 43 –¥–æ–±–∞–≤–∏—Ç –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏–µ –∫–æ–ª–æ–Ω–∫–∏
- `false` ‚Üí –ú–∏–≥—Ä–∞—Ü–∏—è 43 —Å–æ–∑–¥–∞—Å—Ç —Ç–∞–±–ª–∏—Ü—É

---

## ‚ö†Ô∏è –í–∞–∂–Ω—ã–µ –∑–∞–º–µ—Ç–∫–∏

### –ú–∏–≥—Ä–∞—Ü–∏—è 49 (–º–∞—Ç–µ—Ä–∏–∞–ª—ã)

–ü–æ—Å–ª–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è:
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã –≤ UI: `/app/[org]/materials`
2. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤—Å—ë –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –º–∏–≥—Ä–∏—Ä–æ–≤–∞–ª–æ
3. **–¢–æ–ª—å–∫–æ –ø–æ—Å–ª–µ –ø—Ä–æ–≤–µ—Ä–∫–∏:** —Ä–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–π—Ç–µ STEP 7 –≤ –º–∏–≥—Ä–∞—Ü–∏–∏ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è —Å—Ç–∞—Ä—ã—Ö —Ç–∞–±–ª–∏—Ü

### –ú–∏–≥—Ä–∞—Ü–∏—è 43 (telegram_group_admins)

- ‚úÖ –ë–µ–∑–æ–ø–∞—Å–Ω–∞ –¥–ª—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–æ–±–∞–≤–ª—è–µ—Ç –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏–µ –∫–æ–ª–æ–Ω–∫–∏
- ‚úÖ –ù–µ –¥—É–±–ª–∏—Ä—É–µ—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –¥–∞–Ω–Ω—ã–µ

---

## üöÄ –ë—ã—Å—Ç—Ä–æ–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ (–µ—Å–ª–∏ –≤—Å–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–æ–π–¥–µ–Ω—ã)

### –ß–µ—Ä–µ–∑ psql:

```bash
cd "c:\Cursor WS\orbo-1.1"

psql -U postgres -d your_database << EOF
\i db/migrations/43_fix_telegram_group_admins.sql
\i db/migrations/44_sync_telegram_admins_use_new_table.sql
\i db/migrations/45_update_organization_admins_view.sql
\i db/migrations/46_sync_telegram_admins_with_shadow_profiles.sql
\i db/migrations/47_rls_policies_for_shadow_admins.sql
\i db/migrations/48_create_invitations_table.sql
\i db/migrations/49_migrate_old_materials.sql
EOF
```

### –ß–µ—Ä–µ–∑ Supabase SQL Editor:

1. –û—Ç–∫—Ä–æ–π—Ç–µ SQL Editor
2. –ü—Ä–∏–º–µ–Ω—è–π—Ç–µ –ø–æ –æ–¥–Ω–æ–π –º–∏–≥—Ä–∞—Ü–∏–∏
3. –ü—Ä–æ–≤–µ—Ä—è–π—Ç–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–π

---

## ‚úÖ –ü–æ—Å–ª–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –≤—Å–µ—Ö –º–∏–≥—Ä–∞—Ü–∏–π

–ü—Ä–æ–≤–µ—Ä—å—Ç–µ:

```sql
-- 1. –¢–∞–±–ª–∏—Ü–∞ telegram_group_admins —Å–æ–∑–¥–∞–Ω–∞
SELECT column_name, data_type 
FROM information_schema.columns 
WHERE table_name = 'telegram_group_admins';

-- –î–æ–ª–∂–Ω—ã –±—ã—Ç—å: custom_title, can_post_messages, can_edit_messages

-- 2. View organization_admins —Ä–∞–±–æ—Ç–∞–µ—Ç
SELECT * FROM organization_admins LIMIT 1;

-- 3. –§—É–Ω–∫—Ü–∏—è sync_telegram_admins —Ä–∞–±–æ—Ç–∞–µ—Ç
SELECT * FROM sync_telegram_admins('your-org-id');

-- 4. –ú–∞—Ç–µ—Ä–∏–∞–ª—ã –º–∏–≥—Ä–∏—Ä–æ–≤–∞–ª–∏ (–µ—Å–ª–∏ –±—ã–ª–∏)
SELECT COUNT(*) FROM material_pages;
```

---

## üÜò Troubleshooting

### –û—à–∏–±–∫–∞: "cannot change return type of existing function"

**–ú–∏–≥—Ä–∞—Ü–∏—è 46:** –£–∂–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ - —Ñ—É–Ω–∫—Ü–∏—è —Ç–µ–ø–µ—Ä—å —É–¥–∞–ª—è–µ—Ç—Å—è –ø–µ—Ä–µ–¥ –ø–µ—Ä–µ—Å–æ–∑–¥–∞–Ω–∏–µ–º  
**–†–µ—à–µ–Ω–∏–µ:** –ü—Ä–∏–º–µ–Ω–∏—Ç–µ –æ–±–Ω–æ–≤–ª—ë–Ω–Ω—É—é –º–∏–≥—Ä–∞—Ü–∏—é 46

### –û—à–∏–±–∫–∞: "syntax error at or near DELETE"

**–ú–∏–≥—Ä–∞—Ü–∏—è 46:** –£–∂–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ - –ø–µ—Ä–µ–ø–∏—Å–∞–Ω–∞ –ª–æ–≥–∏–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∞–¥–º–∏–Ω–æ–≤ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º CTE  
**–†–µ—à–µ–Ω–∏–µ:** –ü—Ä–∏–º–µ–Ω–∏—Ç–µ –ø–æ—Å–ª–µ–¥–Ω—é—é –≤–µ—Ä—Å–∏—é –º–∏–≥—Ä–∞—Ü–∏–∏ 46

### –û—à–∏–±–∫–∞: "column reference user_id is ambiguous"

**–ú–∏–≥—Ä–∞—Ü–∏—è 46:** –£–∂–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ - –¥–æ–±–∞–≤–ª–µ–Ω—ã –ø—Ä–µ—Ñ–∏–∫—Å—ã —Ç–∞–±–ª–∏—Ü –≤ WHERE —É—Å–ª–æ–≤–∏—è—Ö  
**–†–µ—à–µ–Ω–∏–µ:** –ü—Ä–∏–º–µ–Ω–∏—Ç–µ –ø–æ—Å–ª–µ–¥–Ω—é—é –≤–µ—Ä—Å–∏—é –º–∏–≥—Ä–∞—Ü–∏–∏ 46

### –û—à–∏–±–∫–∞: "functions in index predicate must be marked IMMUTABLE"

**–ú–∏–≥—Ä–∞—Ü–∏—è 48:** –£–∂–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ - —É–±—Ä–∞–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è `NOW()` –∏–∑ –ø—Ä–µ–¥–∏–∫–∞—Ç–∞ –∏–Ω–¥–µ–∫—Å–∞  
**–†–µ—à–µ–Ω–∏–µ:** –ü—Ä–∏–º–µ–Ω–∏—Ç–µ –ø–æ—Å–ª–µ–¥–Ω—é—é –≤–µ—Ä—Å–∏—é –º–∏–≥—Ä–∞—Ü–∏–∏ 48  
**–î–µ—Ç–∞–ª–∏:** –ò–Ω–¥–µ–∫—Å —Ç–µ–ø–µ—Ä—å –≤–∫–ª—é—á–∞–µ—Ç `expires_at` –∫–∞–∫ –∫–æ–ª–æ–Ω–∫—É, –∞ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—é –ø–æ –≤—Ä–µ–º–µ–Ω–∏ –¥–µ–ª–∞–π—Ç–µ –≤ –∑–∞–ø—Ä–æ—Å–∞—Ö

### –û—à–∏–±–∫–∞: "duplicate key value violates unique constraint"

**–í –º–∞—Ç–µ—Ä–∏–∞–ª–∞—Ö (49):** –£–∂–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ - slug —Ç–µ–ø–µ—Ä—å –≥–µ–Ω–µ—Ä–∏—Ä—É—é—Ç—Å—è —É–Ω–∏–∫–∞–ª—å–Ω–æ  
**–í –¥—Ä—É–≥–∏—Ö —Ç–∞–±–ª–∏—Ü–∞—Ö:** –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, –Ω–µ –ø—Ä–∏–º–µ–Ω—è–ª–∏ –ª–∏ –º–∏–≥—Ä–∞—Ü–∏—é –¥–≤–∞–∂–¥—ã

### –û—à–∏–±–∫–∞: "column does not exist"

**custom_title:** –ú–∏–≥—Ä–∞—Ü–∏—è 43 —Ç–µ–ø–µ—Ä—å –¥–æ–±–∞–≤–ª—è–µ—Ç –µ—ë –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏  
**–î—Ä—É–≥–∏–µ –∫–æ–ª–æ–Ω–∫–∏:** –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –ø—Ä–∏–º–µ–Ω—è–µ—Ç–µ –º–∏–≥—Ä–∞—Ü–∏–∏ –ø–æ –ø–æ—Ä—è–¥–∫—É

### –û—à–∏–±–∫–∞: "relation does not exist"

–ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –ø—Ä–µ–¥—ã–¥—É—â–∏–µ –º–∏–≥—Ä–∞—Ü–∏–∏ (40-42) –ø—Ä–∏–º–µ–Ω–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ

---

**–î–∞—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:** 2025-10-19  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ì–æ—Ç–æ–≤–æ –∫ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—é

