# Day 8: OpenAI API Logging & Cost Monitoring ‚úÖ

**–î–∞—Ç–∞:** 06.11.2025  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ó–∞–≤–µ—Ä—à–µ–Ω–æ  

---

## üéØ **–¶–µ–ª—å:**

–†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å —Å–∏—Å—Ç–µ–º—É –ª–æ–≥–≥–∏—Ä–æ–≤–∞–Ω–∏—è –≤—Å–µ—Ö –≤—ã–∑–æ–≤–æ–≤ OpenAI API –∏ —Å–æ–∑–¥–∞—Ç—å –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ —Ä–∞—Å—Ö–æ–¥–æ–≤ –≤ —Å—É–ø–µ—Ä–∞–¥–º–∏–Ω–∫–µ.

---

## ‚úÖ **–í—ã–ø–æ–ª–Ω–µ–Ω–æ:**

### **1. –ú–∏–≥—Ä–∞—Ü–∏—è 094: –¢–∞–±–ª–∏—Ü–∞ `openai_api_logs`**

**–§–∞–π–ª:** `db/migrations/094_openai_api_logs.sql`

**–°–æ–∑–¥–∞–Ω–æ:**
- –¢–∞–±–ª–∏—Ü–∞ `openai_api_logs` —Å –ø–æ–ª—è–º–∏:
  - `org_id` ‚Äî –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è
  - `request_type` ‚Äî —Ç–∏–ø –∑–∞–ø—Ä–æ—Å–∞ (`participant_enrichment`, `weekly_digest`, `custom_analysis`)
  - `model` ‚Äî –º–æ–¥–µ–ª—å OpenAI (`gpt-4o-mini`, etc.)
  - `prompt_tokens`, `completion_tokens`, `total_tokens`
  - `cost_usd`, `cost_rub` ‚Äî —Å—Ç–æ–∏–º–æ—Å—Ç—å
  - `metadata` ‚Äî JSONB –¥–ª—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
  - `created_by` ‚Äî –∫—Ç–æ –∏–Ω–∏—Ü–∏–∏—Ä–æ–≤–∞–ª –∑–∞–ø—Ä–æ—Å
- RLS –ø–æ–ª–∏—Ç–∏–∫–∏ (—Å—É–ø–µ—Ä–∞–¥–º–∏–Ω—ã –≤–∏–¥—è—Ç –≤—Å—ë, –≤–ª–∞–¥–µ–ª—å—Ü—ã ‚Äî —Ç–æ–ª—å–∫–æ —Å–≤–æ—é org)
- RPC —Ñ—É–Ω–∫—Ü–∏—è `get_openai_cost_summary(org_id, days)` ‚Äî –∞–≥—Ä–µ–≥–∞—Ü–∏—è —Ä–∞—Å—Ö–æ–¥–æ–≤

**–ó–∞—á–µ–º:**
- –ö–æ–Ω—Ç—Ä–æ–ª—å —Ä–∞—Å—Ö–æ–¥–æ–≤ –Ω–∞ AI
- –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
- –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ (–∫–∞–∫–∏–µ –∑–∞–ø—Ä–æ—Å—ã –¥–æ—Ä–æ–≥–∏–µ?)

---

### **2. –û–±–Ω–æ–≤–ª—ë–Ω `openaiService` ‚Äî –∞–≤—Ç–æ–ª–æ–≥–≥–∏—Ä–æ–≤–∞–Ω–∏–µ**

**–§–∞–π–ª:** `lib/services/enrichment/openaiService.ts`

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
1. –î–æ–±–∞–≤–ª–µ–Ω Supabase admin client –¥–ª—è –∑–∞–ø–∏—Å–∏ –≤ –ë–î
2. –°–æ–∑–¥–∞–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è `logOpenAICall()` –¥–ª—è –∑–∞–ø–∏—Å–∏ –≤ `openai_api_logs`
3. –û–±–Ω–æ–≤–ª–µ–Ω–∞ —Å–∏–≥–Ω–∞—Ç—É—Ä–∞ `analyzeParticipantWithAI()`:
   - **–î–æ–±–∞–≤–ª–µ–Ω—ã –ø–∞—Ä–∞–º–µ—Ç—Ä—ã:** `orgId`, `userId`, `participantId`
   - **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ª–æ–≥–≥–∏—Ä—É–µ—Ç** –∫–∞–∂–¥—ã–π –≤—ã–∑–æ–≤ –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞ –∫ OpenAI

```typescript
export async function analyzeParticipantWithAI(
  messages: MessageWithContext[],
  participantName: string,
  orgId: string, // ‚≠ê NEW
  userId: string | null = null, // ‚≠ê NEW
  participantId: string | null = null, // ‚≠ê NEW
  groupKeywords: string[] = []
): Promise<AIEnrichmentResult>
```

**–õ–æ–≥–≥–∏—Ä—É–µ–º—ã–µ –¥–∞–Ω–Ω—ã–µ:**
- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ–∫–µ–Ω–æ–≤ (input/output/total)
- –°—Ç–æ–∏–º–æ—Å—Ç—å –≤ USD –∏ RUB
- –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ: participant_id, participant_name, message_count, duration_ms

---

### **3. –û–±–Ω–æ–≤–ª—ë–Ω `participantEnrichmentService`**

**–§–∞–π–ª:** `lib/services/participantEnrichmentService.ts`

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
- –§—É–Ω–∫—Ü–∏—è `enrichParticipant()` —Ç–µ–ø–µ—Ä—å –ø—Ä–∏–Ω–∏–º–∞–µ—Ç `userId` (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
- –ü–µ—Ä–µ–¥–∞—ë—Ç `orgId`, `userId`, `participantId` –≤ `analyzeParticipantWithAI()`

```typescript
export async function enrichParticipant(
  participantId: string,
  orgId: string,
  options: EnrichmentOptions = {},
  userId: string | null = null // ‚≠ê NEW
): Promise<EnrichmentResult>
```

---

### **4. –û–±–Ω–æ–≤–ª–µ–Ω—ã API endpoints**

**–§–∞–π–ª:** `app/api/participants/[participantId]/enrich-ai/route.ts`

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
- POST –∑–∞–ø—Ä–æ—Å —Ç–µ–ø–µ—Ä—å –ø–µ—Ä–µ–¥–∞—ë—Ç `user.id` –≤ `enrichParticipant()`
- –í—Å–µ –≤—ã–∑–æ–≤—ã AI —Ç–µ–ø–µ—Ä—å –ª–æ–≥–≥–∏—Ä—É—é—Ç—Å—è —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º `userId`

**Cron job –Ω–µ –∏–∑–º–µ–Ω—ë–Ω:**
- `app/api/cron/update-participant-roles/route.ts` ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –¥–µ—Ñ–æ–ª—Ç–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ `userId = null` (—ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ, —Ç.–∫. –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø—Ä–æ—Ü–µ—Å—Å)

---

### **5. –°–æ–∑–¥–∞–Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –≤ —Å—É–ø–µ—Ä–∞–¥–º–∏–Ω–∫–µ: `/superadmin/ai-costs`**

**–§–∞–π–ª:** `app/superadmin/ai-costs/page.tsx`

**–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª:**
- **–§–∏–ª—å—Ç—Ä –ø–æ –ø–µ—Ä–∏–æ–¥—É:** 7 / 30 / 90 –¥–Ω–µ–π
- **–ö–∞—Ä—Ç–æ—á–∫–∏ —Å –∏—Ç–æ–≥–∞–º–∏:**
  - –í—Å–µ–≥–æ –∑–∞–ø—Ä–æ—Å–æ–≤
  - –í—Å–µ–≥–æ —Ç–æ–∫–µ–Ω–æ–≤
  - –†–∞—Å—Ö–æ–¥—ã (USD)
  - –†–∞—Å—Ö–æ–¥—ã (RUB)
- **–†–∞–∑–±–∏–≤–∫–∞ –ø–æ —Ç–∏–ø–∞–º –∑–∞–ø—Ä–æ—Å–æ–≤:**
  - `participant_enrichment`
  - `weekly_digest` (–≥–æ—Ç–æ–≤–æ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é)
  - `custom_analysis` (—Ä–µ–∑–µ—Ä–≤)
- **–¢–∞–±–ª–∏—Ü–∞ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö 50 –∑–∞–ø—Ä–æ—Å–æ–≤:**
  - –î–∞—Ç–∞/–≤—Ä–µ–º—è
  - –¢–∏–ø –∑–∞–ø—Ä–æ—Å–∞
  - –ú–æ–¥–µ–ª—å
  - –¢–æ–∫–µ–Ω—ã
  - –°—Ç–æ–∏–º–æ—Å—Ç—å (USD, RUB)
  - –û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è

**–°—Å—ã–ª–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞ –≤ sidebar:**
- `app/superadmin/layout.tsx` ‚Äî –Ω–æ–≤—ã–π –ø—É–Ω–∫—Ç "AI –†–∞—Å—Ö–æ–¥—ã"

---

## üìä **–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –ª–æ–≥–≥–∏—Ä–æ–≤–∞–Ω–∏—è:**

```
User Action (Owner/Admin)
    ‚Üì
API: /api/participants/[id]/enrich-ai (POST)
    ‚Üì
enrichParticipant(participantId, orgId, options, userId)
    ‚Üì
analyzeParticipantWithAI(messages, name, orgId, userId, participantId)
    ‚Üì
OpenAI API Call (gpt-4o-mini)
    ‚Üì
‚úÖ SUCCESS ‚Üí logOpenAICall() ‚Üí INSERT INTO openai_api_logs
    ‚Üì
Return result to user
```

**–ö–ª—é—á–µ–≤—ã–µ —Ç–æ—á–∫–∏:**
- ‚úÖ –í—Å–µ –≤—ã–∑–æ–≤—ã OpenAI API –ª–æ–≥–≥–∏—Ä—É—é—Ç—Å—è **–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏**
- ‚úÖ –õ–æ–≥–≥–∏—Ä–æ–≤–∞–Ω–∏–µ **–Ω–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç** –æ—Å–Ω–æ–≤–Ω–æ–π –ø—Ä–æ—Ü–µ—Å—Å (async)
- ‚úÖ –û—à–∏–±–∫–∏ –ª–æ–≥–≥–∏—Ä–æ–≤–∞–Ω–∏—è **–Ω–µ –ª–æ–º–∞—é—Ç** enrichment
- ‚úÖ –õ–æ–≥–≥–∏—Ä—É–µ—Ç—Å—è **–∫—Ç–æ** –∏–Ω–∏—Ü–∏–∏—Ä–æ–≤–∞–ª –∑–∞–ø—Ä–æ—Å (–¥–ª—è –∞—É–¥–∏—Ç–∞)

---

## üß™ **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:**

### **1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–≥–∏—Ä–æ–≤–∞–Ω–∏—è:**
1. –û—Ç–∫—Ä—ã—Ç—å –ø—Ä–æ—Ñ–∏–ª—å —É—á–∞—Å—Ç–Ω–∏–∫–∞
2. –ù–∞–∂–∞—Ç—å "–û—Ü–µ–Ω–∏—Ç—å –Ω–∞–ª–∏—á–∏–µ –¥–∞–Ω–Ω—ã—Ö" ‚Üí "–ó–∞–ø—É—Å—Ç–∏—Ç—å AI-–∞–Ω–∞–ª–∏–∑"
3. –ü–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –æ—Ç–∫—Ä—ã—Ç—å `/superadmin/ai-costs`
4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –ø–æ—è–≤–∏–ª–∞—Å—å –Ω–æ–≤–∞—è –∑–∞–ø–∏—Å—å:
   - –¢–∏–ø: `participant_enrichment`
   - –ú–æ–¥–µ–ª—å: `gpt-4o-mini`
   - –°—Ç–æ–∏–º–æ—Å—Ç—å: ~$0.0001-0.0005
   - –û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è: –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π ID

### **2. –ü—Ä–æ–≤–µ—Ä–∫–∞ RPC —Ñ—É–Ω–∫—Ü–∏–∏:**
```sql
SELECT * FROM get_openai_cost_summary(NULL, 30);
```
–î–æ–ª–∂–Ω–æ –≤–µ—Ä–Ω—É—Ç—å:
- `total_requests`, `total_tokens`, `total_cost_usd`, `total_cost_rub`
- `by_request_type` (JSONB —Å —Ä–∞–∑–±–∏–≤–∫–æ–π –ø–æ —Ç–∏–ø–∞–º)

### **3. –ü—Ä–æ–≤–µ—Ä–∫–∞ RLS:**
- Superadmin: –≤–∏–¥–∏—Ç **–≤—Å–µ** –∑–∞–ø–∏—Å–∏
- Owner: –≤–∏–¥–∏—Ç —Ç–æ–ª—å–∫–æ **—Å–≤–æ—é** –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—é

---

## üìù **–§–∞–π–ª—ã —Å–æ–∑–¥–∞–Ω—ã/–∏–∑–º–µ–Ω–µ–Ω—ã:**

### **–°–æ–∑–¥–∞–Ω—ã:**
1. `db/migrations/094_openai_api_logs.sql` ‚Äî –º–∏–≥—Ä–∞—Ü–∏—è
2. `app/superadmin/ai-costs/page.tsx` ‚Äî —Å—Ç—Ä–∞–Ω–∏—Ü–∞ —Å—É–ø–µ—Ä–∞–¥–º–∏–Ω–∫–∏
3. `docs/DAY_8_OPENAI_LOGGING_COMPLETE.md` ‚Äî —ç—Ç–æ—Ç –¥–æ–∫—É–º–µ–Ω—Ç

### **–ò–∑–º–µ–Ω–µ–Ω—ã:**
1. `lib/services/enrichment/openaiService.ts` ‚Äî –¥–æ–±–∞–≤–ª–µ–Ω–æ –ª–æ–≥–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
2. `lib/services/participantEnrichmentService.ts` ‚Äî –¥–æ–±–∞–≤–ª–µ–Ω –ø–∞—Ä–∞–º–µ—Ç—Ä userId
3. `app/api/participants/[participantId]/enrich-ai/route.ts` ‚Äî –ø–µ—Ä–µ–¥–∞—á–∞ userId
4. `app/superadmin/layout.tsx` ‚Äî –¥–æ–±–∞–≤–ª–µ–Ω–∞ —Å—Å—ã–ª–∫–∞ "AI –†–∞—Å—Ö–æ–¥—ã"

---

## üîú **–°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏ (Day 9):**

1. ‚úÖ –°–æ–∑–¥–∞—Ç—å RPC `generate_weekly_digest_data(org_id)`
2. ‚úÖ –°–æ–∑–¥–∞—Ç—å AI-—à–∞–±–ª–æ–Ω –¥–ª—è –¥–∞–π–¥–∂–µ—Å—Ç–∞ (—Å –ª–æ–≥–≥–∏—Ä–æ–≤–∞–Ω–∏–µ–º)
3. ‚úÖ –°–æ–∑–¥–∞—Ç—å —Å–µ—Ä–≤–∏—Å `weeklyDigestService`
4. ‚úÖ –°–æ–∑–¥–∞—Ç—å cron `/api/cron/send-weekly-digests`

---

## üí° **–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏:**

1. **–ü–æ–ª–Ω–∞—è –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å:** –ö–∞–∂–¥—ã–π –≤—ã–∑–æ–≤ API –≤–∏–¥–µ–Ω –≤ —Å—É–ø–µ—Ä–∞–¥–º–∏–Ω–∫–µ
2. **–ö–æ–Ω—Ç—Ä–æ–ª—å —Ä–∞—Å—Ö–æ–¥–æ–≤:** –ú–æ–∂–Ω–æ –±—ã—Å—Ç—Ä–æ —É–≤–∏–¥–µ—Ç—å, —Å–∫–æ–ª—å–∫–æ —Ç—Ä–∞—Ç–∏–º
3. **–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è:** –í–∏–¥–Ω–æ, –∫–∞–∫–∏–µ –∑–∞–ø—Ä–æ—Å—ã –¥–æ—Ä–æ–≥–∏–µ (–º–æ–∂–Ω–æ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–º–ø—Ç—ã)
4. **–ê—É–¥–∏—Ç:** –í–∏–¥–Ω–æ, –∫—Ç–æ –∏–Ω–∏—Ü–∏–∏—Ä–æ–≤–∞–ª –∑–∞–ø—Ä–æ—Å (–¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏)
5. **–ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å:** –õ–µ–≥–∫–æ –¥–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–µ —Ç–∏–ø—ã –∑–∞–ø—Ä–æ—Å–æ–≤ (`weekly_digest`, `custom_analysis`)

---

**–°—Ç–∞—Ç—É—Å:** ‚úÖ Day 8 –∑–∞–≤–µ—Ä—à—ë–Ω —É—Å–ø–µ—à–Ω–æ!  
**–î–µ–ø–ª–æ–π:** –ì–æ—Ç–æ–≤ –∫ –¥–µ–ø–ª–æ—é –ø–æ—Å–ª–µ —Ä–µ–≤—å—é  
**–ê–≤—Ç–æ—Ä:** Assistant + Timur

