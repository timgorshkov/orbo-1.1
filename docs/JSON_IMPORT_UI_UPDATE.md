# JSON Import UI Update - 2025-11-04

## Проблема
После реализации JSON парсера на backend, UI все еще показывал инструкции только для HTML формата и не принимал `.json` файлы.

## Решение

### Изменения в `components/telegram/import-history.tsx`

1. **Обновлён `useDropzone` для приема JSON файлов:**
   ```typescript
   accept: {
     'application/json': ['.json'],  // Добавлено - приоритетный формат
     'text/html': ['.html'],         // Оставлено для обратной совместимости
   },
   maxSize: 5 * 1024 * 1024, // Увеличено до 5MB (JSON файлы обычно больше)
   ```

2. **Обновлены инструкции для пользователей:**
   - Добавлена секция "JSON (рекомендуется)" с зелёным выделением
   - HTML формат перемещён в секцию "запасной вариант"
   - Указано преимущество JSON: содержит ID участников Telegram для точной идентификации

3. **Обновлены все UI тексты:**
   - Заголовок: "Поддерживаются JSON и HTML файлы"
   - Drag&drop зона: "Принимаются файлы формата .json (рекомендуется) или .html"
   - Максимальный размер увеличен с 2MB до 5MB

## Техническая цепочка

1. **Backend парсер** (`lib/services/telegramJsonParser.ts`):
   - Парсит `result.json` из Telegram
   - Извлекает `from_id` (Telegram User ID) для каждого автора
   - Возвращает структуру `ParsedJsonMessage[]` и `ParsedJsonAuthor[]`

2. **API endpoint** (`app/api/telegram/import-history/[id]/parse/route.ts`):
   - Автоматически определяет тип файла (JSON или HTML)
   - Приоритет у JSON парсера
   - Использует `from_id` для точного матчинга участников по `tg_user_id`

3. **UI компонент** (`components/telegram/import-history.tsx`):
   - Принимает оба формата файлов
   - Отображает рекомендации и инструкции
   - Показывает preview с матчингом участников

## Преимущества JSON формата

- ✅ **Точная идентификация:** `from_id` = `tg_user_id` (100% точность)
- ✅ **Меньше false-positives:** Не полагается на имя/username, которые могут совпадать у разных людей
- ✅ **Структурированные данные:** Проще парсить, меньше edge cases
- ✅ **Поддержка будущих полей:** JSON может содержать больше метаданных

## Обратная совместимость

HTML формат по-прежнему поддерживается как fallback для случаев, когда:
- У пользователя старая версия Telegram Desktop без JSON export
- Экспорт был сделан давно и уже не переделать
- Техническая необходимость (например, парсинг старого архива)

## Тестирование

После деплоя:
1. Открыть любую группу → Import history
2. Убедиться, что инструкции рекомендуют JSON
3. Загрузить `result.json` файл из Telegram
4. Проверить корректность preview и матчинга участников
5. Выполнить импорт и проверить, что сообщения правильно привязаны к участникам по `tg_user_id`

## Статус
✅ **Завершено** - UI обновлён, готов к тестированию

