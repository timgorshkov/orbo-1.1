# 🚀 ROADMAP — Orbo Platform Evolution
**Дата:** 7 января 2026 (обновлено: 9 февраля 2026)  
**Период:** Февраль — Март 2026  
**Статус:** 🔄 In Progress (актуализирован с учётом ICP-роадмапа)  
**Контекст:** Стратегическое развитие, партнёрства, монетизация
**Первый партнёр:** Votum (@votumfit_bot)

> **Важно:** Этот роадмап был создан в январе 2026 и частично пересмотрен в пользу `ROADMAP_FEB_2026_ICP.md`, 
> который фокусирует развитие на событиях как конверсионном движке для ICP-A.
> Приоритет 1 (Каталог приложений) отложен в пользу улучшений событий и уведомлений.

---

## 📊 АНАЛИЗ ТЕКУЩЕГО СОСТОЯНИЯ

### ✅ Что сделано (обновлено февраль 2026):
| Область | Готовность | Ключевые функции |
|---------|------------|------------------|
| **Telegram-интеграция** | 99% | 3 бота, webhook, импорт, MiniApp, топик-анализ |
| **CRM участников** | 95% | Профили, теги, AI-обогащение (с контекстом событий/заявок), скоринг |
| **Уведомления** | 98% | AI-анализ негатива (по топикам), вопросы, авто-решение, единая цветовая схема |
| **События** | 98% | MiniApp регистрация, оплата, QR check-in, ICS/Google Calendar, анонсы |
| **Orbo Apps** | 60% | Базовые типы, коллекции (нет публичного каталога) |
| **Аналитика** | 80% | Дашборд, метрики групп, attention zones, диаграмма регистраций |
| **OAuth** | 100% | Google, Yandex, Telegram |
| **Суперадмин** | 95% | Имперсонация (вход в любую организацию), панель управления |
| **Безопасность** | 95% | Изоляция данных между организациями, security headers, ротация логов |
| **Инфраструктура** | 100% | PostgreSQL direct (Supabase полностью удалён), Selectel S3 |

### 🎯 Ключевые сегменты (по docs/competition-analysis.md):
1. **Клиентские сообщества брендов** — B2B/B2C чаты, лояльность, конверсия
2. **Профессиональные клубы** — бизнес-клубы, ассоциации, нетворкинг
3. **Агентства** — SMM, performance, клиентские чаты, командная работа

### 💡 Ключевые инсайты из конкурентного анализа:
| Конкурент | Их фокус | Наше отличие |
|-----------|----------|--------------|
| **Combot** | Модерация, геймификация | CRM + бизнес-аналитика |
| **ChatNorris** | AI-саммари, развлечение | Админские инсайты, не участников |
| **DiseCRM** | Personal chats, sales pipeline | **Групповые** чаты, community CRM |

---

## 🎯 СТРАТЕГИЧЕСКИЕ ПРИОРИТЕТЫ (Февраль-Март)

### Приоритет 1: 🏪 Приложения + Партнёрский каталог
**Цель:** Превратить раздел "Приложения" в экосистему внутренних + внешних MiniApps

### Приоритет 2: 📢 Массовое информирование (Announcements)
**Цель:** Планирование и рассылка анонсов в группы, интеграция с событиями

### Приоритет 3: 👔 Роли сотрудников + Offboarding
**Цель:** Различать сотрудников и клиентов, упростить offboarding

### Приоритет 4: 💳 Подготовка к биллингу
**Цель:** Инфраструктура для платных тарифов (без реализации оплаты)

---

## 📦 ДЕТАЛЬНЫЙ ПЛАН

---

## 1️⃣ ПРИЛОЖЕНИЯ И ПАРТНЁРСКИЙ КАТАЛОГ

### 1.1 Архитектура каталога приложений

```
┌─────────────────────────────────────────────────────────────┐
│                    ORBO APPS ECOSYSTEM                      │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ВСЕ приложения доступны как TELEGRAM MINIAPPS              │
│                                                             │
│  ┌─────────────────┐    ┌─────────────────────────────────┐ │
│  │  СОБСТВЕННЫЕ    │    │  ИЗ КАТАЛОГА (ПАРТНЁРСКИЕ)      │ │
│  │  (конструктор)  │    │                                 │ │
│  ├─────────────────┤    ├─────────────────────────────────┤ │
│  │ • Доска объявл. │    │ • Votum (мэтчинг запросов)      │ │
│  │ • Каталог услуг │    │ • [Другие партнёры]             │ │
│  │ • Вакансии      │    │                                 │ │
│  │ • Запросы       │    │ Все = Telegram MiniApps         │ │
│  │ • База знаний   │    │                                 │ │
│  │                 │    │                                 │ │
│  │ ⚠️ ТРЕБУЕТ       │    │                                 │ │
│  │ ПЕРЕРАБОТКИ     │    │                                 │ │
│  └─────────────────┘    └─────────────────────────────────┘ │
│                                                             │
│  ┌─────────────────────────────────────────────────────────┐│
│  │              UI ЛОГИКА                                  ││
│  ├─────────────────────────────────────────────────────────┤│
│  │ 1. СНАЧАЛА показываем: подключённые + созданные        ││
│  │    (единым списком, без разделения)                    ││
│  │ 2. ПОТОМ: ссылка на каталог + кнопка "Создать своё"    ││
│  └─────────────────────────────────────────────────────────┘│
│                                                             │
│  ┌─────────────────────────────────────────────────────────┐│
│  │              SUPERADMIN PANEL                           ││
│  ├─────────────────────────────────────────────────────────┤│
│  │ • Управление каталогом публичных приложений            ││
│  │ • Добавление/редактирование партнёрских MiniApps       ││
│  │ • Статистика подключений по организациям               ││
│  │ • API ключи для будущих интеграций                     ││
│  └─────────────────────────────────────────────────────────┘│
└─────────────────────────────────────────────────────────────┘
```

### 1.1.1 Переработка внутренних приложений (TODO)

**Проблема:** Текущий конструктор приложений требует модернизации.

**План переработки:**
1. Унификация с партнёрскими MiniApps (единый формат)
2. Улучшение UI конструктора
3. Telegram MiniApp для каждого созданного приложения
4. Детальный план — после MVP каталога

### 1.2 Таблицы БД (новые)

```sql
-- Публичный каталог партнёрских приложений
CREATE TABLE public_apps (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  created_at TIMESTAMPTZ DEFAULT NOW(),
  
  -- Информация о приложении
  name TEXT NOT NULL,                    -- "ChatNorris"
  description TEXT,                      -- "AI-саммари обсуждений"
  icon_url TEXT,                         -- URL иконки
  category TEXT,                         -- 'ai', 'moderation', 'engagement'
  
  -- Подключение
  bot_username TEXT,                     -- "@chatnorris_bot"
  bot_deep_link TEXT,                    -- "t.me/chatnorris_bot?startgroup=..."
  setup_instructions TEXT,               -- Markdown инструкции
  
  -- Партнёрство
  partner_name TEXT,                     -- Название компании-партнёра
  partner_contact TEXT,                  -- Email/telegram
  revenue_share_percent DECIMAL(5,2),    -- % комиссии (если есть)
  
  -- Статус
  status TEXT DEFAULT 'draft',           -- draft, active, paused
  featured BOOLEAN DEFAULT false,        -- Показывать в топе каталога
  sort_order INTEGER DEFAULT 0,
  
  -- Метаданные
  external_api_url TEXT,                 -- Для будущих интеграций
  config JSONB DEFAULT '{}'::jsonb       -- Доп. настройки
);

-- Подключения партнёрских приложений к организациям
CREATE TABLE public_app_connections (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  created_at TIMESTAMPTZ DEFAULT NOW(),
  
  public_app_id UUID REFERENCES public_apps(id) ON DELETE CASCADE,
  org_id UUID REFERENCES organizations(id) ON DELETE CASCADE,
  
  -- В каких группах подключено
  connected_groups JSONB DEFAULT '[]'::jsonb, -- [{chat_id, title, connected_at}]
  
  -- Статус
  status TEXT DEFAULT 'active',          -- active, paused, disconnected
  connected_by UUID REFERENCES auth.users(id),
  
  UNIQUE(public_app_id, org_id)
);
```

### 1.3 UI/UX изменения

**Страница /p/[org]/apps:**
```
┌────────────────────────────────────────────────────────────┐
│  🧩 Приложения                                              │
├────────────────────────────────────────────────────────────┤
│                                                            │
│  📱 Ваши приложения (подключённые + созданные единым списком)│
│  ┌──────────────────┐  ┌──────────────────┐               │
│  │ 📦 Барахолка     │  │ 🤝 Votum         │               │
│  │ (собственное)    │  │ (из каталога)    │               │
│  │ [Настройки]      │  │ [Настройки]      │               │
│  │ [Открыть MiniApp]│  │ [Открыть MiniApp]│               │
│  └──────────────────┘  └──────────────────┘               │
│  ┌──────────────────┐                                     │
│  │ 💼 Вакансии      │                                     │
│  │ (собственное)    │                                     │
│  │ [Настройки]      │                                     │
│  │ [Открыть MiniApp]│                                     │
│  └──────────────────┘                                     │
│                                                            │
│  ─────────────────────────────────────────────────────────│
│                                                            │
│  [📂 Открыть каталог приложений]    [✨ Создать своё]      │
│                                                            │
└────────────────────────────────────────────────────────────┘
```

**Superadmin /admin/public-apps:**
```
┌────────────────────────────────────────────────────────────┐
│  🌐 Публичный каталог приложений                [+ Добавить] │
├────────────────────────────────────────────────────────────┤
│  │ Название      │ Партнёр  │ Подключений │ Статус │ Действия │
│  ├───────────────┼──────────┼─────────────┼────────┼──────────┤
│  │ ChatNorris    │ ChatNorr │ 5 орг / 12gr│ Active │ [Edit]   │
│  │ Analytics Bot │ Orbo     │ 0           │ Draft  │ [Edit]   │
└────────────────────────────────────────────────────────────┘
```

### 1.4 Файлы для создания

```
db/migrations/180_public_apps_catalog.sql
app/admin/public-apps/page.tsx
app/api/admin/public-apps/route.ts
app/api/admin/public-apps/[id]/route.ts
app/p/[org]/apps/catalog/page.tsx
app/api/apps/catalog/route.ts
app/api/apps/catalog/[appId]/connect/route.ts
components/apps/public-app-card.tsx
components/apps/connect-app-dialog.tsx
```

### 1.5 Первый партнёр: Votum (@votumfit_bot)

**Описание:**
Votum — бот для мэтчинга запросов участников сообществ. Участники публикуют запросы, бот помогает найти релевантные предложения от других участников.

**Интеграция (MVP):**
1. Размещение в публичном каталоге Orbo
2. Отслеживание факта подключения в организации
3. Трекинг: в каких группах установлен бот

**Ценность для Orbo:**
- Дополняет CRM-функционал — не только анализируем, но и помогаем участникам находить друг друга
- Повышает ценность участия в сообществе
- Демонстрирует модель партнёрской экосистемы

**Что НЕ делаем на старте:**
- API интеграция
- Revenue share (монетизация за пределами платформы)

---

## 2️⃣ МАССОВОЕ ИНФОРМИРОВАНИЕ (ANNOUNCEMENTS)

### 2.1 Концепция

```
┌─────────────────────────────────────────────────────────────┐
│                 ANNOUNCEMENTS SYSTEM                        │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─────────────────┐    ┌─────────────────────────────────┐ │
│  │  СОЗДАНИЕ       │    │  КАЛЕНДАРЬ И ОЧЕРЕДЬ            │ │
│  ├─────────────────┤    ├─────────────────────────────────┤ │
│  │ • TG-формат     │    │     Январь 2026                 │ │
│  │   + эмодзи      │    │ Пн  Вт  Ср  Чт  Пт  Сб  Вс     │ │
│  │ • Выбор групп   │    │          1   2   3   4   5      │ │
│  │ • Время публик. │    │  6   7   8   9  10  11  12     │ │
│  │ • Повторение    │    │      📅      📅                  │ │
│  │                 │    │ 13  14  15  16  17  18  19     │ │
│  └─────────────────┘    └─────────────────────────────────┘ │
│                                                             │
│  ┌─────────────────────────────────────────────────────────┐│
│  │              АВТОРСТВО АНОНСОВ                          ││
│  ├─────────────────────────────────────────────────────────┤│
│  │ У каждого анонса указывается автор:                    ││
│  │   • 👑 Владелец                                        ││
│  │   • 👤 Конкретный админ                                ││
│  │   • 🤖 Автоматический (при создании события)           ││
│  │                                                         ││
│  │ При создании СОБЫТИЯ можно сгенерировать анонсы:       ││
│  │   • ☑️ За 24 часа (по умолчанию)                        ││
│  │   • ☑️ За 1 час (по умолчанию)                          ││
│  │   • Все можно редактировать в очереди                  ││
│  │                                                         ││
│  │ 📰 Дайджест (будущее) — еженедельная сводка            ││
│  └─────────────────────────────────────────────────────────┘│
│                                                             │
│  ┌─────────────────────────────────────────────────────────┐│
│  │              АРХИВ ПУБЛИКАЦИЙ                           ││
│  ├─────────────────────────────────────────────────────────┤│
│  │ • Что отправлено, когда, в какие группы                ││
│  │ • Статус доставки (sent/failed)                        ││
│  │ • Ссылка на сообщение в Telegram                       ││
│  └─────────────────────────────────────────────────────────┘│
└─────────────────────────────────────────────────────────────┘
```

### 2.2 Таблицы БД

```sql
-- Анонсы (запланированные и отправленные)
CREATE TABLE announcements (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  created_at TIMESTAMPTZ DEFAULT NOW(),
  org_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,
  
  -- Контент (Telegram-форматирование: *жирный*, _курсив_, ~зачёркнутый~, ||скрытый|| + эмодзи)
  content_text TEXT NOT NULL,              -- Текст сообщения
  parse_mode TEXT DEFAULT 'MarkdownV2',    -- 'MarkdownV2' или 'HTML'
  -- БЕЗ медиа на старте (content_media можно добавить позже)
  
  -- Авторство
  author_type TEXT NOT NULL,               -- 'owner', 'admin', 'automatic'
  author_user_id UUID REFERENCES auth.users(id), -- null для automatic
  
  -- Куда отправлять
  target_groups JSONB NOT NULL,            -- [{chat_id, title}] или "all"
  
  -- Планирование
  scheduled_at TIMESTAMPTZ,                -- Когда отправить (null = сразу)
  sent_at TIMESTAMPTZ,                     -- Когда фактически отправлено
  
  -- Статус
  status TEXT DEFAULT 'draft',             -- draft, scheduled, sending, sent, failed, cancelled
  
  -- Связь с событием (если авто-создан при создании события)
  event_id UUID REFERENCES events(id),     -- null для ручных анонсов
  reminder_hours_before INTEGER,           -- 24, 1 и т.п. для напоминаний
  
  -- Метаданные
  created_by UUID REFERENCES auth.users(id),
  edited_at TIMESTAMPTZ,
  edited_by UUID REFERENCES auth.users(id)
);

-- Лог отправок в каждую группу
CREATE TABLE announcement_deliveries (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  created_at TIMESTAMPTZ DEFAULT NOW(),
  
  announcement_id UUID REFERENCES announcements(id) ON DELETE CASCADE,
  tg_chat_id BIGINT NOT NULL,
  
  -- Результат
  status TEXT DEFAULT 'pending',           -- pending, sent, failed
  tg_message_id BIGINT,                    -- ID сообщения в Telegram
  error_message TEXT,
  sent_at TIMESTAMPTZ
);

CREATE INDEX idx_announcements_org_status ON announcements(org_id, status);
CREATE INDEX idx_announcements_scheduled ON announcements(scheduled_at) 
  WHERE status = 'scheduled';
```

### 2.3 Интеграция с событиями

**Автоматические анонсы событий:**
1. При создании события → автоматически создаётся `announcement` со `source_type='event_reminder_24h'`
2. Статус `scheduled`, время = `event_date - 24h`
3. Контент генерируется из шаблона, но редактируемый
4. Админ может изменить текст или отменить

**Шаблон напоминания:**
```
📅 Завтра: {event_title}

🕐 {start_time} — {end_time}
📍 {location или "Онлайн"}

{description (первые 200 символов)}

👉 Регистрация: {link}
```

### 2.4 UI страницы

**Страница /p/[org]/announcements:**
```
┌────────────────────────────────────────────────────────────┐
│  📢 Анонсы                              [+ Создать анонс]   │
├────────────────────────────────────────────────────────────┤
│                                                            │
│  [Календарь]  [Очередь]  [Архив]                           │
│                                                            │
│  ─── Запланировано (3) ────────────────────────────────── │
│  │ 📅 Напоминание: Бизнес-завтрак         │ 8 янв 10:00 │ │
│  │ 📢 Новогоднее поздравление             │ 10 янв 12:00│ │
│  │ 📅 Напоминание: Мастермайнд            │ 15 янв 10:00│ │
│                                                            │
│  ─── Отправлено сегодня (1) ──────────────────────────── │
│  │ 📢 Важные изменения правил        │ отправлено 09:00 │ │
│  │    → Группа 1, Группа 2 ✓                             │ │
│                                                            │
└────────────────────────────────────────────────────────────┘
```

### 2.5 Файлы для создания

```
db/migrations/181_announcements.sql
app/p/[org]/announcements/page.tsx
app/p/[org]/announcements/[id]/page.tsx
app/p/[org]/announcements/new/page.tsx
app/api/announcements/route.ts
app/api/announcements/[id]/route.ts
app/api/announcements/[id]/send/route.ts
app/api/cron/send-scheduled-announcements/route.ts
lib/services/announcementService.ts
components/announcements/announcement-form.tsx
components/announcements/announcement-calendar.tsx
components/announcements/group-selector.tsx
```

---

## 3️⃣ РОЛИ СОТРУДНИКОВ + OFFBOARDING

### 3.1 Концепция ролей

```
┌─────────────────────────────────────────────────────────────┐
│                 EMPLOYEE ROLES SYSTEM                       │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─────────────────────────────────────────────────────────┐│
│  │           ТИПЫ УЧАСТНИКОВ                               ││
│  ├─────────────────────────────────────────────────────────┤│
│  │                                                         ││
│  │  👤 Обычный участник (по умолчанию)                    ││
│  │     └── Клиент, потенциальный клиент, гость            ││
│  │                                                         ││
│  │  👔 Сотрудник организации                              ││
│  │     ├── 💼 Аккаунт-менеджер                            ││
│  │     ├── 📊 Менеджер проектов                           ││
│  │     ├── 🎯 Комьюнити-менеджер                          ││
│  │     ├── 💰 Сейлз                                       ││
│  │     ├── 🛠 Тех. поддержка                              ││
│  │     └── 📝 Другое (custom)                             ││
│  │                                                         ││
│  └─────────────────────────────────────────────────────────┘│
│                                                             │
│  ┌─────────────────────────────────────────────────────────┐│
│  │           ПРОЗРАЧНОСТЬ ПРИСУТСТВИЯ (MVP)                ││
│  ├─────────────────────────────────────────────────────────┤│
│  │                                                         ││
│  │  1. Открыть профиль сотрудника                         ││
│  │  2. Вкладка "Сотрудник" показывает:                    ││
│  │     ├── Все группы, где состоит (с ролью в группе)     ││
│  │     ├── Ссылки для перехода в Telegram                 ││
│  │     └── Дату входа в каждую группу                     ││
│  │  3. Для удаления → переход в Telegram вручную          ││
│  │                                                         ││
│  │  ⏳ БУДУЩЕЕ: автоматическое удаление из групп           ││
│  │                                                         ││
│  └─────────────────────────────────────────────────────────┘│
└─────────────────────────────────────────────────────────────┘
```

### 3.2 Изменения в БД

```sql
-- Роли сотрудников (кастомные, создаются организацией)
CREATE TABLE employee_roles (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  org_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,
  
  name TEXT NOT NULL,                      -- "Аккаунт-менеджер"
  description TEXT,                        -- Описание для AI-анализа
  color TEXT,                              -- Цвет для UI
  icon TEXT,                               -- Emoji/иконка
  
  -- Для AI-анализа
  ai_context TEXT,                         -- "Должен отвечать клиентам в течение 2ч"
  
  sort_order INTEGER DEFAULT 0,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  
  UNIQUE(org_id, name)
);

-- Назначение ролей участникам
ALTER TABLE participants 
  ADD COLUMN is_employee BOOLEAN DEFAULT false,
  ADD COLUMN employee_role_id UUID REFERENCES employee_roles(id),
  ADD COLUMN employee_since TIMESTAMPTZ,
  ADD COLUMN employee_notes TEXT;

-- Индекс для быстрого поиска сотрудников
CREATE INDEX idx_participants_employees ON participants(org_id, is_employee) 
  WHERE is_employee = true;

-- БЕЗ системных ролей — организация создаёт свои
```

### 3.2.1 Назначение ролей сотрудников

**Роли НЕ дают прав доступа.** Используются для:
- Фильтрации в CRM (сотрудники vs клиенты)
- AI-анализа коммуникаций (например: "ни один менеджер не ответил клиенту за 2 часа")
- Прозрачности при offboarding

**Описание роли для AI:**
При создании роли админ может указать контекст для AI-анализа:
- "Аккаунт-менеджер — должен отвечать клиентам в течение 2 рабочих часов"
- "Сейлз — работает с лидами, может инициировать разговоры"

### 3.3 UI изменения

**В профиле участника (вкладка "Сотрудник"):**
```
┌────────────────────────────────────────────────────────────┐
│  👤 Иван Петров                                            │
│  @ivan_petrov                                              │
├────────────────────────────────────────────────────────────┤
│                                                            │
│  [Информация] [Активность] [Группы] [Сотрудник]            │
│                                                            │
│  ─── Статус сотрудника ───────────────────────────────────│
│  │ ✅ Является сотрудником организации                   │ │
│  │ Роль: 💼 Аккаунт-менеджер                             │ │
│  │ С: 15 марта 2025                                      │ │
│  │                                                        │ │
│  │ [Изменить роль]  [Снять статус сотрудника]            │ │
│                                                            │
│  ─── Группы, где состоит (5) ─────────────────────────────│
│  ⚠️ Для удаления перейдите в группу через Telegram        │
│                                                            │
│  │ Клиенты "Проект А"    │ admin  │ [Открыть в TG →]    │ │
│  │ Клиенты "Проект Б"    │ admin  │ [Открыть в TG →]    │ │
│  │ Внутренний чат        │ member │ [Открыть в TG →]    │ │
│  │ Рабочий чат команды   │ admin  │ [Открыть в TG →]    │ │
│  │ Клуб участников       │ member │ [Открыть в TG →]    │ │
│                                                            │
└────────────────────────────────────────────────────────────┘
```

**Фильтр в списке участников:**
```
┌─────────────────────────────────────────┐
│  Фильтры                                │
│  ─────────────────────────────────────  │
│  ○ Все участники                        │
│  ○ Только сотрудники                    │
│  ○ Только не сотрудники                 │
│                                         │
│  Роль сотрудника:                       │
│  [Все роли              ▼]              │
└─────────────────────────────────────────┘
```

**Настройка ролей (в разделе "Команда" или "Настройки организации"):**
```
┌────────────────────────────────────────────────────────────┐
│  👔 Роли сотрудников                          [+ Создать]   │
├────────────────────────────────────────────────────────────┤
│                                                            │
│  │ 💼 Аккаунт-менеджер                                   │ │
│  │    Должен отвечать клиентам в течение 2ч              │ │
│  │    Сотрудников: 3                      [Изменить]     │ │
│                                                            │
│  │ 📊 Менеджер проектов                                  │ │
│  │    Координирует работу команды                        │ │
│  │    Сотрудников: 1                      [Изменить]     │ │
│                                                            │
│  │ 💰 Сейлз                                              │ │
│  │    Работает с лидами, инициирует продажи              │ │
│  │    Сотрудников: 2                      [Изменить]     │ │
│                                                            │
└────────────────────────────────────────────────────────────┘
```

### 3.4 Файлы для создания

```
db/migrations/182_employee_roles.sql
app/api/participants/[id]/employee/route.ts
app/api/participants/[id]/offboard/route.ts
app/api/employee-roles/route.ts
app/p/[org]/settings/employee-roles/page.tsx
components/participants/employee-status-card.tsx
components/participants/offboarding-dialog.tsx
components/participants/employee-role-badge.tsx
```

---

## 4️⃣ ПОДГОТОВКА К БИЛЛИНГУ

### 4.1 Концепция тарифов

```
┌─────────────────────────────────────────────────────────────┐
│                    ТАРИФНЫЕ ПЛАНЫ                           │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────┐ │
│  │   FREE      │  │   PRO       │  │   ENTERPRISE        │ │
│  ├─────────────┤  ├─────────────┤  ├─────────────────────┤ │
│  │ 0 ₽/мес    │  │ 2900 ₽/мес  │  │ Индивидуально       │ │
│  │             │  │             │  │                     │ │
│  │ • 5 групп   │  │ • 15 групп  │  │ • Без ограничений   │ │
│  │ • 200 уч-в  │  │ • 5000 уч-в │  │ • SLA               │ │
│  │ • Базовая   │  │ • AI-анализ │  │ • API доступ        │ │
│  │   аналитика │  │ • Анонсы    │  │ • Выделенный        │ │
│  │ • Нет AI    │  │ • Роли сотр.│  │   менеджер          │ │
│  │             │  │ • Приоритет │  │ • Кастомизации      │ │
│  └─────────────┘  │   поддержки │  │                     │ │
│                   └─────────────┘  └─────────────────────┘ │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 4.2 Изменения в БД

```sql
-- Тарифные планы (справочник)
CREATE TABLE billing_plans (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  code TEXT NOT NULL UNIQUE,               -- 'free', 'pro', 'enterprise'
  name TEXT NOT NULL,
  description TEXT,
  
  -- Ценообразование
  price_monthly INTEGER DEFAULT 0,         -- В копейках (290000 = 2900 руб)
  price_yearly INTEGER DEFAULT 0,          -- Годовой тариф (скидка)
  currency TEXT DEFAULT 'RUB',
  
  -- Лимиты
  limits JSONB NOT NULL DEFAULT '{}'::jsonb,
  /*
    {
      "groups": 1,
      "participants": 100,
      "ai_requests_per_month": 0,
      "announcements_per_month": 0,
      "employee_roles": false,
      "api_access": false,
      "priority_support": false
    }
  */
  
  -- Метаданные
  is_active BOOLEAN DEFAULT true,
  sort_order INTEGER DEFAULT 0,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Подписки организаций
CREATE TABLE org_subscriptions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  org_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,
  plan_id UUID NOT NULL REFERENCES billing_plans(id),
  
  -- Период
  started_at TIMESTAMPTZ DEFAULT NOW(),
  expires_at TIMESTAMPTZ,                  -- null = бессрочно (free)
  
  -- Статус
  status TEXT DEFAULT 'active',            -- active, cancelled, expired, past_due
  
  -- Платежи (будущее)
  payment_provider TEXT,                   -- 'stripe', 'yookassa', 'manual'
  external_subscription_id TEXT,           -- ID в платёжке
  
  -- История
  cancelled_at TIMESTAMPTZ,
  cancellation_reason TEXT,
  
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),
  
  UNIQUE(org_id)                           -- Одна подписка на организацию
);

-- Использование лимитов (для отслеживания)
CREATE TABLE org_usage (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  org_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,
  month TEXT NOT NULL,                     -- '2026-01'
  
  groups_count INTEGER DEFAULT 0,
  participants_count INTEGER DEFAULT 0,
  ai_requests_count INTEGER DEFAULT 0,
  announcements_count INTEGER DEFAULT 0,
  
  updated_at TIMESTAMPTZ DEFAULT NOW(),
  
  UNIQUE(org_id, month)
);

-- Вставка базовых планов
INSERT INTO billing_plans (code, name, price_monthly, limits, sort_order) VALUES
  ('free', 'Free', 0, '{"groups": 5, "participants": 200, "ai_requests_per_month": 0}', 1),
  ('pro', 'Pro', 290000, '{"groups": 15, "participants": 5000, "ai_requests_per_month": 500}', 2),
  ('enterprise', 'Enterprise', 0, '{"groups": -1, "participants": -1, "ai_requests_per_month": -1}', 3);

-- Trial статус для org_subscriptions
-- status: 'trial' | 'active' | 'past_due' | 'blocked' | 'cancelled'
```

### 4.2.1 Trial период и блокировка

**По умолчанию:** Новые организации регистрируются на **PRO Trial (14 дней)**

**После окончания Trial:**
1. Если организация подходит под критерии Free (≤200 участников, ≤5 групп) → **автоматический downgrade на Free**
2. Если превышает лимиты Free → уведомление о необходимости оплаты

**Критерии downgrade:**
- Количество активных участников ≤ 200
- Количество подключённых групп ≤ 5
- Не использует Pro-функции активно

**Механика оплаты (MVP):**
- Ручное выставление счетов (менеджером)
- Статус оплаты в системе
- Таблица счетов и истории платежей

```sql
-- Счета (ручное выставление)
CREATE TABLE invoices (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  org_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,
  
  amount INTEGER NOT NULL,                -- В копейках
  currency TEXT DEFAULT 'RUB',
  description TEXT,
  
  status TEXT DEFAULT 'pending',          -- pending, paid, cancelled
  due_date DATE,
  paid_at TIMESTAMPTZ,
  
  created_by UUID REFERENCES auth.users(id),
  created_at TIMESTAMPTZ DEFAULT NOW()
);
```

**Механика блокировки:**

```
┌────────────────────────────────────────────────────────────────┐
│           БЛОКИРОВКА ПРИ НЕОПЛАТЕ                              │
├────────────────────────────────────────────────────────────────┤
│                                                                │
│  ⚠️ Что происходит при просрочке оплаты:                       │
│                                                                │
│  1. ДАШБОРД — ✅ ДОСТУПЕН                                       │
│     └─ Видит общую статистику и уведомление о необходимости    │
│        оплаты                                                  │
│                                                                │
│  2. ВСЕ ОСТАЛЬНЫЕ РАЗДЕЛЫ — ❌ РЕДИРЕКТ НА ОПЛАТУ               │
│     ├─ Участники                                               │
│     ├─ Telegram-группы                                         │
│     ├─ Аналитика                                               │
│     ├─ Мероприятия                                             │
│     ├─ Приложения                                              │
│     ├─ Анонсы                                                  │
│     └─ Настройки (кроме биллинга)                              │
│                                                                │
│  3. ВНУТРЕННИЕ МЕХАНИЗМЫ — ✅ ПРОДОЛЖАЮТ РАБОТАТЬ               │
│     ├─ Сбор активности                                         │
│     ├─ Уведомления (согласно настроенным правилам)             │
│     └─ Обновление метрик                                       │
│                                                                │
│  Это позволяет:                                                │
│  • Не терять данные организации                                │
│  • Не ухудшать метрики сбора активности                        │
│  • Мотивировать к оплате, но не блокировать жёстко             │
│                                                                │
└────────────────────────────────────────────────────────────────┘
```

### 4.3 Middleware для проверки лимитов

```typescript
// lib/billing/checkLimits.ts
export async function checkGroupLimit(orgId: string): Promise<{allowed: boolean, current: number, limit: number}> {
  // Получить текущий план организации
  // Посчитать количество групп
  // Сравнить с лимитом
}

export async function checkAIRequestLimit(orgId: string): Promise<boolean> {
  // Проверить лимит AI-запросов за месяц
}
```

### 4.4 UI для отображения лимитов

**В настройках организации:**
```
┌────────────────────────────────────────────────────────────┐
│  💳 Тариф и лимиты                                         │
├────────────────────────────────────────────────────────────┤
│                                                            │
│  Текущий тариф: PRO (до 15 февраля 2026)                   │
│                                                            │
│  ─── Использование ───────────────────────────────────────│
│  │ Группы:        3 / 10   ████████░░░░░░░░░░░ 30%       │ │
│  │ Участники:    450 / 1000 ████████████░░░░░░░ 45%      │ │
│  │ AI-запросы:   120 / 500  █████████░░░░░░░░░░ 24%      │ │
│                                                            │
│  [Изменить тариф]                                          │
│                                                            │
└────────────────────────────────────────────────────────────┘
```

### 4.5 Файлы для создания

```
db/migrations/183_billing_infrastructure.sql
lib/billing/plans.ts
lib/billing/checkLimits.ts
lib/billing/usage.ts
app/api/billing/plans/route.ts
app/api/billing/subscription/route.ts
app/api/billing/usage/route.ts
app/p/[org]/settings/billing/page.tsx
components/billing/plan-card.tsx
components/billing/usage-meter.tsx
```

---

## 📋 ВОПРОСЫ И РЕШЕНИЯ

### Партнёрство (✅ Отвечено):

1. **Первый партнёр:** Votum (@votumfit_bot) — не ChatNorris
2. **Монетизация:** За пределами платформы на старте
3. **API:** Не делаем. Достаточно: размещение + факт подключения + в каких группах

### Анонсы (✅ Отвечено):

4. **Медиа:** НЕТ на старте. Telegram-форматирование + эмодзи
5. **Авто-анонсы:** ДА — создавать при создании события, можно редактировать
6. **Дайджест:** Оставить на будущее

### Роли (✅ Отвечено):

7. **Права:** Роль НЕ даёт прав. Используется для AI-анализа коммуникаций
8. **Фильтрация:** В разделе участников. Настройка ролей — отдельно (в "Команда" или настройках)
9. **Offboarding:** На старте — только прозрачность (ссылки на группы). Автоудаление — позже

### Биллинг (✅ Отвечено):

10. **Платёжка:** Ручные счета на старте
11. **Trial:** ДА, 14 дней PRO. После — downgrade на Free если подходит
12. **Блокировка:** Мягкая — дашборд доступен, остальное → оплата. Механизмы работают

---

## 💡 ДОПОЛНИТЕЛЬНЫЕ ПРЕДЛОЖЕНИЯ ПО ФУНКЦИОНАЛУ

### Предложение: Фирменный Telegram MiniApp для сообщества

**Что делаем:**
Брендированный MiniApp организации для участников (не админов), который:
1. Обеспечивает процедуру **ассесмента** (одобрения запросов на участие)
2. Даёт доступ к публичной части (как в веб-версии)

**Функционал для кандидатов:**
```
┌────────────────────────────────────────────────────────────┐
│  🏢 [Название сообщества]                                  │
│  Telegram MiniApp                                          │
├────────────────────────────────────────────────────────────┤
│                                                            │
│  📝 Заявка на вступление                                   │
│                                                            │
│  Ваше имя: [___________________________]                   │
│  О себе:   [___________________________]                   │
│  Чем занимаетесь: [____________________]                   │
│  Почему хотите вступить: [_____________]                   │
│                                                            │
│  [✓ Согласен с правилами]                                  │
│                                                            │
│  [Отправить заявку]                                        │
│                                                            │
│  ─────────────────────────────────────────────────────────│
│  Ваша заявка будет рассмотрена в течение 24 часов         │
└────────────────────────────────────────────────────────────┘
```

**Функционал для участников:**
```
┌────────────────────────────────────────────────────────────┐
│  🏢 [Название сообщества]                                  │
│  Добро пожаловать, Иван!                                   │
├────────────────────────────────────────────────────────────┤
│                                                            │
│  [📅 События]  [🧩 Приложения]  [👥 Участники]              │
│                                                            │
│  ─── Ближайшие события ────────────────────────────────── │
│  │ 15 янв — Нетворкинг-встреча           [Записаться]    │ │
│  │ 22 янв — Мастер-класс                 [Записаться]    │ │
│                                                            │
│  ─── Приложения сообщества ─────────────────────────────  │
│  │ 📦 Барахолка              [Открыть]                   │ │
│  │ 💼 Вакансии               [Открыть]                   │ │
│                                                            │
│  [👤 Мой профиль]                                          │
│                                                            │
└────────────────────────────────────────────────────────────┘
```

**Аргументация:**
- Процедура ассесмента = качество участников + меньше спама
- Участники получают доступ к событиям/приложениям прямо в Telegram
- Унификация: все приложения = Telegram MiniApps (в т.ч. фирменный)
- Снижает порог входа для участников (не нужен веб-интерфейс)
- Брендирование: логотип, цвета, название сообщества

**Объём:** 10-14 дней разработки (после MVP каталога и анонсов)

---

## 🗓 ПРЕДЛАГАЕМЫЙ ТАЙМЛАЙН

### Февраль 2026:

| Неделя | Фокус | Задачи |
|--------|-------|--------|
| **1-2** | Партнёрский каталог + Votum | БД + Superadmin UI + Интеграция Votum (@votumfit_bot) |
| **3-4** | Анонсы MVP | БД + UI + Telegram-форматирование + Авто-анонсы событий |

### Март 2026:

| Неделя | Фокус | Задачи |
|--------|-------|--------|
| **1-2** | Роли сотрудников | Кастомные роли + Фильтрация + Прозрачность в группах |
| **3-4** | Биллинг инфра | Trial 14 дней + Ручные счета + Soft-blocking |

### Апрель 2026 (перспектива):

- Фирменный MiniApp для сообщества (ассесмент + доступ к событиям/приложениям)
- Переработка конструктора внутренних приложений
- API для внешних приложений
- Расширенная аналитика (когорты, прогноз оттока)

---

## 📊 МЕТРИКИ УСПЕХА

| Метрика | Цель (март 2026) |
|---------|------------------|
| Votum подключён и отображается в каталоге | ✅ |
| Организаций, подключивших Votum | ≥ 5 |
| Отправленных анонсов | ≥ 50 |
| Организаций с размеченными сотрудниками | ≥ 5 |
| Организаций на Trial PRO | ≥ 10 |
| Ручных счетов выставлено | ≥ 3 |

---

## 🎯 ПРИОРИТЕТЫ ПО ПРЕДЛОЖЕНИЯМ

| Предложение | Приоритет | Когда | Причина |
|-------------|-----------|-------|---------|
| Фирменный MiniApp для сообщества | MEDIUM | Апрель 2026 | Ассесмент + унификация всех приложений как MiniApps |
| Переработка внутренних приложений | MEDIUM | После Votum | Требует унификации с партнёрскими MiniApps |

---

**Статус:** ✅ Ready for Implementation  
**Следующий шаг:** Детальная спецификация для Votum + Партнёрский каталог (Февраль W1-2)

---

*Last Updated: 7 января 2026*

