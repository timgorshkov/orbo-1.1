# –ü–æ–ª–Ω–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º —Å –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ–º —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤

## –ü—Ä–æ–±–ª–µ–º—ã

### 1. –°–ø–∏—Å–æ–∫ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –Ω–µ —É–º–µ–Ω—å—à–∞–µ—Ç—Å—è –ø–æ—Å–ª–µ –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏—è
**–°–∏–º–ø—Ç–æ–º**: –ü–æ—Å–ª–µ –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏—è –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ –≤ —Å–ø–∏—Å–∫–µ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –≤—Å–µ –µ—â–µ –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –æ–±—ä–µ–¥–∏–Ω–µ–Ω–Ω—ã–µ –ø—Ä–æ—Ñ–∏–ª–∏.

**–ü—Ä–∏—á–∏–Ω–∞**: –ó–∞–ø—Ä–æ—Å –≤ `app/app/[org]/members/page.tsx` –Ω–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–ª —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ —Å `merged_into != null`.

### 2. –ü–æ–ª—è –Ω–µ –∑–∞–ø–æ–ª–Ω—è—é—Ç—Å—è –ø–æ—Å–ª–µ –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏—è
**–°–∏–º–ø—Ç–æ–º**: –í—Å–ø–ª—ã–≤–∞—é—â–µ–µ –æ–∫–Ω–æ —Å–æ–æ–±—â–∞–µ—Ç, —á—Ç–æ –ø–æ–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω—ã, –Ω–æ –≤ –ø—Ä–æ—Ñ–∏–ª–µ –æ–Ω–∏ –ø—É—Å—Ç—ã–µ.

**–ü—Ä–∏—á–∏–Ω–∞**: SQL —Ñ—É–Ω–∫—Ü–∏—è `merge_participants_smart` –∑–∞–≥—Ä—É–∂–∞–ª–∞ `v_target_record` –æ–¥–∏–Ω —Ä–∞–∑ –≤ –Ω–∞—á–∞–ª–µ –∏ –Ω–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–ª–∞ –µ–≥–æ –ø–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–∞–∂–¥–æ–≥–æ –¥—É–±–ª–∏–∫–∞—Ç–∞. –ü—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∏—Å—å —É—Å—Ç–∞—Ä–µ–≤—à–∏–µ –¥–∞–Ω–Ω—ã–µ.

### 3. –•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ –Ω–µ –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è
**–°–∏–º–ø—Ç–æ–º**: –í—Å–ø–ª—ã–≤–∞—é—â–µ–µ –æ–∫–Ω–æ –≥–æ–≤–æ—Ä–∏—Ç, —á—Ç–æ –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏, –Ω–æ –≤ –ø—Ä–æ—Ñ–∏–ª–µ –∏—Ö –Ω–µ—Ç.

**–ü—Ä–∏—á–∏–Ω–∞**: –ö–æ–º–ø–æ–Ω–µ–Ω—Ç `participant-profile-card.tsx` –æ—Ç–æ–±—Ä–∞–∂–∞–ª —Ç–æ–ª—å–∫–æ `custom_attributes` (JSON –ø–æ–ª–µ), –Ω–æ –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–ª `traits` –∏–∑ —Ç–∞–±–ª–∏—Ü—ã `participant_traits`, –∫—É–¥–∞ —Ñ—É–Ω–∫—Ü–∏—è merge —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã.

## –†–µ—à–µ–Ω–∏—è

### –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ 1: –§–∏–ª—å—Ç—Ä –æ–±—ä–µ–¥–∏–Ω–µ–Ω–Ω—ã—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –≤ —Å–ø–∏—Å–∫–µ

**–§–∞–π–ª**: `app/app/[org]/members/page.tsx`

**–ë—ã–ª–æ**:
```typescript
const { data: participants, error } = await adminSupabase
  .from('participants')
  .select('*')
  .eq('org_id', orgId)
  .neq('participant_status', 'excluded')
  .order('full_name', { ascending: true, nullsFirst: false })
```

**–°—Ç–∞–ª–æ**:
```typescript
const { data: participants, error} = await adminSupabase
  .from('participants')
  .select('*')
  .eq('org_id', orgId)
  .neq('participant_status', 'excluded')
  .is('merged_into', null) // ‚úÖ –ò—Å–∫–ª—é—á–∞–µ–º –æ–±—ä–µ–¥–∏–Ω–µ–Ω–Ω—ã—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
  .order('full_name', { ascending: true, nullsFirst: false })
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç**: –û–±—ä–µ–¥–∏–Ω–µ–Ω–Ω—ã–µ —É—á–∞—Å—Ç–Ω–∏–∫–∏ –±–æ–ª—å—à–µ –Ω–µ –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –≤ —Å–ø–∏—Å–∫–µ.

---

### –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ 2: –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ target record –≤ SQL —Ñ—É–Ω–∫—Ü–∏–∏

**–§–∞–π–ª**: `db/migrations/26_fix_merge_smart_reload.sql`

**–ü—Ä–æ–±–ª–µ–º–∞ –≤ —Å—Ç–∞—Ä–æ–π –≤–µ—Ä—Å–∏–∏**:
```sql
-- –ó–∞–≥—Ä—É–∂–∞–ª–æ—Å—å –î–û —Ü–∏–∫–ª–∞
SELECT * INTO v_target_record
FROM public.participants
WHERE id = p_target;

FOREACH v_duplicate IN ARRAY p_duplicates
LOOP
  -- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è v_target_record (—É—Å—Ç–∞—Ä–µ–≤—à–∏–µ –¥–∞–Ω–Ω—ã–µ!)
  v_target_value := v_target_record.full_name;
  
  -- –û–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –ë–î
  UPDATE public.participants
  SET full_name = v_duplicate_value
  WHERE id = p_target;
  
  -- –ù–æ v_target_record –Ω–µ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è!
END LOOP;
```

**–ù–æ–≤–∞—è –≤–µ—Ä—Å–∏—è**:
```sql
FOREACH v_duplicate IN ARRAY p_duplicates
LOOP
  -- ‚úÖ –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º target –ø–µ—Ä–µ–¥ –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –∫–∞–∂–¥–æ–≥–æ –¥—É–±–ª–∏–∫–∞—Ç–∞
  SELECT * INTO v_target_record
  FROM public.participants
  WHERE id = p_target;
  
  -- –¢–µ–ø–µ—Ä—å –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
  v_target_value := v_target_record.full_name;
  
  IF v_target_value IS NULL AND v_duplicate_value IS NOT NULL THEN
    UPDATE public.participants
    SET full_name = v_duplicate_value
    WHERE id = p_target;
  END IF;
END LOOP;
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç**: –ü—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ –∫–∞–∂–¥—ã–π –ø–æ—Å–ª–µ–¥—É—é—â–∏–π –≤–∏–¥–∏—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ.

---

### –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ 3: –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ traits –≤ –ø—Ä–æ—Ñ–∏–ª–µ

**–§–∞–π–ª**: `components/members/participant-profile-card.tsx`

**–î–æ–±–∞–≤–ª–µ–Ω–æ**:
```tsx
{/* Traits from database (including merged conflicts) */}
{detail.traits && detail.traits.length > 0 && (
  <div className="space-y-2 mb-4">
    <h4 className="text-sm font-medium text-gray-600 mb-2">
      –•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
    </h4>
    {detail.traits.map((trait) => (
      <div 
        key={trait.id} 
        className={`flex items-start gap-3 p-3 rounded-lg ${
          trait.source === 'merge' 
            ? 'bg-amber-50 border border-amber-200' 
            : 'bg-gray-50'
        }`}
      >
        <div className="flex-1">
          <div className="flex items-center gap-2">
            <div className="text-xs font-medium text-gray-500 uppercase tracking-wide">
              {trait.trait_key}
            </div>
            {trait.source === 'merge' && (
              <span className="text-xs px-2 py-0.5 rounded-full bg-amber-100 text-amber-800">
                –ò–∑ –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏—è
              </span>
            )}
          </div>
          <div className="text-sm text-gray-900 mt-1">{trait.trait_value}</div>
          {trait.metadata && trait.source === 'merge' && (
            <div className="text-xs text-gray-500 mt-1">
              {trait.metadata.conflict_with && (
                <span>–ö–æ–Ω—Ñ–ª–∏–∫—Ç —Å: {trait.metadata.conflict_with}</span>
              )}
            </div>
          )}
        </div>
      </div>
    ))}
  </div>
)}
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç**: 
- Traits –∏–∑ `participant_traits` —Ç–µ–ø–µ—Ä—å –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –≤ –ø—Ä–æ—Ñ–∏–ª–µ
- –ö–æ–Ω—Ñ–ª–∏–∫—Ç—ã –∏–∑ –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏—è –≤—ã–¥–µ–ª–µ–Ω—ã —è–Ω—Ç–∞—Ä–Ω—ã–º —Ñ–æ–Ω–æ–º –∏ –º–µ—Ç–∫–æ–π "–ò–∑ –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏—è"
- –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è, —Å –∫–∞–∫–∏–º –∑–Ω–∞—á–µ–Ω–∏–µ–º –±—ã–ª –∫–æ–Ω—Ñ–ª–∏–∫—Ç

---

### –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ 4: –ò—Å–∫–ª—é—á–µ–Ω–∏–µ –æ–±—ä–µ–¥–∏–Ω–µ–Ω–Ω—ã—Ö –∏–∑ –ø–æ–∏—Å–∫–∞ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤

**–§–∞–π–ª—ã**: 
- `lib/services/participants/matcher.ts`
- `app/api/participants/[participantId]/route.ts`

**–ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ matcher.ts**:
```typescript
const query = this.supabase
  .from('participants')
  .select('id, org_id, ..., merged_into')
  .eq('org_id', intent.orgId)
  .is('merged_into', null) // ‚úÖ –ò—Å–∫–ª—é—á–∞–µ–º —É–∂–µ –æ–±—ä–µ–¥–∏–Ω–µ–Ω–Ω—ã—Ö
```

**–î–æ–±–∞–≤–ª–µ–Ω–æ –¥–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ route.ts**:
```typescript
console.log('Merge check - Current participant:', {
  id: participantId,
  merged_into: participantRecord.merged_into,
  status: participantRecord.status,
  canonicalId
});

console.log('Merge check - Target participant:', {
  id: targetId,
  merged_into: targetRecord.merged_into,
  status: targetRecord.status,
  targetCanonical
});
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç**: –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∞ –æ—à–∏–±–∫–∞ "Participants already share canonical record".

---

## –ü–æ–ª–Ω—ã–π workflow –ø–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π

### –°—Ü–µ–Ω–∞—Ä–∏–π 1: –û–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ –¥–≤—É—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤

```
–ù–∞—á–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ:
- –£—á–∞—Å—Ç–Ω–∏–∫ A: { full_name: "–ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤", email: "ivan@old.com", phone: null }
- –£—á–∞—Å—Ç–Ω–∏–∫ B: { full_name: "–ò–≤–∞–Ω –ò.", email: "ivan@new.com", phone: "+7123456" }

–û–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ A + B:

1. API –≤—ã–∑—ã–≤–∞–µ—Ç merge_participants_smart(target=B, duplicates=[A])
2. –§—É–Ω–∫—Ü–∏—è –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç A:
   - full_name: B="–ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤" ‚â† A="–ò–≤–∞–Ω –ò." ‚Üí –ö–æ–Ω—Ñ–ª–∏–∫—Ç
     ‚Üí –°–æ—Ö—Ä–∞–Ω—è–µ—Ç "–ò–≤–∞–Ω –ò." –≤ trait "full_name_merged"
   - email: B="ivan@new.com" ‚â† A="ivan@old.com" ‚Üí –ö–æ–Ω—Ñ–ª–∏–∫—Ç
     ‚Üí –°–æ—Ö—Ä–∞–Ω—è–µ—Ç "ivan@old.com" –≤ trait "email_merged"
   - phone: B=null, A="+7123456" ‚Üí –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ
     ‚Üí UPDATE participants SET phone="+7123456" WHERE id=B
3. –í—ã–∑—ã–≤–∞–µ—Ç—Å—è merge_participants_extended –¥–ª—è –ø–µ—Ä–µ–Ω–æ—Å–∞ —Å–≤—è–∑–µ–π
4. A.merged_into = B
5. –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è JSON:
   {
     merged_fields: [{ field: "phone", action: "filled", value: "+7123456" }],
     conflicts: [
       { field: "full_name", target_value: "–ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤", duplicate_value: "–ò–≤–∞–Ω –ò.", saved_as: "full_name_merged" },
       { field: "email", target_value: "ivan@new.com", duplicate_value: "ivan@old.com", saved_as: "email_merged" }
     ],
     target: B,
     merged_into: B
   }

–§–∏–Ω–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ:
- –£—á–∞—Å—Ç–Ω–∏–∫ A: { merged_into: B } (–Ω–µ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –≤ —Å–ø–∏—Å–∫–µ)
- –£—á–∞—Å—Ç–Ω–∏–∫ B: { 
    full_name: "–ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤", 
    email: "ivan@new.com", 
    phone: "+7123456" 
  }
- Traits –¥–ª—è B:
  - { trait_key: "full_name_merged", trait_value: "–ò–≤–∞–Ω –ò.", source: "merge" }
  - { trait_key: "email_merged", trait_value: "ivan@old.com", source: "merge" }

UI:
- –°–ø–∏—Å–æ–∫ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤: —Ç–æ–ª—å–∫–æ B –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è ‚úÖ
- –ü—Ä–æ—Ñ–∏–ª—å B: phone –∑–∞–ø–æ–ª–Ω–µ–Ω ‚úÖ
- –•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ B: –ø–æ–∫–∞–∑–∞–Ω—ã 2 –∫–æ–Ω—Ñ–ª–∏–∫—Ç–∞ —Å –º–µ—Ç–∫–æ–π "–ò–∑ –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏—è" ‚úÖ
- –†–µ–¥–∏—Ä–µ–∫—Ç: /app/[org]/members/B ‚úÖ
```

### –°—Ü–µ–Ω–∞—Ä–∏–π 2: –û–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ –ø–æ–¥—Ä—è–¥

```
–ù–∞—á–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ:
- –£—á–∞—Å—Ç–Ω–∏–∫ A: { full_name: "–ò–≤–∞–Ω", email: "a@test.com", phone: null }
- –£—á–∞—Å—Ç–Ω–∏–∫ B: { full_name: null, email: "b@test.com", phone: "+7111" }
- –£—á–∞—Å—Ç–Ω–∏–∫ C: { full_name: "–ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤", email: null, phone: "+7222" }

–û–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ A + B + C (target=A, duplicates=[B, C]):

–ò—Ç–µ—Ä–∞—Ü–∏—è 1 (B):
1. –ó–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è A (fresh): { full_name: "–ò–≤–∞–Ω", email: "a@test.com", phone: null }
2. full_name: A="–ò–≤–∞–Ω", B=null ‚Üí –ù–µ—Ç –¥–µ–π—Å—Ç–≤–∏–π
3. email: A="a@test.com", B="b@test.com" ‚Üí –ö–æ–Ω—Ñ–ª–∏–∫—Ç
   ‚Üí trait: email_merged = "b@test.com"
4. phone: A=null, B="+7111" ‚Üí –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ
   ‚Üí UPDATE: A.phone = "+7111"
5. B.merged_into = A

–ò—Ç–µ—Ä–∞—Ü–∏—è 2 (C):
1. ‚úÖ –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è A (fresh): { full_name: "–ò–≤–∞–Ω", email: "a@test.com", phone: "+7111" }
2. full_name: A="–ò–≤–∞–Ω", C="–ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤" ‚Üí –ö–æ–Ω—Ñ–ª–∏–∫—Ç
   ‚Üí trait: full_name_merged = "–ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤"
3. email: A="a@test.com", C=null ‚Üí –ù–µ—Ç –¥–µ–π—Å—Ç–≤–∏–π
4. phone: A="+7111", C="+7222" ‚Üí –ö–æ–Ω—Ñ–ª–∏–∫—Ç
   ‚Üí trait: phone_merged = "+7222"
5. C.merged_into = A

–§–∏–Ω–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ A:
- full_name: "–ò–≤–∞–Ω"
- email: "a@test.com"
- phone: "+7111" (–∏–∑ B)
- Traits:
  - email_merged = "b@test.com" (–∏–∑ B)
  - full_name_merged = "–ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤" (–∏–∑ C)
  - phone_merged = "+7222" (–∏–∑ C)

‚úÖ –í—Å–µ –¥–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã, –Ω–∏—á–µ–≥–æ –Ω–µ –ø–æ—Ç–µ—Ä—è–Ω–æ!
```

---

## –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π

### 1. –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é

```bash
# –í Supabase SQL Editor
-- –í—ã–ø–æ–ª–Ω–∏—Ç–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ñ–∞–π–ª–∞:
db/migrations/26_fix_merge_smart_reload.sql
```

### 2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä –≤ —Å–ø–∏—Å–∫–µ

```sql
-- –î–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è: –ø–æ–∫–∞–∑—ã–≤–∞–ª–æ –æ–±—ä–µ–¥–∏–Ω–µ–Ω–Ω—ã—Ö
SELECT id, full_name, merged_into
FROM participants
WHERE org_id = 'your-org-id'
AND participant_status != 'excluded';

-- –ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è: —Ç–æ–ª—å–∫–æ –∞–∫—Ç–∏–≤–Ω—ã–µ
SELECT id, full_name, merged_into
FROM participants
WHERE org_id = 'your-org-id'
AND participant_status != 'excluded'
AND merged_into IS NULL;
```

### 3. –¢–µ—Å—Ç –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏—è —Å –Ω–µ—Å–∫–æ–ª—å–∫–∏–º–∏ –¥—É–±–ª–∏–∫–∞—Ç–∞–º–∏

```sql
-- –°–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç–æ–≤—ã—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
INSERT INTO participants (org_id, full_name, email, phone)
VALUES 
  ('org-id', '–ò–≤–∞–Ω –ü–µ—Ç—Ä–æ–≤', 'ivan@test.com', NULL),
  ('org-id', NULL, 'ivan2@test.com', '+7111'),
  ('org-id', '–ò. –ü–µ—Ç—Ä–æ–≤', NULL, '+7222');

-- –ü–æ–ª—É—á–∏—Ç—å –∏—Ö ID
SELECT id, full_name, email, phone FROM participants WHERE org_id = 'org-id' AND full_name LIKE '%–µ—Ç—Ä–æ–≤%' OR email LIKE 'ivan%';

-- –û–±—ä–µ–¥–∏–Ω–∏—Ç—å —á–µ—Ä–µ–∑ UI
-- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç:
SELECT 
  p.id, 
  p.full_name, 
  p.email, 
  p.phone,
  p.merged_into,
  COUNT(t.id) as traits_count
FROM participants p
LEFT JOIN participant_traits t ON t.participant_id = p.id
WHERE p.org_id = 'org-id'
GROUP BY p.id, p.full_name, p.email, p.phone, p.merged_into;

-- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å traits
SELECT 
  trait_key, 
  trait_value, 
  source, 
  metadata
FROM participant_traits
WHERE participant_id = 'target-participant-id'
ORDER BY created_at DESC;
```

### 4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å UI

1. **–°–ø–∏—Å–æ–∫ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤**:
   - –û—Ç–∫—Ä—ã—Ç—å `/app/[org]/members`
   - –£–±–µ–¥–∏—Ç—å—Å—è —á—Ç–æ –æ–±—ä–µ–¥–∏–Ω–µ–Ω–Ω—ã–µ —É—á–∞—Å—Ç–Ω–∏–∫–∏ –Ω–µ –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è
   - –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–æ–ª–∂–Ω–æ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–æ–≤–∞—Ç—å —á–∏—Å–ª—É —Å—Ç—Ä–æ–∫ —Å `merged_into IS NULL`

2. **–ü—Ä–æ—Ñ–∏–ª—å —É—á–∞—Å—Ç–Ω–∏–∫–∞**:
   - –û—Ç–∫—Ä—ã—Ç—å –ø—Ä–æ—Ñ–∏–ª—å —É—á–∞—Å—Ç–Ω–∏–∫–∞, –∫–æ—Ç–æ—Ä—ã–π –±—ã–ª —Ü–µ–ª—å—é –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏—è
   - –í —Ä–∞–∑–¥–µ–ª–µ "–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è" –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –≤–∏–¥–Ω—ã:
     - –•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö (–µ—Å–ª–∏ –µ—Å—Ç—å traits)
     - –ö–æ–Ω—Ñ–ª–∏–∫—Ç—ã –∏–∑ –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏—è —Å —è–Ω—Ç–∞—Ä–Ω—ã–º —Ñ–æ–Ω–æ–º
     - –ú–µ—Ç–∫–∞ "–ò–∑ –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏—è"

3. **–û–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤**:
   - –û—Ç–∫—Ä—ã—Ç—å –≤–∫–ª–∞–¥–∫—É "–î—É–±–ª–∏–∫–∞—Ç—ã"
   - –ù–∞–∂–∞—Ç—å "–û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫"
   - –£–±–µ–¥–∏—Ç—å—Å—è —á—Ç–æ —Ç–µ–∫—É—â–∏–π —É—á–∞—Å—Ç–Ω–∏–∫ –Ω–µ –ø–æ—è–≤–ª—è–µ—Ç—Å—è –≤ —Å–ø–∏—Å–∫–µ
   - –û–±—ä–µ–¥–∏–Ω–∏—Ç—å —Å –¥—É–±–ª–∏–∫–∞—Ç–æ–º
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤—Å–ø–ª—ã–≤–∞—é—â–µ–µ –æ–∫–Ω–æ:
     - "–ó–∞–ø–æ–ª–Ω–µ–Ω—ã –ø–æ–ª—è: ..."
     - "–ö–æ–Ω—Ñ–ª–∏–∫—Ç—ã —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –∫–∞–∫ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏: ..."
   - –ü–æ—Å–ª–µ —Ä–µ–¥–∏—Ä–µ–∫—Ç–∞ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ:
     - –ü–æ–ª—è –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –∑–∞–ø–æ–ª–Ω–µ–Ω—ã
     - –•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –≤ –ø—Ä–æ—Ñ–∏–ª–µ

---

## –ò–∑–º–µ–Ω–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

1. **`app/app/[org]/members/page.tsx`**
   - –î–æ–±–∞–≤–ª–µ–Ω —Ñ–∏–ª—å—Ç—Ä `.is('merged_into', null)`

2. **`db/migrations/26_fix_merge_smart_reload.sql`**
   - –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è `merge_participants_smart`
   - –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ `v_target_record` –≤ —Ü–∏–∫–ª–µ

3. **`components/members/participant-profile-card.tsx`**
   - –î–æ–±–∞–≤–ª–µ–Ω–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ `detail.traits`
   - –°–ø–µ—Ü–∏–∞–ª—å–Ω–æ–µ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è traits —Å `source='merge'`

4. **`lib/services/participants/matcher.ts`**
   - –î–æ–±–∞–≤–ª–µ–Ω —Ñ–∏–ª—å—Ç—Ä `.is('merged_into', null)` –≤ exact –∏ fuzzy –ø–æ–∏—Å–∫–µ
   - –î–æ–±–∞–≤–ª–µ–Ω–æ –ø–æ–ª–µ `merged_into` –≤ —Ç–∏–ø `MatchCandidate`
   - –î–æ–±–∞–≤–ª–µ–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–∏—Å–∫–∞

5. **`app/api/participants/[participantId]/route.ts`**
   - –î–æ–±–∞–≤–ª–µ–Ω–æ –¥–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ—Ü–µ—Å—Å–∞ merge
   - –£–ª—É—á—à–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ —Å –¥–µ—Ç–∞–ª—è–º–∏

---

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ –ø—Ä–∏–Ω—Ü–∏–ø—ã

### 1. –ö–∞–Ω–æ–Ω–∏—á–µ—Å–∫–∞—è –∑–∞–ø–∏—Å—å (Canonical Record)

- –û–¥–∏–Ω —É—á–∞—Å—Ç–Ω–∏–∫ (target) —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è "–∫–∞–Ω–æ–Ω–∏—á–µ—Å–∫–∏–º"
- –í—Å–µ –¥—É–±–ª–∏–∫–∞—Ç—ã –ø–æ–ª—É—á–∞—é—Ç `merged_into = canonical_id`
- –í—Å–µ –¥–∞–Ω–Ω—ã–µ —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ canonical record
- –í—Å–µ —Å–≤—è–∑–∏ (–≥—Ä—É–ø–ø—ã, —Å–æ–±—ã—Ç–∏—è, –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å) –ø–µ—Ä–µ–Ω–æ—Å—è—Ç—Å—è –Ω–∞ canonical record

### 2. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö

**–ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –ø—É—Å—Ç—ã—Ö –ø–æ–ª–µ–π**:
```
IF target.field IS NULL AND duplicate.field IS NOT NULL THEN
  target.field = duplicate.field
```

**–ö–æ–Ω—Ñ–ª–∏–∫—Ç—ã**:
```
IF target.field != duplicate.field (–æ–±–∞ –Ω–µ NULL) THEN
  CREATE participant_trait (
    trait_key = 'field_merged',
    trait_value = duplicate.field,
    source = 'merge',
    metadata = { 
      conflict_with: target.field,
      merged_from: duplicate.id 
    }
  )
```

### 3. –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤ UI

**–°–ø–∏—Å–∫–∏**:
- –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ –∑–∞–ø–∏—Å–∏ —Å `merged_into IS NULL`
- –§–∏–ª—å—Ç—Ä –ø—Ä–∏–º–µ–Ω—è—Ç—å –Ω–∞ —É—Ä–æ–≤–Ω–µ SQL –∑–∞–ø—Ä–æ—Å–∞

**–ü—Ä–æ—Ñ–∏–ª—å**:
- –ï—Å–ª–∏ –æ—Ç–∫—Ä—ã—Ç merged —É—á–∞—Å—Ç–Ω–∏–∫ (A.merged_into = B), –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å canonical (B)
- Traits –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å –≤–º–µ—Å—Ç–µ —Å –æ—Å–Ω–æ–≤–Ω—ã–º–∏ –ø–æ–ª—è–º–∏
- Traits —Å `source='merge'` –≤—ã–¥–µ–ª—è—Ç—å –≤–∏–∑—É–∞–ª—å–Ω–æ

**–î—É–±–ª–∏–∫–∞—Ç—ã**:
- –ò—Å–∫–ª—é—á–∞—Ç—å –∏–∑ –ø–æ–∏—Å–∫–∞ –∑–∞–ø–∏—Å–∏ —Å `merged_into IS NOT NULL`
- –ò—Å–∫–ª—é—á–∞—Ç—å —Ç–µ–∫—É—â–µ–≥–æ —É—á–∞—Å—Ç–Ω–∏–∫–∞ –∏–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤

---

## –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø—Ä–æ–±–ª–µ–º

### –ü—Ä–æ–±–ª–µ–º–∞: "–ü–æ–ª–µ –Ω–µ –∑–∞–ø–æ–ª–Ω–∏–ª–æ—Å—å"

```sql
-- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é –∏–∑–º–µ–Ω–µ–Ω–∏–π
SELECT * FROM participant_audit_log
WHERE participant_id = 'target-id'
AND action = 'merge'
ORDER BY created_at DESC
LIMIT 5;

-- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ —Ñ—É–Ω–∫—Ü–∏—è –≤—ã–∑—ã–≤–∞–ª–∞—Å—å
SELECT * FROM pg_stat_statements
WHERE query LIKE '%merge_participants_smart%'
ORDER BY last_exec DESC
LIMIT 5;
```

### –ü—Ä–æ–±–ª–µ–º–∞: "–•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∞ –Ω–µ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è"

```sql
-- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ trait —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
SELECT * FROM participant_traits
WHERE participant_id = 'target-id'
AND source = 'merge'
ORDER BY created_at DESC;

-- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ detail.traits –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è
-- –í lib/server/getParticipantDetail.ts:65-69
```

### –ü—Ä–æ–±–ª–µ–º–∞: "–î—É–±–ª–∏–∫–∞—Ç –≤—Å–µ –µ—â–µ –≤ —Å–ø–∏—Å–∫–µ"

```sql
-- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å merged_into
SELECT id, full_name, merged_into, participant_status
FROM participants
WHERE id = 'duplicate-id';

-- –ï—Å–ª–∏ merged_into NULL, –∑–Ω–∞—á–∏—Ç merge –Ω–µ –≤—ã–ø–æ–ª–Ω–∏–ª—Å—è
-- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ API
```

---

## –õ—É—á—à–∏–µ –ø—Ä–∞–∫—Ç–∏–∫–∏

### 1. –í—Å–µ–≥–¥–∞ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –ø–æ—Å–ª–µ UPDATE

```sql
-- ‚ùå –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ
SELECT * INTO v_record FROM table WHERE id = 1;
UPDATE table SET field = 'new' WHERE id = 1;
-- v_record.field –≤—Å–µ –µ—â–µ —Å—Ç–∞—Ä–æ–µ!

-- ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ
LOOP
  SELECT * INTO v_record FROM table WHERE id = 1;
  UPDATE table SET field = 'new' WHERE id = 1;
END LOOP;
```

### 2. –§–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å merged –∑–∞–ø–∏—Å–∏ –Ω–∞ —É—Ä–æ–≤–Ω–µ SQL

```typescript
// ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ - —Ñ–∏–ª—å—Ç—Ä –≤ SQL
.from('participants')
.is('merged_into', null)

// ‚ùå –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ - —Ñ–∏–ª—å—Ç—Ä –≤ JS
const filtered = participants.filter(p => !p.merged_into)
```

### 3. –í—Å–µ–≥–¥–∞ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å canonical record

```typescript
const canonicalId = participant.merged_into || participant.id;
const detail = await getParticipantDetail(orgId, canonicalId);
```

---

## –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

–ü–æ—Å–ª–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –≤—Å–µ—Ö –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π —Å–∏—Å—Ç–µ–º–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ:

‚úÖ **–°–∫—Ä—ã–≤–∞–µ—Ç –æ–±—ä–µ–¥–∏–Ω–µ–Ω–Ω—ã—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤** –∏–∑ —Å–ø–∏—Å–∫–∞  
‚úÖ **–ó–∞–ø–æ–ª–Ω—è–µ—Ç –ø—É—Å—Ç—ã–µ –ø–æ–ª—è** –ø—Ä–∏ –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏–∏ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –¥—É–±–ª–∏–∫–∞—Ç–æ–≤  
‚úÖ **–û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏** (traits) –≤ –ø—Ä–æ—Ñ–∏–ª–µ  
‚úÖ **–°–æ—Ö—Ä–∞–Ω—è–µ—Ç –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã** –∫–∞–∫ traits —Å –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–º–∏  
‚úÖ **–†–µ–¥–∏—Ä–µ–∫—Ç–∏—Ç –Ω–∞ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ —É—á–∞—Å—Ç–Ω–∏–∫–∞** (canonical)  
‚úÖ **–ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –ø–æ–≤—Ç–æ—Ä–Ω–æ–µ –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ** –æ–¥–Ω–∏—Ö –∏ —Ç–µ—Ö –∂–µ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤  
‚úÖ **–õ–æ–≥–∏—Ä—É–µ—Ç –ø—Ä–æ—Ü–µ—Å—Å** –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏

–î–∞–Ω–Ω—ã–µ –±–æ–ª—å—à–µ –Ω–µ —Ç–µ—Ä—è—é—Ç—Å—è –ø—Ä–∏ –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏–∏! üéâ

