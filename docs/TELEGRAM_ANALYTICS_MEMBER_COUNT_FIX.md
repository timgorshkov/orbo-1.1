# Исправление подсчета участников в аналитике

## Проблема

Ранее в аналитике Telegram-групп возникали три несоответствия:

1. **Число участников в блоке "Общая статистика" на странице группы** отличалось от фактического количества людей в группе и списка участников.
2. **Список участников** фильтровал только тех, кто оставлял сообщение за последние 7 дней, скрывая более "тихих" участников.
3. **Сводная аналитика** (строка для каждой группы) показывала значение, отличное от данных на странице группы.

Причина — использование разных источников данных:
- `participant_groups` хранил всех участников, но не обновлялся по активности.
- `activity_events` отражал только недавние события (обычно 7 дней).
- Страницы брали данные из разных таблиц и считали по-разному.

## Решение

### 1. API аналитики (`app/api/telegram/analytics/data/route.ts`)

Теперь API выполняет объединение данных:
- Загружает всех активных участников группы из `participant_groups`.
- Обогащает их активностью из `activity_events` за 30 дней (сообщения, вступления, выхода).
- Исключает ботов по ID и username.
- Возвращает:
  - `member_count` — всего участников в группе.
  - `member_active_count` — участников с активностью за последние 7 дней.
  - Полный список участников с количеством сообщений, последней активностью, оценкой риска и т.д.

### 2. Страница группы (`app/app/[org]/telegram/groups/[groupId]/page.tsx`)

- Использует обновлённый API — метрика "Участников" показывает `member_total_count`, а "Активных участников" — `member_active_count`.
- Список во вкладке "Участники" отображает всех участников (включая тех, кто не писал сообщения недавно).
- Все значения синхронизированы: список, общее число, активные участники.

### 3. Сводная аналитика (`app/app/[org]/telegram/analytics/page.tsx`)

- Для каждой группы отображаются два числа: "Всего участников" и "Активных участников за 7 дней" — оба берутся из API.
- Числа совпадают с данными на странице самой группы.

## Логика подсчёта

### Кто считается участником?

**Участник включён в список, если:**
- есть запись в `participant_groups` (человек состоял в группе и не помечен как удалённый);
- не является ботом (список ID/username отфильтрован).

**Числа:**
- `member_count` — все участники группы (с учётом данных Supabase).
- `member_active_count` — участники, у которых есть сообщение или другое событие в `activity_events` за последние 7 дней.

### Источники данных

| Страница                 | Список/данные      | Откуда                          | Период | Описание |
|--------------------------|--------------------|----------------------------------|--------|----------|
| Страница группы          | `participants`     | API `analytics/data`             | 30 дней активности (но включает всех) | Полный список без ботов |
| "Общая статистика" группы | `member_total_count` / `member_active_count` | API `analytics/data` | 7/30 дней | Синхронизировано с вкладкой |
| Сводная аналитика        | `member_count` / `member_active_count` | API `analytics/data` | 7/30 дней | Совпадает со страницей группы |

## Тестирование

Проверьте:
1. **Страница группы** (`/app/[org]/telegram/groups/[groupId]`)
   - Метрика "Всего участников" = количество строк во вкладке "Участники".
   - "Активных участников" логично ≤ "Всего".
   - Список содержит всех, кроме ботов.

2. **Сводная аналитика** (`/app/[org]/telegram/analytics`)
   - Для каждой группы числа совпадают со страницей группы.

3. **Вкладка "Участники"**
   - Все участники, включая тех, кто давно не писал, но состоит в группе.
   - Нет ботов.

## Известные ограничения

1. **Неактивные участники** — если участник удалён из группы физически, но запись осталась в Supabase, он всё равно будет показан. Решение: синхронизировать `participant_groups` с фактическим составом через API Telegram (не реализовано сейчас).

2. **Активность за 7 дней** — `member_active_count` зависит от активности в последние 7 дней, но список показывает всех. Это соответствует текущим требованиям.

3. **Боты** — список ID/username ботов фиксирован. Если появятся новые боты, их нужно добавить в обход.

## Будущие улучшения

1. Синхронизация состава группы через Telegram API (`getChatMembersCount`, `getChatAdministrators`).
2. Исторические графики по активности участников > 30 дней.
3. Разделение метрик: "Активность" (в процентах) vs "DAU" (число), с поясняющими подсказками в UI.
4. Автоматическое обогащение профилей (username/full_name) при появлении новых участников.

