# –°—Ç–∞—Ç—É—Å –æ—á–∏—Å—Ç–∫–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö - 16 –æ–∫—Ç—è–±—Ä—è 2025

## ‚úÖ –ß—Ç–æ —Å–¥–µ–ª–∞–Ω–æ (–º–∏–≥—Ä–∞—Ü–∏—è 42)

### –£–¥–∞–ª–µ–Ω—ã –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ —Ç–∞–±–ª–∏—Ü—ã:
1. **`telegram_activity_events`** ‚ùå –£–î–ê–õ–ï–ù–ê
   - –ë—ã–ª–∞ –ø–æ–ª–Ω—ã–º –¥—É–±–ª–∏–∫–∞—Ç–æ–º `activity_events`
   - –ù–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∞—Å—å –≤ —Ä–∞–±–æ—á–µ–º –∫–æ–¥–µ
   
2. **`telegram_identities`** ‚ùå –£–î–ê–õ–ï–ù–ê
   - –ó–∞–º–µ–Ω–µ–Ω–∞ –Ω–∞ `user_telegram_accounts`
   - –£–¥–∞–ª–µ–Ω–∞ —Ç–∞–∫–∂–µ –∫–æ–ª–æ–Ω–∫–∞ `participants.identity_id`
   
3. **`telegram_updates`** ‚ùå –£–î–ê–õ–ï–ù–ê
   - –°–æ–∑–¥–∞–Ω–∞ –¥–ª—è –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏, –Ω–æ –Ω–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∞—Å—å
   - –ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å —á–µ—Ä–µ–∑ –ë–î –Ω–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞

### –î–æ–±–∞–≤–ª–µ–Ω—ã —É–ª—É—á—à–µ–Ω–∏—è:
‚úÖ **4 –Ω–æ–≤—ã—Ö –∏–Ω–¥–µ–∫—Å–∞ –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏:**
- `idx_participants_email` - –±—ã—Å—Ç—Ä—ã–π –ø–æ–∏—Å–∫ –ø–æ email
- `idx_participant_messages_analyzed` - –ø–æ–∏—Å–∫ –Ω–µ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
- `idx_event_registrations_status_event` - –ø–æ–¥—Å—á–µ—Ç —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–π
- `idx_telegram_auth_codes_cleanup` - –æ—á–∏—Å—Ç–∫–∞ –∏—Å—Ç–µ–∫—à–∏—Ö –∫–æ–¥–æ–≤

‚úÖ **3 CHECK constraints –¥–ª—è —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç–∏ –¥–∞–Ω–Ω—ã—Ö:**
- `events_time_order_check` - end_time > start_time
- `telegram_auth_codes_expires_check` - expires_at > created_at  
- `organization_invites_uses_check` - current_uses <= max_uses

---

## üîç –ß—Ç–æ –ø—Ä–æ–≤–µ—Ä–µ–Ω–æ, –Ω–æ –æ—Å—Ç–∞–≤–ª–µ–Ω–æ

### 1. –°—Ç–∞—Ä–∞—è —Å–∏—Å—Ç–µ–º–∞ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤
- **`material_folders`** - –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–∫–∞–∑–∞–ª–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø–∏—Å–µ–π
- **`material_items`** - –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–∫–∞–∑–∞–ª–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø–∏—Å–µ–π
- **`material_access`** - –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–∫–∞–∑–∞–ª–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø–∏—Å–µ–π

**–°—Ç–∞—Ç—É—Å:** –û—Å—Ç–∞–≤–ª–µ–Ω—ã –¥–ª—è —Ä—É—á–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏ (—Å–º. –Ω–∏–∂–µ)

### 2. –¢–∞–±–ª–∏—Ü–∞ telegram_bots
**–°—Ç–∞—Ç—É—Å:** –ü—Ä–æ–≤–µ—Ä–µ–Ω–æ, —Ç–∞–±–ª–∏—Ü–∞ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç (–Ω–∏–∫–æ–≥–¥–∞ –Ω–µ —Å–æ–∑–¥–∞–≤–∞–ª–∞—Å—å)

---

## üìã –°–õ–ï–î–£–Æ–©–ò–ï –®–ê–ì–ò

### –®–∞–≥ 1: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ä—É—é —Å–∏—Å—Ç–µ–º—É –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤ (–í–ê–ñ–ù–û!)

–í—ã–ø–æ–ª–Ω–∏ –≤ Supabase SQL Editor:

```sql
-- –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ä–æ–π —Å–∏—Å—Ç–µ–º—ã –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤
SELECT 
  (SELECT COUNT(*) FROM material_folders) as folders_count,
  (SELECT COUNT(*) FROM material_items) as items_count,
  (SELECT COUNT(*) FROM material_access) as access_count;
```

**–í–∞—Ä–∏–∞–Ω—Ç—ã –¥–µ–π—Å—Ç–≤–∏–π:**

#### –ï—Å–ª–∏ –í–°–ï = 0:
```sql
-- –ë–µ–∑–æ–ø–∞—Å–Ω–æ —É–¥–∞–ª–∏—Ç—å
DROP TABLE IF EXISTS material_access CASCADE;
DROP TABLE IF EXISTS material_items CASCADE;
DROP TABLE IF EXISTS material_folders CASCADE;
```

#### –ï—Å–ª–∏ –µ—Å—Ç—å –¥–∞–Ω–Ω—ã–µ:
–ù—É–∂–Ω–∞ –º–∏–≥—Ä–∞—Ü–∏—è –Ω–∞ `material_pages`. –Ø –º–æ–≥—É –ø–æ–º–æ—á—å —Å–æ–∑–¥–∞—Ç—å —Å–∫—Ä–∏–ø—Ç –º–∏–≥—Ä–∞—Ü–∏–∏.

---

### –®–∞–≥ 2: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞–±–æ—Ç—É –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è

–ü–æ—Å–ª–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –º–∏–≥—Ä–∞—Ü–∏–∏ 42 –ø—Ä–æ–≤–µ—Ä—å:

1. **–î–∞—à–±–æ—Ä–¥ –∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∞** ‚úì
   - –û—Ç–∫—Ä–æ–π `/app/[org]/dashboard`
   - –ü—Ä–æ–≤–µ—Ä—å, —á—Ç–æ –º–µ—Ç—Ä–∏–∫–∏ –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è
   - –ü—Ä–æ–≤–µ—Ä—å –≥—Ä–∞—Ñ–∏–∫–∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏

2. **–£—á–∞—Å—Ç–Ω–∏–∫–∏ (CRM)** ‚úì
   - –û—Ç–∫—Ä–æ–π `/app/[org]/members`
   - –ü—Ä–æ–≤–µ—Ä—å —Å–ø–∏—Å–æ–∫ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
   - –û—Ç–∫—Ä–æ–π –ø—Ä–æ—Ñ–∏–ª—å —É—á–∞—Å—Ç–Ω–∏–∫–∞

3. **–°–æ–±—ã—Ç–∏—è** ‚úì
   - –û—Ç–∫—Ä–æ–π `/app/[org]/events`
   - –°–æ–∑–¥–∞–π —Ç–µ—Å—Ç–æ–≤–æ–µ —Å–æ–±—ã—Ç–∏–µ
   - –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Å—è –Ω–∞ —Å–æ–±—ã—Ç–∏–µ

4. **Telegram –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è** ‚úì
   - –û—Ç–∫—Ä–æ–π `/app/[org]/telegram`
   - –ü—Ä–æ–≤–µ—Ä—å —Å–ø–∏—Å–æ–∫ –≥—Ä—É–ø–ø
   - –û—Ç–ø—Ä–∞–≤—å —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ —Ç–µ—Å—Ç–æ–≤—É—é –≥—Ä—É–ø–ø—É
   - –ü—Ä–æ–≤–µ—Ä—å, —á—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ—è–≤–∏–ª–æ—Å—å –≤ –∞–Ω–∞–ª–∏—Ç–∏–∫–µ

5. **–ú–∞—Ç–µ—Ä–∏–∞–ª—ã** ‚úì
   - –û—Ç–∫—Ä–æ–π `/app/[org]/materials`
   - –°–æ–∑–¥–∞–π/–æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π —Å—Ç—Ä–∞–Ω–∏—Ü—É
   - –ü—Ä–æ–≤–µ—Ä—å –ø–æ–∏—Å–∫ –ø–æ –º–∞—Ç–µ—Ä–∏–∞–ª–∞–º

---

### –®–∞–≥ 3: –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ª–æ–≥–æ–≤

–ü—Ä–æ–≤–µ—Ä—å –ª–æ–≥–∏ Vercel –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –æ—à–∏–±–æ–∫ –ø–æ—Å–ª–µ –º–∏–≥—Ä–∞—Ü–∏–∏:

```bash
# –ö–æ–º–∞–Ω–¥—ã –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
# (–≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è –≤ Vercel Dashboard -> Logs)
```

**–ù–∞ —á—Ç–æ –æ–±—Ä–∞—Ç–∏—Ç—å –≤–Ω–∏–º–∞–Ω–∏–µ:**
- –û—à–∏–±–∫–∏ —Ç–∏–ø–∞ "relation ... does not exist"
- –û—à–∏–±–∫–∏ –≤ –∞–Ω–∞–ª–∏—Ç–∏–∫–µ Telegram
- –û—à–∏–±–∫–∏ –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –Ω–∞ —Å–æ–±—ã—Ç–∏—è

---

## üéØ –û—Å—Ç–∞—é—â–∏–µ—Å—è –≤–æ–ø—Ä–æ—Å—ã –¥–ª—è —Ä–µ—à–µ–Ω–∏—è

### –í–æ–ø—Ä–æ—Å 1: –ß—Ç–æ –¥–µ–ª–∞—Ç—å —Å profiles.telegram_user_id?

**–ü—Ä–æ–±–ª–µ–º–∞:** 
- –ü–æ–ª–µ `profiles.telegram_user_id` –¥—É–±–ª–∏—Ä—É–µ—Ç —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª `user_telegram_accounts`
- –î–æ–±–∞–≤–ª–µ–Ω–æ –≤ –º–∏–≥—Ä–∞—Ü–∏–∏ 02, –Ω–æ –Ω–µ –∞–∫—Ç–∏–≤–Ω–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è

**–ì–¥–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è:**
- `app/api/telegram/notifications/webhook/route.ts`
- `app/api/user/telegram-id/route.ts`

**–í–∞—Ä–∏–∞–Ω—Ç—ã:**
1. –ú–∏–≥—Ä–∏—Ä–æ–≤–∞—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –Ω–∞ `user_telegram_accounts` (—Ä–µ–∫–æ–º–µ–Ω–¥—É—é)
2. –£–¥–∞–ª–∏—Ç—å –ø–æ–ª–µ `profiles.telegram_user_id`

### –í–æ–ø—Ä–æ—Å 2: –ù—É–∂–Ω–∞ –ª–∏ —Ç–∞–±–ª–∏—Ü–∞ group_metrics?

**–¢–µ–∫—É—â–∞—è —Å–∏—Ç—É–∞—Ü–∏—è:**
- –¢–∞–±–ª–∏—Ü–∞ —Ö—Ä–∞–Ω–∏—Ç –∞–≥—Ä–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏ (DAU, –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ–æ–±—â–µ–Ω–∏–π, –∏ —Ç.–¥.)
- –î–∞–Ω–Ω—ã–µ –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏ –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è

**–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞:**
- Materialized View - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ, –º–µ–Ω—å—à–µ –∫–æ–¥–∞
- On-the-fly –≤—ã—á–∏—Å–ª–µ–Ω–∏—è - –ø—Ä–æ—â–µ, –Ω–æ –º–µ–¥–ª–µ–Ω–Ω–µ–µ

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –û—Å—Ç–∞–≤–∏—Ç—å –∫–∞–∫ –µ—Å—Ç—å (—Ä–∞–±–æ—Ç–∞–µ—Ç —Ö–æ—Ä–æ—à–æ)

### –í–æ–ø—Ä–æ—Å 3: –ö–æ–Ω—Å–æ–ª–∏–¥–∞—Ü–∏—è –º–∏–≥—Ä–∞—Ü–∏–π

**–ü—Ä–æ–±–ª–µ–º–∞:**
- 42 –º–∏–≥—Ä–∞—Ü–∏–∏ - –º–Ω–æ–≥–æ –¥–ª—è MVP
- –ü—Ä–∏ –¥–µ–ø–ª–æ–µ –Ω–∞ –Ω–æ–≤–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ –Ω—É–∂–Ω–æ –ø—Ä–∏–º–µ–Ω—è—Ç—å –≤—Å–µ

**–†–µ—à–µ–Ω–∏–µ:**
–°–æ–∑–¥–∞—Ç—å `db/schema_consolidated.sql` - –æ–¥–∏–Ω —Ñ–∞–π–ª —Å —Ñ–∏–Ω–∞–ª—å–Ω–æ–π —Å—Ö–µ–º–æ–π –¥–ª—è –Ω–æ–≤—ã—Ö –¥–µ–ø–ª–æ–µ–≤

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** –ù–∏–∑–∫–∏–π (—Ä–∞–±–æ—Ç–∞–µ—Ç, –Ω–æ –º–æ–∂–Ω–æ —É–ª—É—á—à–∏—Ç—å)

---

## üìä –ò–¢–û–ì–û–í–ê–Ø –°–¢–ê–¢–ò–°–¢–ò–ö–ê

### –î–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:
- –¢–∞–±–ª–∏—Ü: ~35
- –ù–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö: 5-7
- –ò–Ω–¥–µ–∫—Å–æ–≤: –±–∞–∑–æ–≤—ã–µ

### –ü–æ—Å–ª–µ –º–∏–≥—Ä–∞—Ü–∏–∏ 42:
- –¢–∞–±–ª–∏—Ü: ~32 ‚úÖ
- –ù–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö: 0-3 (–Ω—É–∂–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ material_*)
- –ò–Ω–¥–µ–∫—Å–æ–≤: +4 –Ω–æ–≤—ã—Ö ‚úÖ
- Constraints: +3 –Ω–æ–≤—ã—Ö ‚úÖ

### –£–ª—É—á—à–µ–Ω–∏—è:
- **–£–ø—Ä–æ—â–µ–Ω–∏–µ —Å—Ö–µ–º—ã:** ~10% (3 —Ç–∞–±–ª–∏—Ü—ã —É–¥–∞–ª–µ–Ω—ã)
- **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:** –£–ª—É—á—à–µ–Ω–∞ –∑–∞ —Å—á–µ—Ç –∏–Ω–¥–µ–∫—Å–æ–≤
- **–¶–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö:** –£–ª—É—á—à–µ–Ω–∞ –∑–∞ —Å—á–µ—Ç constraints

---

## ‚úÖ –ì–û–¢–û–í–û –ö –ò–°–ü–û–õ–¨–ó–û–í–ê–ù–ò–Æ

**–°—Ç–∞—Ç—É—Å:** –ú–∏–≥—Ä–∞—Ü–∏—è 42 —É—Å–ø–µ—à–Ω–æ –ø—Ä–∏–º–µ–Ω–µ–Ω–∞ ‚úÖ  
**–†–∏—Å–∫–∏:** –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ  
**–°–ª–µ–¥—É—é—â–∏–π —à–∞–≥:** –ü—Ä–æ–≤–µ—Ä–∏—Ç—å material_* —Ç–∞–±–ª–∏—Ü—ã (—Å–º. –®–∞–≥ 1)

---

## üÜò –ï—Å–ª–∏ —á—Ç–æ-—Ç–æ —Å–ª–æ–º–∞–ª–æ—Å—å

### –û—Ç–∫–∞—Ç –º–∏–≥—Ä–∞—Ü–∏–∏ 42:

```sql
-- –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å telegram_identities
CREATE TABLE IF NOT EXISTS telegram_identities (
  id uuid primary key default gen_random_uuid(),
  tg_user_id bigint not null unique,
  username text,
  first_name text,
  last_name text,
  language_code text,
  raw jsonb,
  created_at timestamptz default now(),
  updated_at timestamptz default now()
);

-- –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å telegram_activity_events
CREATE TABLE IF NOT EXISTS telegram_activity_events (
  id bigserial primary key,
  tg_chat_id bigint not null,
  identity_id uuid references telegram_identities(id) on delete cascade,
  tg_user_id bigint,
  event_type text not null,
  created_at timestamptz not null default now(),
  message_id bigint,
  message_thread_id bigint,
  reply_to_message_id bigint,
  thread_title text,
  meta jsonb
);

-- –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å telegram_updates
CREATE TABLE IF NOT EXISTS telegram_updates (
  id SERIAL PRIMARY KEY,
  update_id BIGINT UNIQUE NOT NULL,
  processed_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∫–æ–ª–æ–Ω–∫—É –≤ participants
ALTER TABLE participants 
ADD COLUMN IF NOT EXISTS identity_id uuid references telegram_identities(id) on delete set null;
```

**–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:** –û—Ç–∫–∞—Ç –Ω–µ –Ω—É–∂–µ–Ω - —Ç–∞–±–ª–∏—Ü—ã –Ω–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∏—Å—å!

---

**–ê–≤—Ç–æ—Ä:** AI Assistant  
**–î–∞—Ç–∞:** 16 –æ–∫—Ç—è–±—Ä—è 2025  
**–í–µ—Ä—Å–∏—è:** 1.0



