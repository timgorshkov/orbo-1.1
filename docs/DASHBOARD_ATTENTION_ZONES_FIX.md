# Dashboard & Attention Zones - Исправление (Nov 4, 2025)

## Проблемы

### 1. ❌ `get_inactive_newcomers` использовала удалённую таблицу
```sql
-- Старая версия (строка 66 в migration 21)
FROM telegram_activity_events  -- Таблица удалена в миграции 070!
```

### 2. ⚠️ Attention Zones показываются только при определённых условиях
```typescript
if (!isOnboarding && (groupsCount || 0) > 0)
```
**Требования:**
- Онбординг завершён: `progress >= 60%` (3+ из 5 шагов)
- Есть хотя бы 1 группа с `bot_status='connected'`

**5 шагов онбординга:**
1. ✅ Организация создана (всегда true)
2. ✅/❌ Telegram аккаунт подключен и верифицирован
3. ✅/❌ Есть подключенные группы (bot_status='connected')
4. ✅/❌ Созданы материалы
5. ✅/❌ Созданы события (published или completed)

---

## Решение

### Migration 079: `db/migrations/079_fix_dashboard_attention_zones.sql`

Переписана функция `get_inactive_newcomers`:
- ✅ Использует `activity_events` вместо `telegram_activity_events`
- ✅ Связывает через `tg_user_id` вместо `participant_id`
- ✅ Фильтрует `event_type IN ('message', 'join')` для релевантной активности

---

## Текущая логика Attention Zones

### 1. **Critical Events** (Критичные события)
- События в ближайшие 3 дня
- `status = 'published'`
- `event_date` между NOW и NOW+3 дня
- Заполненность < 30% от capacity
- Макс 3 события

**Цель:** Предупредить админа о событиях с низкой регистрацией.

### 2. **Churning Participants** (Уходящие участники)
- Были активны раньше (`activity_score > 10`)
- Молчат 14+ дней (`last_activity_at < NOW - 14 days`)
- Не боты (`source != 'bot'`)
- Не помечены как неактивные (`status != 'inactive'`)
- Макс 5 участников

**Цель:** Выявить участников "на грани оттока".

### 3. **Inactive Newcomers** (Неактивные новички)
- Присоединились в последние 30 дней
- Почти не активны (≤2 действия)
- Прошло 14+ дней с момента первой активности или вступления
- Не боты
- Не помечены как неактивные
- Макс 5 новичков

**Цель:** Найти новичков, которые не "прижились" в сообществе.

---

## Логика активности за 14 дней

### Источник данных: `group_metrics`
```sql
SELECT date, message_count, tg_chat_id, org_id
FROM group_metrics
WHERE tg_chat_id IN (список групп организации)
  AND org_id = :org_id  -- Фильтр чтобы избежать дублей
  AND date >= CURRENT_DATE - 14
ORDER BY date
```

**Агрегация:**
- Суммируем `message_count` по дням для всех групп организации
- Заполняем пробелы нулями (если в какой-то день не было сообщений)

**Отображение:**
- 14 столбцов (последние 14 дней)
- Высота столбца пропорциональна числу сообщений
- Если 0 сообщений за весь период: показываем "Нет данных об активности"

---

## Диагностика

Для проверки текущего состояния используйте:
```bash
# Подставьте свой org_id в файл перед запуском
db/diagnose_dashboard_status.sql
```

**Скрипт проверяет:**
1. Статус онбординга (прогресс, enabled attention zones)
2. Активность за 14 дней (сообщения по дням)
3. Критичные события (низкая регистрация)
4. Churning participants (уходящие)
5. Inactive newcomers (неактивные новички)

---

## Возможные причины "Все отлично!"

Если постоянно показывается "Все отлично! ✨" несмотря на проблемы:

1. **Онбординг не завершён** (< 60% progress)
   - Решение: Завершите хотя бы 3 из 5 шагов

2. **Нет подключенных групп** (`bot_status != 'connected'`)
   - Решение: Добавьте группу и выдайте боту админ-права

3. **Нет критичных событий** в ближайшие 3 дня с низкой регистрацией
   - Это норма, если событий нет или они заполнены

4. **Нет участников, удовлетворяющих критериям**
   - `churning`: нет участников с `activity_score > 10`, молчащих 14+ дней
   - `inactive newcomers`: нет новичков (30 дней) с активностью ≤2 и молчащих 14+ дней

5. **Функции RPC возвращают пустые массивы из-за ошибок**
   - До миграции 079: `get_inactive_newcomers` падал с ошибкой (telegram_activity_events не существует)
   - После миграции 079: функция работает корректно

---

## Проверка после деплоя

1. Запустите `db/diagnose_dashboard_status.sql` с вашим `org_id`
2. Откройте дашборд в приложении
3. Проверьте Vercel logs на ошибки в `/api/dashboard/[orgId]`
4. Убедитесь что:
   - `activityChart` содержит ненулевые значения (если есть сообщения)
   - `attentionZones` содержит данные (если есть проблемные зоны)
   - Нет ошибок RPC вызовов `get_churning_participants` и `get_inactive_newcomers`

---

## Рекомендации

1. **Для тестирования attention zones:**
   - Создайте событие на ближайшие 3 дня с capacity > 0 и без регистраций
   - Или убедитесь, что есть участники с `activity_score > 10` и `last_activity_at < NOW - 14 days`

2. **Для тестирования activity chart:**
   - Убедитесь, что `group_metrics` содержит записи для последних 14 дней
   - Если нет — дождитесь ночного пересчёта или запустите `recalculate_daily_metrics` вручную

3. **Для полноты картины:**
   - Завершите онбординг (подключите группы, создайте материалы/события)
   - Тогда attention zones будут доступны и показывать реальные проблемы

---

## Итог

✅ **Миграция 079** исправляет `get_inactive_newcomers`  
✅ **Диагностика** проверяет текущее состояние  
✅ **Документация** описывает логику и условия показа  

**Следующий шаг:** Запустите миграцию 079 в Supabase SQL Editor.

