# Концепция страницы профиля пользователя

## Проблема

Сейчас:
1. Telegram привязывается на `/app/[org]/telegram/account` (только для владельцев)
2. Кнопка "Выйти" находится в левом меню
3. Нет единого места для управления профилем пользователя
4. Теневые админы не могут легко активировать свой профиль

## Решение

### 1. Структура данных

**Уровни данных пользователя:**

```
User (auth.users)
├── id (UUID)
├── email (глобальный email)
├── raw_user_meta_data (имя, фото)
└── email_confirmed_at

Membership (по организациям)
├── org_id + user_id
├── role (owner/admin/member)
├── role_source (manual/telegram_admin)
└── metadata { shadow_profile, telegram_groups, ... }

User Telegram Accounts (по организациям)
├── org_id + user_id
├── telegram_user_id
├── telegram_username
├── is_verified
└── verified_at

Participant (профиль в организации)
├── org_id + tg_user_id
├── full_name, bio, photo_url
└── custom_attributes
```

### 2. Логика профиля

**Профиль = контекстный (в рамках организации)**

На странице `/app/[org]/profile`:
- **Глобальные данные:** Email из `auth.users`
- **Контекстные данные:** Telegram аккаунт для ЭТОЙ организации
- **Профиль участника:** Данные из `participants` для этой организации

**Ключевые принципы:**
1. ✅ Один пользователь может иметь разные Telegram аккаунты в разных организациях
2. ✅ Email - глобальный, но можно иметь участника без email (теневой)
3. ✅ Профиль участника (имя, фото, био) - специфичен для организации
4. ✅ Владелец видит тот же функционал, что и на `/telegram/account`

### 3. Страница профиля

#### Секция 1: Основная информация
```
┌─────────────────────────────────────────────┐
│  [Фото]  Иван Иванов                        │
│          ivan@example.com ✓ Подтвержден     │
│          👨‍💼 Администратор                    │
│                                             │
│  [Изменить фото] [Редактировать профиль]   │
└─────────────────────────────────────────────┘
```

**Поля для редактирования:**
- Фото (загрузка или синхронизация с Telegram)
- Полное имя
- Био (описание)
- Custom attributes (если есть)

#### Секция 2: Email аккаунт
```
┌─────────────────────────────────────────────┐
│  📧 Email аккаунт                           │
│  ────────────────────────────────────────   │
│  Email: ivan@example.com                    │
│  Статус: ✓ Подтвержден                      │
│                                             │
│  [Изменить email] (если разрешено)         │
└─────────────────────────────────────────────┘
```

**Для теневых админов (без email):**
```
┌─────────────────────────────────────────────┐
│  ⚠️ Email не привязан                        │
│  ────────────────────────────────────────   │
│  Для получения полного доступа добавьте и   │
│  подтвердите email адрес.                   │
│                                             │
│  [Добавить email]                           │
└─────────────────────────────────────────────┘
```

#### Секция 3: Telegram аккаунт
```
┌─────────────────────────────────────────────┐
│  💬 Telegram аккаунт в этой организации      │
│  ────────────────────────────────────────   │
│  Username: @ivan_ivanov                     │
│  User ID: 123456789                         │
│  Статус: ✓ Верифицирован 15.01.2025        │
│                                             │
│  Права администратора в группах:            │
│  • Группа 1                                 │
│  • Группа 2                                 │
│                                             │
│  [Обновить данные] [Отвязать]              │
└─────────────────────────────────────────────┘
```

**Если Telegram не привязан:**
```
┌─────────────────────────────────────────────┐
│  💬 Telegram аккаунт в этой организации      │
│  ────────────────────────────────────────   │
│  Telegram не привязан                       │
│                                             │
│  Чтобы привязать Telegram:                  │
│  1. Узнайте ваш Telegram User ID            │
│  2. Введите его ниже                        │
│  3. Получите код верификации от бота        │
│                                             │
│  Telegram User ID: [___________]            │
│  [Получить инструкции] [Привязать]         │
└─────────────────────────────────────────────┘
```

**После привязки, но до верификации:**
```
┌─────────────────────────────────────────────┐
│  💬 Telegram аккаунт в этой организации      │
│  ────────────────────────────────────────   │
│  User ID: 123456789                         │
│  Статус: ⚠️ Требуется верификация           │
│                                             │
│  Введите код из сообщения бота:             │
│  Код верификации: [______]                  │
│  [Верифицировать] [Запросить новый код]    │
└─────────────────────────────────────────────┘
```

#### Секция 4: Настройки аккаунта
```
┌─────────────────────────────────────────────┐
│  ⚙️ Настройки аккаунта                       │
│  ────────────────────────────────────────   │
│  [🚪 Выйти из профиля]                      │
└─────────────────────────────────────────────┘
```

### 4. Интеграция в меню

**Замена кнопки "Выйти" на "Профиль":**

**Свернутое меню (иконки):**
```
┌────┐
│ 🏠 │
│ 👥 │
│ ⚙️ │
│ 👤 │ ← Круглая аватарка (или иконка User)
│ ⬅️ │
└────┘
```

**Развернутое меню:**
```
┌─────────────────┐
│ 🏠  Главная      │
│ 👥  Участники    │
│ ⚙️  Настройки    │
│ [🖼️] Профиль    │ ← Аватарка + имя/email
│ ⬅️  Свернуть     │
└─────────────────┘
```

### 5. Решение конфликта с владельцем

**Проблема:** У владельца есть `/telegram/account` для настройки Telegram.

**Решение:**

1. **Оставляем обе страницы, но с разным фокусом:**
   - `/profile` - **личный профиль** (для всех пользователей)
   - `/telegram/account` - **управление ботом и правами** (только для владельца)

2. **Разделение функционала:**

   **`/profile` (для всех):**
   - Просмотр и редактирование своего профиля
   - Привязка/верификация своего Telegram
   - Просмотр своих прав в группах
   - Активация теневого профиля
   - Выход

   **`/telegram/account` (только владелец):**
   - Настройка Telegram бота организации
   - Обновление прав администраторов ВСЕХ пользователей
   - Управление webhook
   - Технические настройки

3. **UI подсказка для владельца на `/profile`:**
   ```
   💡 Как владелец, вы можете управлять правами всех 
      администраторов в разделе Настройки → Telegram → 
      Настройки аккаунта
   ```

### 6. Краевые случаи

#### Случай 1: Теневой админ без email
**Состояние:**
- `auth.users.email` = NULL
- `membership.role` = 'admin'
- `membership.metadata.shadow_profile` = true
- `user_telegram_accounts.is_verified` = true

**На странице профиля:**
- ⚠️ Большой баннер "Активируйте профиль"
- Форма добавления email
- Кнопка "Подтвердить email"
- Telegram показан как верифицированный
- Кнопка "Выйти" доступна

#### Случай 2: Пользователь с email, но без Telegram
**Состояние:**
- `auth.users.email` = "user@example.com"
- `user_telegram_accounts` = NULL

**На странице профиля:**
- Email показан как подтвержденный
- Telegram секция показывает форму привязки
- Инструкции, как получить User ID
- Кнопка "Выйти" доступна

#### Случай 3: Telegram ID уже занят другим пользователем
**При попытке привязать:**
```javascript
// В API /api/telegram/accounts POST
const existingAccount = await supabase
  .from('user_telegram_accounts')
  .select('user_id, org_id')
  .eq('telegram_user_id', telegramUserId)
  .eq('org_id', orgId)
  .maybeSingle()

if (existingAccount && existingAccount.user_id !== currentUserId) {
  return NextResponse.json({
    error: 'Этот Telegram аккаунт уже привязан к другому пользователю в этой организации',
    details: 'Один Telegram аккаунт может быть привязан только к одному пользователю в рамках организации'
  }, { status: 409 })
}
```

**Показать пользователю:**
```
❌ Этот Telegram аккаунт уже используется

Этот Telegram User ID уже привязан к другому профилю 
в этой организации. Если это ваш аккаунт, обратитесь 
к владельцу организации для решения проблемы.
```

#### Случай 4: Email уже занят другим пользователем
**При попытке добавить email (теневой админ):**
```javascript
// В API /api/auth/activate-profile POST
// Supabase auth автоматически проверяет уникальность email

// Если email занят, предложить связать профили:
if (error.message.includes('User already registered')) {
  return NextResponse.json({
    error: 'Этот email уже зарегистрирован',
    action: 'link_profiles',
    details: 'У вас уже есть профиль с этим email. Хотите связать профили?'
  }, { status: 409 })
}
```

**UI для связывания:**
```
⚠️ Профиль с этим email уже существует

У вас уже есть аккаунт с email user@example.com.
Вы можете:

1. [Войти с этим email] - переключиться на существующий профиль
2. [Использовать другой email] - ввести другой адрес
3. [Связаться с поддержкой] - если нужна помощь
```

#### Случай 5: Участник без Telegram (только email регистрация)
**Состояние:**
- Зарегистрирован через email
- Нет записи в `participants` (т.к. не из Telegram)
- Есть `membership`

**На странице профиля:**
- Показать основную информацию из `auth.users`
- Предложить создать профиль участника
- Кнопка "Дополнить профиль" (имя, фото, био)

### 7. API endpoints

Новые/обновленные endpoints:

```
GET  /api/user/profile?orgId=xxx
  Возвращает:
  - auth.users (email, metadata)
  - membership для org
  - user_telegram_accounts для org
  - participant для org (если есть)

PATCH /api/user/profile?orgId=xxx
  Обновляет:
  - participant (full_name, bio, photo_url)
  - auth.users.raw_user_meta_data (если нужно)

POST /api/user/profile/upload-photo?orgId=xxx
  Загружает фото в Storage
  Обновляет participant.photo_url

POST /api/user/profile/sync-telegram-photo?orgId=xxx
  Синхронизирует фото из Telegram
```

Существующие endpoints (используем без изменений):
```
GET  /api/telegram/accounts?orgId=xxx
POST /api/telegram/accounts (привязка)
POST /api/telegram/accounts/verify (верификация)
POST /api/auth/activate-profile (добавление email для теневых)
```

### 8. Навигация

**В меню:** Ссылка `/app/[org]/profile`

**Breadcrumbs:** Профиль (без org selector)

**Права доступа:** Все пользователи с `membership` в организации

### 9. Фазы реализации

**Фаза 1: Основная структура**
- [ ] Создать страницу `/app/[org]/profile/page.tsx`
- [ ] Создать API GET `/api/user/profile`
- [ ] Заменить "Выйти" на "Профиль" в меню
- [ ] Добавить секцию email
- [ ] Добавить кнопку "Выйти" на страницу профиля

**Фаза 2: Telegram интеграция**
- [ ] Добавить секцию Telegram (использовать логику из `/telegram/account`)
- [ ] Показывать статус верификации
- [ ] Показывать список групп, где админ
- [ ] Форма привязки Telegram

**Фаза 3: Редактирование профиля**
- [ ] Создать API PATCH `/api/user/profile`
- [ ] Форма редактирования имени, био
- [ ] Загрузка фото
- [ ] Синхронизация фото с Telegram

**Фаза 4: Краевые случаи**
- [ ] Баннер активации для теневых админов
- [ ] Обработка конфликтов Telegram ID
- [ ] Обработка конфликтов email
- [ ] Создание профиля участника для email-only пользователей

**Фаза 5: Полировка**
- [ ] Аватарка в меню
- [ ] Адаптивная верстка
- [ ] Тесты
- [ ] Документация

## Итого

✅ **Единый профиль** - все в одном месте  
✅ **Контекстный** - работает в рамках организации  
✅ **Не конфликтует** с `/telegram/account` (разные роли)  
✅ **Решает краевые случаи** - теневые админы, конфликты ID  
✅ **Удобная навигация** - аватарка в меню вместо "Выйти"  

