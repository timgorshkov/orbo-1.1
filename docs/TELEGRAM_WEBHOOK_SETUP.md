# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Telegram Webhook –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏

## –ü—Ä–æ–±–ª–µ–º–∞

–ü–æ—Å–ª–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è `@orbo_community_bot` –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –ø–µ—Ä–µ—Å—Ç–∞–ª–∞ –ø–æ–¥—Ç—è–≥–∏–≤–∞—Ç—å—Å—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –∏–∑ Telegram –≥—Ä—É–ø–ø.

## –†–µ—à–µ–Ω–∏–µ

**–í–∞–∂–Ω–æ:** Telegram Login Widget –∏ Webhook - —ç—Ç–æ **—Ä–∞–∑–Ω—ã–µ –º–µ—Ö–∞–Ω–∏–∑–º—ã**, –æ–Ω–∏ –ù–ï –∫–æ–Ω—Ñ–ª–∏–∫—Ç—É—é—Ç:
- **Login Widget** - OAuth —á–µ—Ä–µ–∑ –±—Ä–∞—É–∑–µ—Ä (–¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π)
- **Webhook** - –ø–æ–ª—É—á–µ–Ω–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –∏–∑ –≥—Ä—É–ø–ø (–¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏)

–û–¥–∏–Ω –∏ —Ç–æ—Ç –∂–µ –±–æ—Ç –º–æ–∂–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –¥–ª—è –æ–±–æ–∏—Ö –º–µ—Ö–∞–Ω–∏–∑–º–æ–≤ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ!

---

## –®–∞–≥ 1: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å webhook

```bash
curl "https://api.telegram.org/bot<YOUR_BOT_TOKEN>/getWebhookInfo"
```

–ó–∞–º–µ–Ω–∏—Ç–µ `<YOUR_BOT_TOKEN>` –Ω–∞ —Ç–æ–∫–µ–Ω –≤–∞—à–µ–≥–æ –±–æ—Ç–∞.

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç (–µ—Å–ª–∏ webhook –Ω–∞—Å—Ç—Ä–æ–µ–Ω):**
```json
{
  "ok": true,
  "result": {
    "url": "https://app.orbo.ru/api/telegram/webhook",
    "has_custom_certificate": false,
    "pending_update_count": 0,
    "max_connections": 40
  }
}
```

**–ï—Å–ª–∏ webhook –ù–ï –Ω–∞—Å—Ç—Ä–æ–µ–Ω:**
```json
{
  "ok": true,
  "result": {
    "url": "",
    "has_custom_certificate": false,
    "pending_update_count": 0
  }
}
```

---

## –®–∞–≥ 2: –ù–∞—Å—Ç—Ä–æ–∏—Ç—å webhook (–µ—Å–ª–∏ –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω)

### –í–∞—Ä–∏–∞–Ω—Ç A: –ß–µ—Ä–µ–∑ curl

```bash
curl -F "url=https://app.orbo.ru/api/telegram/webhook" \
     -F "secret_token=YOUR_WEBHOOK_SECRET" \
     -F "max_connections=40" \
     -F "drop_pending_updates=false" \
     "https://api.telegram.org/bot<YOUR_BOT_TOKEN>/setWebhook"
```

### –í–∞—Ä–∏–∞–Ω—Ç B: –ß–µ—Ä–µ–∑ –±—Ä–∞—É–∑–µ—Ä

–û—Ç–∫—Ä–æ–π—Ç–µ –≤ –±—Ä–∞—É–∑–µ—Ä–µ:
```
https://api.telegram.org/bot<YOUR_BOT_TOKEN>/setWebhook?url=https://app.orbo.ru/api/telegram/webhook&secret_token=YOUR_WEBHOOK_SECRET
```

**–í–∞–∂–Ω–æ:**
- –ó–∞–º–µ–Ω–∏—Ç–µ `<YOUR_BOT_TOKEN>` –Ω–∞ —Ç–æ–∫–µ–Ω –±–æ—Ç–∞
- –ó–∞–º–µ–Ω–∏—Ç–µ `app.orbo.ru` –Ω–∞ –≤–∞—à –¥–æ–º–µ–Ω (–µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ –¥—Ä—É–≥–æ–π)
- `YOUR_WEBHOOK_SECRET` –¥–æ–ª–∂–µ–Ω —Å–æ–≤–ø–∞–¥–∞—Ç—å —Å `TELEGRAM_WEBHOOK_SECRET` –≤ `.env`

**–£—Å–ø–µ—à–Ω—ã–π –æ—Ç–≤–µ—Ç:**
```json
{
  "ok": true,
  "result": true,
  "description": "Webhook was set"
}
```

---

## –®–∞–≥ 3: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤ `.env` (–ª–æ–∫–∞–ª—å–Ω–æ) –∏ –≤ Vercel Environment Variables –µ—Å—Ç—å:

```env
# Telegram Bot Configuration
TELEGRAM_BOT_TOKEN=1234567890:ABCdefGHIjklMNOpqrsTUVwxyz
TELEGRAM_WEBHOOK_SECRET=your_secret_replace_in_production

# –î–ª—è Login Widget
NEXT_PUBLIC_TELEGRAM_BOT_USERNAME=orbo_community_bot
```

### –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤ Vercel:

1. –û—Ç–∫—Ä–æ–π—Ç–µ –ø—Ä–æ–µ–∫—Ç –≤ Vercel Dashboard
2. Settings ‚Üí Environment Variables
3. –î–æ–±–∞–≤—å—Ç–µ:
   - `TELEGRAM_BOT_TOKEN` (Production, Preview, Development)
   - `TELEGRAM_WEBHOOK_SECRET` (Production, Preview, Development)
4. Redeploy –ø—Ä–æ–µ–∫—Ç–∞

---

## –®–∞–≥ 4: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞–±–æ—Ç—É webhook

### 4.1. –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ç–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ

–û—Ç–ø—Ä–∞–≤—å—Ç–µ –ª—é–±–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ Telegram-–≥—Ä—É–ø–ø—É, –≥–¥–µ –¥–æ–±–∞–≤–ª–µ–Ω –±–æ—Ç.

### 4.2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ Vercel

1. –û—Ç–∫—Ä–æ–π—Ç–µ Vercel Dashboard ‚Üí –≤–∞—à –ø—Ä–æ–µ–∫—Ç
2. Functions ‚Üí /api/telegram/webhook
3. –ü–æ—Å–º–æ—Ç—Ä–∏—Ç–µ –ª–æ–≥–∏ - –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –∑–∞–ø–∏—Å–∏:

```
Webhook received: {...}
Processing update with eventProcessingService
```

### 4.3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –≤ –ë–î

```sql
-- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è
SELECT * FROM activity_events 
ORDER BY created_at DESC 
LIMIT 10;

-- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å –≥—Ä—É–ø–ø
SELECT id, org_id, title, bot_status, last_sync_at 
FROM telegram_groups 
WHERE bot_status = 'connected';
```

---

## –®–∞–≥ 5: –£—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ —Ç–∏–ø–∏—á–Ω—ã—Ö –ø—Ä–æ–±–ª–µ–º

### –ü—Ä–æ–±–ª–µ–º–∞: "Webhook –Ω–µ –ø–æ–ª—É—á–∞–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è"

**–ü—Ä–∏—á–∏–Ω—ã:**
1. Webhook URL –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω (–Ω–µ HTTPS)
2. –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π `secret_token`
3. –ë–æ—Ç –Ω–µ –∞–¥–º–∏–Ω –≤ –≥—Ä—É–ø–ø–µ

**–†–µ—à–µ–Ω–∏–µ:**
```bash
# 1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å endpoint
curl https://app.orbo.ru/api/telegram/webhook

# 2. –£–¥–∞–ª–∏—Ç—å –∏ –∑–∞–Ω–æ–≤–æ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å webhook
curl "https://api.telegram.org/bot<BOT_TOKEN>/deleteWebhook?drop_pending_updates=true"
curl -F "url=https://app.orbo.ru/api/telegram/webhook" \
     -F "secret_token=YOUR_SECRET" \
     "https://api.telegram.org/bot<BOT_TOKEN>/setWebhook"

# 3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –±–æ—Ç –∞–¥–º–∏–Ω –≤ –≥—Ä—É–ø–ø–µ
# –ó–∞–π—Ç–∏ –≤ –≥—Ä—É–ø–ø—É ‚Üí –ù–∞—Å—Ç—Ä–æ–π–∫–∏ ‚Üí –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã ‚Üí –î–æ–ª–∂–µ–Ω –±—ã—Ç—å –±–æ—Ç
```

### –ü—Ä–æ–±–ª–µ–º–∞: "401 Unauthorized –≤ –ª–æ–≥–∞—Ö"

**–ü—Ä–∏—á–∏–Ω–∞:** `TELEGRAM_WEBHOOK_SECRET` –≤ Vercel –Ω–µ —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å `secret_token` –≤ webhook.

**–†–µ—à–µ–Ω–∏–µ:**
1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –≤ Vercel
2. –û–±–Ω–æ–≤–∏—Ç—å webhook —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º —Å–µ–∫—Ä–µ—Ç–æ–º
3. Redeploy –ø—Ä–æ–µ–∫—Ç–∞

### –ü—Ä–æ–±–ª–µ–º–∞: "–ë–æ—Ç –Ω–µ —Ä–µ–∞–≥–∏—Ä—É–µ—Ç –Ω–∞ –∫–æ–º–∞–Ω–¥—ã"

**–ü—Ä–∏—á–∏–Ω–∞:** –ë–æ—Ç –Ω–µ –∞–¥–º–∏–Ω –≥—Ä—É–ø–ø—ã –∏–ª–∏ webhook –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω.

**–†–µ—à–µ–Ω–∏–µ:**
1. –ù–∞–∑–Ω–∞—á–∏—Ç—å –±–æ—Ç–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º –≥—Ä—É–ø–ø—ã
2. –î–∞—Ç—å –ø—Ä–∞–≤–∞: "–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏", "–î–æ–±–∞–≤–ª–µ–Ω–∏–µ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤"
3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å webhook —á–µ—Ä–µ–∑ `/getWebhookInfo`

---

## –®–∞–≥ 6: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏

### 6.1. –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è –≤ –≥—Ä—É–ø–ø—É

1. –û—Ç–ø—Ä–∞–≤—å—Ç–µ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–æ–æ–±—â–µ–Ω–∏–π –æ—Ç —Ä–∞–∑–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
2. –î–æ–±–∞–≤—å—Ç–µ –Ω–æ–≤–æ–≥–æ —É—á–∞—Å—Ç–Ω–∏–∫–∞
3. –£–¥–∞–ª–∏—Ç–µ —É—á–∞—Å—Ç–Ω–∏–∫–∞

### 6.2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤ –∞–¥–º–∏–Ω–∫–µ

1. –û—Ç–∫—Ä–æ–π—Ç–µ `/app/[org]/telegram`
2. –í—ã–±–µ—Ä–∏—Ç–µ –≥—Ä—É–ø–ø—É
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∞–Ω–∞–ª–∏—Ç–∏–∫—É:
   - –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –¥–æ–ª–∂–Ω–æ –æ–±–Ω–æ–≤–∏—Ç—å—Å—è
   - –ì—Ä–∞—Ñ–∏–∫ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –¥–æ–ª–∂–µ–Ω –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ
   - –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –¥–æ–ª–∂–Ω–∞ –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è

---

## –í–∞–∂–Ω—ã–µ –∑–∞–º–µ—á–∞–Ω–∏—è

### ‚úÖ –ú–æ–∂–Ω–æ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:
- **Login Widget** –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
- **Webhook** –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
- **Bot Commands** –¥–ª—è –∫–æ–º–∞–Ω–¥ –≤ –≥—Ä—É–ø–ø–∞—Ö
- **Notifications** –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π

### ‚ö†Ô∏è –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è:
- –û–¥–∏–Ω –±–æ—Ç = –æ–¥–∏–Ω webhook URL
- Webhook URL –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å HTTPS
- Timeout –æ–±—Ä–∞–±–æ—Ç–∫–∏ webhook - 60 —Å–µ–∫—É–Ω–¥
- Telegram –ø–æ–≤—Ç–æ—Ä—è–µ—Ç –∑–∞–ø—Ä–æ—Å –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö

### üîí –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:
- –í—Å–µ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ `secret_token`
- –•—Ä–∞–Ω–∏—Ç–µ `TELEGRAM_BOT_TOKEN` –≤ —Å–µ–∫—Ä–µ—Ç–∞—Ö
- –ü—Ä–æ–≤–µ—Ä—è–π—Ç–µ `x-telegram-bot-api-secret-token` –≤ webhook

---

## –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞: Long Polling (–¥–ª—è dev)

–ï—Å–ª–∏ webhook –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç (–Ω–∞–ø—Ä–∏–º–µ—Ä, –Ω–∞ localhost):

```bash
# –£–¥–∞–ª–∏—Ç—å webhook
curl "https://api.telegram.org/bot<BOT_TOKEN>/deleteWebhook"

# –ó–∞–ø—É—Å—Ç–∏—Ç—å long polling (–≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º —Ç–µ—Ä–º–∏–Ω–∞–ª–µ)
node scripts/telegram-polling.js
```

**–ù–æ –¥–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ webhook!**

---

## –ü—Ä–æ–≤–µ—Ä–æ—á–Ω—ã–π —á–µ–∫–ª–∏—Å—Ç

- [ ] Webhook —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω (`getWebhookInfo` –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç URL)
- [ ] –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –≤ Vercel —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã
- [ ] –ë–æ—Ç - –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –≤—Å–µ—Ö –≥—Ä—É–ø–ø
- [ ] Endpoint `/api/telegram/webhook` –æ—Ç–≤–µ—á–∞–µ—Ç 200
- [ ] –õ–æ–≥–∏ Vercel –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç –≤—Ö–æ–¥—è—â–∏–µ webhook'–∏
- [ ] –ë–î —Å–æ–¥–µ—Ä–∂–∏—Ç –∑–∞–ø–∏—Å–∏ –≤ `activity_events`
- [ ] –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –≤ –∞–¥–º–∏–Ω–∫–µ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è

---

**–î–∞—Ç–∞:** 2025-10-10  
**–°—Ç–∞—Ç—É—Å:** –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –≥–æ—Ç–æ–≤–∞ –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è

