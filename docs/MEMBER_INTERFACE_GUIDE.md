# Интерфейс для участников (не-администраторов)

## Дата: 12.10.2025

## Обзор

Интерфейс для обычных участников (role=`member`) уже **полностью реализован** в проекте. Участники, авторизованные через Telegram, имеют доступ к трем основным разделам в режиме чтения с ограниченными правами.

---

## Доступные разделы для участников

### 1. **Материалы** (📄 Materials)
- **Режим**: Только чтение (read-only)
- **Функциональность**:
  - Просмотр всех материалов организации
  - Навигация по дереву материалов
  - Поиск по материалам
  - ❌ Нет кнопок редактирования
  - ❌ Нет drag'n'drop для изменения структуры
  - ❌ Нет кнопки "Добавить материал"

### 2. **События** (📅 Events)  
- **Режим**: Чтение + регистрация
- **Функциональность**:
  - Просмотр **только опубликованных** событий (status='published')
  - Фильтрация: Все / Предстоящие / Прошедшие
  - **Регистрация на события** ✅
  - Скачивание ICS файлов для календаря
  - ❌ Нет доступа к черновикам
  - ❌ Нет кнопки "Создать событие"
  - ❌ Нет кнопки "Редактировать"
  - ❌ Нет кнопки "Поделиться в группах"

### 3. **Участники** (👥 Members)
- **Режим**: Режим карточек
- **Функциональность**:
  - Просмотр всех участников организации
  - Режим отображения: **только карточки** (с фото, именем, bio)
  - Поиск по имени, username, email, bio
  - Просмотр профиля участника (клик на карточку)
  - ❌ Нет режима таблицы (CRM-style)
  - ❌ Нет вкладки "Приглашения"
  - ❌ Нет кнопок редактирования
  - ❌ Нет кнопки "Добавить участника"

---

## Левое меню для участников

### Структура меню

**Для role=`member`**:
```
┌─────────────────────────────┐
│  [Лого организации]         │
│                             │
├─────────────────────────────┤
│  📄 Материалы               │
│  📅 События                 │
│  👥 Участники               │
├─────────────────────────────┤
│  [Кнопка свернуть]          │
└─────────────────────────────┘
```

**Для role=`admin` или `owner`** (для сравнения):
```
┌─────────────────────────────┐
│  [Лого организации]         │
│                             │
├─────────────────────────────┤
│  📊 Дашборд                 │
│  📄 Материалы               │
│  📅 События                 │
│  👥 Участники               │
│  💬 TELEGRAM ГРУППЫ ⚙️       │
│  ⚙️ Настройки               │
├─────────────────────────────┤
│  [Кнопка свернуть]          │
└─────────────────────────────┘
```

### Отличия для участников

**Отсутствуют** в меню для members:
- ❌ Дашборд (админская аналитика)
- ❌ Telegram группы (управление группами)
- ❌ Настройки организации

**Присутствуют** для всех:
- ✅ Материалы (но в режиме чтения)
- ✅ События (но только published)
- ✅ Участники (но только карточки)

---

## Routing и редиректы

### Стартовая страница для участников

Логика в `lib/auth/getDefaultRoute.ts`:

```typescript
// Для role='member'
if (role === 'member') {
  // 1. Если есть материалы → первый корневой материал
  // 2. Если нет материалов, но есть события → /app/[org]/events
  // 3. Если ничего нет → /app/[org]/members
}
```

**Примеры**:
- Участник заходит на `/app/3097b2df.../` 
  → Редирект на `/app/3097b2df.../materials/[first_root_material_id]`
  
- В организации нет материалов
  → Редирект на `/app/3097b2df.../events`

---

## Permissions (разрешения)

Функция `getRolePermissions(role)` в `components/navigation/collapsible-sidebar.tsx`:

| Действие | owner/admin | member | guest |
|----------|-------------|---------|-------|
| `canViewDashboard` | ✅ | ❌ | ❌ |
| `canViewMaterials` | ✅ | ✅ | ❌ |
| `canEditMaterials` | ✅ | ❌ | ❌ |
| `canViewEvents` | ✅ | ✅ | ❌ |
| `canCreateEvents` | ✅ | ❌ | ❌ |
| `canRegisterForEvents` | ✅ | ✅ | ❌ |
| `canViewMembers` | ✅ | ✅ | ❌ |
| `canEditMembers` | ✅ | ❌ | ❌ |
| `canManageTelegram` | ✅ | ❌ | ❌ |
| `canManageSettings` | ✅ | ❌ | ❌ |

---

## Реализованные компоненты

### 1. Layout и навигация

**Файл**: `app/app/[org]/layout.tsx`
- Проверяет роль через `memberships` таблицу
- Передает `role` в `CollapsibleSidebar`
- Загружает Telegram группы только для admin/owner

**Файл**: `components/navigation/collapsible-sidebar.tsx`
- Role-based меню (показывает только доступные разделы)
- Свертывание/развертывание (сохраняется в localStorage)
- Иконки + текст в развернутом виде, только иконки в свернутом

### 2. Материалы (Materials)

**Файл**: `app/app/[org]/materials/page.tsx`
```typescript
const readOnly = role === 'member' // ✅ Режим чтения для members
```

**Файл**: `components/materials/materials-page-viewer.tsx`
- Prop `readOnly?: boolean`
- В режиме `readOnly`:
  - ❌ Скрыты кнопки редактирования
  - ❌ Отключен drag'n'drop
  - ❌ Скрыта кнопка "Добавить материал"
  - ✅ Доступна навигация и просмотр

### 3. События (Events)

**Файл**: `app/app/[org]/events/page.tsx`
```typescript
if (!isAdmin) {
  eventsQuery = eventsQuery.eq('status', 'published') // ✅ Только published
}
```

**Файл**: `components/events/events-list.tsx`
- Prop `isAdmin: boolean`
- Для members:
  - ✅ Показываются published события
  - ✅ Кнопка "Зарегистрироваться"
  - ❌ Скрыта кнопка "Создать событие"
  - ❌ Скрыты кнопки "Редактировать"

### 4. Участники (Members)

**Файл**: `app/app/[org]/members/page.tsx`
```typescript
const isAdmin = role === 'owner' || role === 'admin'
// Передается в MembersTabs
```

**Файл**: `components/members/members-view.tsx`
- Prop `isAdmin: boolean`
- Для members:
  - ✅ Режим карточек по умолчанию
  - ❌ Скрыта кнопка переключения на таблицу
  - ✅ Поиск работает
  - ✅ Клик на карточку → профиль участника

---

## Тестирование

### Подготовка

1. **Создайте тестового участника**:
   - Авторизуйтесь через Telegram (участник Telegram группы)
   - Убедитесь, что в `memberships` таблице создана запись с `role='member'`

2. **Проверьте данные**:
   ```sql
   -- Проверка роли
   SELECT * FROM memberships 
   WHERE user_id = 'YOUR_USER_ID' 
     AND org_id = 'YOUR_ORG_ID';
   -- Должно быть role='member'
   ```

### Сценарий 1: Вход в организацию

**Шаги**:
1. Откройте `/app/[org]` (например, `/app/3097b2df-cc0b-4f8a-8be7-285d440cc1c8`)
2. Ожидается: автоматический редирект на первый материал
3. Проверьте левое меню: должны быть только **3 раздела** (Материалы, События, Участники)

**Ожидаемый результат**:
- ✅ Нет "Дашборд"
- ✅ Нет "Telegram группы"
- ✅ Нет "Настройки"
- ✅ Меню развернуто по умолчанию

### Сценарий 2: Материалы (режим чтения)

**Шаги**:
1. Откройте `/app/[org]/materials`
2. Выберите любой материал в дереве
3. Попробуйте найти кнопки редактирования

**Ожидаемый результат**:
- ✅ Материал отображается
- ✅ Дерево материалов навигируется
- ✅ Поиск работает
- ❌ Нет кнопки "Редактировать"
- ❌ Нет кнопки "Добавить материал"
- ❌ Нет drag'n'drop в дереве

### Сценарий 3: События (с регистрацией)

**Шаги**:
1. Откройте `/app/[org]/events`
2. Проверьте фильтр событий
3. Откройте любое событие
4. Попробуйте зарегистрироваться

**Ожидаемый результат**:
- ✅ Показываются только published события
- ✅ Фильтры работают (Все / Предстоящие / Прошедшие)
- ✅ Кнопка "Зарегистрироваться" работает
- ❌ Нет черновиков (draft)
- ❌ Нет кнопки "Создать событие"
- ❌ Нет кнопки "Редактировать"

### Сценарий 4: Участники (карточки)

**Шаги**:
1. Откройте `/app/[org]/members`
2. Проверьте режим отображения
3. Найдите переключатель видов
4. Кликните на любую карточку

**Ожидаемый результат**:
- ✅ Участники отображаются в виде карточек
- ✅ Поиск работает
- ✅ Клик на карточку → профиль участника
- ❌ Нет переключателя "Таблица" (только для админов)
- ❌ Нет вкладки "Приглашения"
- ❌ Нет кнопки "Добавить участника"

---

## Что уже работает ✅

Вся функциональность для участников уже реализована:

1. ✅ **Левое меню** - показывает только доступные разделы
2. ✅ **Routing** - корректные редиректы для members
3. ✅ **Материалы** - режим чтения (readOnly)
4. ✅ **События** - только published + регистрация
5. ✅ **Участники** - режим карточек + поиск
6. ✅ **Permissions** - role-based ограничения

---

## Дополнительные улучшения (опционально)

### 1. Добавить badge "Участник"

```typescript
// components/navigation/collapsible-sidebar.tsx
{role === 'member' && (
  <div className="px-4 py-2 text-xs text-gray-500">
    Участник
  </div>
)}
```

### 2. Показывать подсказки для недоступных действий

```typescript
// Если member пытается редактировать
<button disabled title="Редактирование доступно только администраторам">
  Редактировать
</button>
```

### 3. Добавить "Мой профиль" в меню

```typescript
// Для member - быстрый доступ к своему профилю
navItems.push({
  key: 'my-profile',
  label: 'Мой профиль',
  icon: User,
  href: `/app/${orgId}/members/${currentUser.participantId}`,
})
```

---

## Статус

✅ **Полностью реализовано**  
📅 **Дата**: 12.10.2025  
🎯 **Готово к использованию**:
  - ✅ Левое меню с 3 разделами
  - ✅ Материалы (режим чтения)
  - ✅ События (published + регистрация)
  - ✅ Участники (карточки + поиск)
📊 **Ошибок**: Нет  
📝 **Требуется**: Только тестирование

---

## Следующий шаг

**Протестируйте авторизацию участника**:

1. Авторизуйтесь через Telegram (участник группы)
2. Откройте `/app/[org]`
3. Убедитесь, что видите только 3 раздела в меню
4. Проверьте каждый раздел:
   - Материалы (читать, но не редактировать)
   - События (видеть и регистрироваться)
   - Участники (карточки, не таблица)

**Все должно работать из коробки!** ✨

---

**Версия**: 1.0  
**Автор**: AI Assistant  
**Последнее обновление**: 12.10.2025

