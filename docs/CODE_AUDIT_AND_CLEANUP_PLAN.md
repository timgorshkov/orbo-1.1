# –ê—É–¥–∏—Ç –∫–æ–¥–æ–≤–æ–π –±–∞–∑—ã –∏ –ø–ª–∞–Ω —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞

**–î–∞—Ç–∞:** 30 –æ–∫—Ç—è–±—Ä—è 2024  
**–¶–µ–ª—å:** –£—Å—Ç—Ä–∞–Ω–∏—Ç—å –Ω–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è –º–µ–∂–¥—É —Å—Ö–µ–º–æ–π –ë–î –∏ –∫–æ–¥–æ–º, —É–¥–∞–ª–∏—Ç—å –º—ë—Ä—Ç–≤—ã–π –∫–æ–¥

---

## üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞—É–¥–∏—Ç–∞

### ‚úÖ –£–¢–í–ï–†–ñ–î–ï–ù–ò–ï 1: telegram_activity_events, telegram_identities, telegram_updates

**–°—Ç–∞—Ç—É—Å –≤–Ω–µ—à–Ω–µ–≥–æ –∞—É–¥–∏—Ç–∞:** ‚úÖ –ü–û–î–¢–í–ï–†–ñ–î–ï–ù  
**–ú–æ–µ –∑–∞–∫–ª—é—á–µ–Ω–∏–µ:** –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–±–ª–µ–º–∞, —Ç—Ä–µ–±—É–µ—Ç –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ–≥–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

#### –§–∞–∫—Ç—ã:
- **–ú–∏–≥—Ä–∞—Ü–∏—è 42** (`db/migrations/42_cleanup_unused_tables.sql`) —É–¥–∞–ª—è–µ—Ç:
  - `telegram_activity_events` (—Å—Ç—Ä–æ–∫–∞ 8)
  - `telegram_identities` (—Å—Ç—Ä–æ–∫–∞ 21)
  - `telegram_updates` (—Å—Ç—Ä–æ–∫–∞ 28)
  - `participants.identity_id` (—Å—Ç—Ä–æ–∫–∞ 18)

#### –ì–¥–µ –∫–æ–¥ –≤—Å—ë –µ—â–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —ç—Ç–∏ —Ç–∞–±–ª–∏—Ü—ã:

**1. `lib/services/eventProcessingService.ts`** - –ö–†–ò–¢–ò–ß–ù–û ‚ùå

```typescript
// –°—Ç—Ä–æ–∫–∏ 47-64: –ú–µ—Ç–æ–¥—ã –¥–ª—è telegram_updates
async isUpdateProcessed(updateId: number): Promise<boolean> {
  const { data } = await this.supabase
    .from('telegram_updates')  // ‚ùå –¢–∞–±–ª–∏—Ü–∞ —É–¥–∞–ª–µ–Ω–∞!
    .select('id')
    .eq('update_id', updateId)
    .single();
  return !!data;
}

async markUpdateProcessed(updateId: number): Promise<void> {
  await this.supabase
    .from('telegram_updates')  // ‚ùå –¢–∞–±–ª–∏—Ü–∞ —É–¥–∞–ª–µ–Ω–∞!
    .insert({ update_id: updateId });
}

// –°—Ç—Ä–æ–∫–∞ 12: ParticipantRow type
type ParticipantRow = {
  identity_id?: string | null;  // ‚ùå –ü–æ–ª–µ —É–¥–∞–ª–µ–Ω–æ!
  // ...
};

// –°—Ç—Ä–æ–∫–∏ 880-1599: –ú–Ω–æ–∂–µ—Å—Ç–≤–æ –≤—ã–∑–æ–≤–æ–≤ writeGlobalActivityEvent
await this.writeGlobalActivityEvent({
  tg_chat_id: chatId,
  identity_id: null,  // ‚ùå –ü–æ–ª–µ —É–¥–∞–ª–µ–Ω–æ!
  tg_user_id: userId,
  event_type: 'message',
  // ...
});

// –°—Ç—Ä–æ–∫–∏ 1584-1600: –ú–µ—Ç–æ–¥ writeGlobalActivityEvent
private async writeGlobalActivityEvent(payload: {...}): Promise<void> {
  // DEPRECATED: telegram_activity_events and telegram_identities tables were removed
  // This method is kept for backward compatibility but does nothing
  return;  // ‚ùå –ü—É—Å—Ç–æ–π –º–µ—Ç–æ–¥, –≤–≤–æ–¥–∏—Ç –≤ –∑–∞–±–ª—É–∂–¥–µ–Ω–∏–µ
}
```

**2. `app/api/participants/backfill-orphans/route.ts`** ‚ö†Ô∏è

```typescript
// –°—Ç—Ä–æ–∫–∏ 10-20: Types
type IdentityRecord = {
  id: string | null;
  tg_user_id: number | null;
  // ...
};

type ParticipantRow = {
  identity_id: string | null;  // ‚ùå –ü–æ–ª–µ —É–¥–∞–ª–µ–Ω–æ!
  // ...
};

type ActivityEventRecord = {
  identity_id: string | null;  // ‚ùå –ü–æ–ª–µ —É–¥–∞–ª–µ–Ω–æ!
  // ...
};
```

#### –ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è:
- ‚ùå `eventProcessingService` –ø—ã—Ç–∞–µ—Ç—Å—è –ø–∏—Å–∞—Ç—å –≤ –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Ç–∞–±–ª–∏—Ü—ã
- ‚ùå –ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å –≤–µ–±—Ö—É–∫–æ–≤ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç (–¥—É–±–ª–∏ —Å–æ–±—ã—Ç–∏–π)
- ‚ùå TypeScript —Ç–∏–ø—ã –Ω–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—Ç —Ä–µ–∞–ª—å–Ω–æ–π —Å—Ö–µ–º–µ
- ‚ö†Ô∏è –ú–∏–≥—Ä–∞—Ü–∏—è 42 –º–æ–≥–ª–∞ –ù–ï –≤—ã–ø–æ–ª–Ω–∏—Ç—å—Å—è –Ω–∞ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ

---

### ‚úÖ –£–¢–í–ï–†–ñ–î–ï–ù–ò–ï 2.4: –°—Ç–∞—Ä—ã–µ —Ç–∞–±–ª–∏—Ü—ã –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤

**–°—Ç–∞—Ç—É—Å –≤–Ω–µ—à–Ω–µ–≥–æ –∞—É–¥–∏—Ç–∞:** ‚úÖ –ü–û–î–¢–í–ï–†–ñ–î–ï–ù  
**–ú–æ–µ –∑–∞–∫–ª—é—á–µ–Ω–∏–µ:** –ë–µ–∑–æ–ø–∞—Å–Ω–æ —É–¥–∞–ª–∏—Ç—å, –º–∏–≥—Ä–∞—Ü–∏—è —Å—É—â–µ—Å—Ç–≤—É–µ—Ç

#### –§–∞–∫—Ç—ã:
- **–ú–∏–≥—Ä–∞—Ü–∏—è 49** (`db/migrations/49_migrate_old_materials.sql`) –º–∏–≥—Ä–∏—Ä—É–µ—Ç –¥–∞–Ω–Ω—ã–µ:
  - `material_folders` ‚Üí `material_pages`
  - `material_items` ‚Üí `material_pages`
  - `material_access` ‚Üí —É–¥–∞–ª—è–µ—Ç—Å—è
- –ú–∏–≥—Ä–∞—Ü–∏—è 42 –ù–ï —É–¥–∞–ª—è–µ—Ç —ç—Ç–∏ —Ç–∞–±–ª–∏—Ü—ã (—Å—Ç—Ä–æ–∫–∏ 36-60), —Ç–æ–ª—å–∫–æ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç

#### –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤ –∫–æ–¥–µ:
- ‚úÖ **–ù–ï–¢ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ `app/api`**
- ‚úÖ **–ù–ï–¢ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ `components`**
- ‚ö†Ô∏è –¢–æ–ª—å–∫–æ –≤ —Ç–∏–ø–∞—Ö `lib/database.types.ts`

#### –†–∏—Å–∫–∏ —É–¥–∞–ª–µ–Ω–∏—è:
- ‚úÖ **–ù–ò–ó–ö–ò–ô –†–ò–°–ö** - —Ç–∞–±–ª–∏—Ü—ã –Ω–µ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è, –º–∏–≥—Ä–∞—Ü–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∞

---

### ‚úÖ –£–¢–í–ï–†–ñ–î–ï–ù–ò–ï 2.5: profiles.telegram_user_id

**–°—Ç–∞—Ç—É—Å –≤–Ω–µ—à–Ω–µ–≥–æ –∞—É–¥–∏—Ç–∞:** ‚úÖ –ü–û–î–¢–í–ï–†–ñ–î–ï–ù  
**–ú–æ–µ –∑–∞–∫–ª—é—á–µ–Ω–∏–µ:** –ü–æ–ª–µ —É—Å—Ç–∞—Ä–µ–ª–æ, –Ω–æ —Ç—Ä–µ–±—É–µ—Ç –æ—Å—Ç–æ—Ä–æ–∂–Ω–æ–π –º–∏–≥—Ä–∞—Ü–∏–∏

#### –§–∞–∫—Ç—ã:
- **–ú–∏–≥—Ä–∞—Ü–∏—è 02** –¥–æ–±–∞–≤–ª—è–µ—Ç `profiles.telegram_user_id` (—Å—Ç—Ä–æ–∫–∞ 15)
- **–ù–æ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞:** `user_telegram_accounts` (—Å–æ–∑–¥–∞–Ω–∞ –ø–æ–∑–∂–µ)
- –ü–æ–ª–µ **–ù–ï –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ app –∫–æ–¥–µ**, —Ç–æ–ª—å–∫–æ –≤ —Ç–∏–ø–∞—Ö

#### –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:
```typescript
// lib/database.types.ts - —Ç–æ–ª—å–∫–æ type definition
profiles: {
  Row: {
    telegram_user_id: number | null  // –î—É–±–ª–∏—Ä—É–µ—Ç user_telegram_accounts
    // ...
  }
}
```

#### –ì–¥–µ —Ä–µ–∞–ª—å–Ω–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è telegram_user_id:
- ‚úÖ `user_telegram_accounts.telegram_user_id` - **–ê–ö–¢–ò–í–ù–û** –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ 19 —Ñ–∞–π–ª–∞—Ö
- ‚ùå `profiles.telegram_user_id` - **–ù–ï –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è** –≤ –∫–æ–¥–µ

#### –†–∏—Å–∫–∏ —É–¥–∞–ª–µ–Ω–∏—è:
- ‚úÖ **–ù–ò–ó–ö–ò–ô –†–ò–°–ö** - –ø–æ–ª–µ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è, –¥–∞–Ω–Ω—ã–µ —É–∂–µ –≤ `user_telegram_accounts`

---

## üõ†Ô∏è –ü–ª–∞–Ω —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞

### –§–∞–∑–∞ 1: –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è (–í—ã—Å–æ–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç)

#### 1.1. –ò—Å–ø—Ä–∞–≤–∏—Ç—å `eventProcessingService.ts` ‚ö†Ô∏è –ö–†–ò–¢–ò–ß–ù–û

**–ü—Ä–æ–±–ª–µ–º–∞:** –ú–µ—Ç–æ–¥—ã –ø—ã—Ç–∞—é—Ç—Å—è –ø–∏—Å–∞—Ç—å –≤ —É–¥–∞–ª—ë–Ω–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã

**–†–µ—à–µ–Ω–∏–µ:**
```typescript
// –£–î–ê–õ–ò–¢–¨ –º–µ—Ç–æ–¥—ã –¥–ª—è telegram_updates (–∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å –Ω–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞)
- async isUpdateProcessed()
- async markUpdateProcessed()

// –£–î–ê–õ–ò–¢–¨ –º—ë—Ä—Ç–≤—ã–π –∫–æ–¥
- private async writeGlobalActivityEvent()
- type ParticipantRow.identity_id

// –ó–ê–ú–ï–ù–ò–¢–¨ –≤—ã–∑–æ–≤—ã writeGlobalActivityEvent –Ω–∞ –ø—Ä—è–º—É—é –∑–∞–ø–∏—Å—å –≤ activity_events
- –í—Å–µ –≤—ã–∑–æ–≤—ã (—Å—Ç—Ä–æ–∫–∏ 880, 1053, 1086, 1145) –∑–∞–º–µ–Ω–∏—Ç—å –Ω–∞ –ø—Ä—è–º–æ–π INSERT
```

**–†–∏—Å–∫–∏:**
- ‚ö†Ô∏è **–°–†–ï–î–ù–ò–ô –†–ò–°–ö** - –º–æ–∂–µ—Ç —Å–ª–æ–º–∞—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É –≤–µ–±—Ö—É–∫–æ–≤
- –¢—Ä–µ–±—É–µ—Ç—Å—è —Ç—â–∞—Ç–µ–ª—å–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π Telegram
- –ù—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—É—é –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å (Redis? –∏–ª–∏ ignore duplicates?)

**–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞:**
- –û—Å—Ç–∞–≤–∏—Ç—å –º–µ—Ç–æ–¥—ã –∫–∞–∫ –∑–∞–≥–ª—É—à–∫–∏ —Å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ–º –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è

---

#### 1.2. –û—á–∏—Å—Ç–∏—Ç—å —Ç–∏–ø—ã –≤ `backfill-orphans/route.ts` ‚úÖ –ë–ï–ó–û–ü–ê–°–ù–û

**–ü—Ä–æ–±–ª–µ–º–∞:** –¢–∏–ø—ã —Å–æ–¥–µ—Ä–∂–∞—Ç —É–¥–∞–ª—ë–Ω–Ω–æ–µ –ø–æ–ª–µ `identity_id`

**–†–µ—à–µ–Ω–∏–µ:**
```typescript
// –£–î–ê–õ–ò–¢–¨ identity_id –∏–∑ —Ç–∏–ø–æ–≤:
type IdentityRecord = {
  - id: string | null;  // –≠—Ç–æ –Ω–∞ —Å–∞–º–æ–º –¥–µ–ª–µ –ù–ï identity_id
  tg_user_id: number | null;
  // ...
};

type ParticipantRow = {
  - identity_id: string | null;
  // ...
};

type ActivityEventRecord = {
  - identity_id: string | null;
  // ...
};
```

**–†–∏—Å–∫–∏:**
- ‚úÖ **–ù–ò–ó–ö–ò–ô –†–ò–°–ö** - –ø–æ–ª–µ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ –ª–æ–≥–∏–∫–µ, —Ç–æ–ª—å–∫–æ –≤ —Ç–∏–ø–∞—Ö

---

### –§–∞–∑–∞ 2: –£–¥–∞–ª–µ–Ω–∏–µ —É—Å—Ç–∞—Ä–µ–≤—à–∏—Ö —Ç–∞–±–ª–∏—Ü (–°—Ä–µ–¥–Ω–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç)

#### 2.1. –§–∏–Ω–∞–ª—å–Ω–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤ ‚úÖ –ë–ï–ó–û–ü–ê–°–ù–û

**–£—Å–ª–æ–≤–∏–µ:** –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–∞ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ, –≤—ã–ø–æ–ª–Ω–µ–Ω–∞ –ª–∏ –º–∏–≥—Ä–∞—Ü–∏—è 49

**SQL:**
```sql
-- –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ–¥ —É–¥–∞–ª–µ–Ω–∏–µ–º
SELECT COUNT(*) as folders_count FROM material_folders;
SELECT COUNT(*) as items_count FROM material_items;
SELECT COUNT(*) as access_count FROM material_access;

-- –ï—Å–ª–∏ –≤—Å–µ 0, –±–µ–∑–æ–ø–∞—Å–Ω–æ —É–¥–∞–ª–∏—Ç—å
DROP TABLE IF EXISTS material_access CASCADE;
DROP TABLE IF EXISTS material_items CASCADE;
DROP TABLE IF EXISTS material_folders CASCADE;
```

**–†–∏—Å–∫–∏:**
- ‚úÖ **–ù–ò–ó–ö–ò–ô –†–ò–°–ö** - –º–∏–≥—Ä–∞—Ü–∏—è 49 —É–∂–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞
- ‚ö†Ô∏è –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –≤ `material_pages`

---

#### 2.2. –£–¥–∞–ª–∏—Ç—å `profiles.telegram_user_id` ‚úÖ –ë–ï–ó–û–ü–ê–°–ù–û

**–£—Å–ª–æ–≤–∏–µ:** –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –≤ `user_telegram_accounts`

**SQL:**
```sql
-- –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ–¥ —É–¥–∞–ª–µ–Ω–∏–µ–º
SELECT 
  COUNT(*) as profiles_with_tg_id,
  COUNT(DISTINCT p.id) as total_profiles
FROM profiles p
WHERE p.telegram_user_id IS NOT NULL;

-- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –≤—Å–µ –µ—Å—Ç—å –≤ user_telegram_accounts
SELECT 
  p.id as profile_id,
  p.telegram_user_id,
  uta.id as account_id
FROM profiles p
LEFT JOIN user_telegram_accounts uta ON uta.telegram_user_id = p.telegram_user_id
WHERE p.telegram_user_id IS NOT NULL
  AND uta.id IS NULL;

-- –ï—Å–ª–∏ –Ω–µ—Ç –Ω–µ—Å–æ–≤–ø–∞–¥–µ–Ω–∏–π, –±–µ–∑–æ–ø–∞—Å–Ω–æ —É–¥–∞–ª–∏—Ç—å
ALTER TABLE profiles DROP COLUMN IF EXISTS telegram_user_id;
```

**–†–∏—Å–∫–∏:**
- ‚úÖ **–ù–ò–ó–ö–ò–ô –†–ò–°–ö** - –ø–æ–ª–µ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ –∫–æ–¥–µ
- ‚ö†Ô∏è –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–∞ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ, –Ω–µ—Ç –ª–∏ –Ω–µ—Å–æ–≤–ø–∞–¥–µ–Ω–∏–π

---

### –§–∞–∑–∞ 3: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ (–ù–∏–∑–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç)

#### 3.1. –û–±–Ω–æ–≤–∏—Ç—å —Ç–∏–ø—ã TypeScript

**–§–∞–π–ª—ã:**
- `lib/database.types.ts` - –ø–µ—Ä–µ—Å–æ–∑–¥–∞—Ç—å —á–µ—Ä–µ–∑ `supabase gen types`

#### 3.2. –£–¥–∞–ª–∏—Ç—å —É—Å—Ç–∞—Ä–µ–≤—à—É—é –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é

**–§–∞–π–ª—ã –¥–ª—è —Ä–µ–≤—å—é:**
- `docs/THREE_CRITICAL_FIXES.md` - —É–ø–æ–º–∏–Ω–∞–µ—Ç telegram_identities
- `docs/TELEGRAM_IDENTITIES_REMOVAL_FIX.md` - —É—Å—Ç–∞—Ä–µ–ª
- `docs/DATABASE_CLEANUP_STATUS.md` - –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å—ã
- `docs/DATABASE_ANALYSIS.md` - –æ–±–Ω–æ–≤–∏—Ç—å –∞–Ω–∞–ª–∏–∑

---

## ‚ö†Ô∏è –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï –í–û–ü–†–û–°–´ –ö –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Æ

### Q1: –ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å –≤–µ–±—Ö—É–∫–æ–≤ Telegram

**–ü—Ä–æ–±–ª–µ–º–∞:** `telegram_updates` —É–¥–∞–ª–µ–Ω–∞, –Ω–æ –º–µ—Ç–æ–¥—ã –ø—ã—Ç–∞—é—Ç—Å—è –≤ –Ω–µ—ë –ø–∏—Å–∞—Ç—å

**–í–∞—Ä–∏–∞–Ω—Ç—ã:**
1. **–£–¥–∞–ª–∏—Ç—å –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å** (—Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ) - –≤–æ–∑–º–æ–∂–Ω—ã –¥—É–±–ª–∏ —Å–æ–±—ã—Ç–∏–π
2. **–†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å —á–µ—Ä–µ–∑ Redis** - –Ω—É–∂–Ω–∞ –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞
3. **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å unique constraints –≤ activity_events** - –º–æ–∂–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å

**–í–æ–ø—Ä–æ—Å:** –ö–∞–∫ –≤—ã —Ö–æ—Ç–∏—Ç–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –¥—É–±–ª–∏–∫–∞—Ç—ã —Å–æ–±—ã—Ç–∏–π –æ—Ç Telegram?

---

### Q2: –ú–∏–≥—Ä–∞—Ü–∏—è 42 –Ω–∞ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ

**–ü—Ä–æ–±–ª–µ–º–∞:** –ö–æ–¥ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —É–¥–∞–ª—ë–Ω–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã, –∑–Ω–∞—á–∏—Ç –ª–∏–±–æ:
- –ú–∏–≥—Ä–∞—Ü–∏—è 42 **–ù–ï –≤—ã–ø–æ–ª–Ω–µ–Ω–∞** –Ω–∞ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ
- –ò–õ–ò –∫–æ–¥ —Ä–∞–±–æ—Ç–∞–µ—Ç —Å –æ—à–∏–±–∫–∞–º–∏

**–í–æ–ø—Ä–æ—Å:** –í—ã–ø–æ–ª–Ω–µ–Ω–∞ –ª–∏ –º–∏–≥—Ä–∞—Ü–∏—è 42 –Ω–∞ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ? –ù—É–∂–Ω–æ –ª–∏ –µ—ë –æ—Ç–∫–∞—Ç–∏—Ç—å?

---

### Q3: –°—Ç–∞—Ä—ã–µ —Ç–∞–±–ª–∏—Ü—ã –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤

**–í–æ–ø—Ä–æ—Å:** –ú–∏–≥—Ä–∞—Ü–∏—è 49 –≤—ã–ø–æ–ª–Ω–µ–Ω–∞ –Ω–∞ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ? –í—Å–µ –¥–∞–Ω–Ω—ã–µ –≤ `material_pages`?

---

### Q4: profiles.telegram_user_id

**–í–æ–ø—Ä–æ—Å:** –ï—Å—Ç—å –ª–∏ –Ω–∞ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ –¥–∞–Ω–Ω—ã–µ –≤ `profiles.telegram_user_id`, –∫–æ—Ç–æ—Ä—ã—Ö –Ω–µ—Ç –≤ `user_telegram_accounts`?

---

## üìù –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º–∞—è –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å –¥–µ–π—Å—Ç–≤–∏–π

### –®–∞–≥ 1: –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞ ‚ö†Ô∏è –ö–†–ò–¢–ò–ß–ù–û

```sql
-- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —Å—É—â–µ—Å—Ç–≤—É—é—Ç –ª–∏ —É–¥–∞–ª—ë–Ω–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã
SELECT table_name 
FROM information_schema.tables 
WHERE table_schema = 'public' 
  AND table_name IN ('telegram_updates', 'telegram_identities', 'telegram_activity_events');

-- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ –∫–æ–ª–æ–Ω–∫–∞ identity_id
SELECT column_name 
FROM information_schema.columns 
WHERE table_schema = 'public' 
  AND table_name = 'participants'
  AND column_name = 'identity_id';

-- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ä—ã–µ —Ç–∞–±–ª–∏—Ü—ã –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤
SELECT COUNT(*) FROM material_folders;
SELECT COUNT(*) FROM material_items;
```

### –®–∞–≥ 2: –í –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤

#### –ï—Å–ª–∏ —Ç–∞–±–ª–∏—Ü—ã –£–î–ê–õ–ï–ù–´ –Ω–∞ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ:
‚Üí –ò—Å–ø—Ä–∞–≤–∏—Ç—å –∫–æ–¥ (–§–∞–∑–∞ 1) –ù–ï–ú–ï–î–õ–ï–ù–ù–û

#### –ï—Å–ª–∏ —Ç–∞–±–ª–∏—Ü—ã –ï–©–Å –°–£–©–ï–°–¢–í–£–Æ–¢:
‚Üí –û—Ç–ª–æ–∂–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é 42, —Å–Ω–∞—á–∞–ª–∞ –∏—Å–ø—Ä–∞–≤–∏—Ç—å –∫–æ–¥

### –®–∞–≥ 3: –ü–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ (–ø–æ—Å–ª–µ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏)

1. ‚úÖ –ò—Å–ø—Ä–∞–≤–∏—Ç—å `eventProcessingService.ts`
2. ‚úÖ –ò—Å–ø—Ä–∞–≤–∏—Ç—å —Ç–∏–ø—ã –≤ `backfill-orphans`
3. ‚úÖ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ dev
4. ‚úÖ –î–µ–ø–ª–æ–π —Ñ–∏–∫—Å–∞
5. ‚ö†Ô∏è –í—ã–ø–æ–ª–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é 42 (–µ—Å–ª–∏ –Ω–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞)
6. ‚úÖ –£–¥–∞–ª–∏—Ç—å —Å—Ç–∞—Ä—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã (–§–∞–∑–∞ 2.1)
7. ‚úÖ –£–¥–∞–ª–∏—Ç—å `profiles.telegram_user_id` (–§–∞–∑–∞ 2.2)

---

## üéØ –û—Ü–µ–Ω–∫–∞ —Ä–∏—Å–∫–æ–≤

| –ü—Ä–æ–±–ª–µ–º–∞ | –†–∏—Å–∫ –ø–æ–ª–æ–º–∫–∏ | –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç | –°–ª–æ–∂–Ω–æ—Å—Ç—å |
|----------|--------------|-----------|-----------|
| telegram_updates –≤ eventProcessingService | üî¥ –í–´–°–û–ö–ò–ô | P0 | –°—Ä–µ–¥–Ω—è—è |
| identity_id –≤ —Ç–∏–ø–∞—Ö | üü° –ù–ò–ó–ö–ò–ô | P1 | –ù–∏–∑–∫–∞—è |
| –°—Ç–∞—Ä—ã–µ —Ç–∞–±–ª–∏—Ü—ã –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤ | üü¢ –ù–ï–¢ | P2 | –ù–∏–∑–∫–∞—è |
| profiles.telegram_user_id | üü¢ –ù–ï–¢ | P2 | –ù–∏–∑–∫–∞—è |

---

## üìö –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –Ω–∞–±–ª—é–¥–µ–Ω–∏—è

### –•–æ—Ä–æ—à–∏–µ –ø—Ä–∞–∫—Ç–∏–∫–∏, –∫–æ—Ç–æ—Ä—ã–µ —É–∂–µ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã:

1. ‚úÖ –ú–∏–≥—Ä–∞—Ü–∏—è 42 —Ö–æ—Ä–æ—à–æ –¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∞
2. ‚úÖ –ú–∏–≥—Ä–∞—Ü–∏—è 49 –º–∏–≥—Ä–∏—Ä—É–µ—Ç –¥–∞–Ω–Ω—ã–µ –ø–µ—Ä–µ–¥ —É–¥–∞–ª–µ–Ω–∏–µ–º
3. ‚úÖ `writeGlobalActivityEvent` –ø–æ–º–µ—á–µ–Ω –∫–∞–∫ DEPRECATED

### –ß—Ç–æ –º–æ–∂–Ω–æ —É–ª—É—á—à–∏—Ç—å:

1. ‚ö†Ô∏è –ü—Ä–æ–≤–µ—Ä—è—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–π –ø–µ—Ä–µ–¥ –¥–µ–ø–ª–æ–µ–º –∫–æ–¥–∞
2. ‚ö†Ô∏è –£–¥–∞–ª—è—Ç—å –º—ë—Ä—Ç–≤—ã–π –∫–æ–¥ —Å—Ä–∞–∑—É, –Ω–µ –æ—Å—Ç–∞–≤–ª—è—Ç—å –∑–∞–≥–ª—É—à–∫–∏
3. ‚ö†Ô∏è –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ—Å–æ–∑–¥–∞–≤–∞—Ç—å —Ç–∏–ø—ã (`supabase gen types`)

---

## ‚úÖ –ò—Ç–æ–≥–æ–≤–æ–µ –∑–∞–∫–ª—é—á–µ–Ω–∏–µ

**–í–Ω–µ—à–Ω–∏–π –∞—É–¥–∏—Ç –í–ï–†–ï–ù**, –Ω–æ —Å–∏—Ç—É–∞—Ü–∏—è —Ç—Ä–µ–±—É–µ—Ç —É—Ç–æ—á–Ω–µ–Ω–∏—è:

1. ‚ùå **–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –Ω–µ—Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ—Å—Ç—å** –≤ `eventProcessingService.ts` - —Ç—Ä–µ–±—É–µ—Ç –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ–≥–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è
2. ‚úÖ **–°—Ç–∞—Ä—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã** –º–æ–∂–Ω–æ –±–µ–∑–æ–ø–∞—Å–Ω–æ —É–¥–∞–ª–∏—Ç—å
3. ‚úÖ **profiles.telegram_user_id** –º–æ–∂–Ω–æ –±–µ–∑–æ–ø–∞—Å–Ω–æ —É–¥–∞–ª–∏—Ç—å
4. ‚ö†Ô∏è **–ù—É–∂–Ω–∞ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞** –ø–µ—Ä–µ–¥ –ª—é–±—ã–º–∏ –¥–µ–π—Å—Ç–≤–∏—è–º–∏

**–ì–æ—Ç–æ–≤ –ø—Ä–∏—Å—Ç—É–ø–∏—Ç—å –∫ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—é —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ –æ—Ç–≤–µ—Ç–æ–≤ –Ω–∞ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –≤–æ–ø—Ä–æ—Å—ã.**

