# Автоматическая подгрузка фотографий участников из Telegram

## Обзор

Реализована автоматическая подгрузка фотографий профиля участников из Telegram, если они не загрузили фото вручную.

## Как это работает

### 1. Telegram Bot API

Используются методы Telegram Bot API:
- `getUserProfilePhotos` - получение списка фотографий профиля пользователя
- `getFile` - получение информации о файле для скачивания
- Прямое скачивание файла по URL `https://api.telegram.org/file/bot<token>/<file_path>`

### 2. Логика работы

1. **Проверка наличия фото**: Если у участника уже есть загруженное вручную фото (URL содержит `participant-photos`), оно не перезаписывается
2. **Запрос к Telegram**: Запрашиваем фотографии профиля пользователя по `tg_user_id`
3. **Скачивание**: Скачиваем наибольшую версию фото (последнюю в массиве)
4. **Загрузка в Storage**: Сохраняем файл в Supabase Storage bucket `participant-photos`
5. **Обновление БД**: Обновляем `photo_url` в таблице `participants`

### 3. Автоматическая подгрузка в UI

Создан React хук `useTelegramPhoto`, который:
- Автоматически вызывается при отображении участника без фото
- Запрашивает синхронизацию фото с Telegram
- Обновляет отображение при получении фото
- Не блокирует рендеринг (работает асинхронно)

## Реализованные компоненты

### Новые файлы

#### 1. `lib/services/telegramService.ts` (обновлён)
Добавлены методы:
```typescript
async getUserProfilePhotos(userId: number, offset?: number, limit?: number)
async getFile(fileId: string)
getFileUrl(filePath: string): string
async downloadFile(filePath: string): Promise<ArrayBuffer>
```

#### 2. `app/api/participants/[id]/sync-telegram-photo/route.ts`
API endpoint для синхронизации фото:
- `POST /api/participants/[id]/sync-telegram-photo`
- Проверяет авторизацию
- Не перезаписывает вручную загруженные фото
- Скачивает и сохраняет фото из Telegram
- Обновляет `photo_url` в БД

#### 3. `lib/hooks/useTelegramPhoto.ts`
React хук для автоматической подгрузки:
```typescript
const { photoUrl, isLoading, error } = useTelegramPhoto(
  participantId,
  currentPhotoUrl,
  tgUserId
)
```

#### 4. `components/members/participant-avatar.tsx`
Универсальный компонент аватара с автоматической подгрузкой:
```typescript
<ParticipantAvatar
  participantId={participant.id}
  photoUrl={participant.photo_url}
  tgUserId={participant.tg_user_id}
  displayName={displayName}
  size="md"  // 'sm' | 'md' | 'lg'
/>
```

### Обновлённые компоненты

#### 1. `components/members/member-card.tsx`
- Использует `ParticipantAvatar` для отображения фото
- Автоматически подгружает фото из Telegram

#### 2. `components/members/members-table.tsx`
- Использует `ParticipantAvatar` в таблице участников
- Автоматически подгружает фото из Telegram

## Использование

### Автоматическое использование

Фото подгружаются автоматически в следующих местах:
1. **Список участников (таблица)** - `/app/[org]/members`
2. **Список участников (карточки)** - `/app/[org]/members`
3. **Профиль участника** - можно добавить аналогично

### Ручная синхронизация

Можно вызвать синхронизацию вручную:
```typescript
const response = await fetch(
  `/api/participants/${participantId}/sync-telegram-photo`,
  { method: 'POST' }
)
const data = await response.json()
// data.photo_url - URL нового фото
```

### В новых компонентах

Для использования в новых компонентах:

```typescript
import { ParticipantAvatar } from '@/components/members/participant-avatar'

<ParticipantAvatar
  participantId={participant.id}
  photoUrl={participant.photo_url}
  tgUserId={participant.tg_user_id}
  displayName={participant.full_name || 'Unknown'}
  size="md"
  className="custom-class"
/>
```

## Приоритеты отображения

1. **Вручную загруженное фото** - если `photo_url` содержит `participant-photos`, используется оно
2. **Фото из Telegram** - если нет загруженного фото, автоматически запрашивается из Telegram
3. **Инициалы** - если нет фото вообще, отображаются инициалы на цветном фоне

## Ограничения

1. **Авторизация**: Для синхронизации фото требуется авторизация
2. **Telegram User ID**: Фото можно подгрузить только для участников с `tg_user_id`
3. **Privacy Settings**: Если пользователь скрыл фото профиля в Telegram, оно не будет доступно
4. **Rate Limits**: Telegram Bot API имеет лимиты на количество запросов
5. **Нет перезаписи**: Вручную загруженные фото не перезаписываются автоматически

## Производительность

### Оптимизация
- Хук `useTelegramPhoto` запускается только если нет фото
- Запросы кэшируются в Supabase Storage
- Не блокирует рендеринг (асинхронная загрузка)
- Показывается placeholder до загрузки фото

### Потенциальные улучшения
1. **Batch синхронизация** - синхронизировать фото сразу для нескольких участников
2. **Background job** - периодическая фоновая синхронизация всех фото
3. **CDN кэширование** - использовать CDN для фото из Storage

## Тестирование

### Сценарий 1: Новый участник без фото
1. Участник присоединяется к группе
2. Открываем список участников
3. Фото автоматически подгружается из Telegram (если есть)

### Сценарий 2: Участник загружает фото вручную
1. Участник загружает фото через интерфейс
2. Вручную загруженное фото сохраняется
3. Автоматическая синхронизация больше не запускается

### Сценарий 3: Участник без Telegram фото
1. Участник не установил фото профиля в Telegram
2. Отображаются инициалы на цветном фоне
3. Нет ошибок в консоли

### Сценарий 4: Участник изменил фото в Telegram
1. Можно вручную вызвать синхронизацию через API
2. Или удалить вручную загруженное фото, чтобы сработала автоматическая синхронизация

## Troubleshooting

### Фото не подгружается
1. Проверьте, что у участника есть `tg_user_id`
2. Проверьте права доступа бота к профилю пользователя
3. Проверьте логи в Vercel/Console
4. Убедитесь, что Storage bucket `participant-photos` существует

### Ошибка "Failed to upload photo to storage"
1. Проверьте настройки bucket `participant-photos`
2. Убедитесь, что RLS политики настроены корректно (из миграции 24)
3. Проверьте квоту Storage в Supabase

### Фото не обновляется после загрузки
1. Проверьте, что `photo_url` обновился в БД
2. Очистите кэш браузера
3. Проверьте, что публичный URL доступен

## Безопасность

1. **Авторизация**: Требуется авторизованный пользователь для синхронизации
2. **RLS Policies**: Используются существующие политики из миграции 24
3. **Валидация**: Проверяется существование участника и наличие `tg_user_id`
4. **Нет перезаписи**: Защита от случайной перезаписи вручную загруженных фото

## Будущие улучшения

1. **Автоматическая фоновая синхронизация**
   - Периодическая задача для обновления фото всех участников
   - Использовать Supabase Edge Functions или внешний cron

2. **Batch API**
   - Endpoint для синхронизации фото нескольких участников одним запросом
   - Снижение нагрузки на Telegram API

3. **Кэширование метаданных**
   - Сохранять информацию о последней попытке синхронизации
   - Не пытаться повторно, если фото нет в Telegram

4. **UI для принудительной синхронизации**
   - Кнопка "Обновить фото из Telegram" в профиле участника
   - Массовая синхронизация в настройках

5. **Fallback на bot avatar**
   - Если нет фото профиля, можно использовать дефолтные аватары Telegram

