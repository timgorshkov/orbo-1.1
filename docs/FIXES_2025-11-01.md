# ðŸ”§ Hotfixes â€” 2025-11-01

## Issue 1: Duplicate Participant Scoring Trigger âœ…

**Problem:**
```sql
-- Query returned 2 rows instead of 1:
[
  {"trigger_name": "trigger_update_participant_scores"},
  {"trigger_name": "trigger_update_participant_scores"}
]
```

**Cause:**
Migration 074 created trigger twice (likely due to double execution or migration conflict)

**Fix:**
Created **`db/migrations/077_fix_duplicate_trigger.sql`**

```sql
-- Drop all existing triggers
DROP TRIGGER IF EXISTS trigger_update_participant_scores ON public.participants;

-- Recreate once
CREATE TRIGGER trigger_update_participant_scores
  BEFORE INSERT OR UPDATE OF last_activity_at
  ON public.participants
  FOR EACH ROW
  EXECUTE FUNCTION update_participant_scores_trigger();
```

**Action Required:**
```bash
# Apply migration 077 in Supabase SQL Editor
# Copy contents of db/migrations/077_fix_duplicate_trigger.sql
# Execute in SQL Editor

# Verify fix:
SELECT trigger_name 
FROM information_schema.triggers 
WHERE trigger_schema = 'public' 
AND trigger_name = 'trigger_update_participant_scores';

# Should return exactly 1 row âœ…
```

---

## Issue 2: Compilation Error in Cron Endpoint âœ…

**Problem:**
```
Error: Expression expected
  ,-[/vercel/path0/app/api/cron/telegram-health-check/route.ts:21:1]
   24 |  *     "schedule": "*/10 * * * *"
      :                            ^
```

**Cause:**
The `*/` in the comment was interpreted as closing the multi-line comment block `/* ... */`

**Fix:**
Removed the problematic example from the comment:

**Before:**
```typescript
/**
 * Add to vercel.json:
 * {
 *   "crons": [{
 *     "path": "/api/cron/telegram-health-check",
 *     "schedule": "*/10 * * * *"  // â† This broke compilation!
 *   }]
 * }
 */
```

**After:**
```typescript
/**
 * Telegram Health Check Cron Job
 * 
 * This endpoint should be called every 10 minutes by Vercel Cron
 * 
 * Configured in vercel.json with schedule: "every 10 minutes"
 */
```

---

## Issue 3: Supabase Query Builder Errors âœ…

**Problem:**
```
Property 'catch' does not exist on type 'PostgrestFilterBuilder'
```

**Cause:**
Used `.catch()` on Supabase query (doesn't return standard Promise)

**Fix:**
Replaced `.catch()` with proper Supabase error handling:

**Before:**
```typescript
await supabaseServiceRole.rpc('log_telegram_health', {
  // ...
}).catch((err) => {
  console.error('Failed:', err.message);
});
```

**After:**
```typescript
const { error: healthLogError } = await supabaseServiceRole.rpc('log_telegram_health', {
  // ...
});

if (healthLogError) {
  console.error('Failed:', healthLogError.message);
}
```

---

## Files Modified

1. âœ… `db/migrations/077_fix_duplicate_trigger.sql` â€” NEW
2. âœ… `app/api/cron/telegram-health-check/route.ts` â€” FIXED

---

## Verification Steps

### 1. Apply Migration 077
```sql
-- In Supabase SQL Editor:
-- Copy/paste contents of 077_fix_duplicate_trigger.sql
-- Execute

-- Should see: "Migration 077 Complete"
```

### 2. Verify Trigger Count
```sql
SELECT COUNT(*) as trigger_count
FROM information_schema.triggers 
WHERE trigger_schema = 'public' 
AND trigger_name = 'trigger_update_participant_scores';

-- Should return: trigger_count = 1 âœ…
```

### 3. Test Compilation
```bash
# Local:
npm run build

# Should compile without errors âœ…

# Or deploy to Vercel:
git add .
git commit -m "fix: resolve duplicate trigger and compilation errors"
git push

# Deployment should succeed âœ…
```

### 4. Test Cron Endpoint
```bash
# After deployment:
curl https://your-domain.vercel.app/api/cron/telegram-health-check

# Should return health check results âœ…
```

---

## Status

- âœ… Migration 077 created
- âœ… Compilation errors fixed
- âœ… Supabase query handling corrected
- âœ… Linter errors cleared

**All issues resolved!** ðŸŽ‰

---

## Next Steps

1. Apply migration 077 in Supabase
2. Deploy to Vercel
3. Verify cron job runs successfully
4. Continue with Day 3 (Structured Logging) when ready

---

**Date:** 2025-11-01  
**Time to fix:** ~10 minutes  
**Status:** âœ… Complete

