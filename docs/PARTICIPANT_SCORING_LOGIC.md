# –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Å–∫–æ—Ä–∏–Ω–≥ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ (Migration 074)  
**–î–∞—Ç–∞:** 1 –Ω–æ—è–±—Ä—è 2025

---

## üìä –û–±–∑–æ—Ä

–°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç –¥–≤–∞ —Å–∫–æ—Ä–∞ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —É—á–∞—Å—Ç–Ω–∏–∫–∞:
- **`activity_score`** (0-999) ‚Äî —É—Ä–æ–≤–µ–Ω—å –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
- **`risk_score`** (0-100) ‚Äî —Ä–∏—Å–∫ –æ—Ç—Ç–æ–∫–∞

–°–∫–æ—Ä—ã –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è **–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏** —á–µ—Ä–µ–∑ SQL —Ç—Ä–∏–≥–≥–µ—Ä –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ `last_activity_at`.

---

## üéØ Activity Score (0-999)

### –ß—Ç–æ –∏–∑–º–µ—Ä—è–µ—Ç
–û–±—â–∏–π —É—Ä–æ–≤–µ–Ω—å –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ —É—á–∞—Å—Ç–Ω–∏–∫–∞ —Å —É—á–µ—Ç–æ–º:
- –ö–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Å–æ–æ–±—â–µ–Ω–∏–π
- –ö–æ–ª–∏—á–µ—Å—Ç–≤–∞ –æ—Ç–≤–µ—Ç–æ–≤ (replies)
- –î–∞–≤–Ω–æ—Å—Ç–∏ –ø–æ—Å–ª–µ–¥–Ω–µ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
- –°—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏ —É—á–∞—Å—Ç–∏—è

### –õ–æ–≥–∏–∫–∞ —Ä–∞—Å—á–µ—Ç–∞

#### 1. –ë–∞–∑–æ–≤—ã–π —Å–∫–æ—Ä (—Å–æ–æ–±—â–µ–Ω–∏—è)
```
–ë–∞–∑–æ–≤—ã–π = (–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ_—Å–æ–æ–±—â–µ–Ω–∏–π √ó 5) + (–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ_–æ—Ç–≤–µ—Ç–æ–≤ √ó 3)
```
- –û–±—ã—á–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ: **5 –±–∞–ª–ª–æ–≤**
- –û—Ç–≤–µ—Ç (reply): **+3 –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –±–∞–ª–ª–∞** (–≤—Å–µ–≥–æ 8)
- –£—á–∏—Ç—ã–≤–∞—é—Ç—Å—è —Å–æ–æ–±—â–µ–Ω–∏—è –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ **30 –¥–Ω–µ–π**

#### 2. –ë–æ–Ω—É—Å –∑–∞ –¥–∞–≤–Ω–æ—Å—Ç—å –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
| –ü–æ—Å–ª–µ–¥–Ω—è—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å | –ú–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä |
|----------------------|-------------|
| –°–µ–≥–æ–¥–Ω—è/–≤—á–µ—Ä–∞ (‚â§1 –¥–µ–Ω—å) | **+20** –±–∞–ª–ª–æ–≤ |
| –ù–∞ —ç—Ç–æ–π –Ω–µ–¥–µ–ª–µ (‚â§7 –¥–Ω–µ–π) | **+10** –±–∞–ª–ª–æ–≤ |
| 8-14 –¥–Ω–µ–π –Ω–∞–∑–∞–¥ | 0 (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) |
| 15-30 –¥–Ω–µ–π –Ω–∞–∑–∞–¥ | **-20** –±–∞–ª–ª–æ–≤ |
| 30+ –¥–Ω–µ–π –Ω–∞–∑–∞–¥ | **-50** –±–∞–ª–ª–æ–≤ (–º–∏–Ω–∏–º—É–º 0) |
| –ù–∏–∫–æ–≥–¥–∞ –Ω–µ –±—ã–ª –∞–∫—Ç–∏–≤–µ–Ω | **0** –±–∞–ª–ª–æ–≤ |

#### 3. –ë–æ–Ω—É—Å –∑–∞ —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å
```
–ë–æ–Ω—É—Å —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏ = min(30, (—Å–æ–æ–±—â–µ–Ω–∏–π_–∑–∞_30_–¥–Ω–µ–π √ó 30) / –¥–Ω–µ–π_—Å_–ø—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è)
```
–ù–∞–≥—Ä–∞–∂–¥–∞–µ—Ç —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ —Å –ø–æ—Å—Ç–æ—è–Ω–Ω–æ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å—é (–º–∞–∫—Å–∏–º—É–º +30 –±–∞–ª–ª–æ–≤).

#### 4. –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è
–ò—Ç–æ–≥–æ–≤—ã–π —Å–∫–æ—Ä –æ–≥—Ä–∞–Ω–∏—á–µ–Ω –¥–∏–∞–ø–∞–∑–æ–Ω–æ–º **0-999**.

### –ò–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏—è

| Activity Score | –£—Ä–æ–≤–µ–Ω—å | –û–ø–∏—Å–∞–Ω–∏–µ |
|----------------|---------|----------|
| 0-10 | üî¥ –ù–µ–∞–∫—Ç–∏–≤–µ–Ω | –ù–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –∏–ª–∏ —Ç–æ–ª—å–∫–æ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª—Å—è |
| 11-50 | üü° –ù–∏–∑–∫–∞—è | –†–µ–¥–∫–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è |
| 51-100 | üü¢ –°—Ä–µ–¥–Ω—è—è | –†–µ–≥—É–ª—è—Ä–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è |
| 101-200 | üü¢ –í—ã—Å–æ–∫–∞—è | –ê–∫—Ç–∏–≤–Ω—ã–π —É—á–∞—Å—Ç–Ω–∏–∫ |
| 200+ | ‚≠ê –û—á–µ–Ω—å –≤—ã—Å–æ–∫–∞—è | –°—É–ø–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π —É—á–∞—Å—Ç–Ω–∏–∫ |

---

## ‚ö†Ô∏è Risk Score (0-100)

### –ß—Ç–æ –∏–∑–º–µ—Ä—è–µ—Ç
–†–∏—Å–∫ –æ—Ç—Ç–æ–∫–∞ (churn) —É—á–∞—Å—Ç–Ω–∏–∫–∞. –ß–µ–º –≤—ã—à–µ, —Ç–µ–º –±–æ–ª—å—à–µ –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å, —á—Ç–æ —É—á–∞—Å—Ç–Ω–∏–∫ –ø–æ–∫–∏–Ω–µ—Ç —Å–æ–æ–±—â–µ—Å—Ç–≤–æ.

### –õ–æ–≥–∏–∫–∞ —Ä–∞—Å—á–µ—Ç–∞

–û—Å–Ω–æ–≤–Ω–æ–π —Ñ–∞–∫—Ç–æ—Ä ‚Äî **–¥–∞–≤–Ω–æ—Å—Ç—å –ø–æ—Å–ª–µ–¥–Ω–µ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ + –∏—Å—Ç–æ—Ä–∏—è —É—á–∞—Å—Ç–∏—è**.

#### –¢–∞–±–ª–∏—Ü–∞ —Ä–∏—Å–∫–æ–≤

| –°—Ü–µ–Ω–∞—Ä–∏–π | Risk Score | –û–ø–∏—Å–∞–Ω–∏–µ |
|----------|------------|----------|
| **–ê–∫—Ç–∏–≤–µ–Ω 0-3 –¥–Ω—è –Ω–∞–∑–∞–¥** | 5-15 | üü¢ –û—á–µ–Ω—å –Ω–∏–∑–∫–∏–π —Ä–∏—Å–∫ |
| **–ê–∫—Ç–∏–≤–µ–Ω 4-7 –¥–Ω–µ–π –Ω–∞–∑–∞–¥** | 25 | üü¢ –ù–∏–∑–∫–∏–π —Ä–∏—Å–∫ |
| **–ê–∫—Ç–∏–≤–µ–Ω 8-14 –¥–Ω–µ–π –Ω–∞–∑–∞–¥** | 40 | üü° –°—Ä–µ–¥–Ω–∏–π —Ä–∏—Å–∫ |
| **–ê–∫—Ç–∏–≤–µ–Ω 15-30 –¥–Ω–µ–π –Ω–∞–∑–∞–¥** | 50 | üü° –°—Ä–µ–¥–Ω–∏–π —Ä–∏—Å–∫ |
| **–ú–æ–ª—á–∏—Ç 30+ –¥–Ω–µ–π** (–±–µ–∑ –∏—Å—Ç–æ—Ä–∏–∏) | 50 | üü° –°—Ä–µ–¥–Ω–∏–π —Ä–∏—Å–∫ |
| **–ú–æ–ª—á–∏—Ç 14+ –¥–Ω–µ–π** (3+ —Å–æ–æ–±—â–µ–Ω–∏—è) | 65 | üü† –°—Ä–µ–¥–Ω–µ-–≤—ã—Å–æ–∫–∏–π —Ä–∏—Å–∫ |
| **–ú–æ–ª—á–∏—Ç 21+ –¥–Ω–µ–π** (5+ —Å–æ–æ–±—â–µ–Ω–∏–π) | 80 | üî¥ –í—ã—Å–æ–∫–∏–π —Ä–∏—Å–∫ |
| **–ú–æ–ª—á–∏—Ç 30+ –¥–Ω–µ–π** (10+ —Å–æ–æ–±—â–µ–Ω–∏–π) | **90-100** | üî¥ **–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π —Ä–∏—Å–∫ –æ—Ç—Ç–æ–∫–∞** |
| **–ù–∏–∫–æ–≥–¥–∞ –Ω–µ –±—ã–ª –∞–∫—Ç–∏–≤–µ–Ω** (7+ –¥–Ω–µ–π) | 60 | üü† –í—ã—Å–æ–∫–∏–π —Ä–∏—Å–∫ - –Ω–µ –≤–æ–≤–ª–µ—á–µ–Ω |
| **–ù–∏–∫–æ–≥–¥–∞ –Ω–µ –±—ã–ª –∞–∫—Ç–∏–≤–µ–Ω** (<7 –¥–Ω–µ–π) | 30 | üü° –°—Ä–µ–¥–Ω–∏–π - –¥–∞—Ç—å –≤—Ä–µ–º—è |

#### –ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ activity_score

–í—ã—Å–æ–∫–∞—è –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å **—Å–Ω–∏–∂–∞–µ—Ç** —Ä–∏—Å–∫:
- `activity_score > 100` ‚Üí **-20** –∫ —Ä–∏—Å–∫—É
- `activity_score > 50` ‚Üí **-10** –∫ —Ä–∏—Å–∫—É
- –ú–∏–Ω–∏–º—É–º: **5** (—É—á–∞—Å—Ç–Ω–∏–∫–∏ —Å –æ—á–µ–Ω—å –≤—ã—Å–æ–∫–∏–º —Å–∫–æ—Ä–æ–º –Ω–µ –º–æ–≥—É—Ç –∏–º–µ—Ç—å —Ä–∏—Å–∫ < 5)

### –ò–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏—è

| Risk Score | –£—Ä–æ–≤–µ–Ω—å | –î–µ–π—Å—Ç–≤–∏–µ |
|------------|---------|----------|
| 0-25 | üü¢ –ù–∏–∑–∫–∏–π | –í—Å–µ —Ö–æ—Ä–æ—à–æ |
| 26-50 | üü° –°—Ä–µ–¥–Ω–∏–π | –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ |
| 51-70 | üü† –í—ã—Å–æ–∫–∏–π | ‚ö†Ô∏è –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –≤–æ–≤–ª–µ—á–µ–Ω–∏–µ |
| 71-100 | üî¥ –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π | ‚ö†Ô∏è‚ö†Ô∏è **–¢—Ä–µ–±—É–µ—Ç—Å—è —Å—Ä–æ—á–Ω–æ–µ –≤–Ω–∏–º–∞–Ω–∏–µ** |

---

## üîÑ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ

### –¢—Ä–∏–≥–≥–µ—Ä

–°–∫–æ—Ä—ã –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞—é—Ç—Å—è **–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏** –ø—Ä–∏:
- –í—Å—Ç–∞–≤–∫–µ –Ω–æ–≤–æ–≥–æ —É—á–∞—Å—Ç–Ω–∏–∫–∞ (`INSERT`)
- –û–±–Ω–æ–≤–ª–µ–Ω–∏–∏ `last_activity_at` (`UPDATE`)

```sql
CREATE TRIGGER trigger_update_participant_scores
  BEFORE INSERT OR UPDATE OF last_activity_at ON participants
  FOR EACH ROW
  EXECUTE FUNCTION update_participant_scores_trigger();
```

### –ö–æ–≥–¥–∞ –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è —Å–∫–æ—Ä—ã

1. **–ü—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –Ω–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è** ‚Üí `last_activity_at` –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è ‚Üí —Ç—Ä–∏–≥–≥–µ—Ä –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ—Ç —Å–∫–æ—Ä—ã
2. **–ü—Ä–∏ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–∏ –∫ –≥—Ä—É–ø–ø–µ** ‚Üí —Å–æ–∑–¥–∞–µ—Ç—Å—è participant ‚Üí —Ç—Ä–∏–≥–≥–µ—Ä —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç –Ω–∞—á–∞–ª—å–Ω—ã–µ —Å–∫–æ—Ä—ã
3. **–ü—Ä–∏ –∏–º–ø–æ—Ä—Ç–µ –∏—Å—Ç–æ—Ä–∏–∏** ‚Üí `last_activity_at` –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è ‚Üí —Ç—Ä–∏–≥–≥–µ—Ä –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ—Ç

### –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

- –¢—Ä–∏–≥–≥–µ—Ä —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç **—Ç–æ–ª—å–∫–æ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏** `last_activity_at`
- –†–∞—Å—á–µ—Ç –±—ã—Å—Ç—Ä—ã–π (2-3 SQL –∑–∞–ø—Ä–æ—Å–∞)
- –ù–µ –≤–ª–∏—è–µ—Ç –Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫—É —Å–æ–æ–±—â–µ–Ω–∏–π (–≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –≤ —Ç–æ–π –∂–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏)

---

## üéØ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤ UI

### Dashboard: –ó–æ–Ω—ã –≤–Ω–∏–º–∞–Ω–∏—è

**`components/dashboard/attention-zones.tsx`**

–ò—Å–ø–æ–ª—å–∑—É–µ—Ç —Å–∫–æ—Ä—ã –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤, —Ç—Ä–µ–±—É—é—â–∏—Ö –≤–Ω–∏–º–∞–Ω–∏—è:

#### 1. –£—á–∞—Å—Ç–Ω–∏–∫–∏ –Ω–∞ –≥—Ä–∞–Ω–∏ –æ—Ç—Ç–æ–∫–∞ (Churning)
```sql
-- –§—É–Ω–∫—Ü–∏—è: get_churning_participants()
WHERE activity_score > 10  -- –ë—ã–ª–∏ –∞–∫—Ç–∏–≤–Ω—ã —Ä–∞–Ω—å—à–µ
  AND last_activity_at < NOW() - INTERVAL '14 days'
ORDER BY activity_score DESC
```

**–ö—Ä–∏—Ç–µ—Ä–∏–∏:**
- `activity_score > 10` ‚Äî –±—ã–ª–∏ –∞–∫—Ç–∏–≤–Ω—ã –≤ –ø—Ä–æ—à–ª–æ–º
- –ú–æ–ª—á–∞—Ç 14+ –¥–Ω–µ–π
- –¢–æ–ø-10 –ø–æ –ø—Ä–µ–¥—ã–¥—É—â–µ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏

#### 2. –ù–µ–∞–∫—Ç–∏–≤–Ω—ã–µ –Ω–æ–≤–∏—á–∫–∏
```sql
-- –§—É–Ω–∫—Ü–∏—è: get_inactive_newcomers()
WHERE created_at > NOW() - INTERVAL '30 days'
  AND activity_count <= 2
ORDER BY created_at DESC
```

**–ö—Ä–∏—Ç–µ—Ä–∏–∏:**
- –ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª–∏—Å—å –º–µ–Ω–µ–µ 30 –¥–Ω–µ–π –Ω–∞–∑–∞–¥
- –ú–µ–Ω–µ–µ 2 —Å–æ–æ–±—â–µ–Ω–∏–π
- –ú–æ–ª—á–∞—Ç 14+ –¥–Ω–µ–π

### Analytics API

**`app/api/telegram/analytics/data/route.ts`**

–í–∫–ª—é—á–∞–µ—Ç `activity_score` –∏ `risk_score` –≤ –æ—Ç–≤–µ—Ç –¥–ª—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ –ø–æ —É—á–∞—Å—Ç–Ω–∏–∫–∞–º.

### Participants List

–£—á–∞—Å—Ç–Ω–∏–∫–∏ –º–æ–≥—É—Ç –±—ã—Ç—å –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã –ø–æ:
- `activity_score` ‚Äî —Å–∞–º—ã–µ –∞–∫—Ç–∏–≤–Ω—ã–µ —Å–≤–µ—Ä—Ö—É
- `risk_score` ‚Äî –≤ –≥—Ä—É–ø–ø–µ —Ä–∏—Å–∫–∞ —Å–≤–µ—Ä—Ö—É

---

## üìù –†—É—á–Ω–æ–π –ø–µ—Ä–µ—Å—á–µ—Ç

### –ü–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å –≤—Å–µ —Å–∫–æ—Ä—ã

```sql
UPDATE participants
SET 
  activity_score = calculate_activity_score(id),
  risk_score = calculate_risk_score(id)
WHERE tg_user_id IS NOT NULL;
```

### –ü–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å –¥–ª—è –æ–¥–Ω–æ–≥–æ —É—á–∞—Å—Ç–Ω–∏–∫–∞

```sql
UPDATE participants
SET 
  activity_score = calculate_activity_score(id),
  risk_score = calculate_risk_score(id)
WHERE id = 'participant-uuid';
```

### –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Å–∫–æ—Ä–æ–≤

```sql
-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ activity_score
SELECT 
  COUNT(*) FILTER (WHERE activity_score = 0) as inactive,
  COUNT(*) FILTER (WHERE activity_score BETWEEN 1 AND 50) as low,
  COUNT(*) FILTER (WHERE activity_score BETWEEN 51 AND 100) as medium,
  COUNT(*) FILTER (WHERE activity_score BETWEEN 101 AND 200) as high,
  COUNT(*) FILTER (WHERE activity_score > 200) as very_high,
  AVG(activity_score)::INTEGER as avg_score
FROM participants
WHERE tg_user_id IS NOT NULL;

-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ risk_score
SELECT 
  COUNT(*) FILTER (WHERE risk_score <= 25) as low_risk,
  COUNT(*) FILTER (WHERE risk_score BETWEEN 26 AND 50) as medium_risk,
  COUNT(*) FILTER (WHERE risk_score BETWEEN 51 AND 70) as high_risk,
  COUNT(*) FILTER (WHERE risk_score > 70) as critical_risk,
  AVG(risk_score)::INTEGER as avg_risk
FROM participants
WHERE tg_user_id IS NOT NULL;
```

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –¢–µ—Å—Ç 1: –ù–æ–≤—ã–π –∞–∫—Ç–∏–≤–Ω—ã–π —É—á–∞—Å—Ç–Ω–∏–∫

```sql
-- –°–æ–∑–¥–∞–µ–º —É—á–∞—Å—Ç–Ω–∏–∫–∞ —Å –Ω–µ–¥–∞–≤–Ω–µ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å—é
INSERT INTO participants (org_id, tg_user_id, full_name, last_activity_at, created_at)
VALUES ('org-uuid', 99999, 'Test Active User', NOW() - INTERVAL '1 day', NOW() - INTERVAL '7 days')
RETURNING id, activity_score, risk_score;

-- –û–∂–∏–¥–∞–µ–º: activity_score > 0, risk_score < 20
```

### –¢–µ—Å—Ç 2: –£—á–∞—Å—Ç–Ω–∏–∫ –≤ –∑–æ–Ω–µ —Ä–∏—Å–∫–∞

```sql
-- –°–æ–∑–¥–∞–µ–º —É—á–∞—Å—Ç–Ω–∏–∫–∞, –º–æ–ª—á–∞—â–µ–≥–æ 30 –¥–Ω–µ–π (–Ω–æ –±—ã–ª –∞–∫—Ç–∏–≤–µ–Ω)
INSERT INTO participants (org_id, tg_user_id, full_name, last_activity_at, created_at)
VALUES ('org-uuid', 88888, 'Test Churning User', NOW() - INTERVAL '30 days', NOW() - INTERVAL '60 days')
RETURNING id, activity_score, risk_score;

-- –î–æ–±–∞–≤–ª—è–µ–º –∏—Å—Ç–æ—Ä–∏—é –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
INSERT INTO activity_events (org_id, tg_user_id, tg_chat_id, event_type, created_at)
SELECT 'org-uuid', 88888, -123456, 'message', NOW() - INTERVAL '35 days' + (i || ' days')::INTERVAL
FROM generate_series(1, 15) i;

-- –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º
UPDATE participants 
SET last_activity_at = last_activity_at 
WHERE tg_user_id = 88888
RETURNING activity_score, risk_score;

-- –û–∂–∏–¥–∞–µ–º: activity_score > 50 (–±—ã–ª –∞–∫—Ç–∏–≤–µ–Ω), risk_score > 80 (–≤—ã—Å–æ–∫–∏–π —Ä–∏—Å–∫)
```

### –¢–µ—Å—Ç 3: –¢—Ä–∏–≥–≥–µ—Ä —Ä–∞–±–æ—Ç–∞–µ—Ç

```sql
-- –û–±–Ω–æ–≤–ª—è–µ–º last_activity_at –∏ –ø—Ä–æ–≤–µ—Ä—è–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–µ—Ä–µ—Å—á–µ—Ç
UPDATE participants
SET last_activity_at = NOW()
WHERE tg_user_id = 99999
RETURNING activity_score, risk_score;

-- –û–∂–∏–¥–∞–µ–º: activity_score —É–≤–µ–ª–∏—á–∏–ª—Å—è (–±–æ–Ω—É—Å –∑–∞ —Å–≤–µ–∂–µ—Å—Ç—å), risk_score —É–º–µ–Ω—å—à–∏–ª—Å—è
```

---

## üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∏ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è

### –ò–∑–º–µ–Ω–∏—Ç—å –≤–µ—Å–∞

–ï—Å–ª–∏ –Ω—É–∂–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å –ª–æ–≥–∏–∫—É —Ä–∞—Å—á–µ—Ç–∞:

1. –û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ —Ñ—É–Ω–∫—Ü–∏–∏ `calculate_activity_score()` –∏ `calculate_risk_score()`
2. –ü—Ä–∏–º–µ–Ω–∏—Ç–µ —á–µ—Ä–µ–∑ –Ω–æ–≤—É—é –º–∏–≥—Ä–∞—Ü–∏—é:
   ```sql
   CREATE OR REPLACE FUNCTION calculate_activity_score(p_participant_id UUID)
   RETURNS INTEGER AS $$
   -- –ù–æ–≤–∞—è –ª–æ–≥–∏–∫–∞
   END;
   $$ LANGUAGE plpgsql;
   ```
3. –ü–µ—Ä–µ—Å—á–∏—Ç–∞–π—Ç–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Å–∫–æ—Ä—ã

### –î–æ–±–∞–≤–∏—Ç—å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ñ–∞–∫—Ç–æ—Ä—ã

–í–æ–∑–º–æ–∂–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è:
- –£—á–µ—Ç —Ä–µ–∞–∫—Ü–∏–π (–µ—Å–ª–∏ —Ç–∞–±–ª–∏—Ü–∞ –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–∞)
- –£—á–µ—Ç —É—á–∞—Å—Ç–∏—è –≤ —Å–æ–±—ã—Ç–∏—è—Ö (—Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏)
- –£—á–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ –º–∞—Ç–µ—Ä–∏–∞–ª–∞–º
- –í—Ä–µ–º—è —Å—É—Ç–æ–∫ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ (—É—Ç—Ä–æ/–≤–µ—á–µ—Ä)
- –î–ª–∏–Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–π (chars_count)

---

## üìö –°–≤—è–∑–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

**–ú–∏–≥—Ä–∞—Ü–∏–∏:**
- `db/migrations/09_participant_scores.sql` ‚Äî –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫–æ–ª–æ–Ω–æ–∫
- `db/migrations/074_implement_participant_scoring.sql` ‚Äî —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –ª–æ–≥–∏–∫–∏

**UI –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã:**
- `components/dashboard/attention-zones.tsx` ‚Äî –∑–æ–Ω—ã –≤–Ω–∏–º–∞–Ω–∏—è
- `app/app/[org]/members/page.tsx` ‚Äî —Å–ø–∏—Å–æ–∫ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤

**API:**
- `app/api/telegram/analytics/data/route.ts` ‚Äî –∞–Ω–∞–ª–∏—Ç–∏–∫–∞

**SQL —Ñ—É–Ω–∫—Ü–∏–∏:**
- `calculate_activity_score(UUID)` ‚Äî —Ä–∞—Å—á–µ—Ç activity_score
- `calculate_risk_score(UUID)` ‚Äî —Ä–∞—Å—á–µ—Ç risk_score
- `update_participant_scores_trigger()` ‚Äî —Ç—Ä–∏–≥–≥–µ—Ä
- `get_churning_participants(UUID, INTEGER)` ‚Äî —É—á–∞—Å—Ç–Ω–∏–∫–∏ –Ω–∞ –≥—Ä–∞–Ω–∏ –æ—Ç—Ç–æ–∫–∞
- `get_inactive_newcomers(UUID, INTEGER)` ‚Äî –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã–µ –Ω–æ–≤–∏—á–∫–∏

---

## üéâ –†–µ–∑—É–ª—å—Ç–∞—Ç—ã

–ü–æ—Å–ª–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –º–∏–≥—Ä–∞—Ü–∏–∏ 074:

‚úÖ Dashboard "–ó–æ–Ω—ã –≤–Ω–∏–º–∞–Ω–∏—è" –Ω–∞—á–∏–Ω–∞–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å  
‚úÖ –£—á–∞—Å—Ç–Ω–∏–∫–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–ª—É—á–∞—é—Ç —Å–∫–æ—Ä—ã –ø—Ä–∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏  
‚úÖ –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ä–µ–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ  
‚úÖ –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏/—Ä–∏—Å–∫—É —Ä–∞–±–æ—Ç–∞–µ—Ç  
‚úÖ –ù–µ—Ç —Ä—É—á–Ω–æ–≥–æ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è (–ø–æ–ª–Ω–æ—Å—Ç—å—é –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)

---

**–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ:** 1 –Ω–æ—è–±—Ä—è 2025  
**–ú–∏–≥—Ä–∞—Ü–∏—è:** 074  
**–°—Ç–∞—Ç—É—Å:** –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ –∏ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–æ

