# üî¥ –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê: –£—Ç–µ—á–∫–∞ bio –∏ custom_attributes –º–µ–∂–¥—É –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è–º–∏

## üéØ –ü—Ä–æ–±–ª–µ–º–∞

–ü—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ Telegram-–≥—Ä—É–ø–ø—ã –≤ –Ω–æ–≤—É—é –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—é —Å–∏—Å—Ç–µ–º–∞ **–∫–æ–ø–∏—Ä–æ–≤–∞–ª–∞** `bio` (–∫—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ) –∏ `custom_attributes` (–¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è) –∏–∑ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –¥—Ä—É–≥–æ–π –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏.

### –ü–æ—á–µ–º—É —ç—Ç–æ –∫—Ä–∏—Ç–∏—á–Ω–æ?
- ‚ùå **–ù–∞—Ä—É—à–µ–Ω–∏–µ –∏–∑–æ–ª—è—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö** –º–µ–∂–¥—É –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è–º–∏
- ‚ùå **–£—Ç–µ—á–∫–∞ –ø—Ä–∏–≤–∞—Ç–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏** (bio –∏ –ø–æ–ª—è –º–æ–≥—É—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ)
- ‚ùå **–ü—É—Ç–∞–Ω–∏—Ü–∞ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π** (–≤–∏–¥—è—Ç —á—É–∂–∏–µ –æ–ø–∏—Å–∞–Ω–∏—è)

---

## üîç –ì–¥–µ –±—ã–ª–∞ –ø—Ä–æ–±–ª–µ–º–∞

### 1. **API endpoint** - `app/api/telegram/groups/add-to-org/route.ts`

**–ë—ã–ª–æ (—Å—Ç—Ä–æ–∫–∏ 110-111):**
```typescript
custom_attributes: participant.custom_attributes || {},
bio: participant.bio
```

–ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ participant –≤ –Ω–æ–≤–æ–π –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ –∫–æ–ø–∏—Ä–æ–≤–∞–ª–∏—Å—å –¥–∞–Ω–Ω—ã–µ –∏–∑ –∏—Å—Ö–æ–¥–Ω–æ–π –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏.

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ:**
```typescript
// ‚úÖ –ù–ï –∫–æ–ø–∏—Ä—É–µ–º bio –∏ custom_attributes –∏–∑ –¥—Ä—É–≥–æ–π –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏
custom_attributes: {},
bio: null
```

---

### 2. **–ú–∏–≥—Ä–∞—Ü–∏—è** - `db/migrations/35_sync_participants_for_existing_groups.sql`

–û–¥–Ω–æ—Ä–∞–∑–æ–≤–∞—è –º–∏–≥—Ä–∞—Ü–∏—è (—É–∂–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞) —Ç–æ–∂–µ –∫–æ–ø–∏—Ä–æ–≤–∞–ª–∞ –¥–∞–Ω–Ω—ã–µ:

```sql
COALESCE(v_participant.custom_attributes, '{}'::jsonb),
v_participant.bio
```

–≠—Ç–∞ –º–∏–≥—Ä–∞—Ü–∏—è —É–∂–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞ –∏ –Ω–µ –±—É–¥–µ—Ç –∑–∞–ø—É—Å–∫–∞—Ç—å—Å—è —Å–Ω–æ–≤–∞, –Ω–æ –æ–Ω–∞ –º–æ–≥–ª–∞ —Å–æ–∑–¥–∞—Ç—å "–≥—Ä—è–∑–Ω—ã–µ" –¥–∞–Ω–Ω—ã–µ.

---

## ‚úÖ –†–µ—à–µ–Ω–∏–µ

### 1. **–ò—Å–ø—Ä–∞–≤–ª–µ–Ω –∫–æ–¥** (—É–∂–µ —Å–¥–µ–ª–∞–Ω–æ)
- `app/api/telegram/groups/add-to-org/route.ts` - –Ω–µ –∫–æ–ø–∏—Ä—É–µ—Ç –¥–∞–Ω–Ω—ã–µ

### 2. **–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞** 
–°–∫—Ä–∏–ø—Ç `db/diagnose_bio_leakage.sql` –ø—Ä–æ–≤–µ—Ä—è–µ—Ç:
- –°–∫–æ–ª—å–∫–æ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ —Å—É—â–µ—Å—Ç–≤—É—é—Ç –≤ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è—Ö
- –°–∫–æ–ª—å–∫–æ –∏–∑ –Ω–∏—Ö –∏–º–µ—é—Ç –æ–¥–∏–Ω–∞–∫–æ–≤—ã–µ bio/custom_attributes
- –ú–∞—Å—à—Ç–∞–± –ø—Ä–æ–±–ª–µ–º—ã

### 3. **–ú–∏–≥—Ä–∞—Ü–∏—è –¥–ª—è –æ—á–∏—Å—Ç–∫–∏**
–ú–∏–≥—Ä–∞—Ü–∏—è `db/migrations/066_fix_bio_custom_attributes_leakage.sql`:

**–õ–æ–≥–∏–∫–∞:**
1. –ù–∞—Ö–æ–¥–∏—Ç –≤—Å–µ—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ (`tg_user_id`), –∫–æ—Ç–æ—Ä—ã–µ —Å—É—â–µ—Å—Ç–≤—É—é—Ç –≤ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è—Ö
2. –î–ª—è –∫–∞–∂–¥–æ–≥–æ –Ω–∞—Ö–æ–¥–∏—Ç **—Å–∞–º—É—é —Å—Ç–∞—Ä—É—é** –∑–∞–ø–∏—Å—å (–ø–æ `created_at`)
3. –û—á–∏—â–∞–µ—Ç `bio` –∏ `custom_attributes` –≤ –±–æ–ª–µ–µ –ø–æ–∑–¥–Ω–∏—Ö –∑–∞–ø–∏—Å—è—Ö, **—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –æ–Ω–∏ –∏–¥–µ–Ω—Ç–∏—á–Ω—ã** (—Ç.–µ. –±—ã–ª–∏ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω—ã, –∞ –Ω–µ –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω—ã)

**–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:**
- ‚úÖ –ù–ï —Ç—Ä–æ–≥–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ, –∫–æ—Ç–æ—Ä—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–ª (–ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –∏–¥–µ–Ω—Ç–∏—á–Ω–æ—Å—Ç—å)
- ‚úÖ –û—Å—Ç–∞–≤–ª—è–µ—Ç –¥–∞–Ω–Ω—ã–µ –≤ —Å–∞–º–æ–π —Å—Ç–∞—Ä–æ–π –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ (–≥–¥–µ –æ–Ω–∏ –±—ã–ª–∏ —Å–æ–∑–¥–∞–Ω—ã)
- ‚úÖ –û—á–∏—â–∞–µ—Ç —Ç–æ–ª—å–∫–æ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ (—Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ) –¥–∞–Ω–Ω—ã–µ

---

## üß™ –ü—Ä–æ–≤–µ—Ä–∫–∞

### –®–∞–≥ 1: –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞
```sql
psql -f db/diagnose_bio_leakage.sql
```

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
- –°–ø–∏—Å–æ–∫ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –≤ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è—Ö
- –£—á–∞—Å—Ç–Ω–∏–∫–∏ —Å –æ–¥–∏–Ω–∞–∫–æ–≤—ã–º–∏ bio
- –£—á–∞—Å—Ç–Ω–∏–∫–∏ —Å –æ–¥–∏–Ω–∞–∫–æ–≤—ã–º–∏ custom_attributes
- –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞

---

### –®–∞–≥ 2: –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é
```sql
psql -f db/migrations/066_fix_bio_custom_attributes_leakage.sql
```

**–û–∂–∏–¥–∞–µ–º—ã–π –≤—ã–≤–æ–¥:**
```
üîç Starting bio/custom_attributes leakage cleanup...
  Processing tg_user_id 154588486 (in 2 orgs)
    Oldest record: org_id=xxx, created_at=...
    ‚úÖ Cleaned 1 duplicate records for tg_user_id 154588486
‚úÖ Cleanup completed!

üìä Final statistics:
  Participants with bio: ...
  Participants with custom_attributes: ...
  Participants in multiple orgs: ...
```

---

### –®–∞–≥ 3: –ü–æ–≤—Ç–æ—Ä–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞
```sql
psql -f db/diagnose_bio_leakage.sql
```

**–û–∂–∏–¥–∞–µ—Ç—Å—è:**
- –£—á–∞—Å—Ç–Ω–∏–∫–∏ —Å –æ–¥–∏–Ω–∞–∫–æ–≤—ã–º–∏ bio/custom_attributes = **0** ‚úÖ

---

## üìä –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –ª–æ–≥–∏–∫–∞ (–ø–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è)

| –°–æ–±—ã—Ç–∏–µ | –£—á–∞—Å—Ç–Ω–∏–∫ —É–∂–µ –≤ org1 | bio/custom_attributes –≤ org2 |
|---------|---------------------|------------------------------|
| –ì—Ä—É–ø–ø–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞ –≤ org2 | –î–∞ | ‚úÖ **–ü—É—Å—Ç—ã–µ** (NULL / {}) |
| –ù–æ–≤—ã–π —É—á–∞—Å—Ç–Ω–∏–∫ –≤ org2 | –ù–µ—Ç | ‚úÖ **–ü—É—Å—Ç—ã–µ** (NULL / {}) |
| –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ—Ç –≤ org2 | - | ‚úÖ **–°–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –≤ org2** |

**–ò–∑–æ–ª—è—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∞!** üîí

---

## üéØ –†–µ–∑—É–ª—å—Ç–∞—Ç

‚úÖ **–ö–æ–¥ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω** - –Ω–æ–≤—ã–µ –≥—Ä—É–ø–ø—ã –Ω–µ –±—É–¥—É—Ç –∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ  
‚úÖ **–ú–∏–≥—Ä–∞—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∞** - –æ—á–∏—Å—Ç–∏—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –¥—É–±–ª–∏–∫–∞—Ç—ã  
‚úÖ **–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –≥–æ—Ç–æ–≤–∞** - –º–æ–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–æ –∏ –ø–æ—Å–ª–µ  
‚úÖ **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å** - –Ω–µ —Ç—Ä–æ–≥–∞–µ—Ç –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ  

---

## üìÅ –ò–∑–º–µ–Ω–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

1. ‚úÖ `app/api/telegram/groups/add-to-org/route.ts` - –∏—Å–ø—Ä–∞–≤–ª–µ–Ω –∫–æ–¥
2. üìä `db/diagnose_bio_leakage.sql` - –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞
3. üîß `db/migrations/066_fix_bio_custom_attributes_leakage.sql` - –º–∏–≥—Ä–∞—Ü–∏—è

---

## üö® –í–∞–∂–Ω–æ

**–ü–µ—Ä–µ–¥ –¥–µ–ø–ª–æ–µ–º:**
1. –ó–∞–ø—É—Å—Ç–∏—Ç–µ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É `db/diagnose_bio_leakage.sql`
2. –ü—Ä–∏–º–µ–Ω–∏—Ç–µ –º–∏–≥—Ä–∞—Ü–∏—é `066_fix_bio_custom_attributes_leakage.sql`
3. –ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
4. –î–µ–ø–ª–æ–π—Ç–µ –∫–æ–¥

**–ü–æ—Å–ª–µ –¥–µ–ø–ª–æ—è:**
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –Ω–æ–≤—ã–µ —É—á–∞—Å—Ç–Ω–∏–∫–∏ –¥–æ–±–∞–≤–ª—è—é—Ç—Å—è —Å –ø—É—Å—Ç—ã–º–∏ bio/custom_attributes
- –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –≤ –∫–∞–∂–¥–æ–π –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏

---

**–ò–°–ü–†–ê–í–õ–ï–ù–û!** üéâ

