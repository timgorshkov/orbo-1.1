# Настройки организации - Руководство по установке

## Что реализовано

### 1. База данных
- ✅ Добавлено поле `logo_url` в таблицу `organizations`
- ✅ Добавлены поля `role_source` и `metadata` в таблицу `memberships` для отслеживания источника прав админов
- ✅ Создано представление `organization_admins` для удобного управления командой
- ✅ Реализована функция `sync_telegram_admins()` для автоматической синхронизации прав админов

### 2. API
- ✅ `GET/PUT /api/organizations/[id]` - получение и обновление организации
- ✅ `POST /api/organizations/[id]/logo` - загрузка логотипа
- ✅ `DELETE /api/organizations/[id]/logo` - удаление логотипа
- ✅ `GET /api/organizations/[id]/team` - получение списка команды
- ✅ `POST /api/organizations/[id]/team/sync` - ручная синхронизация админов

### 3. UI компоненты
- ✅ Страница настроек `/app/[org]/settings`
- ✅ Форма редактирования организации с загрузкой логотипа
- ✅ Список команды с владельцем и администраторами
- ✅ Пункт "Настройки" в левом меню (внизу)

### 4. Автоматическая синхронизация
- ✅ Синхронизация прав админов при каждом входе в организацию
- ✅ Автоматическое добавление админов из Telegram-групп
- ✅ Автоматическое удаление прав при потере статуса админа

## Установка

### Шаг 1: Применить миграцию БД

```bash
node db/init.js db/migrations/20_org_settings_and_admins.sql
```

### Шаг 2: Настроить Storage (если еще не настроен)

Убедитесь, что bucket `materials` создан в Supabase Storage и настроены политики доступа:

1. Создайте bucket `materials` (если не существует)
2. Сделайте его публичным или настройте политики для папки `org-logos/`

### Шаг 3: Перезапустить сервер

```bash
npm run dev
```

## Использование

### Для владельцев и администраторов

1. **Перейдите в настройки организации**
   - Нажмите на пункт "Настройки" внизу левого меню

2. **Обновите основные настройки**
   - Измените название организации
   - Загрузите логотип (рекомендуется квадратный, JPG или PNG, до 5MB)

3. **Просмотрите команду**
   - Владелец отображается первым с фиолетовым бейджем
   - Администраторы показаны с группами, где они являются админами
   - Для каждого участника видна привязка Telegram-аккаунта

4. **Синхронизируйте команду**
   - Нажмите "Синхронизировать с Telegram" для ручного обновления списка админов

## Логика работы прав

### Владелец (Owner)
- Один на организацию
- Полный доступ ко всем функциям
- Не теряет права автоматически
- Создается при создании организации

### Администраторы (Admin)
- Может быть несколько
- Автоматически добавляются из админов Telegram-групп
- Имеют доступ ко всем функциям (кроме передачи владения)
- Автоматически теряют права при потере статуса админа во всех группах

### Участники (Member) - будущее
- Доступ к просмотру материалов, событий
- Регистрация на события
- Просмотр списка участников

## Привязка Telegram

### Обязательность для владельцев/админов
- **Не требуется** для создания организации и работы с материалами
- **Требуется** для:
  - Просмотра Telegram-групп в меню
  - Отправки уведомлений в Telegram
  - Доступа к аналитике групп

### Как работает
- Пользователи без Telegram видят только вручную созданные организации
- Пользователи с Telegram также видят организации, где они админы групп
- Функционал, связанный с Telegram, появляется только после привязки аккаунта

## Архитектура ролей

```
organizations
├── owner_id (UUID) - один владелец
└── memberships
    ├── role: 'owner' | 'admin' | 'member'
    ├── role_source: 'manual' | 'telegram_admin' | 'invitation'
    └── metadata: { telegram_groups: [...], synced_at: '...' }
```

## API примеры

### Обновить название организации

```javascript
const response = await fetch(`/api/organizations/${orgId}`, {
  method: 'PUT',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    name: 'Новое название'
  })
})
```

### Загрузить логотип

```javascript
const formData = new FormData()
formData.append('file', file)

const response = await fetch(`/api/organizations/${orgId}/logo`, {
  method: 'POST',
  body: formData
})
```

### Получить команду

```javascript
const response = await fetch(`/api/organizations/${orgId}/team`)
const data = await response.json()
console.log(data.team) // [{ user_id, role, telegram_username, admin_groups, ... }]
```

### Синхронизировать админов

```javascript
const response = await fetch(`/api/organizations/${orgId}/team/sync`, {
  method: 'POST'
})
```

## Безопасность

- ✅ Все API endpoints требуют аутентификацию
- ✅ Только владельцы и админы могут обновлять настройки
- ✅ Логотипы загружаются в отдельную папку `org-logos/`
- ✅ Размер файлов ограничен 5MB
- ✅ Разрешены только JPG и PNG форматы
- ✅ RLS политики защищают данные организаций

## Troubleshooting

### Админ не появляется в списке
1. Проверьте, что пользователь действительно админ в Telegram-группе
2. Убедитесь, что у пользователя привязан Telegram-аккаунт
3. Нажмите "Синхронизировать с Telegram" в настройках
4. Проверьте таблицу `participant_groups`, что `is_admin = true`

### Логотип не загружается
1. Проверьте размер файла (должен быть < 5MB)
2. Проверьте формат (только JPG или PNG)
3. Убедитесь, что bucket `materials` существует в Supabase Storage
4. Проверьте переменную окружения `SUPABASE_SERVICE_ROLE_KEY`

### Пользователь потерял права админа
- Это нормально, если он перестал быть админом во всех Telegram-группах
- Права восстановятся автоматически при возвращении статуса админа
- Владелец может вручную добавить его обратно (функция в разработке)

## Дальнейшие улучшения

- [ ] Передача владения другому пользователю
- [ ] Ручное управление администраторами владельцем
- [ ] Дополнительные роли (editor, viewer)
- [ ] История изменений команды
- [ ] Уведомления о изменении прав
- [ ] Billing и управление подпиской

