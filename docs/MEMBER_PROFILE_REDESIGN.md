# Redesign: Профиль участника

## Обзор изменений

Карточки участников теперь открываются на отдельной странице с профилем в стиле социальных сетей, вместо всплывающего окна.

---

## Что изменилось

### 1. Навигация
**Было:** Клик по карточке → модальное окно  
**Стало:** Клик по карточке/строке → `/app/[org]/members/[participantId]`

### 2. Страница профиля
**URL:** `/app/[org]/members/[participantId]`

**Функционал:**
- ✅ Проверка авторизации и роли
- ✅ Определение прав редактирования (админ или свой профиль)
- ✅ Вкладки: Профиль, Активность (админ), Дубликаты (админ)

### 3. Дизайн профиля
**Стиль:** Как в социальных сетях

**Структура:**
- Цветной header (градиент)
- Фото профиля (круглое, на границе header/content)
- Кнопка "Редактировать" (для админов и владельца профиля)
- Основная информация с иконками
- Дополнительные характеристики (custom_attributes)
- Группы Telegram
- Заметки (если есть)

---

## Компоненты

### 1. `app/app/[org]/members/[participantId]/page.tsx`

**Server Component**

```typescript
// Функционал:
- Проверка auth
- Определение роли (getUserRoleInOrg)
- Загрузка данных участника (getParticipantDetail)
- Определение canEdit (админ или свой профиль)
- Передача пропсов в ParticipantDetailTabs
```

**Пропсы для ParticipantDetailTabs:**
- `orgId`
- `initialDetail`
- `isAdmin` - показывать ли вкладки Активность/Дубликаты
- `canEdit` - разрешено ли редактировать
- `currentUserId` - для future use

---

### 2. `components/members/participant-detail-tabs.tsx`

**Client Component**

**Вкладки:**
- **Профиль** (для всех)
- **Активность** (только админ)
- **Дубликаты** (только админ)

**Изменения:**
- ❌ Убрана вкладка "Характеристики"
- ✅ Характеристики интегрированы в профиль
- ✅ Условное отображение вкладок на основе `isAdmin`

---

### 3. `components/members/participant-profile-card.tsx`

**Client Component** (полностью переписан)

#### Режим просмотра

**Header:**
- Цветной градиент (blue → purple)
- Круглое фото профиля (h-32 w-32)
- Кнопка "Редактировать" (если `canEdit`)

**Основная информация:**
- Имя (h1, крупный шрифт)
- Контактные карточки с иконками:
  - Telegram (@username) - активная ссылка
  - Email - активная ссылка (mailto:)
  - Телефон - активная ссылка (tel:)
  - Дата добавления

**Custom Attributes:**
- Заголовок "Дополнительная информация"
- Карточки ключ-значение
- Если пусто: "Нет дополнительных характеристик"

**Заметки:**
- Если есть: отображаются в сером блоке
- Если нет: не отображаются (в режиме просмотра)

**Группы Telegram:**
- Список групп с названиями
- Статус (Активен/Неактивен) - цветной badge

#### Режим редактирования

**Активация:** Кнопка "Редактировать" → `setEditing(true)`

**Доступные поля:**
- Полное имя (Input)
- Email (Input type="email")
- Телефон (Input type="tel")
- Custom Attributes:
  - Редактирование существующих (Input для значения)
  - Удаление (кнопка с иконкой Trash2)
  - Добавление новых (два Input: ключ + значение, кнопка Plus)
- Заметки (Textarea)

**Кнопки:**
- "Отмена" → сброс изменений, `setEditing(false)`
- "Сохранить" → PUT `/api/participants/[id]`, обновление state

**API запрос:**
```typescript
PUT /api/participants/[participantId]
Body: {
  orgId,
  full_name,
  email,
  phone,
  notes,
  custom_attributes: { key: value }
}
```

**Поля только для чтения:**
- Telegram username (tg_username)
- Дата добавления (created_at)
- Группы Telegram
- Фото профиля (пока)

---

### 4. `components/members/member-card.tsx`

**Изменения:**
- ❌ Убран проп `onClick`
- ✅ Обёрнут в `<Link href="/app/[org]/members/[id]">`
- ✅ Использует `useParams()` для получения `orgId`

---

### 5. `components/members/members-table.tsx`

**Изменения:**
- ❌ Убран проп `onRowClick`
- ✅ Добавлен `useRouter()` и `useParams()`
- ✅ `handleRowClick(participantId)` → `router.push()`

---

### 6. `components/members/members-view.tsx`

**Изменения:**
- ❌ Убран `selectedMember` state
- ❌ Убран import `MemberProfileModal`
- ❌ Убрано модальное окно
- ✅ Обновлены вызовы `MemberCard` и `MembersTable` (без callback'ов)

---

## Удалённые файлы

- ❌ `components/members/participant-traits-card.tsx`
- ❌ `components/members/member-profile-modal.tsx`

---

## UI/UX особенности

### Профиль в стиле соцсетей

**Вдохновлено:** Facebook, LinkedIn, VK

**Ключевые элементы:**
1. **Визуальный header** - градиент, привлекательный дизайн
2. **Круглое фото** - на пересечении header и content
3. **Карточки информации** - иконки + данные, визуально разделены
4. **Цветовые акценты** - разные цвета для разных типов контактов
5. **Активные ссылки** - Telegram, Email, Phone - кликабельны
6. **Чистый дизайн** - много белого пространства, читаемость

### Режим редактирования

**Философия:** Inline editing

**Принципы:**
- Минимум изменений в layout при переключении режимов
- Input'ы появляются на месте текста
- Явные кнопки "Сохранить" и "Отмена"
- Показ состояния "pending" при сохранении

### Custom Attributes

**Формат:** Ключ-значение (key-value pairs)

**Примеры:**
- Должность: CTO
- Компания: Acme Inc
- Город: Москва
- Навыки: React, TypeScript

**В режиме редактирования:**
- Изменение значений
- Удаление полей
- Добавление новых через форму внизу

---

## Права доступа

### Просмотр профиля
**Кто может:** Все участники организации (role !== 'guest')

### Редактирование профиля
**Кто может:**
- Владелец организации (owner)
- Администраторы (admin)
- Сам участник (detail.participant.user_id === user.id)

### Вкладки "Активность" и "Дубликаты"
**Кто может:** Только админы (owner, admin)

---

## Тестирование

### Сценарий 1: Админ смотрит чужой профиль
1. Логин как админ
2. `/app/[org]/members` → клик по карточке
3. ✅ Открылась страница профиля
4. ✅ Видны все 3 вкладки
5. ✅ Кнопка "Редактировать" доступна
6. Клик "Редактировать"
7. ✅ Поля стали редактируемыми
8. Изменить email, добавить характеристику
9. Клик "Сохранить"
10. ✅ Изменения сохранены
11. ✅ Режим просмотра

### Сценарий 2: Участник смотрит свой профиль
1. Логин как обычный участник
2. Перейти на `/app/[org]/members/[свой_id]`
3. ✅ Открылась страница профиля
4. ✅ Видна только вкладка "Профиль"
5. ✅ Кнопка "Редактировать" доступна
6. Клик "Редактировать"
7. ✅ Можно редактировать свои данные
8. Изменить телефон
9. Клик "Сохранить"
10. ✅ Изменения сохранены

### Сценарий 3: Участник смотрит чужой профиль
1. Логин как обычный участник
2. `/app/[org]/members` → клик по чужой карточке
3. ✅ Открылась страница профиля
4. ✅ Видна только вкладка "Профиль"
5. ❌ Кнопки "Редактировать" нет
6. ✅ Данные в режиме просмотра

### Сценарий 4: Навигация из таблицы
1. Логин как админ
2. `/app/[org]/members` → переключить на "Таблица"
3. Клик по строке
4. ✅ Открылась страница профиля

### Сценарий 5: Custom Attributes
1. Открыть профиль в режиме редактирования
2. Добавить характеристику: "Навыки" = "React"
3. Добавить характеристику: "Опыт" = "5 лет"
4. ✅ Характеристики появились в списке
5. Изменить "Опыт" на "6 лет"
6. Удалить "Навыки" (кнопка корзины)
7. Сохранить
8. ✅ Обновления применены
9. Перезагрузить страницу
10. ✅ Изменения сохранены

---

## API

### GET `/api/participants/[participantId]`
**Используется:** `getParticipantDetail(orgId, participantId)`

**Возвращает:** `ParticipantDetailResult`
- `participant` - основные данные
- `groups` - список Telegram групп
- `externalIds` - внешние идентификаторы
- `auditLog` - история изменений
- `requestedParticipantId`

### PUT `/api/participants/[participantId]`
**Body:**
```json
{
  "orgId": "uuid",
  "full_name": "string",
  "email": "string | null",
  "phone": "string | null",
  "notes": "string | null",
  "custom_attributes": {
    "key": "value"
  }
}
```

**Возвращает:**
```json
{
  "detail": ParticipantDetailResult
}
```

---

## Миграция

### Пользователи
**Ничего не нужно делать** - данные остаются в той же таблице `participants`.

### Разработчики
Если вы кастомизировали модальное окно профиля:
1. Проверьте новую страницу `/app/[org]/members/[id]`
2. Перенесите кастомизации в `participant-profile-card.tsx`

---

## Roadmap

### Фазы реализации
- [x] Фаза 1: Страница профиля с вкладками
- [x] Фаза 2: Режимы просмотра/редактирования
- [x] Фаза 3: Custom attributes в профиле
- [x] Фаза 4: Удаление модального окна
- [ ] Фаза 5: Загрузка фото профиля (будущее)
- [ ] Фаза 6: История активности в профиле (будущее)

---

## Дата
**Создано:** 10.10.2025  
**Статус:** ✅ Реализовано  
**Версия:** 1.0

