# Webhook Monitoring Fix ‚Äî Global Status ‚úÖ

**Date:** 7 –Ω–æ—è–±—Ä—è 2025  
**Status:** COMPLETE

---

## üéØ **–ü—Ä–æ–±–ª–µ–º–∞:**

**–°—Ç–∞—Ä–∞—è –ª–æ–≥–∏–∫–∞ (per-group):**
- –ö–∞–∂–¥–∞—è –≥—Ä—É–ø–ø–∞ –º–æ–Ω–∏—Ç–æ—Ä–∏–ª–∞—Å—å –æ—Ç–¥–µ–ª—å–Ω–æ
- –ï—Å–ª–∏ –≥—Ä—É–ø–ø–∞ –º–æ–ª—á–∏—Ç >60 –º–∏–Ω ‚Üí unhealthy (–∫—Ä–∞—Å–Ω–∞—è)
- **–†–µ–∑—É–ª—å—Ç–∞—Ç:** "9 –∏–∑ 10 –≥—Ä—É–ø–ø –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã" (confusing!)
- **–ü—Ä–æ–±–ª–µ–º–∞:** –î–ª—è –º–Ω–æ–≥–∏—Ö –≥—Ä—É–ø–ø –º–æ–ª—á–∞–Ω–∏–µ 1-2 –¥–Ω—è ‚Äî –Ω–æ—Ä–º–∞, –Ω–µ –æ—à–∏–±–∫–∞

---

## ‚úÖ **–†–µ—à–µ–Ω–∏–µ:**

**–ù–æ–≤–∞—è –ª–æ–≥–∏–∫–∞ (global webhook status):**
- Webhook —Å—á–∏—Ç–∞–µ—Ç—Å—è —Ä–∞–±–æ—Ç–∞—é—â–∏–º, –µ—Å–ª–∏ **—Ö–æ—Ç—è –±—ã –æ–¥–Ω–∞** –≥—Ä—É–ø–ø–∞ –ø–æ–ª—É—á–∏–ª–∞ —Å–æ–±—ã—Ç–∏–µ
- –ù–µ –≤–∞–∂–Ω–æ, –∫–∞–∫–∞—è –∏–º–µ–Ω–Ω–æ –≥—Ä—É–ø–ø–∞ –∞–∫—Ç–∏–≤–Ω–∞
- **–ö—Ä–∏—Ç–∏—á–Ω–æ —Ç–æ–ª—å–∫–æ:** —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π —Å–±–æ–π webhook (–Ω–∏–∫–∞–∫–∏–µ —Å–æ–±—ã—Ç–∏—è –Ω–µ –ø—Ä–∏—Ö–æ–¥—è—Ç)

---

## üìä **–ö—Ä–∏—Ç–µ—Ä–∏–∏ —Å—Ç–∞—Ç—É—Å–∞:**

| –°—Ç–∞—Ç—É—Å | –£—Å–ª–æ–≤–∏–µ | –ó–Ω–∞—á–µ–Ω–∏–µ |
|--------|---------|----------|
| üü¢ **Healthy** | –ü–æ—Å–ª–µ–¥–Ω–µ–µ —Å–æ–±—ã—Ç–∏–µ < 30 –º–∏–Ω –Ω–∞–∑–∞–¥ | Webhook —Ä–∞–±–æ—Ç–∞–µ—Ç –æ—Ç–ª–∏—á–Ω–æ |
| üü° **Degraded** | –ü–æ—Å–ª–µ–¥–Ω–µ–µ —Å–æ–±—ã—Ç–∏–µ 30 –º–∏–Ω - 3 —á–∞—Å–∞ –Ω–∞–∑–∞–¥ | Webhook —Ä–∞–±–æ—Ç–∞–µ—Ç, –Ω–æ –¥–∞–≤–Ω–æ –Ω–µ –±—ã–ª–æ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ |
| üî¥ **Unhealthy** | –ü–æ—Å–ª–µ–¥–Ω–µ–µ —Å–æ–±—ã—Ç–∏–µ > 3 —á–∞—Å–æ–≤ –Ω–∞–∑–∞–¥ | –í–æ–∑–º–æ–∂–µ–Ω —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π —Å–±–æ–π webhook |

---

## üîß **–ß—Ç–æ –∏–∑–º–µ–Ω–µ–Ω–æ:**

### **1. API `/api/telegram/health`** ‚úÖ
**–§–∞–π–ª:** `app/api/telegram/health/route.ts`

**–ù–æ–≤–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –æ—Ç–≤–µ—Ç–∞:**
```json
{
  "ok": true,
  "timestamp": "2025-11-07T20:46:51.865Z",
  "global_status": {
    "status": "degraded",
    "last_event_at": "2025-11-07T19:48:28.881+00:00",
    "last_event_from_group": {
      "title": "–ë–∞–Ω—è –ñ–∏–≤–∏—Ü–∞",
      "tg_chat_id": -4547985702
    },
    "minutes_since_last_event": 58,
    "active_groups_24h": 1,
    "total_groups": 10
  }
}
```

**–õ–æ–≥–∏–∫–∞:**
- –ù–∞—Ö–æ–¥–∏—Ç **—Å–∞–º–æ–µ —Å–≤–µ–∂–µ–µ** —Å–æ–±—ã—Ç–∏–µ –∏–∑ **–≤—Å–µ—Ö** –≥—Ä—É–ø–ø
- –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Å—Ç–∞—Ç—É—Å –ø–æ –≤—Ä–µ–º–µ–Ω–∏ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Å–æ–±—ã—Ç–∏—è (–Ω–µ –ø–æ –∫–∞–∂–¥–æ–π –≥—Ä—É–ø–ø–µ)
- –°—á–∏—Ç–∞–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã–µ –≥—Ä—É–ø–ø—ã –∑–∞ 24 —á–∞—Å–∞

---

### **2. –í–∏–¥–∂–µ—Ç `TelegramHealthStatus`** ‚úÖ
**–§–∞–π–ª:** `components/superadmin/telegram-health-status.tsx`

**–ù–æ–≤—ã–π UI –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç:**
1. **–°—Ç–∞—Ç—É—Å webhook:** "Webhook —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ" (–≤–º–µ—Å—Ç–æ "9 –∏–∑ 10 –≥—Ä—É–ø–ø –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã")
2. **–ü–æ—Å–ª–µ–¥–Ω–µ–µ —Å–æ–±—ã—Ç–∏–µ:** "58 –º–∏–Ω –Ω–∞–∑–∞–¥" + –Ω–∞–∑–≤–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã
3. **–ê–∫—Ç–∏–≤–Ω—ã—Ö –≥—Ä—É–ø–ø –∑–∞ 24 —á–∞—Å–∞:** "1 –∏–∑ 10"
4. **Info message:** "–î–ª—è –º–Ω–æ–≥–∏—Ö –≥—Ä—É–ø–ø –º–æ–ª—á–∞–Ω–∏–µ 1-2 –¥–Ω—è ‚Äî –Ω–æ—Ä–º–∞. –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ç–æ–ª—å–∫–æ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Å–±–æ–∏ webhook."

**–¶–≤–µ—Ç–æ–≤–∞—è –∏–Ω–¥–∏–∫–∞—Ü–∏—è:**
- üü¢ –ó–µ–ª–µ–Ω—ã–π —Ñ–æ–Ω ‚Üí Healthy (< 30 –º–∏–Ω)
- üü° –ñ–µ–ª—Ç—ã–π —Ñ–æ–Ω ‚Üí Degraded (30 –º–∏–Ω - 3 —á–∞—Å–∞)
- üî¥ –ö—Ä–∞—Å–Ω—ã–π —Ñ–æ–Ω ‚Üí Unhealthy (> 3 —á–∞—Å–æ–≤)

---

## üì∏ **–ü—Ä–∏–º–µ—Ä –Ω–æ–≤–æ–≥–æ –≤–∏–¥–∂–µ—Ç–∞:**

### **Healthy status (–ø–æ—Å–ª–µ–¥–Ω–µ–µ —Å–æ–±—ã—Ç–∏–µ 10 –º–∏–Ω –Ω–∞–∑–∞–¥):**
```
‚úÖ Webhook —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
   –ü–æ—Å–ª–µ–¥–Ω–µ–µ —Å–æ–±—ã—Ç–∏–µ: 10 –º–∏–Ω –Ω–∞–∑–∞–¥
   –ì—Ä—É–ø–ø–∞: –ë–∞–Ω—è –ñ–∏–≤–∏—Ü–∞
   
   –ê–∫—Ç–∏–≤–Ω—ã—Ö –≥—Ä—É–ø–ø –∑–∞ 24 —á–∞—Å–∞: 2 –∏–∑ 10
   
   ‚ÑπÔ∏è –î–ª—è –º–Ω–æ–≥–∏—Ö –≥—Ä—É–ø–ø –º–æ–ª—á–∞–Ω–∏–µ 1-2 –¥–Ω—è ‚Äî –Ω–æ—Ä–º–∞. 
      –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ç–æ–ª—å–∫–æ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Å–±–æ–∏ webhook.
```

### **Degraded status (–ø–æ—Å–ª–µ–¥–Ω–µ–µ —Å–æ–±—ã—Ç–∏–µ 1 —á–∞—Å –Ω–∞–∑–∞–¥):**
```
‚ö†Ô∏è Webhook —Ä–∞–±–æ—Ç–∞–µ—Ç, –Ω–æ –¥–∞–≤–Ω–æ –Ω–µ –±—ã–ª–æ —Å–æ–±—ã—Ç–∏–π
   –ü–æ—Å–ª–µ–¥–Ω–µ–µ —Å–æ–±—ã—Ç–∏–µ: 1 —á –Ω–∞–∑–∞–¥
   –ì—Ä—É–ø–ø–∞: Test Group
   
   –ê–∫—Ç–∏–≤–Ω—ã—Ö –≥—Ä—É–ø–ø –∑–∞ 24 —á–∞—Å–∞: 1 –∏–∑ 10
   
   ‚ÑπÔ∏è –î–ª—è –º–Ω–æ–≥–∏—Ö –≥—Ä—É–ø–ø –º–æ–ª—á–∞–Ω–∏–µ 1-2 –¥–Ω—è ‚Äî –Ω–æ—Ä–º–∞.
```

### **Unhealthy status (–ø–æ—Å–ª–µ–¥–Ω–µ–µ —Å–æ–±—ã—Ç–∏–µ 5 —á–∞—Å–æ–≤ –Ω–∞–∑–∞–¥):**
```
‚ùå –í–æ–∑–º–æ–∂–µ–Ω —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π —Å–±–æ–π webhook
   –ü–æ—Å–ª–µ–¥–Ω–µ–µ —Å–æ–±—ã—Ç–∏–µ: 5 —á –Ω–∞–∑–∞–¥
   –ì—Ä—É–ø–ø–∞: Last Active Group
   
   –ê–∫—Ç–∏–≤–Ω—ã—Ö –≥—Ä—É–ø–ø –∑–∞ 24 —á–∞—Å–∞: 0 –∏–∑ 10
   
   ‚ö†Ô∏è –ù–µ—Ç —Å–æ–±—ã—Ç–∏–π –±–æ–ª–µ–µ 3 —á–∞—Å–æ–≤. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ webhook –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≤ Telegram.
```

---

## ‚úÖ **–†–µ–∑—É–ª—å—Ç–∞—Ç:**

1. **–í–∏–¥–∂–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç** –≥–ª–æ–±–∞–ª—å–Ω—ã–π —Å—Ç–∞—Ç—É—Å webhook
2. **–ù–µ –ø—É—Ç–∞–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è** —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏ –æ "–Ω–µ–∞–∫—Ç–∏–≤–Ω—ã—Ö –≥—Ä—É–ø–ø–∞—Ö"
3. **–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ç–æ–ª—å–∫–æ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã** (webhook —Å–ª–æ–º–∞–Ω), –∞ –Ω–µ –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ–µ –º–æ–ª—á–∞–Ω–∏–µ –≥—Ä—É–ø–ø
4. **–ò–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω–æ:** –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø–æ—Å–ª–µ–¥–Ω–µ–µ —Å–æ–±—ã—Ç–∏–µ, –∏–∑ –∫–∞–∫–æ–π –≥—Ä—É–ø–ø—ã, —Å–∫–æ–ª—å–∫–æ –≥—Ä—É–ø–ø –∞–∫—Ç–∏–≤–Ω—ã

---

## üìã **–§–∞–π–ª—ã –∏–∑–º–µ–Ω–µ–Ω—ã:**

- ‚úÖ `app/api/telegram/health/route.ts` ‚Äî –Ω–æ–≤–∞—è –ª–æ–≥–∏–∫–∞ API
- ‚úÖ `components/superadmin/telegram-health-status.tsx` ‚Äî –Ω–æ–≤—ã–π UI –≤–∏–¥–∂–µ—Ç–∞

---

## üöÄ **Deploy:**

```bash
git add app/api/telegram/health/route.ts components/superadmin/telegram-health-status.tsx
git commit -m "Fix: Change webhook monitoring to global status (not per-group)"
git push
```

---

## ‚úÖ **Testing:**

–ü–æ—Å–ª–µ –¥–µ–ø–ª–æ—è:
1. –û—Ç–∫—Ä—ã—Ç—å `/superadmin/telegram`
2. –í–∏–¥–∂–µ—Ç –¥–æ–ª–∂–µ–Ω –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å:
   - –ì–ª–æ–±–∞–ª—å–Ω—ã–π —Å—Ç–∞—Ç—É—Å (healthy/degraded/unhealthy)
   - –ü–æ—Å–ª–µ–¥–Ω–µ–µ —Å–æ–±—ã—Ç–∏–µ —Å –Ω–∞–∑–≤–∞–Ω–∏–µ–º –≥—Ä—É–ø–ø—ã
   - –ê–∫—Ç–∏–≤–Ω—ã–µ –≥—Ä—É–ø–ø—ã –∑–∞ 24 —á–∞—Å–∞
   - Info message –æ —Ç–æ–º, —á—Ç–æ –º–æ–ª—á–∞–Ω–∏–µ –≥—Ä—É–ø–ø ‚Äî –Ω–æ—Ä–º–∞

---

**Status:** ‚úÖ COMPLETE  
**Time:** ~1 —á–∞—Å (Quick fix, –∫–∞–∫ –∏ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–ª–æ—Å—å)  
**Impact:** –í–∏–¥–∂–µ—Ç —Ç–µ–ø–µ—Ä—å –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ webhook status

